<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RCA+ 矛盾分析繪圖工具 (含參數與原理)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        #diagram-render-area { position: relative; overflow: auto; }
        #svg-connector-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 0; }
        .rca-node {
            background-color: white; border: 1px solid #d1d5db; padding: 0.75rem 1.25rem; margin: 0.5rem;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            display: inline-flex; align-items: center; min-width: 220px; /* 稍微加寬以容納更多資訊 */
            text-align: left; border-radius: 0.375rem; position: relative; z-index: 1;
        }
        .rca-node-content { display: flex; flex-direction: column; gap: 0.5rem; width: 100%; }
        .rca-node-header { display: flex; align-items: center; gap: 0.5rem; }
        .rca-node-icon { font-weight: bold; font-size: 1.1em; }
        .nc-badge { font-size: 0.7em; font-weight: bold; color: #4b5563; background-color: #e5e7eb; padding: 0.1rem 0.3rem; border-radius: 0.25rem; margin-left: 0.3rem; }
        .rca-node-text { font-weight: 500; word-break: break-word; flex-grow: 1; }
        .selected-items-list { font-size: 0.75rem; color: #4b5563; margin-top: 0.5rem; padding-top: 0.25rem; border-top: 1px dashed #e5e7eb; }
        .selected-items-list strong { color: #1f2937; }
        .selected-items-list ul { list-style-type: disc; margin-left: 1rem; }

        .rca-node-initial-problem { border-left: 4px solid #ef4444; }
        .rca-node-initial-problem .rca-node-icon { color: #ef4444; }
        .rca-node-cause { border-left: 4px solid #3b82f6; }
        .rca-node-cause .rca-node-icon.contradictory { color: #7c3aed; }
        .rca-node-positive-effect { border-left: 4px solid #10b981; background-color: #f0fdf4; border-radius: 50px; padding: 0.75rem 1.5rem; min-width: 180px; }
        .rca-node-positive-effect .rca-node-header { justify-content: center; }
        .rca-node-positive-effect .rca-node-icon { color: #10b981; }
        .rca-node-negative-effect { border-left: 4px solid #f97316; background-color: #fff7ed; border-radius: 50px; padding: 0.75rem 1.5rem; min-width: 180px; }
        .rca-node-negative-effect .rca-node-header { justify-content: center; }
        .rca-node-negative-effect .rca-node-icon { color: #f97316; }

        .rca-children-container { display: flex; flex-direction: column; align-items: center; margin-top: 1rem; position: relative; }
        
        .rca-node-actions { display: flex; flex-wrap: wrap; gap: 0.25rem; margin-top: 0.5rem; border-top: 1px solid #e5e7eb; padding-top: 0.5rem; }
        .action-button { background-color: #6b7280; color: white; padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem; border: none; cursor: pointer; transition: background-color 0.2s; }
        .action-button:hover { background-color: #4b5563; }
        .action-button.add-cause { background-color: #3b82f6; }
        .action-button.add-positive { background-color: #10b981; }
        .action-button.add-negative { background-color: #f97316; }
        .action-button.toggle-nc { background-color: #a855f7; }
        .action-button.set-and-sources { background-color: #6d28d9; } 
        .action-button.edit-node { background-color: #f59e0b; } 
        .action-button.set-parameters { background-color: #0ea5e9; } /* Sky blue for parameters */
        .action-button.set-principles { background-color: #ec4899; } /* Pink for principles */
        .action-button.finalize-diagram { background-color: #059669; } 
        .action-button.edit-diagram { background-color: #d97706; } 
        .remove-button { background-color: #ef4444; }
        
        .input-group-container { margin-top: 0.5rem; }
        .input-group { display: flex; flex-direction: column; gap: 0.5rem; padding: 0.5rem; border: 1px solid #e5e7eb; border-radius: 0.25rem; background-color: #f9fafb; }
        .input-field { border: 1px solid #d1d5db; padding: 0.5rem; border-radius: 0.25rem; font-size: 0.875rem; width: 100%; }
        .save-button { background-color: #065f46; color: white; }
        .save-edit-button { background-color: #065f46; color: white; }

        #cause-effect-table-section { margin-top: 2rem; }
        .cause-effect-table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
        .cause-effect-table th, .cause-effect-table td { border: 1px solid #d1d5db; padding: 0.5rem; text-align: left; font-size: 0.875rem; }
        .cause-effect-table th { background-color: #e5e7eb; font-weight: 600; }
        .cause-effect-table td { background-color: white; }

        /* Modals Styles */
        .modal { z-index: 50; }
        .modal-options-container label { cursor: pointer; }
        .modal-options-container h4 { font-semibold; margin-top: 0.5rem; margin-bottom: 0.25rem; color: #374151; }
    </style>
</head>
<body class="p-4 md:p-8">
    <div class="container mx-auto max-w-6xl">
        <header class="mb-6 text-center">
            <h1 class="text-2xl md:text-3xl font-bold text-gray-700">RCA+ 矛盾分析繪圖工具</h1>
            <p class="text-gray-500 mt-1">視覺化根本原因、正面/負面效果，支援「且」關係連接、矛盾點標示、效果參數與發明原理。</p>
        </header>

        <section id="controls-section" class="mb-6 p-4 bg-white rounded-lg shadow">
             <div id="problem-input-area">
                <h2 class="text-xl font-semibold text-gray-700 mb-3">1. 設定主要負面效果</h2>
                <div class="flex flex-col sm:flex-row gap-2">
                    <input type="text" id="problem-statement-input" placeholder="輸入觀察到的主要負面效果" class="input-field flex-grow p-2 rounded-md border-gray-300 focus:ring-blue-500 focus:border-blue-500">
                    <button id="set-problem-button" class="action-button add-cause text-white font-semibold py-2 px-4 rounded-md">設定問題根源</button>
                </div>
            </div>
            <div id="tool-buttons" style="display: none;" class="mt-4 flex flex-wrap gap-2">
                <button id="finalize-diagram-button" class="action-button finalize-diagram text-white font-semibold py-2 px-4 rounded-md">完成圖表</button>
                <button id="export-diagram-button" class="action-button bg-purple-500 hover:bg-purple-600 text-white font-semibold py-2 px-4 rounded-md">匯出圖表 (PNG)</button>
                <button id="toggle-table-button" class="action-button bg-teal-500 hover:bg-teal-600 text-white font-semibold py-2 px-4 rounded-md">顯示原因效果表</button>
            </div>
        </section>

        <section id="rca-diagram-section" class="bg-white p-4 md:p-6 rounded-lg shadow min-h-[400px]">
            <h2 class="text-xl font-semibold text-gray-700 mb-4 text-center" id="diagram-title" style="display: none;">2. RCA+ 分析圖</h2>
            <div id="diagram-render-area">
                <div id="rca-diagram-container" class="overflow-x-auto pb-4"></div>
                <svg id="svg-connector-layer"></svg>
            </div>
        </section>

        <section id="cause-effect-table-section" style="display: none;" class="bg-white p-4 md:p-6 rounded-lg shadow">
            <h2 class="text-xl font-semibold text-gray-700 mb-3">3. 原因效果表</h2>
            <table class="cause-effect-table">
                <thead> <tr><th>原因</th><th>原因類型</th><th>正面效果</th><th>負面效果</th></tr> </thead>
                <tbody id="cause-effect-table-body"></tbody>
            </table>
        </section>
    </div>

    <div id="and-source-modal" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center" style="display: none;">
        <div class="relative mx-auto p-5 border w-11/12 md:w-1/2 lg:w-1/3 shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <h3 class="text-lg leading-6 font-medium text-gray-900 text-center" id="and-source-modal-title">為效果設定 AND 輸入源</h3>
                <div class="mt-4 px-2 py-3 max-h-72 overflow-y-auto modal-options-container" id="and-source-options-container"></div>
                <div class="items-center px-4 py-3 mt-4 text-right">
                    <button id="cancel-and-sources-button" class="mr-2 px-4 py-2 bg-gray-300 text-gray-800 text-base font-medium rounded-md w-auto shadow-sm hover:bg-gray-400 focus:outline-none focus:ring-2 focus:ring-gray-300">取消</button>
                    <button id="save-and-sources-button" class="px-4 py-2 bg-green-500 text-white text-base font-medium rounded-md w-auto shadow-sm hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-300">儲存AND來源</button>
                </div>
            </div>
        </div>
    </div>

    <div id="effect-parameter-modal" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center" style="display: none;">
        <div class="relative mx-auto p-5 border w-11/12 md:w-1/2 lg:w-2/5 shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <h3 class="text-lg leading-6 font-medium text-gray-900 text-center" id="effect-parameter-modal-title">設定效果參數</h3>
                <div class="mt-4 px-2 py-3 max-h-96 overflow-y-auto modal-options-container" id="effect-parameter-options-container">
                    </div>
                <div class="items-center px-4 py-3 mt-4 text-right">
                    <button id="cancel-effect-parameters-button" class="mr-2 px-4 py-2 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400">取消</button>
                    <button id="save-effect-parameters-button" class="px-4 py-2 bg-sky-500 text-white rounded-md hover:bg-sky-700">儲存參數</button>
                </div>
            </div>
        </div>
    </div>

    <div id="inventive-principle-modal" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center" style="display: none;">
        <div class="relative mx-auto p-5 border w-11/12 md:w-1/2 lg:w-2/5 shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <h3 class="text-lg leading-6 font-medium text-gray-900 text-center" id="inventive-principle-modal-title">選擇發明原理</h3>
                <div class="mt-4 px-2 py-3 max-h-96 overflow-y-auto modal-options-container" id="inventive-principle-options-container">
                    </div>
                <div class="items-center px-4 py-3 mt-4 text-right">
                    <button id="cancel-inventive-principles-button" class="mr-2 px-4 py-2 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400">取消</button>
                    <button id="save-inventive-principles-button" class="px-4 py-2 bg-pink-500 text-white rounded-md hover:bg-pink-700">儲存原理</button>
                </div>
            </div>
        </div>
    </div>


    <script>
        // --- (保持現有的全局變數和 DOM 元素引用) ---
        let rcaData = null; 
        let nodeIdCounter = 0;
        let currentAndTargetNodeId = null; 
        let isFinalizedView = false; 
        let currentParameterTargetNodeId = null; // For effect parameters
        let currentPrincipleTargetNodeId = null; // For inventive principles

        // DOM Elements (add new modal elements)
        const problemInput = document.getElementById('problem-statement-input');
        const setProblemButton = document.getElementById('set-problem-button');
        const diagramContainer = document.getElementById('rca-diagram-container');
        const svgLayer = document.getElementById('svg-connector-layer');
        const diagramTitle = document.getElementById('diagram-title');
        const problemInputArea = document.getElementById('problem-input-area');
        const toolButtonsContainer = document.getElementById('tool-buttons');
        const finalizeDiagramButton = document.getElementById('finalize-diagram-button'); 
        const exportDiagramButton = document.getElementById('export-diagram-button');
        const toggleTableButton = document.getElementById('toggle-table-button');
        const causeEffectTableSection = document.getElementById('cause-effect-table-section');
        const causeEffectTableBody = document.getElementById('cause-effect-table-body');
        
        const andSourceModal = document.getElementById('and-source-modal');
        const andSourceOptionsContainer = document.getElementById('and-source-options-container');
        const andSourceModalTitle = document.getElementById('and-source-modal-title');
        const saveAndSourcesButton = document.getElementById('save-and-sources-button');
        const cancelAndSourcesButton = document.getElementById('cancel-and-sources-button');

        const effectParameterModal = document.getElementById('effect-parameter-modal');
        const effectParameterOptionsContainer = document.getElementById('effect-parameter-options-container');
        const effectParameterModalTitle = document.getElementById('effect-parameter-modal-title');
        const saveEffectParametersButton = document.getElementById('save-effect-parameters-button');
        const cancelEffectParametersButton = document.getElementById('cancel-effect-parameters-button');

        const inventivePrincipleModal = document.getElementById('inventive-principle-modal');
        const inventivePrincipleOptionsContainer = document.getElementById('inventive-principle-options-container');
        const inventivePrincipleModalTitle = document.getElementById('inventive-principle-modal-title');
        const saveInventivePrinciplesButton = document.getElementById('save-inventive-principles-button');
        const cancelInventivePrinciplesButton = document.getElementById('cancel-inventive-principles-button');

        // --- Data for Parameters and Principles ---
        const EFFECT_PARAMETERS = {
            "活動": ["活動效用性", "活動可變性", "活動費用", "活動時間", "活動複雜性", "活動方便性", "活動安全性", "活動可靠性"],
            "系統": ["系統有效性", "系統可變性", "系統費用", "系統時間", "系統複雜性", "系統方便性", "系統安全性", "系統可靠性", "對系統的有害影響", "系統產生的有害影響", "組織壓力", "組織穩定性"],
            "其他": ["內部風險", "外部風險", "信息共享", "信息損失", "信息流", "回饋", "物料流", "適應性/多功能性", "顧客壓力", "顧客穩定性", "環境穩定性"]
        };
        const INVENTIVE_PRINCIPLES = [
            "分割", "取出/分離", "改變局部特性", "非對稱性", "合併/整合", "多用性/多功能", "套疊/巢狀結構", 
            "反制行動", "預先反制行動", "預先行動", "事先補償/預防", "消除緊張", "另一方向/反向操作", 
            "非直線姓", "動態化", "稍微少些或多些(的動作)", "另外維度/空間", "共鳴(協調)", "週期行動", 
            "連續的有利作用", "快速行動", "轉有害為有利", "回饋", "中介物/媒介", "自助/自我服務", 
            "使用複製品或模型", "廉價與短期[拋棄式]", "替換系統運作原理/使用其他原理", "流動性和靈活性", 
            "改變邊界條件", "孔洞和網路", "改變外觀/可見度", "同質性", "丟棄與恢復", "改變特性", 
            "模範轉移", "相對變化", "增強的環境", "鈍性(惰性)環境", "組合(複合)結構"
        ];

        function initialize() {
            setProblemButton.addEventListener('click', handleSetInitialProblem);
            problemInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') handleSetInitialProblem(); });
            finalizeDiagramButton.addEventListener('click', handleToggleFinalizeView); 
            exportDiagramButton.addEventListener('click', exportDiagramAsPNG);
            toggleTableButton.addEventListener('click', handleToggleCauseEffectTable);
            
            saveAndSourcesButton.addEventListener('click', handleSaveAndSources);
            cancelAndSourcesButton.addEventListener('click', handleCancelAndSources);
            
            saveEffectParametersButton.addEventListener('click', handleSaveEffectParameters);
            cancelEffectParametersButton.addEventListener('click', () => { effectParameterModal.style.display = 'none'; currentParameterTargetNodeId = null; });
            
            saveInventivePrinciplesButton.addEventListener('click', handleSaveInventivePrinciples);
            cancelInventivePrinciplesButton.addEventListener('click', () => { inventivePrincipleModal.style.display = 'none'; currentPrincipleTargetNodeId = null; });
            
            new ResizeObserver(drawAllSvgConnectors).observe(diagramContainer);
        }

        function createNode(text, type, parentId, isNonChangeable = false) {
            nodeIdCounter++;
            const node = {
                id: `node-${nodeIdCounter}`, text: text, type: type, parentId: parentId, children: [],
                andSourceNodeIds: [],
                effectParameters: [], // 新增
                inventivePrinciples: [] // 新增
            };
            if (type === 'cause') node.isNonChangeable = isNonChangeable;
            return node;
        }

        function createNodeElement(nodeData) {
            // ... (大部分 createNodeElement 內容與前一版本相同) ...
            const nodeWrapper = document.createElement('div');
            nodeWrapper.classList.add('rca-node-wrapper');
            const nodeDiv = document.createElement('div');
            nodeDiv.classList.add('rca-node', `rca-node-${nodeData.type}`);
            nodeDiv.id = nodeData.id; 
            nodeDiv.dataset.nodeId = nodeData.id;

            const contentDiv = document.createElement('div');
            contentDiv.classList.add('rca-node-content');
            const headerDiv = document.createElement('div');
            headerDiv.classList.add('rca-node-header');
            const iconSpan = document.createElement('span');
            iconSpan.classList.add('rca-node-icon');
            const textSpan = document.createElement('span');
            textSpan.classList.add('rca-node-text');
            textSpan.textContent = nodeData.text;

            headerDiv.appendChild(iconSpan);
            headerDiv.appendChild(textSpan);

            if (nodeData.type === 'cause' && nodeData.isNonChangeable) {
                const ncBadge = document.createElement('span');
                ncBadge.classList.add('nc-badge'); ncBadge.textContent = 'NC';
                headerDiv.appendChild(ncBadge);
            }
            contentDiv.appendChild(headerDiv);

            // 顯示已選的效果參數和發明原理
            if (nodeData.effectParameters && nodeData.effectParameters.length > 0) {
                const paramsDiv = document.createElement('div');
                paramsDiv.classList.add('selected-items-list');
                paramsDiv.innerHTML = `<strong>效果參數:</strong> <ul>${nodeData.effectParameters.map(p => `<li>${p}</li>`).join('')}</ul>`;
                contentDiv.appendChild(paramsDiv);
            }
            if (nodeData.inventivePrinciples && nodeData.inventivePrinciples.length > 0) {
                const principlesDiv = document.createElement('div');
                principlesDiv.classList.add('selected-items-list');
                principlesDiv.innerHTML = `<strong>發明原理:</strong> <ul>${nodeData.inventivePrinciples.map(p => `<li>${p}</li>`).join('')}</ul>`;
                contentDiv.appendChild(principlesDiv);
            }


            if (!isFinalizedView) {
                const actionsDiv = document.createElement('div');
                actionsDiv.classList.add('rca-node-actions');
                actionsDiv.appendChild(createActionButton('修訂此項', 'edit-node', () => promptEditNode(nodeData.id, contentDiv)));

                if (nodeData.type === 'initial-problem') {
                    iconSpan.textContent = '(-)';
                    actionsDiv.appendChild(createActionButton('新增原因', 'add-cause', () => promptAddNode(nodeData.id, contentDiv, 'cause', '輸入原因描述')));
                } else if (nodeData.type === 'cause') {
                    const { hasPositiveChild, hasNegativeChild } = checkChildrenEffects(nodeData);
                    if (hasPositiveChild && hasNegativeChild) {
                        iconSpan.textContent = '(+/-)'; iconSpan.classList.add('contradictory');
                    } else { iconSpan.textContent = ''; }
                    actionsDiv.appendChild(createActionButton('新增子原因', 'add-cause', () => promptAddNode(nodeData.id, contentDiv, 'cause', '輸入子原因描述')));
                    actionsDiv.appendChild(createActionButton('(+) 正面效果', 'add-positive', () => promptAddNode(nodeData.id, contentDiv, 'positive-effect', '輸入此原因帶來的正面效果')));
                    actionsDiv.appendChild(createActionButton('(-) 負面效果', 'add-negative', () => promptAddNode(nodeData.id, contentDiv, 'negative-effect', '輸入此原因導致的負面效果')));
                    const ncButtonText = nodeData.isNonChangeable ? '取消NC標記' : '設為NC';
                    actionsDiv.appendChild(createActionButton(ncButtonText, 'toggle-nc', () => toggleNonChangeable(nodeData.id)));
                    actionsDiv.appendChild(createActionButton('選擇發明原理', 'set-principles', () => openInventivePrincipleModal(nodeData.id))); // 新增按鈕
                    if (nodeData.parentId) { 
                       actionsDiv.appendChild(createActionButton('移除此原因', 'remove-button', () => removeNode(nodeData.id)));
                    }
                } else if (nodeData.type === 'positive-effect' || nodeData.type === 'negative-effect') {
                    iconSpan.textContent = nodeData.type === 'positive-effect' ? '(+)' : '(-)';
                    actionsDiv.appendChild(createActionButton('(+) 新增正面子效果', 'add-positive', () => promptAddNode(nodeData.id, contentDiv, 'positive-effect', '輸入正面子效果描述')));
                    actionsDiv.appendChild(createActionButton('(-) 新增負面子效果', 'add-negative', () => promptAddNode(nodeData.id, contentDiv, 'negative-effect', '輸入負面子效果描述')));
                    actionsDiv.appendChild(createActionButton('設定效果參數', 'set-parameters', () => openEffectParameterModal(nodeData.id))); // 新增按鈕
                    actionsDiv.appendChild(createActionButton('設定AND輸入源', 'set-and-sources', () => openAndSourceModal(nodeData.id)));
                    actionsDiv.appendChild(createActionButton('移除效果', 'remove-button', () => removeNode(nodeData.id)));
                }
                contentDiv.appendChild(actionsDiv);

                const inputContainer = document.createElement('div'); 
                inputContainer.classList.add('input-group-container');
                contentDiv.appendChild(inputContainer);
            } else {
                // Finalized view icon logic
                if (nodeData.type === 'initial-problem') iconSpan.textContent = '(-)';
                else if (nodeData.type === 'cause') {
                    const { hasPositiveChild, hasNegativeChild } = checkChildrenEffects(nodeData);
                    if (hasPositiveChild && hasNegativeChild) {
                        iconSpan.textContent = '(+/-)'; iconSpan.classList.add('contradictory');
                    } else { iconSpan.textContent = ''; }
                } else if (nodeData.type === 'positive-effect') iconSpan.textContent = '(+)';
                else if (nodeData.type === 'negative-effect') iconSpan.textContent = '(-)';
            }
            
            nodeDiv.appendChild(contentDiv); 
            nodeWrapper.appendChild(nodeDiv); 

            if (nodeData.children && nodeData.children.length > 0) {
                const childrenContainer = document.createElement('div');
                childrenContainer.classList.add('rca-children-container');
                if (nodeData.children.length > 1) childrenContainer.classList.add('has-multiple-children');
                nodeData.children.forEach(childNode => childrenContainer.appendChild(createNodeElement(childNode)));
                nodeWrapper.appendChild(childrenContainer);
            }
            return nodeWrapper;
        }

        // --- Effect Parameter Modal Logic ---
        function openEffectParameterModal(targetNodeId) {
            if (isFinalizedView) return;
            currentParameterTargetNodeId = targetNodeId;
            const targetNode = findNodeById(rcaData, targetNodeId);
            if (!targetNode || (targetNode.type !== 'positive-effect' && targetNode.type !== 'negative-effect')) return;

            effectParameterModalTitle.textContent = `為效果 "${targetNode.text}" 設定效果參數`;
            effectParameterOptionsContainer.innerHTML = '';

            Object.keys(EFFECT_PARAMETERS).forEach(category => {
                const categoryTitle = document.createElement('h4');
                categoryTitle.textContent = category;
                effectParameterOptionsContainer.appendChild(categoryTitle);

                EFFECT_PARAMETERS[category].forEach(param => {
                    const div = document.createElement('div');
                    div.classList.add('flex', 'items-center', 'my-1');
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.id = `param-chk-${param.replace(/\s|\//g, '-')}`; // Sanitize ID
                    checkbox.value = param;
                    checkbox.classList.add('form-checkbox', 'h-4', 'w-4', 'text-sky-600', 'rounded');
                    if (targetNode.effectParameters && targetNode.effectParameters.includes(param)) {
                        checkbox.checked = true;
                    }
                    const label = document.createElement('label');
                    label.htmlFor = checkbox.id;
                    label.textContent = param;
                    label.classList.add('ml-2', 'text-sm', 'text-gray-700');
                    div.appendChild(checkbox);
                    div.appendChild(label);
                    effectParameterOptionsContainer.appendChild(div);
                });
            });
            effectParameterModal.style.display = 'flex';
        }

        function handleSaveEffectParameters() {
            if (!currentParameterTargetNodeId) return;
            const targetNode = findNodeById(rcaData, currentParameterTargetNodeId);
            if (!targetNode) return;

            const selectedParameters = [];
            const checkboxes = effectParameterOptionsContainer.querySelectorAll('input[type="checkbox"]:checked');
            checkboxes.forEach(chk => selectedParameters.push(chk.value));

            targetNode.effectParameters = selectedParameters;
            effectParameterModal.style.display = 'none';
            currentParameterTargetNodeId = null;
            renderRcaDiagram();
        }

        // --- Inventive Principle Modal Logic ---
        function openInventivePrincipleModal(targetNodeId) {
            if (isFinalizedView) return;
            currentPrincipleTargetNodeId = targetNodeId;
            const targetNode = findNodeById(rcaData, targetNodeId);
            if (!targetNode || targetNode.type !== 'cause') return;

            inventivePrincipleModalTitle.textContent = `為原因 "${targetNode.text}" 選擇發明原理`;
            inventivePrincipleOptionsContainer.innerHTML = '';

            INVENTIVE_PRINCIPLES.forEach(principle => {
                const div = document.createElement('div');
                div.classList.add('flex', 'items-center', 'my-1');
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = `principle-chk-${principle.replace(/\s|\/|\[|\]/g, '-')}`; // Sanitize ID
                checkbox.value = principle;
                checkbox.classList.add('form-checkbox', 'h-4', 'w-4', 'text-pink-600', 'rounded');
                if (targetNode.inventivePrinciples && targetNode.inventivePrinciples.includes(principle)) {
                    checkbox.checked = true;
                }
                const label = document.createElement('label');
                label.htmlFor = checkbox.id;
                label.textContent = principle;
                label.classList.add('ml-2', 'text-sm', 'text-gray-700');
                div.appendChild(checkbox);
                div.appendChild(label);
                inventivePrincipleOptionsContainer.appendChild(div);
            });
            inventivePrincipleModal.style.display = 'flex';
        }

        function handleSaveInventivePrinciples() {
            if (!currentPrincipleTargetNodeId) return;
            const targetNode = findNodeById(rcaData, currentPrincipleTargetNodeId);
            if (!targetNode) return;

            const selectedPrinciples = [];
            const checkboxes = inventivePrincipleOptionsContainer.querySelectorAll('input[type="checkbox"]:checked');
            checkboxes.forEach(chk => selectedPrinciples.push(chk.value));

            targetNode.inventivePrinciples = selectedPrinciples;
            inventivePrincipleModal.style.display = 'none';
            currentPrincipleTargetNodeId = null;
            renderRcaDiagram();
        }

        // --- (保持其他 JavaScript 函數如 handleSetInitialProblem, drawAllSvgConnectors, etc. 與前一版本相同或稍作調整以適應新數據) ---
        // ... (此處省略了大部分與前一版本相同的 JS 函數，如 handleToggleFinalizeView, promptEditNode, openAndSourceModal, isDescendant, handleSaveAndSources, handleCancelAndSources, drawAllSvgConnectors, drawSvgLine, drawSvgCircle, checkChildrenEffects, toggleNonChangeable, createActionButton, promptAddNode, addNodeToData, removeNode, findNodeById, handleToggleCauseEffectTable, getCauseEffectTableData, renderCauseEffectTable, exportDiagramAsPNG)
        // 請確保將前一版本中這些函數的完整實現複製到此處。為簡潔起見，此處僅示意。
        // 重要的：複製並貼上以下函數的完整實現，因為它們在此版本中保持不變：
        // handleToggleFinalizeView, promptEditNode, openAndSourceModal, isDescendant, handleSaveAndSources, handleCancelAndSources, 
        // drawAllSvgConnectors, drawSvgLine, drawSvgCircle, checkChildrenEffects, toggleNonChangeable, createActionButton, 
        // promptAddNode, addNodeToData, removeNode, findNodeById, handleToggleCauseEffectTable, 
        // getCauseEffectTableData, renderCauseEffectTable, exportDiagramAsPNG.
        // (以下為這些函數的簡化佔位符，實際應使用完整代碼)
        function handleToggleFinalizeView() { isFinalizedView = !isFinalizedView; finalizeDiagramButton.textContent = isFinalizedView ? '編輯圖表' : '完成圖表'; finalizeDiagramButton.classList.toggle('edit-diagram', isFinalizedView); finalizeDiagramButton.classList.toggle('finalize-diagram', !isFinalizedView); renderRcaDiagram(); }
        function promptEditNode(nodeId, parentNodeContentDiv) { /* ... */ }
        function openAndSourceModal(targetNodeId) { /* ... */ }
        function isDescendant(parentNode, childNodeIdToFind) { /* ... */ return false; }
        function handleSaveAndSources() { /* ... */ }
        function handleCancelAndSources() { andSourceModal.style.display = 'none'; currentAndTargetNodeId = null; }
        function drawAllSvgConnectors() { /* ... */ }
        function drawSvgLine(x1, y1, x2, y2, color, strokeWidth) { /* ... */ }
        function drawSvgCircle(cx, cy, r, fillColor) { /* ... */ }
        function checkChildrenEffects(nodeData) { let hp=false, hn=false; if(nodeData.children) nodeData.children.forEach(c => { if(c.type==='positive-effect') hp=true; if(c.type==='negative-effect') hn=true; }); return {hasPositiveChild:hp, hasNegativeChild:hn}; }
        function toggleNonChangeable(nodeId) { if(isFinalizedView) return; const n=findNodeById(rcaData,nodeId); if(n&&n.type==='cause'){n.isNonChangeable=!n.isNonChangeable; renderRcaDiagram();renderCauseEffectTable();} }
        function createActionButton(text, className, onClickHandler) { const b=document.createElement('button');b.classList.add('action-button',...className.split(' '));b.textContent=text;b.addEventListener('click',onClickHandler);return b; }
        function promptAddNode(parentId, parentNodeContentDiv, nodeTypeToAdd, placeholderText) { if(isFinalizedView)return; const iC=parentNodeContentDiv.querySelector('.input-group-container');if(!iC)return;iC.innerHTML=''; const iG=document.createElement('div');iG.classList.add('input-group'); const nI=document.createElement('input');nI.type='text';nI.placeholder=placeholderText;nI.classList.add('input-field'); const sB=document.createElement('button');sB.textContent='儲存';sB.classList.add('action-button','save-button','w-full','mt-2'); sB.onclick=()=>{const nT=nI.value.trim();if(nT){addNodeToData(parentId,nT,nodeTypeToAdd);}else{alert('描述不能為空！');}}; nI.addEventListener('keypress',(e)=>{if(e.key==='Enter')sB.click();}); iG.appendChild(nI);iG.appendChild(sB);iC.appendChild(iG);nI.focus(); }
        function addNodeToData(parentId, nodeText, nodeType) { const pN=findNodeById(rcaData,parentId); if(pN){const nN=createNode(nodeText,nodeType,parentId);pN.children.push(nN);renderRcaDiagram();renderCauseEffectTable();}}
        function removeNode(nodeIdToRemove) { if(isFinalizedView)return; if(rcaData&&rcaData.id===nodeIdToRemove){alert('不能移除主要問題根源節點！');return;} function fR(n,idR){if(!n)return null;n.children=n.children.map(c=>fR(c,idR)).filter(c=>c!==null); function rASF(cN){if(!cN)return;if(cN.andSourceNodeIds&&cN.andSourceNodeIds.includes(idR)){cN.andSourceNodeIds=cN.andSourceNodeIds.filter(sId=>sId!==idR);}if(cN.children){cN.children.forEach(rASF);}}if(rcaData)rASF(rcaData); return(n.id===idR)?null:n;} rcaData=fR(rcaData,nodeIdToRemove); if(!rcaData){problemInputArea.style.display='flex';diagramTitle.style.display='none';toolButtonsContainer.style.display='none';causeEffectTableSection.style.display='none';} renderRcaDiagram();renderCauseEffectTable(); }
        function findNodeById(node, id) { if(!node)return null;if(node.id===id)return node;if(node.children){for(const c of node.children){const f=findNodeById(c,id);if(f)return f;}}return null;}
        function handleToggleCauseEffectTable() { const iH=causeEffectTableSection.style.display==='none';causeEffectTableSection.style.display=iH?'block':'none';toggleTableButton.textContent=iH?'隱藏原因效果表':'顯示原因效果表';if(iH)renderCauseEffectTable(); }
        function getCauseEffectTableData() { const tRD=[]; function cDR(n){if(!n)return;if(n.type==='cause'){const{hasPositiveChild:hP,hasNegativeChild:hN}=checkChildrenEffects(n);let cT='';if(n.isNonChangeable)cT='NC';else if(hP&&hN)cT='N+P';else if(hN)cT='N';else if(hP)cT='P';else cT='N'; if(cT!=='P'){const pE=n.children.filter(c=>c.type==='positive-effect').map(c=>c.text).join('; ')||'一 (無)';const nE=n.children.filter(c=>c.type==='negative-effect').map(c=>c.text).join('; ')||'一 (無)';tRD.push({cause:n.text,type:cT,positive:pE,negative:nE});}}if(n.children)n.children.forEach(cDR);}if(rcaData)cDR(rcaData);return tRD;}
        function renderCauseEffectTable() { if(!rcaData){causeEffectTableBody.innerHTML='<tr><td colspan="4" class="text-center text-gray-500">請先設定主要負面效果並建立分析圖。</td></tr>';return;}const tD=getCauseEffectTableData();causeEffectTableBody.innerHTML='';if(tD.length===0){causeEffectTableBody.innerHTML='<tr><td colspan="4" class="text-center text-gray-500">目前圖表中無符合條件的原因可顯示於表格。</td></tr>';return;}tD.forEach(rD=>{const r=causeEffectTableBody.insertRow();r.insertCell().textContent=rD.cause;r.insertCell().textContent=rD.type;r.insertCell().textContent=rD.positive;r.insertCell().textContent=rD.negative;});}
        function exportDiagramAsPNG() { const dRA=document.getElementById('diagram-render-area');if(!dRA||diagramContainer.children.length===0){alert('圖表為空或找不到圖表元素！');return;} const aIGN=diagramContainer.querySelectorAll('.input-group-container .input-group');aIGN.forEach(g=>g.style.display='none'); svgLayer.setAttribute('width',diagramContainer.scrollWidth);svgLayer.setAttribute('height',diagramContainer.scrollHeight);svgLayer.setAttribute('viewBox',`0 0 ${diagramContainer.scrollWidth} ${diagramContainer.scrollHeight}`); html2canvas(dRA,{scale:1.5,useCORS:true,backgroundColor:'#ffffff',logging:true,onclone:(cD)=>{const cS=cD.getElementById('svg-connector-layer');const cDgm=cD.getElementById('rca-diagram-container');if(cS&&cDgm){cS.setAttribute('width',cDgm.scrollWidth);cS.setAttribute('height',cDgm.scrollHeight);cS.setAttribute('viewBox',`0 0 ${cDgm.scrollWidth} ${cDgm.scrollHeight}`);}if(isFinalizedView){const cADs=cD.querySelectorAll('.rca-node-actions');cADs.forEach(d=>d.style.display='none');const cICs=cD.querySelectorAll('.input-group-container');cICs.forEach(d=>d.style.display='none');}}}).then(c=>{aIGN.forEach(g=>g.style.display='flex');const i=c.toDataURL('image/png');const l=document.createElement('a');l.download='rca-plus-diagram.png';l.href=i;l.click();}).catch(e=>{console.error('匯出圖表失敗:',e);alert('匯出圖表失敗，請檢查控制台錯誤訊息。');aIGN.forEach(g=>g.style.display='flex');});}

        initialize();
    </script>
</body>
</html>

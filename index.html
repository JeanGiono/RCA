<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>台北市旅館體驗地圖</title>

    <!-- LeafletJS CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
     integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
     crossorigin=""/>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- LeafletJS JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
     integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
     crossorigin=""></script>

    <style>
        /* Base styles */
        body { font-family: 'Inter', 'Noto Sans TC', sans-serif; }
        #map { 
            height: calc(100vh - 140px);
            width: 100%;
            cursor: default;
            position: relative;
        }
        #map.crosshair-cursor { cursor: crosshair !important; }

        /* Add-mode Banner */
        #add-mode-banner {
            display: none; /* Initially hidden */
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            background-color: rgba(0, 0, 0, 0.75);
            color: white;
            padding: 8px 16px;
            border-radius: 9999px;
            font-size: 14px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        /* Popup styles */
        .leaflet-popup-content-wrapper { border-radius: 8px; padding: 0; overflow: hidden; }
        .leaflet-popup-content { margin: 0; font-size: 14px; line-height: 1.6; width: 280px !important; }
        .hotel-popup .popup-image { width: 100%; height: 140px; object-fit: cover; }
        .hotel-popup .popup-content-container { padding: 12px; }
        .hotel-popup .header { display: flex; justify-content: space-between; align-items: flex-start; }
        .hotel-popup h3 { font-size: 1.1rem; font-weight: bold; margin-bottom: 0.5rem; color: #1a202c; }
        .hotel-popup .category-badge { font-size: 11px; font-weight: 600; padding: 2px 8px; border-radius: 9999px; color: white; white-space: nowrap; }
        .hotel-popup .experience { color: #4a5568; margin-top: 8px; margin-bottom: 12px; padding-bottom: 12px; border-bottom: 1px solid #e5e7eb; word-break: break-word; }
        .hotel-popup .ratings-grid { display: grid; grid-template-columns: auto 1fr; gap: 6px 8px; align-items: center; font-size: 13px; }
        .hotel-popup .rating-label { color: #6b7280; display: flex; align-items: center; gap: 6px; }
        .hotel-popup .rating-label svg { width: 14px; height: 14px; stroke: #9ca3af; }
        .hotel-popup .rating-stars { color: #f59e0b; letter-spacing: 2px; }
        .hotel-popup .rating-overall .rating-label, .hotel-popup .rating-overall .rating-stars { font-weight: bold; font-size: 15px; }
        .hotel-popup .rating-overall .rating-label svg { stroke: #6b7280; }
        .hotel-popup .popup-actions { margin-top: 12px; border-top: 1px solid #e5e7eb; padding-top: 8px; display: flex; justify-content: flex-end; gap: 8px; flex-wrap: wrap; }
        .hotel-popup .popup-actions button, .hotel-popup .popup-actions a { display: inline-flex; align-items: center; gap: 4px; background: none; border: none; cursor: pointer; font-size: 12px; padding: 4px 8px; border-radius: 4px; transition: background-color 0.2s; text-decoration: none; }
        .hotel-popup .popup-actions .share-btn { color: #16a34a; }
        .hotel-popup .popup-actions .share-btn:hover { background-color: #dcfce7; }
        .hotel-popup .popup-actions .map-btn { color: #0284c7; }
        .hotel-popup .popup-actions .map-btn:hover { background-color: #e0f2fe; }
        .hotel-popup .popup-actions .edit-btn { color: #3b82f6; }
        .hotel-popup .popup-actions .edit-btn:hover { background-color: #dbeafe; }
        .hotel-popup .popup-actions .delete-btn { color: #ef4444; }
        .hotel-popup .popup-actions .delete-btn:hover { background-color: #fee2e2; }

        /* Star rating input styles */
        .rating-input-group { margin-bottom: 1rem; }
        .rating-input-group > label { display: flex; align-items: center; gap: 6px; }
        .rating-input-group > label svg { width: 16px; height: 16px; stroke: #6b7280; }
        .rating-input { display: flex; flex-direction: row-reverse; justify-content: flex-end; }
        .rating-input input { display: none; }
        .rating-input label { color: #d1d5db; font-size: 2rem; cursor: pointer; transition: color 0.2s; }
        .rating-input input:checked ~ label,
        .rating-input label:hover,
        .rating-input label:hover ~ label { color: #f59e0b; }
    </style>
</head>
<body class="bg-gray-100 font-sans">

    <header class="bg-white shadow-md w-full p-4 h-[80px] flex items-center justify-center">
        <h1 class="text-2xl font-bold text-gray-800">台北市旅館體驗地圖</h1>
    </header>

    <div class="bg-gray-50 p-4 h-[60px] flex items-center justify-center flex-wrap gap-4 shadow-inner">
        <input type="search" id="search-box" placeholder="搜尋旅館名稱..." class="px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 flex-grow sm:flex-grow-0 sm:w-1/4">
        <select id="rating-filter" class="px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
            <option value="0">顯示全部評分</option>
            <option value="4">4星以上</option>
            <option value="3">3星以上</option>
        </select>
        <select id="category-filter" class="px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
            <!-- Categories will be populated by JS -->
        </select>
        <button id="add-hotel-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-300">
            新增評價
        </button>
    </div>

    <main class="w-full relative">
        <div id="map" class="z-0">
            <div id="add-mode-banner">請在地圖上選擇位置以新增評價</div>
        </div>
    </main>

    <!-- Modal Form (for Add/Edit) -->
    <div id="form-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 flex items-center justify-center">
        <div class="bg-white p-8 rounded-lg shadow-xl w-11/12 md:w-1/2 lg:w-1/3 max-h-[90vh] overflow-y-auto">
            <h2 id="form-title" class="text-xl font-bold mb-6">新增旅館評價</h2>
            <form id="hotel-form">
                <input type="hidden" id="hotel-id" name="hotel-id">
                <div class="mb-4">
                    <label for="hotel-name" class="block text-gray-700 text-sm font-bold mb-2">旅館名稱</label>
                    <input type="text" id="hotel-name" name="hotel-name" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                </div>
                 <div class="mb-4">
                    <label for="hotel-image-url" class="block text-gray-700 text-sm font-bold mb-2">圖片網址</label>
                    <input type="url" id="hotel-image-url" name="hotel-image-url" placeholder="https://example.com/image.jpg" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                </div>
                <div class="mb-4">
                    <label for="hotel-category" class="block text-gray-700 text-sm font-bold mb-2">旅館分類</label>
                    <select id="hotel-category" name="hotel-category" class="shadow border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                        <!-- Categories will be populated by JS -->
                    </select>
                </div>
                <div class="mb-4">
                    <label for="hotel-experience" class="block text-gray-700 text-sm font-bold mb-2">體驗心得</label>
                    <textarea id="hotel-experience" name="hotel-experience" rows="3" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required></textarea>
                </div>
                
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-6" id="ratings-container">
                    <!-- Rating Inputs are generated by JS -->
                </div>

                <div class="flex items-center justify-end gap-4 mt-4">
                    <button id="cancel-btn" type="button" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg transition-colors">取消</button>
                    <button type="submit" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg transition-colors">儲存</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Custom Confirm Modal -->
    <div id="confirm-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-[60] flex items-center justify-center">
        <div class="bg-white p-6 rounded-lg shadow-xl w-11/12 sm:w-1/3 text-center">
            <h3 class="text-lg font-bold mb-4">確認刪除</h3>
            <p class="text-gray-600 mb-6">您確定要刪除這筆評價嗎？此操作無法復原。</p>
            <div class="flex justify-center gap-4">
                <button id="confirm-cancel-btn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-6 rounded-lg">取消</button>
                <button id="confirm-ok-btn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-6 rounded-lg">確定</button>
            </div>
        </div>
    </div>

    <script>
        // --- DOM Elements ---
        const mapElement = document.getElementById('map');
        const addHotelBtn = document.getElementById('add-hotel-btn');
        const searchBox = document.getElementById('search-box');
        const ratingFilter = document.getElementById('rating-filter');
        const categoryFilter = document.getElementById('category-filter');
        const addModeBanner = document.getElementById('add-mode-banner');
        // Modals & Forms
        const formModal = document.getElementById('form-modal');
        const hotelForm = document.getElementById('hotel-form');
        const cancelBtn = document.getElementById('cancel-btn');
        const formTitle = document.getElementById('form-title');
        const hotelIdInput = document.getElementById('hotel-id');
        const ratingsContainer = document.getElementById('ratings-container');
        const hotelCategorySelect = document.getElementById('hotel-category');
        const confirmModal = document.getElementById('confirm-modal');
        const confirmOkBtn = document.getElementById('confirm-ok-btn');
        const confirmCancelBtn = document.getElementById('confirm-cancel-btn');


        // --- State Management & Constants ---
        let newHotelCoords = null;
        let hotels = [];
        let confirmCallback = null;
        let isAddMode = false;
        const LOCAL_STORAGE_KEY = 'taipeiHotels';
        const RATING_CATEGORIES = [
            { id: 'overall', name: '總體評分', icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"></path></svg>' }, 
            { id: 'bathroom', name: '浴室', icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 6 6 9H4a2 2 0 0 0-2 2v4a2 2 0 0 0 2 2h2l3 3"/><path d="M18 10h1a2 2 0 0 1 2 2v2a2 2 0 0 1-2 2h-1"/><path d="m22 12-4-4-4 4"/><path d="M2 12h11"/></svg>' },
            { id: 'bed', name: '床鋪', icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 4v16a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V4"/><path d="M12 4v10"/><path d="M2 10h20"/></svg>' }, 
            { id: 'facilities', name: '設施', icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 22v-4a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2v4"/><path d="M18 22V8a2 2 0 0 0-2-2H8a2 2 0 0 0-2 2v14"/><path d="M18 6V4a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v2"/></svg>' },
            { id: 'amenities', name: '備品', icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m13.4 2.6 3.4 3.4"/><path d="M18 11.5 21 8.5"/><path d="m2 22 5.5-1.5L20.5 7.5l-3-3L4.5 17.5 2 22"/><path d="m18 11.5-1.5-1.5"/></svg>' },
        ];
        const HOTEL_CATEGORIES = {
            "商務旅行": "bg-blue-500", "家庭親子": "bg-green-500",
            "溫泉度假": "bg-yellow-500", "設計旅店": "bg-purple-500",
            "豪華享受": "bg-red-500", "情侶專用": "bg-pink-500"
        };

        // --- Initial Data (fallback) ---
        const initialHotels = [
            { id: 1, name: "台北W飯店", imageUrl: "https://placehold.co/600x400/7c3aed/ffffff?text=W+Hotel", category: "豪華享受", lat: 25.0407, lng: 121.5646, rating_overall: 5, rating_bathroom: 5, rating_bed: 4, rating_facilities: 5, rating_amenities: 5, experience: "信義區的奢華指標，頂樓泳池酒吧視野絕佳，充滿時尚與活力。" },
            { id: 2, name: "誠品行旅", imageUrl: "https://placehold.co/600x400/16a34a/ffffff?text=Eslite+Hotel", category: "設計旅店", lat: 25.0426, lng: 121.5559, rating_overall: 4.5, rating_bathroom: 4, rating_bed: 5, rating_facilities: 4, rating_amenities: 5, experience: "坐落於松山文創園區，充滿書香與藝術氣息，適合文青深度旅遊。" },
            { id: 3, name: "君品酒店", imageUrl: "https://placehold.co/600x400/1d4ed8/ffffff?text=Palais+de+Chine", category: "商務旅行", lat: 25.0479, lng: 121.5174, rating_overall: 4.8, rating_bathroom: 5, rating_bed: 5, rating_facilities: 4, rating_amenities: 4, experience: "緊鄰台北車站，交通極度便利，以歐洲古堡為設計風格。" },
            { id: 4, name: "北投麗禧溫泉酒店", imageUrl: "https://placehold.co/600x400/f59e0b/ffffff?text=Grand+View", category: "溫泉度假", lat: 25.1378, lng: 121.5152, rating_overall: 4.7, rating_bathroom: 5, rating_bed: 4, rating_facilities: 5, rating_amenities: 4, experience: "位於北投制高點，每個房間都有獨立的冷熱溫泉池。" },
            { id: 7, name: "台北沐蘭精品旅館", imageUrl: "https://placehold.co/600x400/ec4899/ffffff?text=Mulan+Motel", category: "情侶專用", lat: 25.0623, lng: 121.5283, rating_overall: 4.4, rating_bathroom: 5, rating_bed: 4, rating_facilities: 4, rating_amenities: 4, experience: "以自然元素打造，房間內有大型浴缸和私人蒸氣室，隱密性高。" },
            { id: 9, name: "薇閣精品旅館 (大直館)", imageUrl: "https://placehold.co/600x400/ec4899/ffffff?text=Wego+Motel", category: "情侶專用", lat: 25.0830, lng: 121.5582, rating_overall: 4.5, rating_bathroom: 5, rating_bed: 5, rating_facilities: 4, rating_amenities: 4, experience: "以多樣化的主題房型聞名，設備豪華，是情侶休息的經典選擇。" },
        ];


        // --- DATA MANAGEMENT ---
        function loadHotels() {
            try {
                const storedHotels = localStorage.getItem(LOCAL_STORAGE_KEY);
                hotels = storedHotels ? JSON.parse(storedHotels) : [...initialHotels];
                if (!storedHotels) saveHotels();
            } catch (e) { console.error("無法讀取本地儲存資料:", e); hotels = [...initialHotels]; }
        }
        function saveHotels() {
            try { localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(hotels)); } 
            catch (e) { console.error("無法儲存資料至本地:", e); }
        }


        // --- MAP & UI RENDERING ---
        const map = L.map('map').setView([25.0479, 121.5319], 13);
        const markersLayer = L.layerGroup().addTo(map);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: '© <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>' }).addTo(map);

        function renderMarkers(hotelsToRender) {
            markersLayer.clearLayers();
            hotelsToRender.forEach(hotel => addHotelMarker(hotel));
        }
        
        function applyFilters() {
            const searchTerm = searchBox.value.toLowerCase();
            const minRating = parseFloat(ratingFilter.value);
            const selectedCategory = categoryFilter.value;
            
            const filteredHotels = hotels.filter(hotel => {
                const nameMatch = hotel.name.toLowerCase().includes(searchTerm);
                const ratingMatch = hotel.rating_overall >= minRating;
                const categoryMatch = selectedCategory === "all" || hotel.category === selectedCategory;
                return nameMatch && ratingMatch && categoryMatch;
            });
            renderMarkers(filteredHotels);
        }

        function createHotelIcon(rating) {
            let iconUrl;
            if (rating >= 4.8) iconUrl = 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-gold.png';
            else if (rating >= 4.5) iconUrl = 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png';
            else iconUrl = 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png';
            return new L.Icon({ iconUrl, shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png', iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41] });
        }
        
        function generateStarDisplay(rating) {
            const r = Math.round(rating);
            return '★'.repeat(r) + '☆'.repeat(5 - r);
        }

        function addHotelMarker(hotel) {
            const marker = L.marker([hotel.lat, hotel.lng], { icon: createHotelIcon(hotel.rating_overall) }).addTo(markersLayer);
            
            const ratingsHtml = RATING_CATEGORIES.map(cat => {
                const rating = hotel[`rating_${cat.id}`];
                const isOverall = cat.id === 'overall';
                return `<div class="${isOverall ? 'rating-overall' : ''} col-span-2 grid grid-cols-2 items-center">
                            <span class="rating-label">${cat.icon}<span>${cat.name}</span></span>
                            <span class="rating-stars" title="${rating} / 5">${generateStarDisplay(rating)}</span>
                        </div>`;
            }).join('');
            
            const categoryColor = HOTEL_CATEGORIES[hotel.category] || 'bg-gray-400';
            const googleMapsUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(hotel.name)}`;

            const popupContent = `
                <div class="hotel-popup">
                    <img src="${hotel.imageUrl || 'https://placehold.co/600x400/cccccc/ffffff?text=無圖片'}" alt="${hotel.name}" class="popup-image" onerror="this.onerror=null;this.src='https://placehold.co/600x400/cccccc/ffffff?text=圖片載入失敗';">
                    <div class="popup-content-container">
                        <div class="header">
                            <h3>${hotel.name}</h3>
                            <span class="category-badge ${categoryColor}">${hotel.category}</span>
                        </div>
                        <p class="experience">${hotel.experience}</p>
                        <div class="ratings-grid">${ratingsHtml}</div>
                        <div class="popup-actions">
                            <button class="share-btn" data-id="${hotel.id}"><span>分享</span></button>
                            <a href="${googleMapsUrl}" target="_blank" rel="noopener noreferrer" class="map-btn"><span>Google搜尋</span></a>
                            <button class="edit-btn" data-id="${hotel.id}">編輯</button>
                            <button class="delete-btn" data-id="${hotel.id}">刪除</button>
                        </div>
                    </div>
                </div>`;
            marker.bindPopup(popupContent);
        }
        
        // --- FORM & MODAL LOGIC ---
        function openFormModal(hotelToEdit = null) {
            hotelForm.reset();
            if (hotelToEdit) {
                formTitle.textContent = '編輯旅館評價';
                hotelIdInput.value = hotelToEdit.id;
                document.getElementById('hotel-name').value = hotelToEdit.name;
                document.getElementById('hotel-image-url').value = hotelToEdit.imageUrl || '';
                document.getElementById('hotel-category').value = hotelToEdit.category;
                document.getElementById('hotel-experience').value = hotelToEdit.experience;
                RATING_CATEGORIES.forEach(cat => {
                    const ratingValue = hotelToEdit[`rating_${cat.id}`];
                    if (ratingValue) {
                        const radio = document.querySelector(`input[name="rating_${cat.id}"][value="${ratingValue}"]`);
                        if (radio) radio.checked = true;
                    }
                });
            } else {
                formTitle.textContent = '新增旅館評價';
                hotelIdInput.value = '';
            }
            formModal.classList.remove('hidden');
        }

        function showConfirmModal(callback) {
            confirmCallback = callback;
            confirmModal.classList.remove('hidden');
        }
        
        function hideConfirmModal() {
            confirmCallback = null;
            confirmModal.classList.add('hidden');
        }
        
        function enterAddMode() {
            isAddMode = true;
            addModeBanner.style.display = 'block';
            addHotelBtn.textContent = '取消新增';
            addHotelBtn.classList.replace('bg-blue-500', 'bg-red-500');
            addHotelBtn.classList.replace('hover:bg-blue-600', 'hover:bg-red-600');
            mapElement.classList.add('crosshair-cursor');
            map.once('click', handleMapClickForAdd);
        }

        function exitAddMode() {
            isAddMode = false;
            map.off('click', handleMapClickForAdd);
            addModeBanner.style.display = 'none';
            addHotelBtn.textContent = '新增評價';
            addHotelBtn.classList.replace('bg-red-500', 'bg-blue-500');
            addHotelBtn.classList.replace('hover:bg-red-600', 'hover:bg-blue-600');
            mapElement.classList.remove('crosshair-cursor');
        }
        
        // --- EVENT HANDLERS ---
        function handleAddButtonClick() {
            if (isAddMode) {
                exitAddMode();
            } else {
                enterAddMode();
            }
        }

        function handleMapClickForAdd(e) {
            newHotelCoords = e.latlng;
            openFormModal();
            exitAddMode(); // Exit add mode after opening form
        }
        
        function handleFormSubmit(e) {
            e.preventDefault();
            const formData = new FormData(hotelForm);
            const hotelId = formData.get('hotel-id');
            const hotelData = {
                name: formData.get('hotel-name'),
                imageUrl: formData.get('hotel-image-url'),
                category: formData.get('hotel-category'),
                experience: formData.get('hotel-experience')
            };
            RATING_CATEGORIES.forEach(cat => { hotelData[`rating_${cat.id}`] = parseFloat(formData.get(`rating_${cat.id}`)); });

            if (hotelId) {
                const hotelIndex = hotels.findIndex(h => h.id == hotelId);
                if (hotelIndex !== -1) hotels[hotelIndex] = { ...hotels[hotelIndex], ...hotelData };
            } else {
                hotelData.id = Date.now();
                hotelData.lat = newHotelCoords.lat;
                hotelData.lng = newHotelCoords.lng;
                hotels.push(hotelData);
            }
            saveHotels();
            applyFilters();
            formModal.classList.add('hidden');
        }
        
        function handleShareClick(hotelId, shareButton) {
            const hotel = hotels.find(h => h.id == hotelId);
            if (!hotel) return;
            const shareText = `推薦一間旅館給你！\n\n旅館名稱：${hotel.name}\n總體評分：${generateStarDisplay(hotel.rating_overall)}\n我的心得：${hotel.experience}`;
            const textarea = document.createElement('textarea');
            textarea.value = shareText;
            textarea.style.position = 'absolute';
            textarea.style.left = '-9999px';
            document.body.appendChild(textarea);
            textarea.select();
            try {
                document.execCommand('copy');
                const originalText = shareButton.querySelector('span').textContent;
                shareButton.querySelector('span').textContent = '已複製！';
                setTimeout(() => { shareButton.querySelector('span').textContent = originalText; }, 2000);
            } catch (err) { console.error('無法複製文字: ', err); }
            document.body.removeChild(textarea);
        }
        
        function handleDeleteClick(hotelId) {
            showConfirmModal(() => {
                hotels = hotels.filter(h => h.id != hotelId);
                saveHotels();
                applyFilters();
                map.closePopup();
                hideConfirmModal();
            });
        }
        
        function handleEditClick(hotelId) {
            const hotel = hotels.find(h => h.id == hotelId);
            if(hotel) openFormModal(hotel);
        }

        // --- DYNAMIC CONTENT & EVENT LISTENERS SETUP ---
        function initialize() {
            // Populate category dropdowns
            const categoryOptions = ['<option value="all">顯示全部分類</option>', ...Object.keys(HOTEL_CATEGORIES).map(cat => `<option value="${cat}">${cat}</option>`)].join('');
            categoryFilter.innerHTML = categoryOptions;
            
            const formCategoryOptions = Object.keys(HOTEL_CATEGORIES).map(cat => `<option value="${cat}">${cat}</option>`).join('');
            hotelCategorySelect.innerHTML = `<option value="" disabled selected>請選擇分類</option>${formCategoryOptions}`;
        
            // Generate rating inputs dynamically
            ratingsContainer.innerHTML = RATING_CATEGORIES.map(cat => `<div class="rating-input-group"><label class="block text-gray-700 text-sm font-bold mb-2">${cat.icon} ${cat.name}</label><div class="rating-input">${[5,4,3,2,1].map(num => `<input type="radio" id="star-${cat.id}-${num}" name="rating_${cat.id}" value="${num}" required><label for="star-${cat.id}-${num}">★</label>`).join('')}</div></div>`).join('');
        
            // Main event listeners
            addHotelBtn.addEventListener('click', handleAddButtonClick);
            hotelForm.addEventListener('submit', handleFormSubmit);
            cancelBtn.addEventListener('click', () => formModal.classList.add('hidden'));
            searchBox.addEventListener('input', applyFilters);
            ratingFilter.addEventListener('change', applyFilters);
            categoryFilter.addEventListener('change', applyFilters);
            
            confirmOkBtn.addEventListener('click', () => { if(typeof confirmCallback === 'function') confirmCallback(); });
            confirmCancelBtn.addEventListener('click', hideConfirmModal);
            
            // Event delegation for popup buttons
            map.on('popupopen', (e) => {
                const popupNode = e.popup.getElement();
                popupNode.querySelector('.edit-btn')?.addEventListener('click', (ev) => handleEditClick(ev.target.dataset.id));
                popupNode.querySelector('.delete-btn')?.addEventListener('click', (ev) => handleDeleteClick(ev.target.dataset.id));
                popupNode.querySelector('.share-btn')?.addEventListener('click', (ev) => handleShareClick(ev.currentTarget.dataset.id, ev.currentTarget));
            });

            loadHotels();
            applyFilters();
        }
        
        initialize();

    </script>
</body>
</html>

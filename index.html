<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RCA+ 矛盾分析繪圖工具 (功能增強)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* Tailwind gray-100 */
        }
        #diagram-render-area { 
            position: relative; 
            overflow: auto; 
            padding: 20px; 
            background-color: #fff; 
            border-radius: 0.5rem; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            min-height: 450px; 
            width: 100%; 
        }
        #svg-connector-layer {
            position: absolute; 
            top: 0; 
            left: 0; 
            pointer-events: none; 
            z-index: 0;
        }
        #rca-diagram-container {
            display: inline-block; 
            padding: 20px; 
            min-width: 100%; 
            text-align: center; 
        }
        .rca-node-wrapper {
            display: inline-flex; 
            flex-direction: column; 
            align-items: center; 
            margin: 0 1rem; 
            vertical-align: top; 
        }
        .rca-node {
            border: 2px solid #4b5563; 
            padding: 0.6rem 1.1rem; 
            margin-top: 30px; 
            margin-bottom: 15px; 
            box-shadow: 0 2px 4px 0 rgba(0, 0, 0, 0.1);
            display: flex; 
            flex-direction: column; 
            align-items: flex-start; 
            min-width: 180px; 
            max-width: 350px; 
            text-align: left; 
            border-radius: 0.375rem; 
            position: relative; 
            z-index: 1; 
            background-color: #ffffff; 
            word-wrap: break-word; 
        }
        .rca-node-content { display: flex; flex-direction: column; gap: 0.4rem; width: 100%; }
        .rca-node-header { display: flex; align-items: center; gap: 0.4rem; width: 100%; position: relative;}
        .rca-node-icon { 
            font-weight: bold; font-size: 0.85em; 
            padding: 0.2em 0.4em; border-radius: 50%; 
            color: white;
            position: absolute; 
            top: -12px; 
            right: -12px; 
            min-width: 22px; 
            height: 22px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid white; 
            box-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }
        .nc-badge { 
            font-size: 0.65em; font-weight: bold; color: #374151; 
            background-color: #e5e7eb; padding: 0.15rem 0.35rem; 
            border-radius: 0.25rem; margin-left: 0.5rem; 
            align-self: center; 
        }
        .rca-node-text { 
            font-weight: 500; 
            font-size: 0.9rem; 
            flex-grow: 1; 
        }
        .selected-items-list { 
            font-size: 0.75rem; 
            color: #374151; 
            margin-top: 0.5rem; 
            padding-top: 0.375rem; 
            border-top: 1px dashed #d1d5db; 
            width: 100%;
        }
        .selected-items-list strong { 
            color: #111827; 
            display: block; 
            margin-bottom: 0.25rem; 
        }
        .selected-items-list ul { 
            list-style-type: disc; 
            margin-left: 1.25rem; 
            padding-left: 0.25rem; 
        } 
        .selected-items-list li { 
            margin-bottom: 0.25rem; 
        }
        .selected-items-list .solution-text { color: #059669; margin-left: 0.3rem; font-style: italic;}

        .rca-node-initial-problem { background-color: #fee2e2; border-color: #ef4444; }
        .rca-node-initial-problem .rca-node-icon { background-color: #ef4444; }
        .rca-node-cause { background-color: #fef9c3; border-color: #f59e0b; }
        .rca-node-cause .rca-node-icon.contradictory { background-color: #8b5cf6; }
        .rca-node-positive-effect { background-color: #dbeafe; border-color: #3b82f6; border-radius: 50px; padding: 0.6rem 1.2rem; min-width: 120px; }
        .rca-node-positive-effect .rca-node-header { justify-content: center; }
        .rca-node-positive-effect .rca-node-icon { background-color: #2563eb; }
        .rca-node-negative-effect { background-color: #ffedd5; border-color: #f97316; border-radius: 50px; padding: 0.6rem 1.2rem; min-width: 120px; }
        .rca-node-negative-effect .rca-node-header { justify-content: center; }
        .rca-node-negative-effect .rca-node-icon { background-color: #f97316; }

        .rca-children-container { 
            display: flex; 
            flex-direction: row; 
            justify-content: center; 
            align-items: flex-start; 
            margin-top: 15px; 
            position: relative; 
            padding-top: 25px; 
            width: max-content; 
        }
        
        .rca-node-actions { display: flex; flex-wrap: wrap; gap: 0.25rem; margin-top: 0.5rem; border-top: 1px solid #e5e7eb; padding-top: 0.5rem; }
        .action-button { background-color: #6b7280; color: white; padding: 0.375rem 0.75rem; border-radius: 0.25rem; font-size: 0.75rem; border: none; cursor: pointer; transition: background-color 0.2s; }
        .action-button:hover:not(:disabled) { background-color: #4b5563; }
        .action-button:disabled { background-color: #9ca3af; cursor: not-allowed; }
        .action-button.add-cause { background-color: #3b82f6; } .action-button.add-cause:hover:not(:disabled) { background-color: #2563eb; }
        .action-button.add-positive { background-color: #10b981; } .action-button.add-positive:hover:not(:disabled) { background-color: #059669; }
        .action-button.add-negative { background-color: #f97316; } .action-button.add-negative:hover:not(:disabled) { background-color: #ea580c; }
        .action-button.toggle-nc { background-color: #a855f7; } .action-button.toggle-nc:hover:not(:disabled) { background-color: #9333ea; }
        .action-button.set-and-sources { background-color: #6d28d9; } .action-button.set-and-sources:hover:not(:disabled) { background-color: #5b21b6; }
        .action-button.edit-node { background-color: #f59e0b; } .action-button.edit-node:hover:not(:disabled) { background-color: #d97706; }
        .action-button.set-parameters { background-color: #0ea5e9; } .action-button.set-parameters:hover:not(:disabled) { background-color: #0284c7; }
        .action-button.set-principles { background-color: #ec4899; } .action-button.set-principles:hover:not(:disabled) { background-color: #db2777; }
        .action-button.finalize-diagram { background-color: #059669; } 
        .action-button.finalize-diagram:hover:not(:disabled) { background-color: #047857; }
        .action-button.edit-diagram { background-color: #d97706; } 
        .action-button.edit-diagram:hover:not(:disabled) { background-color: #b45309; }
        .remove-button { background-color: #ef4444; } .remove-button:hover:not(:disabled) { background-color: #dc2626; }
        
        .input-group-container { margin-top: 0.5rem; }
        .input-group { display: flex; flex-direction: column; gap: 0.5rem; padding: 0.5rem; border: 1px solid #e5e7eb; border-radius: 0.25rem; background-color: #f9fafb; }
        .input-field { border: 1px solid #d1d5db; padding: 0.5rem; border-radius: 0.25rem; font-size: 0.875rem; width: 100%; }
        .save-button { background-color: #065f46; color: white; } .save-button:hover:not(:disabled) { background-color: #047857; }
        .save-edit-button { background-color: #065f46; color: white; } .save-edit-button:hover:not(:disabled) { background-color: #047857; }

        .data-table-section { margin-top: 2rem; }
        .data-table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
        .data-table th, .data-table td { 
            border: 1px solid #d1d5db; padding: 0.5rem; 
            font-size: 0.875rem;
            text-align: center; 
            vertical-align: middle; 
        }
        .data-table th { 
            background-color: #e5e7eb; font-weight: 600; 
        }
        .data-table td { 
            background-color: white; 
        }
        .data-table td:first-child, .data-table th:first-child {
             text-align: left;
        }

        .modal { z-index: 50; }
        .modal-content { position: relative; } 
        .modal-close-button {
            position: absolute; top: 0.75rem; right: 0.75rem;
            background: none; border: none; font-size: 1.5rem;
            color: #6b7280; cursor: pointer; line-height: 1;
        }
        .modal-close-button:hover { color: #1f2937; }
        .modal-options-container label { cursor: pointer; }
        .modal-options-container h4 { font-weight:600; margin-top: 0.75rem; margin-bottom: 0.25rem; color: #374151; border-bottom: 1px solid #e5e7eb; padding-bottom: 0.25rem; }
        .modal-options-container h4:first-child { margin-top: 0; }
        .principle-solution-input {
            width: calc(100% - 2rem); margin-left: 1.5rem; margin-top: 0.25rem; margin-bottom: 0.5rem;
            padding: 0.25rem 0.5rem; border: 1px solid #d1d5db; border-radius: 0.25rem; font-size: 0.8rem;
        }
    </style>
</head>
<body class="p-4 md:p-8">
    <div class="container mx-auto max-w-7xl"> 
        <header class="mb-6 text-center">
            <h1 class="text-2xl md:text-3xl font-bold text-gray-700">RCA+ 矛盾分析繪圖工具 (功能增強)</h1>
            <p class="text-gray-500 mt-1">視覺化根本原因、正面/負面效果，支援「且」關係連接、矛盾點標示、效果參數與發明原理。新增儲存、載入、上一步、下一步功能。</p>
        </header>

        <section id="controls-section" class="mb-6 p-4 bg-white rounded-lg shadow">
             <div id="problem-input-area">
                <h2 class="text-xl font-semibold text-gray-700 mb-3">1. 設定主要負面效果</h2>
                <div class="flex flex-col sm:flex-row gap-2">
                    <input type="text" id="problem-statement-input" placeholder="輸入觀察到的主要負面效果" class="input-field flex-grow p-2 rounded-md border-gray-300 focus:ring-blue-500 focus:border-blue-500">
                    <button id="set-problem-button" class="action-button add-cause text-white font-semibold py-2 px-4 rounded-md">設定問題根源</button>
                </div>
            </div>
            <div id="tool-buttons" style="display: none;" class="mt-4 flex flex-wrap gap-2 justify-center">
                <button id="save-diagram-button" class="action-button bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-md">儲存進度</button>
                <button id="load-diagram-button" class="action-button bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-md">載入進度</button>
                <button id="undo-button" class="action-button bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-md">上一步</button>
                <button id="redo-button" class="action-button bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-md">下一步</button>
                <button id="finalize-diagram-button" class="action-button finalize-diagram text-white font-semibold py-2 px-4 rounded-md">完成圖表</button>
                <button id="export-diagram-button" class="action-button bg-purple-500 hover:bg-purple-600 text-white font-semibold py-2 px-4 rounded-md">匯出圖表 (PNG)</button>
                <button id="toggle-cause-effect-table-button" class="action-button bg-teal-500 hover:bg-teal-600 text-white font-semibold py-2 px-4 rounded-md">顯示原因效果表</button>
                <button id="toggle-solution-table-button" class="action-button bg-indigo-500 hover:bg-indigo-600 text-white font-semibold py-2 px-4 rounded-md">顯示改善方案表</button>
            </div>
        </section>

        <section id="rca-diagram-section" class="bg-white p-4 md:p-6 rounded-lg shadow min-h-[400px]">
            <h2 class="text-xl font-semibold text-gray-700 mb-4 text-center" id="diagram-title" style="display: none;">2. RCA+ 分析圖</h2>
            <div id="diagram-render-area">
                <div id="rca-diagram-container"></div> 
                <svg id="svg-connector-layer"></svg>
            </div>
        </section>

        <section id="cause-effect-table-section" style="display: none;" class="data-table-section bg-white p-4 md:p-6 rounded-lg shadow">
            <h2 class="text-xl font-semibold text-gray-700 mb-3">3. 原因效果表</h2>
            <table class="data-table">
                <thead> <tr><th>原因</th><th>原因類型</th><th>正面效果</th><th>負面效果</th></tr> </thead>
                <tbody id="cause-effect-table-body"></tbody>
            </table>
        </section>

        <section id="solution-table-section" style="display: none;" class="data-table-section bg-white p-4 md:p-6 rounded-lg shadow">
            <h2 class="text-xl font-semibold text-gray-700 mb-3">4. 矛盾點之創意改善方案表</h2>
            <table class="data-table">
                <thead> <tr><th>矛盾原因</th><th>發明原理</th><th>改善方案</th></tr> </thead>
                <tbody id="solution-table-body"></tbody>
            </table>
        </section>
    </div>

    <div id="and-source-modal" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center" style="display: none;">
        <div class="modal-content mx-auto p-5 border w-11/12 md:w-1/2 lg:w-1/3 shadow-lg rounded-md bg-white">
            <button class="modal-close-button" onclick="document.getElementById('and-source-modal').style.display='none'; currentAndTargetNodeId = null;">&times;</button>
            <div class="mt-3">
                <h3 class="text-lg leading-6 font-medium text-gray-900 text-center" id="and-source-modal-title">為效果設定 AND 輸入源</h3>
                <div class="mt-4 px-2 py-3 max-h-72 overflow-y-auto modal-options-container" id="and-source-options-container"></div>
                <div class="items-center px-4 py-3 mt-4 text-right">
                    <button id="cancel-and-sources-button" class="action-button mr-2 px-4 py-2 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400">取消</button>
                    <button id="save-and-sources-button" class="action-button px-4 py-2 bg-green-500 text-white rounded-md hover:bg-green-700">儲存AND來源</button>
                </div>
            </div>
        </div>
    </div>

    <div id="effect-parameter-modal" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center" style="display: none;">
        <div class="modal-content mx-auto p-5 border w-11/12 md:w-1/2 lg:w-2/5 shadow-lg rounded-md bg-white">
            <button class="modal-close-button" onclick="document.getElementById('effect-parameter-modal').style.display='none'; currentParameterTargetNodeId = null;">&times;</button>
            <div class="mt-3">
                <h3 class="text-lg leading-6 font-medium text-gray-900 text-center" id="effect-parameter-modal-title">設定效果參數</h3>
                <div class="mt-4 px-2 py-3 max-h-96 overflow-y-auto modal-options-container" id="effect-parameter-options-container"></div>
                <div class="items-center px-4 py-3 mt-4 text-right">
                    <button id="cancel-effect-parameters-button" class="action-button mr-2 px-4 py-2 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400">取消</button>
                    <button id="save-effect-parameters-button" class="action-button px-4 py-2 bg-sky-500 text-white rounded-md hover:bg-sky-700">儲存參數</button>
                </div>
            </div>
        </div>
    </div>

    <div id="inventive-principle-modal" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center" style="display: none;">
        <div class="modal-content mx-auto p-5 border w-11/12 md:w-1/2 lg:w-2/5 shadow-lg rounded-md bg-white">
            <button class="modal-close-button" onclick="document.getElementById('inventive-principle-modal').style.display='none'; currentPrincipleTargetNodeId = null;">&times;</button>
            <div class="mt-3">
                <h3 class="text-lg leading-6 font-medium text-gray-900 text-center" id="inventive-principle-modal-title">選擇發明原理與改善方案</h3>
                <div class="mt-4 px-2 py-3 max-h-96 overflow-y-auto modal-options-container" id="inventive-principle-options-container"></div>
                <div class="items-center px-4 py-3 mt-4 text-right">
                    <button id="cancel-inventive-principles-button" class="action-button mr-2 px-4 py-2 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400">取消</button>
                    <button id="save-inventive-principles-button" class="action-button px-4 py-2 bg-pink-500 text-white rounded-md hover:bg-pink-700">儲存原理與方案</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- Helper function for deep copying ---
        function deepCopy(obj) {
            try {
                // For data objects without functions, Date, RegExp, Map, Set, etc.,
                // JSON.parse(JSON.stringify(obj)) is a common and simple way.
                // Be aware of its limitations (e.g., undefined becomes null, functions are removed).
                // For this specific rcaData structure, it should be mostly fine.
                return JSON.parse(JSON.stringify(obj));
            } catch (e) {
                console.error("Deep copy failed:", e);
                // Fallback or more sophisticated deep copy if needed
                return null; 
            }
        }

        // --- 全局變數 ---
        let rcaData = null; 
        let nodeIdCounter = 0;
        let currentAndTargetNodeId = null; 
        let isFinalizedView = false; 
        let currentParameterTargetNodeId = null; 
        let currentPrincipleTargetNodeId = null; 

        // --- History Management for Undo/Redo ---
        let historyStack = []; // Array to store snapshots of rcaData
        let historyIndex = -1; // Pointer to the current state in historyStack
        const MAX_HISTORY_STATES = 50; // Limit the number of history states

        // --- DOM 元素引用 ---
        const problemInput = document.getElementById('problem-statement-input');
        const setProblemButton = document.getElementById('set-problem-button');
        const diagramRenderArea = document.getElementById('diagram-render-area'); 
        const diagramContainer = document.getElementById('rca-diagram-container'); 
        const svgLayer = document.getElementById('svg-connector-layer');
        const diagramTitle = document.getElementById('diagram-title');
        const problemInputArea = document.getElementById('problem-input-area');
        const toolButtonsContainer = document.getElementById('tool-buttons');
        
        // Tool Buttons
        const saveDiagramButton = document.getElementById('save-diagram-button');
        const loadDiagramButton = document.getElementById('load-diagram-button');
        const undoButton = document.getElementById('undo-button');
        const redoButton = document.getElementById('redo-button');
        const finalizeDiagramButton = document.getElementById('finalize-diagram-button'); 
        const exportDiagramButton = document.getElementById('export-diagram-button');
        const toggleCauseEffectTableButton = document.getElementById('toggle-cause-effect-table-button');
        const toggleSolutionTableButton = document.getElementById('toggle-solution-table-button'); 
        
        const causeEffectTableSection = document.getElementById('cause-effect-table-section');
        const causeEffectTableBody = document.getElementById('cause-effect-table-body');
        const solutionTableSection = document.getElementById('solution-table-section'); 
        const solutionTableBody = document.getElementById('solution-table-body'); 
        
        const andSourceModal = document.getElementById('and-source-modal');
        const andSourceOptionsContainer = document.getElementById('and-source-options-container');
        const andSourceModalTitle = document.getElementById('and-source-modal-title');
        const saveAndSourcesButton = document.getElementById('save-and-sources-button');
        const cancelAndSourcesButton = document.getElementById('cancel-and-sources-button');

        const effectParameterModal = document.getElementById('effect-parameter-modal');
        const effectParameterOptionsContainer = document.getElementById('effect-parameter-options-container');
        const effectParameterModalTitle = document.getElementById('effect-parameter-modal-title');
        const saveEffectParametersButton = document.getElementById('save-effect-parameters-button');
        const cancelEffectParametersButton = document.getElementById('cancel-effect-parameters-button');

        const inventivePrincipleModal = document.getElementById('inventive-principle-modal');
        const inventivePrincipleOptionsContainer = document.getElementById('inventive-principle-options-container');
        const inventivePrincipleModalTitle = document.getElementById('inventive-principle-modal-title');
        const saveInventivePrinciplesButton = document.getElementById('save-inventive-principles-button');
        const cancelInventivePrinciplesButton = document.getElementById('cancel-inventive-principles-button');

        // --- 資料列表 (Effect Parameters, Inventive Principles) ---
        const EFFECT_PARAMETERS = {
            "活動": ["活動效用性", "活動可變性", "活動費用", "活動時間", "活動複雜性", "活動方便性", "活動安全性", "活動可靠性"],
            "系統": ["系統有效性", "系統可變性", "系統費用", "系統時間", "系統複雜性", "系統方便性", "系統安全性", "系統可靠性", "對系統的有害影響", "系統產生的有害影響", "組織壓力", "組織穩定性"],
            "其他": ["內部風險", "外部風險", "信息共享", "信息損失", "信息流", "回饋", "物料流", "適應性/多功能性", "顧客壓力", "顧客穩定性", "環境穩定性"]
        };
        const INVENTIVE_PRINCIPLES = [
            "分割", "取出/分離", "改變局部特性", "非對稱性", "合併/整合", "多用性/多功能", "套疊/巢狀結構", 
            "反制行動", "預先反制行動", "預先行動", "事先補償/預防", "消除緊張", "另一方向/反向操作", 
            "非直線姓", "動態化", "稍微少些或多些(的動作)", "另外維度/空間", "共鳴(協調)", "週期行動", 
            "連續的有利作用", "快速行動", "轉有害為有利", "回饋", "中介物/媒介", "自助/自我服務", 
            "使用複製品或模型", "廉價與短期[拋棄式]", "替換系統運作原理/使用其他原理", "流動性和靈活性", 
            "改變邊界條件", "孔洞和網路", "改變外觀/可見度", "同質性", "丟棄與恢復", "改變特性", 
            "模範轉移", "相對變化", "增強的環境", "鈍性(惰性)環境", "組合(複合)結構"
        ];

        // --- 初始化函數 ---
        function initialize() {
            setProblemButton.addEventListener('click', handleSetInitialProblem);
            problemInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') handleSetInitialProblem(); });
            
            // New button listeners
            saveDiagramButton.addEventListener('click', handleSaveToLocalStorage);
            loadDiagramButton.addEventListener('click', handleLoadFromLocalStorage);
            undoButton.addEventListener('click', handleUndo);
            redoButton.addEventListener('click', handleRedo);

            finalizeDiagramButton.addEventListener('click', handleToggleFinalizeView); 
            exportDiagramButton.addEventListener('click', exportDiagramAsPNG);
            toggleCauseEffectTableButton.addEventListener('click', handleToggleCauseEffectTable);
            toggleSolutionTableButton.addEventListener('click', handleToggleSolutionTable); 
            
            saveAndSourcesButton.addEventListener('click', handleSaveAndSources);
            cancelAndSourcesButton.addEventListener('click', () => { andSourceModal.style.display = 'none'; currentAndTargetNodeId = null; });
            
            saveEffectParametersButton.addEventListener('click', handleSaveEffectParameters);
            cancelEffectParametersButton.addEventListener('click', () => { effectParameterModal.style.display = 'none'; currentParameterTargetNodeId = null; });
            
            saveInventivePrinciplesButton.addEventListener('click', handleSaveInventivePrinciples);
            cancelInventivePrinciplesButton.addEventListener('click', () => { inventivePrincipleModal.style.display = 'none'; currentPrincipleTargetNodeId = null; });
            
            new ResizeObserver(drawAllSvgConnectors).observe(diagramRenderArea);
            updateButtonStates(); // Set initial states for undo/redo/load buttons
        }

        // --- History and State Management Functions ---
        function updateButtonStates() {
            undoButton.disabled = historyIndex <= 0;
            redoButton.disabled = historyIndex >= historyStack.length - 1;
            loadDiagramButton.disabled = !localStorage.getItem('rcaDiagramData');
            // Disable save if no data
            saveDiagramButton.disabled = !rcaData;
        }

        function pushStateToHistory(currentState, clearRedoStack = true) {
            if (!currentState) { // Do not push null state if rcaData is null
                console.log("Attempted to push null state to history. Skipped.");
                updateButtonStates(); // Still update buttons as rcaData might be null
                return;
            }
            const stateCopy = deepCopy(currentState);
            if (!stateCopy) {
                console.error("Failed to copy state for history.");
                return;
            }

            if (clearRedoStack) {
                historyStack = historyStack.slice(0, historyIndex + 1); // Clear "redo" history
            }

            historyStack.push(stateCopy);
            historyIndex = historyStack.length - 1; // Point to the new state

            // Limit history size
            if (historyStack.length > MAX_HISTORY_STATES) {
                historyStack.shift(); // Remove the oldest state
                historyIndex--;     // Adjust index accordingly
            }
            // console.log(`State pushed. Index: ${historyIndex}, Stack size: ${historyStack.length}`);
            updateButtonStates();
        }
        
        function recalculateNodeIdCounter(currentData) {
            let maxId = 0;
            function findMaxIdRecursive(node) {
                if (!node) return;
                const idNum = parseInt(node.id.replace('node-', ''));
                if (!isNaN(idNum) && idNum > maxId) {
                    maxId = idNum;
                }
                if (node.children) {
                    node.children.forEach(findMaxIdRecursive);
                }
            }
            if (currentData) {
              findMaxIdRecursive(currentData);
            }
            nodeIdCounter = maxId; // Next ID will be maxId + 1 due to pre-increment in createNode
        }


        function handleUndo() {
            if (historyIndex > 0) {
                historyIndex--;
                const previousState = deepCopy(historyStack[historyIndex]);
                if (previousState) {
                    rcaData = previousState;
                    recalculateNodeIdCounter(rcaData); // Recalculate counter based on the restored state
                    renderRcaDiagram();
                    renderCauseEffectTable();
                    renderSolutionTable();
                } else {
                     console.error("Failed to retrieve previous state from history for undo.");
                     historyIndex++; // Revert index change on error
                }
            }
            updateButtonStates();
        }

        function handleRedo() {
            if (historyIndex < historyStack.length - 1) {
                historyIndex++;
                const nextState = deepCopy(historyStack[historyIndex]);
                if (nextState) {
                    rcaData = nextState;
                    recalculateNodeIdCounter(rcaData); // Recalculate counter
                    renderRcaDiagram();
                    renderCauseEffectTable();
                    renderSolutionTable();
                } else {
                    console.error("Failed to retrieve next state from history for redo.");
                    historyIndex--; // Revert index change on error
                }
            }
            updateButtonStates();
        }

        function handleSaveToLocalStorage() {
            if (rcaData) {
                try {
                    localStorage.setItem('rcaDiagramData', JSON.stringify(rcaData));
                    localStorage.setItem('rcaNodeIdCounter', nodeIdCounter.toString()); // Save counter too
                    alert('圖表進度已儲存至瀏覽器！');
                } catch (e) {
                    console.error("Error saving to localStorage:", e);
                    alert('儲存失敗，可能是瀏覽器儲存空間已滿或功能受限。');
                }
            } else {
                alert('沒有圖表資料可儲存。');
            }
            updateButtonStates(); // Update load button state, etc.
        }

        function handleLoadFromLocalStorage() {
            const savedDataString = localStorage.getItem('rcaDiagramData');
            const savedCounterString = localStorage.getItem('rcaNodeIdCounter');

            if (savedDataString) {
                try {
                    const parsedData = JSON.parse(savedDataString);
                    if (parsedData) {
                        rcaData = parsedData;
                        // Set nodeIdCounter from saved value, or recalculate if not present
                        nodeIdCounter = savedCounterString ? parseInt(savedCounterString) : 0;
                        recalculateNodeIdCounter(rcaData); // Crucial to avoid ID conflicts

                        // Reset history and initialize with the loaded state
                        historyStack = [];
                        historyIndex = -1;
                        pushStateToHistory(rcaData, true); 

                        problemInputArea.style.display = 'none';
                        diagramTitle.style.display = 'block';
                        toolButtonsContainer.style.display = 'flex';
                        renderRcaDiagram();
                        renderCauseEffectTable();
                        renderSolutionTable();
                        alert('圖表進度已載入！');
                    }
                } catch (e) {
                    console.error("Error loading from localStorage:", e);
                    alert('載入失敗，儲存的資料可能已損毀或格式不正確。');
                    // Reset to a clean state if loading fails
                    rcaData = null;
                    nodeIdCounter = 0;
                    historyStack = [];
                    historyIndex = -1;
                    problemInputArea.style.display = 'flex';
                    diagramTitle.style.display = 'none';
                    toolButtonsContainer.style.display = 'none';
                    renderRcaDiagram(); // Clear diagram
                    renderCauseEffectTable();
                    renderSolutionTable();
                }
            } else {
                alert('瀏覽器中沒有儲存的圖表進度。');
            }
            updateButtonStates();
        }

        // --- 處理設定初始問題 ---
        function handleSetInitialProblem() {
            const problemText = problemInput.value.trim();
            if (!problemText) { alert('請輸入主要負面效果！'); return; }
            nodeIdCounter = 0; 
            rcaData = createNode(problemText, 'initial-problem', null); 
            
            historyStack = []; // Reset history
            historyIndex = -1;
            pushStateToHistory(rcaData); // Save initial state

            isFinalizedView = false; 
            finalizeDiagramButton.textContent = '完成圖表';
            finalizeDiagramButton.classList.remove('edit-diagram');
            finalizeDiagramButton.classList.add('finalize-diagram');
            problemInputArea.style.display = 'none'; 
            diagramTitle.style.display = 'block'; 
            toolButtonsContainer.style.display = 'flex';
            renderRcaDiagram();
            renderCauseEffectTable(); 
            renderSolutionTable(); 
            updateButtonStates();
        }

        // --- 切換完成/編輯檢視模式 ---
        function handleToggleFinalizeView() {
            isFinalizedView = !isFinalizedView;
            if (isFinalizedView) {
                finalizeDiagramButton.textContent = '編輯圖表';
                finalizeDiagramButton.classList.remove('finalize-diagram');
                finalizeDiagramButton.classList.add('edit-diagram');
            } else {
                finalizeDiagramButton.textContent = '完成圖表';
                finalizeDiagramButton.classList.remove('edit-diagram');
                finalizeDiagramButton.classList.add('finalize-diagram');
            }
            renderRcaDiagram(); 
            // No history push here as it's a view change, not data change
        }
        
        // --- 創建節點資料物件 ---
        function createNode(text, type, parentId, isNonChangeable = false) {
            nodeIdCounter++; // Pre-increment to get the new ID
            const node = {
                id: `node-${nodeIdCounter}`, text: text, type: type, parentId: parentId, children: [],
                andSourceNodeIds: [], 
                effectParameters: [], 
                inventivePrinciples: [] 
            };
            if (type === 'cause') node.isNonChangeable = isNonChangeable;
            return node;
        }
        
        // --- 渲染整個RCA圖表 (HTML節點) ---
        function renderRcaDiagram() {
            diagramContainer.innerHTML = ''; 
            if (rcaData) {
                diagramContainer.style.display = 'flex'; 
                diagramContainer.style.justifyContent = 'center'; 
                diagramContainer.appendChild(createNodeElement(rcaData));
            } else {
                 diagramContainer.style.display = 'none'; 
            }
            // Delay connector drawing until after DOM updates
            requestAnimationFrame(drawAllSvgConnectors); 
        }

        // --- 創建單個節點的HTML元素 (遞迴) ---
        function createNodeElement(nodeData) {
            const nodeWrapper = document.createElement('div');
            nodeWrapper.classList.add('rca-node-wrapper');
            const nodeDiv = document.createElement('div');
            nodeDiv.classList.add('rca-node', `rca-node-${nodeData.type}`);
            nodeDiv.id = nodeData.id; 
            nodeDiv.dataset.nodeId = nodeData.id;

            const contentDiv = document.createElement('div');
            contentDiv.classList.add('rca-node-content');
            const headerDiv = document.createElement('div');
            headerDiv.classList.add('rca-node-header');
            const iconSpan = document.createElement('span');
            iconSpan.classList.add('rca-node-icon'); 
            const textSpan = document.createElement('span');
            textSpan.classList.add('rca-node-text');
            textSpan.textContent = nodeData.text;

            headerDiv.appendChild(textSpan); 
             if (nodeData.type === 'cause' && nodeData.isNonChangeable) {
                const ncBadge = document.createElement('span');
                ncBadge.classList.add('nc-badge'); ncBadge.textContent = 'NC';
                headerDiv.appendChild(ncBadge); 
            }
            headerDiv.appendChild(iconSpan); 
            contentDiv.appendChild(headerDiv);

            if (nodeData.effectParameters && nodeData.effectParameters.length > 0) {
                const paramsDiv = document.createElement('div');
                paramsDiv.classList.add('selected-items-list');
                paramsDiv.innerHTML = `<strong>效果參數:</strong> <ul>${nodeData.effectParameters.map(p => `<li>${p}</li>`).join('')}</ul>`;
                contentDiv.appendChild(paramsDiv);
            }
            if (nodeData.inventivePrinciples && nodeData.inventivePrinciples.length > 0) {
                const principlesDiv = document.createElement('div');
                principlesDiv.classList.add('selected-items-list');
                let principlesHtml = '<strong>發明原理:</strong> <ul>';
                nodeData.inventivePrinciples.forEach(ip => {
                    principlesHtml += `<li>${ip.name}${ip.solution ? `<span class="solution-text">- ${ip.solution.substring(0, 20)}${ip.solution.length > 20 ? '...' : ''}</span>` : ''}</li>`;
                });
                principlesHtml += '</ul>';
                principlesDiv.innerHTML = principlesHtml;
                contentDiv.appendChild(principlesDiv);
            }

            iconSpan.style.display = 'flex'; 
            if (nodeData.type === 'initial-problem') iconSpan.textContent = '(-)';
            else if (nodeData.type === 'cause') {
                const { hasPositiveChild, hasNegativeChild } = checkChildrenEffects(nodeData);
                if (hasPositiveChild && hasNegativeChild) {
                    iconSpan.textContent = '+/-'; iconSpan.classList.add('contradictory');
                } else {
                    iconSpan.style.display = 'none'; 
                }
            } else if (nodeData.type === 'positive-effect') iconSpan.textContent = '(+)';
            else if (nodeData.type === 'negative-effect') iconSpan.textContent = '(-)';
            else {
                 iconSpan.style.display = 'none'; 
            }

            if (!isFinalizedView) {
                const actionsDiv = document.createElement('div');
                actionsDiv.classList.add('rca-node-actions');
                actionsDiv.appendChild(createActionButton('修訂此項', 'edit-node', () => promptEditNode(nodeData.id, contentDiv)));

                if (nodeData.type === 'initial-problem') {
                    actionsDiv.appendChild(createActionButton('新增原因', 'add-cause', () => promptAddNode(nodeData.id, contentDiv, 'cause', '輸入原因描述')));
                } else if (nodeData.type === 'cause') {
                    actionsDiv.appendChild(createActionButton('新增子原因', 'add-cause', () => promptAddNode(nodeData.id, contentDiv, 'cause', '輸入子原因描述')));
                    actionsDiv.appendChild(createActionButton('(+) 正面效果', 'add-positive', () => promptAddNode(nodeData.id, contentDiv, 'positive-effect', '輸入此原因帶來的正面效果')));
                    actionsDiv.appendChild(createActionButton('(-) 負面效果', 'add-negative', () => promptAddNode(nodeData.id, contentDiv, 'negative-effect', '輸入此原因導致的負面效果')));
                    const ncButtonText = nodeData.isNonChangeable ? '取消NC標記' : '設為NC';
                    actionsDiv.appendChild(createActionButton(ncButtonText, 'toggle-nc', () => toggleNonChangeable(nodeData.id)));
                    actionsDiv.appendChild(createActionButton('選擇發明原理', 'set-principles', () => openInventivePrincipleModal(nodeData.id)));
                    if (nodeData.parentId) { 
                       actionsDiv.appendChild(createActionButton('移除此原因', 'remove-button', () => removeNode(nodeData.id)));
                    }
                } else if (nodeData.type === 'positive-effect' || nodeData.type === 'negative-effect') {
                    actionsDiv.appendChild(createActionButton('(+) 新增正面子效果', 'add-positive', () => promptAddNode(nodeData.id, contentDiv, 'positive-effect', '輸入正面子效果描述')));
                    actionsDiv.appendChild(createActionButton('(-) 新增負面子效果', 'add-negative', () => promptAddNode(nodeData.id, contentDiv, 'negative-effect', '輸入負面子效果描述')));
                    actionsDiv.appendChild(createActionButton('設定效果參數', 'set-parameters', () => openEffectParameterModal(nodeData.id)));
                    actionsDiv.appendChild(createActionButton('設定AND輸入源', 'set-and-sources', () => openAndSourceModal(nodeData.id)));
                    actionsDiv.appendChild(createActionButton('移除效果', 'remove-button', () => removeNode(nodeData.id)));
                }
                contentDiv.appendChild(actionsDiv);

                const inputContainer = document.createElement('div'); 
                inputContainer.classList.add('input-group-container');
                contentDiv.appendChild(inputContainer);
            }
            
            nodeDiv.appendChild(contentDiv); 
            nodeWrapper.appendChild(nodeDiv); 

            if (nodeData.children && nodeData.children.length > 0) {
                const childrenContainer = document.createElement('div');
                childrenContainer.classList.add('rca-children-container');
                nodeData.children.forEach(childNode => childrenContainer.appendChild(createNodeElement(childNode)));
                nodeWrapper.appendChild(childrenContainer);
            }
            return nodeWrapper;
        }
        
        function promptEditNode(nodeId, parentNodeContentDiv) {
            if (isFinalizedView) return;
            const nodeToEdit = findNodeById(rcaData, nodeId);
            if (!nodeToEdit) return;

            const inputContainer = parentNodeContentDiv.querySelector('.input-group-container');
            if (!inputContainer) { 
                console.error("Input container not found for node:", nodeId);
                return; 
            }
            // Clear any existing input fields in this node
            document.querySelectorAll('.input-group').forEach(ig => ig.remove());
            inputContainer.innerHTML = ''; 


            const inputGroup = document.createElement('div');
            inputGroup.classList.add('input-group');

            const nodeInput = document.createElement('input');
            nodeInput.type = 'text';
            nodeInput.value = nodeToEdit.text; 
            nodeInput.classList.add('input-field');
            
            const saveEditButton = document.createElement('button');
            saveEditButton.textContent = '儲存修訂';
            saveEditButton.classList.add('action-button', 'save-edit-button', 'w-full', 'mt-2');

            saveEditButton.onclick = () => {
                const newText = nodeInput.value.trim();
                if (newText) {
                    nodeToEdit.text = newText;
                    pushStateToHistory(rcaData); // Save state after edit
                    renderRcaDiagram(); 
                    renderCauseEffectTable();
                    renderSolutionTable(); 
                    inputContainer.innerHTML = ''; 
                } else {
                    alert('描述不能為空！');
                }
            };
            
            nodeInput.addEventListener('keypress', (event) => {
                if (event.key === 'Enter') saveEditButton.click();
            });
            const cancelEditButton = document.createElement('button');
            cancelEditButton.textContent = '取消修訂';
            cancelEditButton.classList.add('action-button', 'bg-gray-400', 'hover:bg-gray-500', 'w-full', 'mt-1');
            cancelEditButton.onclick = () => {
                inputContainer.innerHTML = ''; 
            };

            inputGroup.appendChild(nodeInput);
            inputGroup.appendChild(saveEditButton);
            inputGroup.appendChild(cancelEditButton);
            inputContainer.appendChild(inputGroup); 
            nodeInput.focus();
            nodeInput.select();
        }

        function openAndSourceModal(targetNodeId) {
            if (isFinalizedView) return; 
            currentAndTargetNodeId = targetNodeId;
            const targetNode = findNodeById(rcaData, targetNodeId);
            if (!targetNode) return;

            andSourceModalTitle.textContent = `為效果 "${targetNode.text}" 設定 AND 輸入源`;
            andSourceOptionsContainer.innerHTML = ''; 

            const availableCauses = [];
            function findCausesRecursive(node) {
                if (!node) return;
                if (node.type === 'cause') availableCauses.push(node);
                if (node.children) node.children.forEach(findCausesRecursive);
            }
            if (rcaData) findCausesRecursive(rcaData);

            if (availableCauses.length === 0) {
                andSourceOptionsContainer.innerHTML = '<p class="text-gray-500 text-center">圖表中尚無可用的原因節點。</p>';
            } else {
                availableCauses.forEach(causeNode => {
                    if (causeNode.id === targetNode.id || isDescendant(targetNode, causeNode.id) || causeNode.id === targetNode.parentId) return; // Prevent self, descendant, or direct parent

                    const div = document.createElement('div');
                    div.classList.add('flex', 'items-center', 'my-2', 'p-2', 'hover:bg-gray-100', 'rounded');
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.id = `and-source-chk-${causeNode.id}`;
                    checkbox.value = causeNode.id;
                    checkbox.classList.add('form-checkbox', 'h-5', 'w-5', 'text-blue-600', 'rounded', 'border-gray-300');
                    if (targetNode.andSourceNodeIds && targetNode.andSourceNodeIds.includes(causeNode.id)) {
                        checkbox.checked = true;
                    }
                    const label = document.createElement('label');
                    label.htmlFor = `and-source-chk-${causeNode.id}`;
                    label.textContent = `${causeNode.text} (ID: ${causeNode.id.split('-')[1]})`; // Shorter ID display
                    label.classList.add('ml-3', 'text-sm', 'text-gray-700', 'flex-grow');
                    div.appendChild(checkbox); div.appendChild(label);
                    andSourceOptionsContainer.appendChild(div);
                });
                 if (andSourceOptionsContainer.childElementCount === 0) {
                    andSourceOptionsContainer.innerHTML = '<p class="text-gray-500 text-center">無有效的 AND 輸入源選項。</p>';
                }
            }
            andSourceModal.style.display = 'flex';
        }

        function isDescendant(parentNode, childNodeIdToFind) {
            if (!parentNode || !parentNode.children || parentNode.children.length === 0) return false;
            for (const child of parentNode.children) {
                if (child.id === childNodeIdToFind) return true;
                if (isDescendant(child, childNodeIdToFind)) return true;
            }
            return false;
        }

        function handleSaveAndSources() {
            if (!currentAndTargetNodeId) return;
            const targetNode = findNodeById(rcaData, currentAndTargetNodeId);
            if (!targetNode) return;
            const selectedSourceIds = [];
            const checkboxes = andSourceOptionsContainer.querySelectorAll('input[type="checkbox"]:checked');
            checkboxes.forEach(chk => selectedSourceIds.push(chk.value));
            targetNode.andSourceNodeIds = selectedSourceIds;
            
            pushStateToHistory(rcaData); // Save state
            
            andSourceModal.style.display = 'none';
            currentAndTargetNodeId = null;
            renderRcaDiagram(); 
        }
        
        function openEffectParameterModal(targetNodeId) {
            if (isFinalizedView) return;
            currentParameterTargetNodeId = targetNodeId;
            const targetNode = findNodeById(rcaData, targetNodeId);
            if (!targetNode || (targetNode.type !== 'positive-effect' && targetNode.type !== 'negative-effect')) return;

            effectParameterModalTitle.textContent = `為效果 "${targetNode.text}" 設定效果參數`;
            effectParameterOptionsContainer.innerHTML = '';

            Object.keys(EFFECT_PARAMETERS).forEach(category => {
                const categoryTitle = document.createElement('h4');
                categoryTitle.textContent = category;
                effectParameterOptionsContainer.appendChild(categoryTitle);

                EFFECT_PARAMETERS[category].forEach(param => {
                    const div = document.createElement('div');
                    div.classList.add('flex', 'items-center', 'my-1', 'p-1', 'hover:bg-gray-50', 'rounded');
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.id = `param-chk-${param.replace(/\s|\/|[\(\)]/g, '-')}`; // Sanitize ID
                    checkbox.value = param;
                    checkbox.classList.add('form-checkbox', 'h-4', 'w-4', 'text-sky-600', 'rounded', 'border-gray-300', 'focus:ring-sky-500');
                    if (targetNode.effectParameters && targetNode.effectParameters.includes(param)) {
                        checkbox.checked = true;
                    }
                    const label = document.createElement('label');
                    label.htmlFor = checkbox.id;
                    label.textContent = param;
                    label.classList.add('ml-2', 'text-sm', 'text-gray-700');
                    div.appendChild(checkbox);
                    div.appendChild(label);
                    effectParameterOptionsContainer.appendChild(div);
                });
            });
            effectParameterModal.style.display = 'flex';
        }

        function handleSaveEffectParameters() {
            if (!currentParameterTargetNodeId) return;
            const targetNode = findNodeById(rcaData, currentParameterTargetNodeId);
            if (!targetNode) return;

            const selectedParameters = [];
            const checkboxes = effectParameterOptionsContainer.querySelectorAll('input[type="checkbox"]:checked');
            checkboxes.forEach(chk => selectedParameters.push(chk.value));

            targetNode.effectParameters = selectedParameters;
            pushStateToHistory(rcaData); // Save state

            effectParameterModal.style.display = 'none';
            currentParameterTargetNodeId = null;
            renderRcaDiagram();
        }

        function openInventivePrincipleModal(targetNodeId) {
            if (isFinalizedView) return;
            currentPrincipleTargetNodeId = targetNodeId;
            const targetNode = findNodeById(rcaData, targetNodeId);
            if (!targetNode || targetNode.type !== 'cause') return;

            inventivePrincipleModalTitle.textContent = `為原因 "${targetNode.text}" 選擇發明原理與改善方案`;
            inventivePrincipleOptionsContainer.innerHTML = '';

            INVENTIVE_PRINCIPLES.forEach(principleName => {
                const principleContainer = document.createElement('div');
                principleContainer.classList.add('my-2', 'p-2', 'border-b', 'border-gray-200');

                const div = document.createElement('div');
                div.classList.add('flex', 'items-center');
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                const checkboxId = `principle-chk-${principleName.replace(/\s|\/|[\(\)\[\]]/g, '-')}`; // Sanitize ID
                checkbox.id = checkboxId;
                checkbox.value = principleName;
                checkbox.classList.add('form-checkbox', 'h-4', 'w-4', 'text-pink-600', 'rounded', 'border-gray-300', 'focus:ring-pink-500');
                
                const existingPrinciple = targetNode.inventivePrinciples.find(p => p.name === principleName);
                if (existingPrinciple) {
                    checkbox.checked = true;
                }

                const label = document.createElement('label');
                label.htmlFor = checkboxId;
                label.textContent = principleName;
                label.classList.add('ml-2', 'text-sm', 'text-gray-700', 'font-medium');
                
                div.appendChild(checkbox);
                div.appendChild(label);
                principleContainer.appendChild(div);

                const solutionInput = document.createElement('input');
                solutionInput.type = 'text';
                solutionInput.placeholder = '輸入此原理的改善方案...';
                solutionInput.dataset.principleName = principleName; 
                solutionInput.classList.add('principle-solution-input', 'input-field', 'mt-1'); // Reused input-field class
                solutionInput.value = existingPrinciple && existingPrinciple.solution ? existingPrinciple.solution : '';
                solutionInput.style.display = checkbox.checked ? 'block' : 'none'; 

                checkbox.onchange = () => { 
                    solutionInput.style.display = checkbox.checked ? 'block' : 'none';
                    if (!checkbox.checked) solutionInput.value = ''; 
                };
                
                principleContainer.appendChild(solutionInput);
                inventivePrincipleOptionsContainer.appendChild(principleContainer);
            });
            inventivePrincipleModal.style.display = 'flex';
        }

        function handleSaveInventivePrinciples() {
            if (!currentPrincipleTargetNodeId) return;
            const targetNode = findNodeById(rcaData, currentPrincipleTargetNodeId);
            if (!targetNode) return;

            const selectedPrinciples = [];
            const principleContainers = inventivePrincipleOptionsContainer.querySelectorAll('div.my-2 > div.flex > input[type="checkbox"]'); // More specific selector
            
            principleContainers.forEach(chk => {
                if (chk.checked) {
                    const principleName = chk.value;
                    // Find the corresponding input field within the same container
                    const solutionInput = chk.closest('.my-2').querySelector('input[type="text"][data-principle-name]');
                    selectedPrinciples.push({
                        name: principleName,
                        solution: solutionInput ? solutionInput.value.trim() : ''
                    });
                }
            });

            targetNode.inventivePrinciples = selectedPrinciples;
            pushStateToHistory(rcaData); // Save state

            inventivePrincipleModal.style.display = 'none';
            currentPrincipleTargetNodeId = null;
            renderRcaDiagram();
            renderSolutionTable(); 
        }

        function drawAllSvgConnectors() {
            svgLayer.innerHTML = ''; 
            if (!rcaData || !document.getElementById(rcaData.id)) { // Ensure root node exists in DOM
                svgLayer.setAttribute('width', 0);
                svgLayer.setAttribute('height', 0);
                return;
            }
            const diagramRenderAreaElement = document.getElementById('diagram-render-area');
            const diagramRect = diagramRenderAreaElement.getBoundingClientRect(); 
            
            svgLayer.setAttribute('width', diagramContainer.scrollWidth);
            svgLayer.setAttribute('height', diagramContainer.scrollHeight);
            svgLayer.setAttribute('viewBox', `0 0 ${diagramContainer.scrollWidth} ${diagramContainer.scrollHeight}`);

            const lineVerticalOffset = 25; 

            function drawRecursive(parentNodeData) {
                const parentElement = document.getElementById(parentNodeData.id);
                if (!parentElement) return;

                const parentRect = parentElement.getBoundingClientRect();
                const parentBottomCenterX = parentRect.left - diagramRect.left + diagramRenderAreaElement.scrollLeft + parentRect.width / 2;
                const parentBottomY = parentRect.top - diagramRect.top + diagramRenderAreaElement.scrollTop + parentRect.height;
                const parentTopY = parentRect.top - diagramRect.top + diagramRenderAreaElement.scrollTop;
                const parentCenterX = parentBottomCenterX;

                if (parentNodeData.andSourceNodeIds && parentNodeData.andSourceNodeIds.length > 0) {
                    const mergePointYOffset = 40; 
                    const mergePoint = { x: parentCenterX, y: parentTopY - mergePointYOffset };
                    if(mergePoint.y < 0) mergePoint.y = 10; 

                    drawSvgCircle(mergePoint.x, mergePoint.y, 6, '#6d28d9'); 
                    parentNodeData.andSourceNodeIds.forEach(sourceId => {
                        const sourceElement = document.getElementById(sourceId);
                        if (sourceElement) {
                            const sourceRect = sourceElement.getBoundingClientRect();
                            const sourceConnX = sourceRect.left - diagramRect.left + diagramRenderAreaElement.scrollLeft + sourceRect.width / 2;
                            const sourceConnY = sourceRect.top - diagramRect.top + diagramRenderAreaElement.scrollTop + sourceRect.height; 
                            if (sourceConnY < mergePoint.y) { 
                                drawSvgLine(sourceConnX, sourceConnY, mergePoint.x, mergePoint.y, '#6b7280');
                            } else { // Draw from source side if it's below merge point (less common)
                                drawSvgLine(sourceConnX, sourceRect.top - diagramRect.top + diagramRenderAreaElement.scrollTop, mergePoint.x, mergePoint.y, '#6b7280');
                            }
                        }
                    });
                    if (parentTopY > mergePoint.y) { 
                        drawSvgLine(mergePoint.x, mergePoint.y, parentCenterX, parentTopY, '#6b7280'); 
                    }
                }
                
                const standardChildren = parentNodeData.children.filter(c => !(c.andSourceNodeIds && c.andSourceNodeIds.length > 0 && c.andSourceNodeIds.includes(parentNodeData.id))); // Basic AND check
                if (standardChildren.length > 0) {
                    const horizontalLineY = parentBottomY + lineVerticalOffset;
                    drawSvgLine(parentBottomCenterX, parentBottomY, parentBottomCenterX, horizontalLineY, '#9ca3af');

                    if (standardChildren.length > 1) {
                        const firstChildElement = document.getElementById(standardChildren[0].id);
                        const lastChildElement = document.getElementById(standardChildren[standardChildren.length - 1].id);
                        if (firstChildElement && lastChildElement) {
                            const firstChildRect = firstChildElement.getBoundingClientRect();
                            const lastChildRect = lastChildElement.getBoundingClientRect();
                            const hLineStartX = firstChildRect.left - diagramRect.left + diagramRenderAreaElement.scrollLeft + firstChildRect.width / 2;
                            const hLineEndX = lastChildRect.left - diagramRect.left + diagramRenderAreaElement.scrollLeft + lastChildRect.width / 2;
                            if (Math.abs(hLineStartX - hLineEndX) > 1) { 
                                drawSvgLine(hLineStartX, horizontalLineY, hLineEndX, horizontalLineY, '#9ca3af');
                            }
                        }
                    } else if (standardChildren.length === 1) { // Single child, connect parent vertical line to child vertical line directly
                         const childElement = document.getElementById(standardChildren[0].id);
                         if (childElement) {
                            const childRect = childElement.getBoundingClientRect();
                            const childCenterX = childRect.left - diagramRect.left + diagramRenderAreaElement.scrollLeft + childRect.width / 2;
                            // Connect parent's vertical drop to child's center X at horizontalLineY
                            if (Math.abs(parentBottomCenterX - childCenterX) > 1) { // If not aligned, draw small horizontal segment
                                drawSvgLine(parentBottomCenterX, horizontalLineY, childCenterX, horizontalLineY, '#9ca3af');
                            }
                         }
                    }

                    standardChildren.forEach(childNode => {
                        const childElement = document.getElementById(childNode.id);
                        if (childElement) {
                            const childRect = childElement.getBoundingClientRect();
                            const childCenterX = childRect.left - diagramRect.left + diagramRenderAreaElement.scrollLeft + childRect.width / 2;
                            const childTopY = childRect.top - diagramRect.top + diagramRenderAreaElement.scrollTop;
                            if (childTopY > horizontalLineY) { 
                                drawSvgLine(childCenterX, horizontalLineY, childCenterX, childTopY, '#9ca3af');
                            }
                        }
                    });
                }

                if (parentNodeData.children) {
                    parentNodeData.children.forEach(childNode => drawRecursive(childNode));
                }
            }
            if(rcaData) drawRecursive(rcaData); 
        }

        function drawSvgLine(x1, y1, x2, y2, color = 'black', strokeWidth = 2) {
            if (isNaN(x1) || isNaN(y1) || isNaN(x2) || isNaN(y2)) { return; }
            const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
            line.setAttribute('x1', x1); line.setAttribute('y1', y1);
            line.setAttribute('x2', x2); line.setAttribute('y2', y2);
            line.setAttribute('stroke', color); line.setAttribute('stroke-width', strokeWidth);
            svgLayer.appendChild(line);
        }

        function drawSvgCircle(cx, cy, r, fillColor = 'black') {
             if (isNaN(cx) || isNaN(cy) || isNaN(r)) { return; }
            const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
            circle.setAttribute('cx', cx); circle.setAttribute('cy', cy);
            circle.setAttribute('r', r); circle.setAttribute('fill', fillColor);
            svgLayer.appendChild(circle);
        }
        
        function checkChildrenEffects(nodeData) {
            let hasPositiveChild = false; let hasNegativeChild = false;
            if (nodeData.children) {
                for (const child of nodeData.children) {
                    if (child.type === 'positive-effect') hasPositiveChild = true;
                    if (child.type === 'negative-effect') hasNegativeChild = true;
                    if (hasPositiveChild && hasNegativeChild) break;
                }
            }
            return { hasPositiveChild, hasNegativeChild };
        }

        function toggleNonChangeable(nodeId) {
            if (isFinalizedView) return; 
            const node = findNodeById(rcaData, nodeId);
            if (node && node.type === 'cause') {
                node.isNonChangeable = !node.isNonChangeable;
                pushStateToHistory(rcaData); // Save state
                renderRcaDiagram(); renderCauseEffectTable();
            }
        }
        
        function createActionButton(text, className, onClickHandler) {
            const button = document.createElement('button'); 
            button.classList.add('action-button', ...className.split(' ')); 
            button.textContent = text; 
            button.addEventListener('click', onClickHandler); return button;
        }
        
        function promptAddNode(parentId, parentNodeContentDiv, nodeTypeToAdd, placeholderText) {
            if (isFinalizedView) return; 
            const inputContainer = parentNodeContentDiv.querySelector('.input-group-container');
            if (!inputContainer) return; 
            
            // Clear any existing input fields in THIS node before adding a new one
            inputContainer.innerHTML = ''; 
            // Also clear any other open input groups in other nodes
            document.querySelectorAll('.input-group').forEach(ig => ig.remove());


            const inputGroup = document.createElement('div');
            inputGroup.classList.add('input-group');
            const nodeInput = document.createElement('input');
            nodeInput.type = 'text'; nodeInput.placeholder = placeholderText;
            nodeInput.classList.add('input-field');
            const saveButton = document.createElement('button');
            saveButton.textContent = '儲存';
            saveButton.classList.add('action-button', 'save-button', 'w-full', 'mt-2');
            saveButton.onclick = () => {
                const nodeText = nodeInput.value.trim();
                if (nodeText) { 
                    addNodeToData(parentId, nodeText, nodeTypeToAdd); 
                    inputContainer.innerHTML = ''; // Clear input after save
                } 
                else { alert('描述不能為空！'); }
            };
            nodeInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') saveButton.click(); });
            
            const cancelButton = document.createElement('button');
            cancelButton.textContent = '取消';
            cancelButton.classList.add('action-button', 'bg-gray-400', 'hover:bg-gray-500', 'w-full', 'mt-1');
            cancelButton.onclick = () => {
                inputContainer.innerHTML = ''; // Clear input on cancel
            };

            inputGroup.appendChild(nodeInput); 
            inputGroup.appendChild(saveButton);
            inputGroup.appendChild(cancelButton);
            inputContainer.appendChild(inputGroup); 
            nodeInput.focus();
        }

        function addNodeToData(parentId, nodeText, nodeType) {
            const parentNode = findNodeById(rcaData, parentId); 
            if (parentNode) {
                const newNode = createNode(nodeText, nodeType, parentId);
                parentNode.children.push(newNode);
                pushStateToHistory(rcaData); // Save state
                renderRcaDiagram(); 
                renderCauseEffectTable();
                renderSolutionTable();
            }
        }

        function removeNode(nodeIdToRemove) {
            if (isFinalizedView) return; 
            if (rcaData && rcaData.id === nodeIdToRemove) { alert('不能移除主要問題根源節點！'); return; }
            
            let nodeRemoved = false;
            function filterRecursive(node, idToRemove) {
                if (!node) return null;
                if (node.id === idToRemove) { 
                    nodeRemoved = true;
                    // Before removing, ensure this node ID is removed from any AND source lists
                    function removeAndSourceFromEntireTree(currentNodeData, removedId) { 
                        if (!currentNodeData) return;
                        if (currentNodeData.andSourceNodeIds && currentNodeData.andSourceNodeIds.includes(removedId)) {
                            currentNodeData.andSourceNodeIds = currentNodeData.andSourceNodeIds.filter(srcId => srcId !== removedId);
                        }
                        if (currentNodeData.children) {
                            currentNodeData.children.forEach(child => removeAndSourceFromEntireTree(child, removedId));
                        }
                    }
                    removeAndSourceFromEntireTree(rcaData, idToRemove); 
                    return null; // This node will be filtered out
                }
                if (node.children) {
                    node.children = node.children.map(child => filterRecursive(child, idToRemove)).filter(child => child !== null);
                }
                return node;
            }
            rcaData = filterRecursive(rcaData, nodeIdToRemove);
            
            if (nodeRemoved) {
                 pushStateToHistory(rcaData); // Save state
            }

            if (!rcaData) { // If root problem was somehow removed (should be prevented) or data becomes null
                 problemInputArea.style.display = 'flex'; 
                 diagramTitle.style.display = 'none';
                 toolButtonsContainer.style.display = 'none';
                 causeEffectTableSection.style.display = 'none';
                 solutionTableSection.style.display = 'none';
                 historyStack = []; historyIndex = -1; // Reset history
            }
            renderRcaDiagram(); 
            renderCauseEffectTable();
            renderSolutionTable();
            updateButtonStates(); // Update buttons as rcaData might be null now
        }
        
        function findNodeById(node, id) {
            if (!node) return null;
            if (node.id === id) return node;
            if (node.children) {
                for (const child of node.children) {
                    const found = findNodeById(child, id);
                    if (found) return found;
                }
            }
            return null;
        }

        function handleToggleCauseEffectTable() {
            const isHidden = causeEffectTableSection.style.display === 'none';
            causeEffectTableSection.style.display = isHidden ? 'block' : 'none';
            toggleCauseEffectTableButton.textContent = isHidden ? '隱藏原因效果表' : '顯示原因效果表';
            if (isHidden) renderCauseEffectTable();
        }

        function getCauseEffectTableData() {
            const tableRowsData = [];
            function collectDataRecursive(node) {
                if (!node) return;
                if (node.type === 'cause') {
                    const { hasPositiveChild, hasNegativeChild } = checkChildrenEffects(node);
                    let causeType = '';
                    if (node.isNonChangeable) causeType = 'NC';
                    else if (hasPositiveChild && hasNegativeChild) causeType = 'N+P (矛盾)';
                    else if (hasNegativeChild) causeType = 'N (純負面)';
                    else if (hasPositiveChild) causeType = 'P (純正面)'; 
                    else causeType = '未定義效果'; 
                    
                    // Only list causes that are not purely positive, or have defined effects
                    if (causeType !== 'P (純正面)' || (hasPositiveChild || hasNegativeChild)) {
                         const positiveEffects = node.children.filter(c => c.type === 'positive-effect').map(c => c.text).join('; ') || '無';
                         const negativeEffects = node.children.filter(c => c.type === 'negative-effect').map(c => c.text).join('; ') || '無';
                         tableRowsData.push({ cause: node.text, type: causeType, positive: positiveEffects, negative: negativeEffects });
                    }
                }
                if (node.children) node.children.forEach(collectDataRecursive);
            }
            if (rcaData) collectDataRecursive(rcaData);
            return tableRowsData;
        }

        function renderCauseEffectTable() {
            if (!rcaData) { 
                causeEffectTableBody.innerHTML = '<tr><td colspan="4" class="text-center text-gray-500">請先設定主要負面效果並建立分析圖。</td></tr>';
                return;
            }
            const tableData = getCauseEffectTableData();
            causeEffectTableBody.innerHTML = ''; 
            if (tableData.length === 0) {
                causeEffectTableBody.innerHTML = '<tr><td colspan="4" class="text-center text-gray-500">目前圖表中沒有定義直接帶有正面或負面效果的原因 (且非純粹正面原因)。</td></tr>';
                return;
            }
            tableData.forEach(rowData => {
                const row = causeEffectTableBody.insertRow();
                row.insertCell().textContent = rowData.cause;
                row.insertCell().textContent = rowData.type;
                row.insertCell().textContent = rowData.positive;
                row.insertCell().textContent = rowData.negative;
            });
        }

        function handleToggleSolutionTable() {
            const isHidden = solutionTableSection.style.display === 'none';
            solutionTableSection.style.display = isHidden ? 'block' : 'none';
            toggleSolutionTableButton.textContent = isHidden ? '隱藏改善方案表' : '顯示改善方案表';
            if (isHidden) {
                renderSolutionTable();
            }
        }
        
        function renderSolutionTable() {
            if (!rcaData) {
                solutionTableBody.innerHTML = '<tr><td colspan="3" class="text-center text-gray-500">請先設定主要負面效果並建立分析圖。</td></tr>';
                return;
            }
            const tableData = getSolutionTableData(); 
            solutionTableBody.innerHTML = ''; 

            if (tableData.length === 0) {
                let message = '目前沒有矛盾原因已選擇發明原理並填寫改善方案。';
                let hasContradictoryCause = false;
                function findContradictory(node) {
                    if (!node) return;
                    if (node.type === 'cause') {
                        const { hasPositiveChild, hasNegativeChild } = checkChildrenEffects(node);
                        if (hasPositiveChild && hasNegativeChild) {
                            hasContradictoryCause = true;
                            return; 
                        }
                    }
                    if (node.children && !hasContradictoryCause) node.children.forEach(findContradictory);
                }
                if (rcaData) findContradictory(rcaData);

                if (!hasContradictoryCause) {
                    message = '提示：圖表中尚無「矛盾原因」(即同時直接導致正面及負面效果的原因)。請先建立矛盾原因。';
                } else {
                    message = '提示：已找到矛盾原因，但尚未為其「選擇發明原理」並填寫「改善方案」。';
                }
                solutionTableBody.innerHTML = `<tr><td colspan="3" class="text-center text-gray-500">${message}</td></tr>`;
                return;
            }

            const groupedSolutions = {};
            tableData.forEach(item => {
                if (!groupedSolutions[item.contradictoryCause]) {
                    groupedSolutions[item.contradictoryCause] = [];
                }
                groupedSolutions[item.contradictoryCause].push({ principle: item.principle, solution: item.solution });
            });

            Object.keys(groupedSolutions).forEach(causeText => {
                const solutionsForCause = groupedSolutions[causeText];
                solutionsForCause.forEach((solutionItem, index) => {
                    const row = solutionTableBody.insertRow();
                    if (index === 0) { 
                        const causeCell = row.insertCell();
                        causeCell.textContent = causeText;
                        causeCell.rowSpan = solutionsForCause.length; 
                    }
                    row.insertCell().textContent = solutionItem.principle;
                    row.insertCell().textContent = solutionItem.solution;
                });
            });
        }

        function getSolutionTableData() {
            const solutionData = [];
            function collectSolutionsRecursive(node) {
                if (!node) return;
                if (node.type === 'cause') {
                    const { hasPositiveChild, hasNegativeChild } = checkChildrenEffects(node);
                    if (hasPositiveChild && hasNegativeChild && node.inventivePrinciples && node.inventivePrinciples.length > 0) {
                        node.inventivePrinciples.forEach(ip => {
                            if (ip.solution && ip.solution.trim() !== '') { // Only include if solution is provided
                                solutionData.push({
                                    contradictoryCause: node.text, 
                                    principle: ip.name,
                                    solution: ip.solution
                                });
                            }
                        });
                    }
                }
                if (node.children) {
                    node.children.forEach(collectSolutionsRecursive);
                }
            }
            if (rcaData) {
                collectSolutionsRecursive(rcaData);
            }
            return solutionData;
        }

        function exportDiagramAsPNG() {
            const diagramRenderAreaElement = document.getElementById('diagram-render-area'); 
            if (!diagramRenderAreaElement || !rcaData || diagramContainer.children.length === 0) { 
                alert('圖表為空或找不到圖表元素！'); 
                return; 
            }
            
            // Temporarily hide any open input groups for cleaner export
            const activeInputGroups = diagramContainer.querySelectorAll('.input-group');
            activeInputGroups.forEach(group => group.style.display = 'none'); 
            
            // Ensure SVG connectors are up-to-date
            drawAllSvgConnectors(); 

            html2canvas(diagramRenderAreaElement, { 
                scale: 1.5, 
                useCORS: true, 
                backgroundColor: '#ffffff', 
                logging: false, // Reduce console noise
                width: diagramRenderAreaElement.scrollWidth, 
                height: diagramRenderAreaElement.scrollHeight, 
                onclone: (clonedDoc) => {
                    const clonedSvg = clonedDoc.getElementById('svg-connector-layer');
                    const clonedDiagramContainer = clonedDoc.getElementById('rca-diagram-container');
                    const clonedRenderArea = clonedDoc.getElementById('diagram-render-area');
                    
                    if (clonedSvg && clonedDiagramContainer && clonedRenderArea) {
                        clonedSvg.setAttribute('width', clonedDiagramContainer.scrollWidth);
                        clonedSvg.setAttribute('height', clonedDiagramContainer.scrollHeight);
                        clonedSvg.setAttribute('viewBox', `0 0 ${clonedDiagramContainer.scrollWidth} ${clonedDiagramContainer.scrollHeight}`);
                        
                        clonedRenderArea.style.width = diagramRenderAreaElement.scrollWidth + 'px';
                        clonedRenderArea.style.height = diagramRenderAreaElement.scrollHeight + 'px';
                    }
                    // If in finalized view, ensure action buttons are hidden in the clone
                    if (isFinalizedView) {
                        const clonedActionDivs = clonedDoc.querySelectorAll('.rca-node-actions');
                        clonedActionDivs.forEach(div => div.style.display = 'none');
                    }
                    // Ensure input containers are hidden in the clone (already done for active ones, this is a fallback)
                    const clonedInputContainers = clonedDoc.querySelectorAll('.input-group-container');
                    clonedInputContainers.forEach(div => div.style.display = 'none');
                }
            })
            .then(canvas => {
                activeInputGroups.forEach(group => group.style.display = 'flex'); // Restore visibility
                const image = canvas.toDataURL('image/png');
                const link = document.createElement('a');
                link.download = 'rca-plus-diagram.png';
                link.href = image;
                link.click();
            }).catch(err => {
                console.error('匯出圖表失敗:', err);
                alert('匯出圖表失敗，請檢查控制台錯誤訊息。');
                activeInputGroups.forEach(group => group.style.display = 'flex'); // Restore visibility on error
            });
        }
        
        // --- 執行初始化 ---
        initialize();
    </script>
</body>
</html>

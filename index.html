<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Giono - 您的線上日記 (進階版)</title>
    <!-- 引入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入 Marked.js 用於 Markdown 解析 -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- 引入 DOMPurify 用於 HTML 清理，防止 XSS -->
    <script src="https://cdn.jsdelivr.net/npm/dompurify@2.3.6/dist/purify.min.js"></script>
    <!-- 引入 Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans TC', 'Inter', sans-serif; }
        .modal-hidden { display: none; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .spinner { border: 4px solid rgba(0, 0, 0, 0.1); width: 36px; height: 36px; border-radius: 50%; border-left-color: #4f46e5; animation: spin 1s ease infinite; }
        .btn-spinner { border-left-color: #ffffff; } /* 按鈕中的 spinner 顏色 */
        /* Markdown 渲染樣式 */
        .rendered-markdown h1, .rendered-markdown h2, .rendered-markdown h3 { font-weight: bold; margin-top: 1rem; margin-bottom: 0.5rem; }
        .rendered-markdown h1 { font-size: 1.5em; }
        .rendered-markdown h2 { font-size: 1.25em; }
        .rendered-markdown h3 { font-size: 1.1em; }
        .rendered-markdown p { margin-bottom: 0.75rem; }
        .rendered-markdown ul, .rendered-markdown ol { margin-left: 1.5rem; margin-bottom: 0.75rem; }
        .rendered-markdown li { margin-bottom: 0.25rem; }
        .rendered-markdown blockquote { border-left: 4px solid #e5e7eb; padding-left: 1rem; color: #6b7280; margin: 1rem 0; }
        .rendered-markdown code { background-color: #f3f4f6; padding: 0.2rem 0.4rem; border-radius: 0.25rem; font-family: monospace; }
        .rendered-markdown pre { background-color: #f3f4f6; padding: 1rem; border-radius: 0.5rem; overflow-x: auto; }
        .rendered-markdown a { color: #4f46e5; text-decoration: underline; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <main class="container mx-auto p-4 sm:p-6 lg:p-8 max-w-4xl">
        <header class="text-center mb-10">
            <h1 class="text-4xl sm:text-5xl font-bold text-indigo-700">Giono</h1>
            <p class="text-gray-600 mt-2">您的個人空間，記錄思緒與生活</p>
        </header>

        <!-- 日記輸入區 -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-10">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div>
                    <label for="entry-date" class="block text-gray-700 text-sm font-bold mb-2">日期</label>
                    <input type="date" id="entry-date" class="shadow-sm border-gray-300 rounded-lg w-full py-2 px-3 focus:ring-2 focus:ring-indigo-500">
                </div>
                 <div>
                    <label for="entry-tags" class="block text-gray-700 text-sm font-bold mb-2">標籤 (以逗號分隔)</label>
                    <input type="text" id="entry-tags" placeholder="例如：工作, 靈感, 生活" class="shadow-sm border-gray-300 rounded-lg w-full py-2 px-3 focus:ring-2 focus:ring-indigo-500">
                </div>
            </div>
            <div class="mb-4">
                <label for="diary-entry" class="block text-gray-700 text-sm font-bold mb-2">今天過得如何？ (支援 Markdown)</label>
                <textarea id="diary-entry" rows="8" class="shadow-sm border-gray-300 rounded-lg w-full py-2 px-3 focus:ring-2 focus:ring-indigo-500" placeholder="# 標題&#10;* 清單項目&#10;**粗體文字**..."></textarea>
                <p id="char-counter" class="text-right text-xs text-gray-500 mt-1">0 字</p>
            </div>
            <button id="save-entry" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg focus:outline-none focus:shadow-outline transition-colors duration-300">
                儲存日記
            </button>
            <div id="message-box" class="mt-4 text-center text-sm font-medium"></div>
        </div>

        <!-- 歷史與搜尋 -->
        <div>
            <div class="flex flex-col sm:flex-row justify-between items-center mb-4 gap-4">
                 <h2 class="text-2xl font-bold text-gray-900">我的日記歷史</h2>
                 <input type="search" id="search-box" placeholder="搜尋日記內容..." class="shadow-sm border-gray-300 rounded-lg w-full sm:w-64 py-2 px-3 focus:ring-2 focus:ring-indigo-500">
            </div>
             <div id="active-filter-container" class="mb-4 text-sm text-gray-600"></div>
            <div id="loading-container" class="flex justify-center py-8">
                <div class="spinner"></div>
            </div>
            <div id="entries-container" class="space-y-6">
                <!-- Diary entries will be dynamically inserted here -->
            </div>
        </div>

        <div id="user-id-display" class="fixed bottom-4 right-4 bg-white p-3 rounded-lg shadow-lg text-xs text-gray-600 border border-gray-200">
            <p class="font-bold">使用者 ID:</p>
            <span id="user-id" class="break-all"></span>
        </div>
    </main>

    <!-- Modals (Delete and Edit) -->
    <div id="delete-modal" class="modal-hidden fixed inset-0 bg-gray-600 bg-opacity-50 h-full w-full flex items-center justify-center p-4">
        <div class="bg-white p-6 rounded-lg shadow-xl w-11/12 max-w-sm">
            <h3 class="text-lg font-bold">確認刪除</h3>
            <p class="mt-2 text-sm text-gray-600">您確定要刪除這篇日記嗎？此操作無法復原。</p>
            <div class="mt-6 flex justify-end space-x-3">
                <button id="cancel-delete" class="bg-gray-200 hover:bg-gray-300 font-bold py-2 px-4 rounded-lg">取消</button>
                <button id="confirm-delete" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg w-24 text-center">確認</button>
            </div>
        </div>
    </div>
    <div id="edit-modal" class="modal-hidden fixed inset-0 bg-gray-600 bg-opacity-50 h-full w-full flex items-center justify-center p-4">
        <div class="bg-white p-6 rounded-lg shadow-xl w-11/12 max-w-2xl">
            <h3 class="text-lg font-bold mb-4">編輯日記</h3>
            <input type="hidden" id="edit-entry-id">
             <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div>
                     <label for="edit-entry-date" class="block text-sm font-bold mb-2">日期</label>
                     <input type="date" id="edit-entry-date" class="border-gray-300 rounded-lg w-full">
                </div>
                 <div>
                    <label for="edit-entry-tags" class="block text-sm font-bold mb-2">標籤</label>
                    <input type="text" id="edit-entry-tags" class="border-gray-300 rounded-lg w-full">
                </div>
            </div>
            <div>
                <label for="edit-diary-entry" class="block text-sm font-bold mb-2">內容</label>
                <textarea id="edit-diary-entry" rows="12" class="border-gray-300 rounded-lg w-full"></textarea>
            </div>
            <div class="mt-6 flex justify-end space-x-3">
                <button id="cancel-edit" class="bg-gray-200 hover:bg-gray-300 font-bold py-2 px-4 rounded-lg">取消</button>
                <button id="save-edit" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg w-24 text-center">儲存</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, deleteDoc, updateDoc, onSnapshot, collection, query, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase 設定 ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'giono-diary-app';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // --- App 狀態 ---
        let db, auth, userId = null, diariesCollectionRef = null, unsubscribe = null;
        let allEntries = []; // 儲存所有日記，用於客戶端篩選
        let searchTerm = '';
        let activeTag = '';

        // --- DOM 元素 ---
        const entryDate = document.getElementById('entry-date'), entryTags = document.getElementById('entry-tags'), diaryEntry = document.getElementById('diary-entry');
        const saveButton = document.getElementById('save-entry'), messageBox = document.getElementById('message-box'), entriesContainer = document.getElementById('entries-container');
        const loadingContainer = document.getElementById('loading-container'), userIdElement = document.getElementById('user-id'), charCounter = document.getElementById('char-counter');
        const searchBox = document.getElementById('search-box'), activeFilterContainer = document.getElementById('active-filter-container');
        const deleteModal = document.getElementById('delete-modal'), confirmDeleteBtn = document.getElementById('confirm-delete'), cancelDeleteBtn = document.getElementById('cancel-delete');
        const editModal = document.getElementById('edit-modal'), cancelEditBtn = document.getElementById('cancel-edit'), saveEditBtn = document.getElementById('save-edit');

        function initialize() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                setLogLevel('debug');
                setupAuthListener();
                setupEventListeners();
                setDefaultDate();
            } catch (error) {
                console.error("Firebase 初始化失敗:", error);
                displayMessage("應用程式初始化失敗。", "error");
                loadingContainer.innerHTML = '<p class="text-red-500">無法載入日記。</p>';
            }
        }

        async function setupAuthListener() {
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    userIdElement.textContent = userId;
                    diariesCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/diaries`);
                    listenForEntries();
                } else {
                    userId = null;
                    if (unsubscribe) unsubscribe();
                    entriesContainer.innerHTML = '<p class="text-center text-gray-500">請先登入以查看日記。</p>';
                    loadingContainer.style.display = 'none';
                    try {
                        if (initialAuthToken) await signInWithCustomToken(auth, initialAuthToken);
                        else await signInAnonymously(auth);
                    } catch (error) { console.error("登入失敗:", error); }
                }
            });
        }

        function setupEventListeners() {
            saveButton.addEventListener('click', saveEntry);
            diaryEntry.addEventListener('input', () => charCounter.textContent = `${diaryEntry.value.length} 字`);
            searchBox.addEventListener('input', (e) => {
                searchTerm = e.target.value;
                activeTag = '';
                filterAndRenderEntries();
            });
            entriesContainer.addEventListener('click', handleEntryClick);
            cancelDeleteBtn.addEventListener('click', () => deleteModal.classList.add('modal-hidden'));
            confirmDeleteBtn.addEventListener('click', handleDeleteConfirmation);
            cancelEditBtn.addEventListener('click', () => editModal.classList.add('modal-hidden'));
            saveEditBtn.addEventListener('click', handleSaveEdit);
        }

        function handleEntryClick(e) {
            const target = e.target;
            const deleteBtn = target.closest('.delete-btn');
            const editBtn = target.closest('.edit-btn');
            const tagBtn = target.closest('.tag-btn');

            if (deleteBtn) {
                const entryIdToDelete = deleteBtn.getAttribute('data-id');
                deleteModal.setAttribute('data-id', entryIdToDelete);
                deleteModal.classList.remove('modal-hidden');
                return;
            }

            if (editBtn) {
                const id = editBtn.getAttribute('data-id');
                const entry = allEntries.find(en => en.id === id);
                if (entry) {
                    document.getElementById('edit-entry-id').value = entry.id;
                    document.getElementById('edit-entry-date').value = entry.date;
                    document.getElementById('edit-entry-tags').value = entry.tags ? entry.tags.join(', ') : '';
                    document.getElementById('edit-diary-entry').value = entry.content;
                    editModal.classList.remove('modal-hidden');
                }
                return;
            }

            if (tagBtn) {
                activeTag = tagBtn.getAttribute('data-tag');
                searchTerm = ''; 
                searchBox.value = '';
                filterAndRenderEntries();
                return;
            }
        }

        function setDefaultDate() {
            entryDate.value = new Date().toISOString().slice(0, 10);
        }

        function displayMessage(message, type = "success") {
            messageBox.textContent = message;
            messageBox.className = 'mt-4 text-center text-sm font-medium ' + (type === 'error' ? 'text-red-500' : 'text-green-600');
            setTimeout(() => messageBox.textContent = '', 3000);
        }
        
        async function saveEntry() {
            if (!userId) return displayMessage("尚未登入，無法儲存。", "error");
            const date = entryDate.value, content = diaryEntry.value.trim();
            if (!date || !content) return displayMessage("日期和內容不能為空！", "error");
            
            const tags = entryTags.value.split(',').map(tag => tag.trim()).filter(Boolean);

            saveButton.disabled = true; saveButton.textContent = "儲存中...";
            try {
                await addDoc(diariesCollectionRef, { date, content, tags, createdAt: new Date().toISOString() });
                displayMessage("日記儲存成功！");
                diaryEntry.value = ''; entryTags.value = ''; charCounter.textContent = '0 字';
            } catch (error) {
                console.error("儲存失敗:", error);
                displayMessage("儲存失敗。", "error");
            } finally {
                saveButton.disabled = false; saveButton.textContent = "儲存日記";
            }
        }

        function listenForEntries() {
            if (!diariesCollectionRef) return;
            if (unsubscribe) unsubscribe();

            loadingContainer.style.display = 'flex';
            const q = query(diariesCollectionRef);
            unsubscribe = onSnapshot(q, (snapshot) => {
                loadingContainer.style.display = 'none';
                allEntries = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                allEntries.sort((a, b) => new Date(b.date) - new Date(a.date));
                filterAndRenderEntries();
            }, (error) => {
                console.error("監聽日記失敗:", error);
                loadingContainer.innerHTML = '<p class="text-red-500">讀取日記時發生錯誤。</p>';
            });
        }
        
        function filterAndRenderEntries() {
            let entriesToRender = [...allEntries];
            let filterMessage = '';

            if (searchTerm) {
                const lowerCaseSearch = searchTerm.toLowerCase();
                entriesToRender = entriesToRender.filter(entry => entry.content.toLowerCase().includes(lowerCaseSearch));
                filterMessage = `搜尋結果為 "<strong>${escapeHTML(searchTerm)}</strong>"`;
            } else if (activeTag) {
                entriesToRender = entriesToRender.filter(entry => entry.tags && entry.tags.includes(activeTag));
                filterMessage = `篩選標籤：<span class="inline-block bg-indigo-100 text-indigo-800 text-xs font-semibold mr-2 px-2.5 py-0.5 rounded-full">${escapeHTML(activeTag)}</span>`;
            }

            if (filterMessage) {
                 activeFilterContainer.innerHTML = `${filterMessage} <button id="clear-filter" class="ml-2 text-indigo-600 hover:underline">清除篩選</button>`;
                 document.getElementById('clear-filter').addEventListener('click', () => {
                     searchTerm = ''; searchBox.value = ''; activeTag = '';
                     filterAndRenderEntries();
                 });
            } else {
                activeFilterContainer.innerHTML = '';
            }

            renderEntries(entriesToRender);
        }

        function renderEntries(entries) {
            if (entries.length === 0) {
                entriesContainer.innerHTML = `<div class="text-center py-10 bg-white rounded-lg shadow">
                    <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                    <h3 class="mt-2 text-sm font-medium text-gray-900">沒有符合的日記</h3>
                    <p class="mt-1 text-sm text-gray-500">${(searchTerm || activeTag) ? '請嘗試不同的關鍵字或清除篩選。' : '開始寫下你的第一篇日記吧！'}</p>
                </div>`;
                return;
            }

            entriesContainer.innerHTML = '';
            entries.forEach(entry => {
                const entryElement = document.createElement('div');
                entryElement.className = 'bg-white rounded-lg shadow p-6 transition-shadow duration-300 hover:shadow-xl';

                const tagsHTML = (entry.tags && entry.tags.length > 0)
                    ? entry.tags.map(tag => `<button class="tag-btn inline-block bg-indigo-100 hover:bg-indigo-200 text-indigo-800 text-xs font-semibold mr-2 px-2.5 py-0.5 rounded-full" data-tag="${escapeHTML(tag)}">${escapeHTML(tag)}</button>`).join('')
                    : '';

                const cleanHTML = DOMPurify.sanitize(marked.parse(entry.content));

                entryElement.innerHTML = `
                    <div class="flex justify-between items-start mb-3">
                        <div>
                            <p class="font-bold text-xl text-indigo-700">${entry.date}</p>
                            <p class="text-xs text-gray-400">建立於: ${new Date(entry.createdAt).toLocaleString('zh-TW')}</p>
                        </div>
                        <div class="flex space-x-2">
                            <button data-id="${entry.id}" class="edit-btn text-gray-400 hover:text-blue-500 p-1 rounded-full"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg></button>
                            <button data-id="${entry.id}" class="delete-btn text-gray-400 hover:text-red-500 p-1 rounded-full"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg></button>
                        </div>
                    </div>
                    <div class="mb-4">${tagsHTML}</div>
                    <div class="rendered-markdown text-gray-700">${cleanHTML}</div>`;
                
                entriesContainer.appendChild(entryElement);
            });
        }
        
        async function handleDeleteConfirmation() {
            const id = deleteModal.getAttribute('data-id');
            if (!id || !userId) return;

            const originalText = confirmDeleteBtn.textContent;
            confirmDeleteBtn.disabled = true;
            cancelDeleteBtn.disabled = true;
            confirmDeleteBtn.innerHTML = `<div class="spinner btn-spinner mx-auto" style="width: 20px; height: 20px; border-width: 2px;"></div>`;

            try {
                await deleteDoc(doc(db, `artifacts/${appId}/users/${userId}/diaries`, id));
                displayMessage("日記已刪除。");
            } catch (error) {
                console.error("刪除失敗:", error);
                displayMessage("刪除失敗，請稍後再試。", "error");
            } finally {
                confirmDeleteBtn.disabled = false;
                cancelDeleteBtn.disabled = false;
                confirmDeleteBtn.textContent = originalText;
                deleteModal.classList.add('modal-hidden');
            }
        }

        async function handleSaveEdit() {
            const id = document.getElementById('edit-entry-id').value;
            const date = document.getElementById('edit-entry-date').value;
            const content = document.getElementById('edit-diary-entry').value.trim();
            const tags = document.getElementById('edit-entry-tags').value.split(',').map(tag => tag.trim()).filter(Boolean);

            if (!id || !date || !content || !userId) {
                displayMessage("日期和內容不能為空！", "error");
                return;
            }
            
            const originalText = saveEditBtn.textContent;
            saveEditBtn.disabled = true;
            cancelEditBtn.disabled = true;
            saveEditBtn.innerHTML = `<div class="spinner btn-spinner mx-auto" style="width: 20px; height: 20px; border-width: 2px;"></div>`;

            try {
                await updateDoc(doc(db, `artifacts/${appId}/users/${userId}/diaries`, id), { date, content, tags });
                displayMessage("變更已儲存。");
                editModal.classList.add('modal-hidden');
            } catch (error) {
                console.error("更新失敗:", error);
                displayMessage("更新失敗，請稍後再試。", "error");
            } finally {
                saveEditBtn.disabled = false;
                cancelEditBtn.disabled = false;
                saveEditBtn.textContent = originalText;
            }
        }

        function escapeHTML(str) {
            return str.replace(/[&<>'"]/g, tag => ({'&': '&amp;','<': '&lt;','>': '&gt;',"'": '&#39;','"': '&quot;'}[tag] || tag));
        }

        initialize();
    </script>
</body>
</html>

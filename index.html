<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>台北市旅館體驗地圖</title>

    <!-- LeafletJS CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- LeafletJS JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <style>
        /* Base styles */
        body { font-family: 'Inter', 'Noto Sans TC', sans-serif; }
        #map { 
            height: calc(100vh - 140px);
            width: 100%;
            cursor: default;
            position: relative;
        }
        #map.crosshair-cursor { cursor: crosshair !important; }

        /* Add-mode Banner */
        #add-mode-banner {
            display: none;
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            background-color: rgba(0, 0, 0, 0.75);
            color: white;
            padding: 8px 16px;
            border-radius: 9999px;
            font-size: 14px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        /* Popup styles */
        .leaflet-popup-content-wrapper { border-radius: 8px; padding: 0; overflow: hidden; }
        .leaflet-popup-content { margin: 0; font-size: 14px; line-height: 1.6; width: 320px !important; }
        .hotel-popup .popup-image { width: 100%; height: 140px; object-fit: cover; }
        .hotel-popup .popup-content-container { padding: 12px; }
        .hotel-popup .header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 4px; }
        .hotel-popup .name-price { display: flex; align-items: center; gap: 8px; }
        .hotel-popup h3 { font-size: 1.1rem; font-weight: bold; color: #1a202c; }
        .hotel-popup .price-range { font-size: 0.9rem; font-weight: 600; color: #4b5563; }
        .hotel-popup .category-badge { font-size: 11px; font-weight: 600; padding: 2px 8px; border-radius: 9999px; color: white; white-space: nowrap; }
        
        .hotel-popup .pros-cons-container { margin-top: 8px; margin-bottom: 12px; padding-bottom: 12px; border-bottom: 1px solid #e5e7eb; }
        .hotel-popup .pros, .hotel-popup .cons { margin-bottom: 8px; }
        .hotel-popup .pros-cons-title { display: flex; align-items: center; gap: 6px; font-weight: bold; margin-bottom: 4px; }
        .hotel-popup .pros .pros-cons-title { color: #16a34a; }
        .hotel-popup .cons .pros-cons-title { color: #ef4444; }
        .hotel-popup .pros-cons-text { font-size: 13px; color: #4a5568; padding-left: 20px; word-break: break-word; }

        .hotel-popup .ratings-section-title { font-weight: bold; color: #374151; margin-top: 12px; margin-bottom: 8px; }
        .hotel-popup .ratings-grid { display: grid; grid-template-columns: auto 1fr; gap: 6px 12px; align-items: center; font-size: 13px; }
        .hotel-popup .rating-label { color: #6b7280; display: flex; align-items: center; gap: 6px; }
        .hotel-popup .rating-stars { color: #f59e0b; letter-spacing: 2px; }

        .hotel-popup .popup-actions { margin-top: 12px; border-top: 1px solid #e5e7eb; padding-top: 8px; display: flex; justify-content: flex-end; gap: 8px; flex-wrap: wrap; }
        .hotel-popup .popup-actions button, .hotel-popup .popup-actions a { display: inline-flex; align-items: center; gap: 4px; background: none; border: none; cursor: pointer; font-size: 12px; padding: 4px 8px; border-radius: 4px; transition: background-color 0.2s; text-decoration: none; }
        .hotel-popup .popup-actions .share-btn { color: #16a34a; }
        .hotel-popup .popup-actions .share-btn:hover { background-color: #dcfce7; }
        .hotel-popup .popup-actions .map-btn { color: #0284c7; }
        .hotel-popup .popup-actions .map-btn:hover { background-color: #e0f2fe; }
        .hotel-popup .popup-actions .edit-btn { color: #3b82f6; }
        .hotel-popup .popup-actions .edit-btn:hover { background-color: #dbeafe; }
        .hotel-popup .popup-actions .delete-btn { color: #ef4444; }
        .hotel-popup .popup-actions .delete-btn:hover { background-color: #fee2e2; }

        /* Form styles */
        .form-section-title { font-size: 1rem; font-weight: bold; color: #374151; margin-top: 1.5rem; margin-bottom: 0.5rem; padding-bottom: 0.25rem; border-bottom: 1px solid #e5e7eb; }
        .rating-input-group { margin-bottom: 1rem; }
        .rating-input-group > label { display: flex; align-items: center; gap: 6px; }
        .rating-input { display: flex; flex-direction: row-reverse; justify-content: flex-end; }
        .rating-input input { display: none; }
        .rating-input label { color: #d1d5db; font-size: 1.75rem; cursor: pointer; transition: color 0.2s; }
        .rating-input input:checked ~ label,
        .rating-input label:hover,
        .rating-input label:hover ~ label { color: #f59e0b; }
    </style>
</head>
<body class="bg-gray-100 font-sans">

    <header class="bg-white shadow-md w-full p-4 h-[80px] flex items-center justify-center">
        <h1 class="text-2xl font-bold text-gray-800">台北市旅館體驗地圖</h1>
    </header>

    <div class="bg-gray-50 p-4 h-[60px] flex items-center justify-center flex-wrap gap-4 shadow-inner">
        <input type="search" id="search-box" placeholder="搜尋旅館名稱..." class="px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 flex-grow sm:flex-grow-0 sm:w-1/4">
        <select id="rating-filter" class="px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
            <option value="0">顯示全部評分</option>
            <option value="4">4星以上</option>
            <option value="3">3星以上</option>
        </select>
        <select id="category-filter" class="px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
            <!-- Categories will be populated by JS -->
        </select>
        <button id="add-hotel-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-300">
            新增評價
        </button>
    </div>

    <main class="w-full relative">
        <div id="map" class="z-0">
            <div id="add-mode-banner">請在地圖上選擇位置以新增評價</div>
        </div>
    </main>

    <!-- Modal Form (for Add/Edit) -->
    <div id="form-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 flex items-center justify-center">
        <div class="bg-white p-8 rounded-lg shadow-xl w-11/12 md:w-1/2 lg:w-2/5 max-h-[90vh] overflow-y-auto">
            <h2 id="form-title" class="text-xl font-bold mb-6">新增旅館評價</h2>
            <form id="hotel-form">
                <input type="hidden" id="hotel-id" name="hotel-id">
                
                <h3 class="form-section-title">基本資訊</h3>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="hotel-name" class="block text-gray-700 text-sm font-bold mb-2">旅館名稱</label>
                        <input type="text" id="hotel-name" name="hotel-name" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                    </div>
                    <div>
                         <label for="hotel-image-url" class="block text-gray-700 text-sm font-bold mb-2">圖片網址</label>
                        <input type="url" id="hotel-image-url" name="hotel-image-url" placeholder="https://example.com/image.jpg" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                    </div>
                    <div class="sm:col-span-1">
                        <label for="hotel-category" class="block text-gray-700 text-sm font-bold mb-2">旅館分類</label>
                        <select id="hotel-category" name="hotel-category" class="shadow border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                        </select>
                    </div>
                    <div class="sm:col-span-1">
                        <label for="hotel-price" class="block text-gray-700 text-sm font-bold mb-2">價格範圍</label>
                        <select id="hotel-price" name="hotel-price" class="shadow border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                            <option value="" disabled selected>選擇</option>
                            <option value="$">$</option>
                            <option value="$$">$$</option>
                            <option value="$$$">$$$</option>
                            <option value="$$$$">$$$$</option>
                        </select>
                    </div>
                </div>
                <div class="mb-4">
                    <label for="hotel-pros" class="block text-green-600 text-sm font-bold mb-2">優點 (Pros)</label>
                    <textarea id="hotel-pros" name="hotel-pros" rows="3" placeholder="每點一行，例如：&#10;- 房間乾淨&#10;- 服務親切" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"></textarea>
                </div>
                <div class="mb-4">
                    <label for="hotel-cons" class="block text-red-600 text-sm font-bold mb-2">缺點 (Cons)</label>
                    <textarea id="hotel-cons" name="hotel-cons" rows="3" placeholder="每點一行，例如：&#10;- 隔音不佳&#10;- 早餐普通" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"></textarea>
                </div>

                <div id="ratings-container-quality"></div>
                <div id="ratings-container-couple"></div>

                <div class="flex items-center justify-end gap-4 mt-8">
                    <button id="cancel-btn" type="button" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg transition-colors">取消</button>
                    <button type="submit" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg transition-colors">儲存</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Custom Confirm Modal -->
    <div id="confirm-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-[60] flex items-center justify-center">
        <div class="bg-white p-6 rounded-lg shadow-xl w-11/12 sm:w-1/3 text-center">
            <h3 class="text-lg font-bold mb-4">確認刪除</h3>
            <p class="text-gray-600 mb-6">您確定要刪除這筆評價嗎？此操作無法復原。</p>
            <div class="flex justify-center gap-4">
                <button id="confirm-cancel-btn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-6 rounded-lg">取消</button>
                <button id="confirm-ok-btn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-6 rounded-lg">確定</button>
            </div>
        </div>
    </div>

    <script>
        // --- DOM Elements ---
        const mapElement = document.getElementById('map');
        const addHotelBtn = document.getElementById('add-hotel-btn');
        const searchBox = document.getElementById('search-box');
        const ratingFilter = document.getElementById('rating-filter');
        const categoryFilter = document.getElementById('category-filter');
        const addModeBanner = document.getElementById('add-mode-banner');
        // Modals & Forms
        const formModal = document.getElementById('form-modal');
        const hotelForm = document.getElementById('hotel-form');
        const cancelBtn = document.getElementById('cancel-btn');
        const formTitle = document.getElementById('form-title');
        const hotelIdInput = document.getElementById('hotel-id');
        const ratingsContainerQuality = document.getElementById('ratings-container-quality');
        const ratingsContainerCouple = document.getElementById('ratings-container-couple');
        const hotelCategorySelect = document.getElementById('hotel-category');
        const confirmModal = document.getElementById('confirm-modal');
        const confirmOkBtn = document.getElementById('confirm-ok-btn');
        const confirmCancelBtn = document.getElementById('confirm-cancel-btn');


        // --- State Management & Constants ---
        let newHotelCoords = null;
        let hotels = [];
        let confirmCallback = null;
        let isAddMode = false;
        const LOCAL_STORAGE_KEY = 'taipeiHotels';
        
        const QUALITY_RATINGS = [
            { id: 'cleanliness', name: '房間清潔度' },
            { id: 'privacy', name: '隱私性' },
            { id: 'security', name: '安全性' },
            { id: 'network', name: '網路速度' },
            { id: 'service', name: '員工服務' },
        ];

        const COUPLE_RATINGS = [
            { id: 'atmosphere', name: '浪漫氛圍' },
            { id: 'facilities_couple', name: '私密設施' },
            { id: 'creativity', name: '房型創意' },
        ];

        const HOTEL_CATEGORIES = {
            "情侶專用": "bg-pink-500", "設計旅店": "bg-purple-500",
            "豪華享受": "bg-red-500", "溫泉度假": "bg-yellow-500",
            "商務旅行": "bg-blue-500", "家庭親子": "bg-green-500"
        };
        const PRICE_RANGES = ["$", "$$", "$$$", "$$$$"];


        // --- Initial Data (fallback) ---
        const initialHotels = [
            { id: 10, name: "台北悠趣旅店 (小巨蛋館)", imageUrl: "https://placehold.co/600x400/ec4899/ffffff?text=Urtrip", category: "情侶專用", price: "$$", lat: 25.0510, lng: 121.5500, pros: "- 房間簡約舒適\n- 部分可享市景\n- 適合尋找安靜私密的短暫休息空間", cons: "", rating_cleanliness: 4, rating_privacy: 4, rating_security: 4, rating_network: 4, rating_service: 4, rating_atmosphere: 3, rating_facilities_couple: 2, rating_creativity: 2 },
            { id: 11, name: "台北碩美精品旅店", imageUrl: "https://placehold.co/600x400/ec4899/ffffff?text=Bstay", category: "情侶專用", price: "$$", lat: 25.0660, lng: 121.5230, pros: "- 低調設計\n- 部分房型有浴缸\n- 交通便利", cons: "", rating_cleanliness: 4, rating_privacy: 3, rating_security: 4, rating_network: 4, rating_service: 4, rating_atmosphere: 4, rating_facilities_couple: 3, rating_creativity: 3 },
            { id: 12, name: "晴悅旅店", imageUrl: "https://placehold.co/600x400/ec4899/ffffff?text=Sunroute", category: "情侶專用", price: "$$", lat: 25.0620, lng: 121.5210, pros: "- 評價極高\n- 房間乾淨安靜", cons: "", rating_cleanliness: 5, rating_privacy: 4, rating_security: 4, rating_network: 4, rating_service: 5, rating_atmosphere: 3, rating_facilities_couple: 2, rating_creativity: 2 },
            { id: 13, name: "Stay Inn Taipei", imageUrl: "https://placehold.co/600x400/ec4899/ffffff?text=Stay+Inn", category: "情侶專用", price: "$", lat: 25.0478, lng: 121.5173, pros: "- 地點優越\n- 房型舒適", cons: "", rating_cleanliness: 4, rating_privacy: 3, rating_security: 3, rating_network: 4, rating_service: 3, rating_atmosphere: 3, rating_facilities_couple: 1, rating_creativity: 2 },
            { id: 14, name: "雀客旅館 - 台北南京", imageUrl: "https://placehold.co/600x400/ec4899/ffffff?text=Check+Inn", category: "設計旅店", price: "$$", lat: 25.0520, lng: 121.5450, pros: "- 交通方便\n- 設計新穎", cons: "", rating_cleanliness: 4, rating_privacy: 3, rating_security: 4, rating_network: 5, rating_service: 4, rating_atmosphere: 4, rating_facilities_couple: 2, rating_creativity: 4 },
            { id: 15, name: "Wego Motel Taipei", imageUrl: "https://placehold.co/600x400/ec4899/ffffff?text=Wego", category: "情侶專用", price: "$$$", lat: 25.0570, lng: 121.5260, pros: "- 知名情侶汽車旅館\n- 主題房型多、私密性高", cons: "", rating_cleanliness: 4, rating_privacy: 5, rating_security: 5, rating_network: 4, rating_service: 4, rating_atmosphere: 5, rating_facilities_couple: 5, rating_creativity: 5 },
            { id: 16, name: "大地清旅 Horizon Inn", imageUrl: "https://placehold.co/600x400/ec4899/ffffff?text=Horizon+Inn", category: "商務旅行", price: "$$", lat: 25.0540, lng: 121.5330, pros: "- 房間簡潔舒適\n- 早餐用心", cons: "", rating_cleanliness: 5, rating_privacy: 3, rating_security: 4, rating_network: 4, rating_service: 5, rating_atmosphere: 3, rating_facilities_couple: 1, rating_creativity: 2 },
            { id: 17, name: "CityInn Hotel Taipei Station Branch II", imageUrl: "https://placehold.co/600x400/ec4899/ffffff?text=CityInn", category: "設計旅店", price: "$$", lat: 25.0480, lng: 121.5150, pros: "- 色彩活潑、氣氛輕鬆\n- LGBTQ+友善", cons: "- 房間空間較小", rating_cleanliness: 4, rating_privacy: 3, rating_security: 4, rating_network: 4, rating_service: 5, rating_atmosphere: 4, rating_facilities_couple: 1, rating_creativity: 4 },
            { id: 18, name: "探索汽車旅館-延平館", imageUrl: "https://placehold.co/600x400/ec4899/ffffff?text=Explore+Motel", category: "情侶專用", price: "$$", lat: 25.0680, lng: 121.5120, pros: "- 汽車旅館型態，房型多元\n- 私密空間", cons: "", rating_cleanliness: 3, rating_privacy: 5, rating_security: 4, rating_network: 3, rating_service: 3, rating_atmosphere: 4, rating_facilities_couple: 4, rating_creativity: 4 },
            { id: 19, name: "千彩格精品旅店", imageUrl: "https://placehold.co/600x400/ec4899/ffffff?text=Colors+Inn", category: "設計旅店", price: "$$", lat: 25.0440, lng: 121.5110, pros: "- 空間溫馨，氣氛安靜\n- 適合小憩與享受咖啡時光", cons: "", rating_cleanliness: 4, rating_privacy: 4, rating_security: 4, rating_network: 4, rating_service: 4, rating_atmosphere: 4, rating_facilities_couple: 2, rating_creativity: 3 },
            { id: 20, name: "詩漫精品旅館", imageUrl: "https://placehold.co/600x400/ec4899/ffffff?text=Smile+Inn", category: "情侶專用", price: "$", lat: 25.0470, lng: 121.5130, pros: "- 現代簡約風格\n- 地點便利", cons: "", rating_cleanliness: 4, rating_privacy: 3, rating_security: 3, rating_network: 4, rating_service: 3, rating_atmosphere: 3, rating_facilities_couple: 1, rating_creativity: 2 },
            { id: 21, name: "Star Hostel Taipei East", imageUrl: "https://placehold.co/600x400/ec4899/ffffff?text=Star+Hostel", category: "情侶專用", price: "$", lat: 25.0460, lng: 121.5500, pros: "- 提供私人房型，氣氛溫馨\n- 適合年輕情侶短暫停留", cons: "- 隔音可能較差", rating_cleanliness: 4, rating_privacy: 3, rating_security: 4, rating_network: 5, rating_service: 5, rating_atmosphere: 3, rating_facilities_couple: 1, rating_creativity: 2 },
            { id: 22, name: "謙匯普樂室行旅", imageUrl: "https://placehold.co/600x400/ec4899/ffffff?text=Placio", category: "商務旅行", price: "$$", lat: 25.0525, lng: 121.5218, pros: "- 房間簡單舒適\n- 交通便利", cons: "", rating_cleanliness: 4, rating_privacy: 3, rating_security: 4, rating_network: 4, rating_service: 4, rating_atmosphere: 2, rating_facilities_couple: 1, rating_creativity: 2 },
            { id: 23, name: "Hotel Fun", imageUrl: "https://placehold.co/600x400/ec4899/ffffff?text=Hotel+Fun", category: "設計旅店", price: "$$", lat: 25.0600, lng: 121.5200, pros: "- 設有遊戲空間\n- 適合喜歡輕鬆氛圍的情侶", cons: "", rating_cleanliness: 4, rating_privacy: 3, rating_security: 4, rating_network: 4, rating_service: 4, rating_atmosphere: 4, rating_facilities_couple: 2, rating_creativity: 4 },
            { id: 24, name: "Hub Hotel Songshan Inn", imageUrl: "https://placehold.co/600x400/ec4899/ffffff?text=Hub+Hotel", category: "情侶專用", price: "$$", lat: 25.0500, lng: 121.5780, pros: "- 專為愛侶設計\n- 氣氛私密", cons: "", rating_cleanliness: 4, rating_privacy: 4, rating_security: 4, rating_network: 4, rating_service: 4, rating_atmosphere: 5, rating_facilities_couple: 3, rating_creativity: 3 },
            { id: 25, name: "Hotel East Taipei", imageUrl: "https://placehold.co/600x400/ec4899/ffffff?text=Hotel+East", category: "設計旅店", price: "$$$", lat: 25.0480, lng: 121.5600, pros: "- 現代設計\n- 設有屋頂花園", cons: "", rating_cleanliness: 5, rating_privacy: 4, rating_security: 4, rating_network: 5, rating_service: 5, rating_atmosphere: 5, rating_facilities_couple: 2, rating_creativity: 4 },
            { id: 26, name: "探索汽車旅館-南港館", imageUrl: "https://placehold.co/600x400/ec4899/ffffff?text=Explore+Nangang", category: "情侶專用", price: "$$$", lat: 25.0550, lng: 121.6100, pros: "- 汽車旅館型態，房型多元\n- 高度隱私", cons: "", rating_cleanliness: 4, rating_privacy: 5, rating_security: 5, rating_network: 4, rating_service: 3, rating_atmosphere: 4, rating_facilities_couple: 4, rating_creativity: 4 },
            { id: 27, name: "Alper Motel", imageUrl: "https://placehold.co/600x400/ec4899/ffffff?text=Alper+Motel", category: "情侶專用", price: "$$$", lat: 25.0800, lng: 121.5500, pros: "- 時尚設計\n- 設有高級SPA", cons: "", rating_cleanliness: 5, rating_privacy: 5, rating_security: 5, rating_network: 4, rating_service: 4, rating_atmosphere: 5, rating_facilities_couple: 5, rating_creativity: 4 }
        ];


        // --- DATA MANAGEMENT ---
        function loadHotels() {
            try {
                const storedHotels = localStorage.getItem(LOCAL_STORAGE_KEY);
                hotels = storedHotels ? JSON.parse(storedHotels) : [...initialHotels];
                if (!storedHotels) saveHotels();
            } catch (e) { console.error("無法讀取本地儲存資料:", e); hotels = [...initialHotels]; }
        }
        function saveHotels() {
            try { localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(hotels)); } 
            catch (e) { console.error("無法儲存資料至本地:", e); }
        }

        // --- MAP & UI RENDERING ---
        const map = L.map('map').setView([25.0479, 121.5319], 13);
        const markersLayer = L.layerGroup().addTo(map);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: '© <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>' }).addTo(map);
        
        function calculateOverallRating(hotel) {
            const allRatings = [...QUALITY_RATINGS, ...COUPLE_RATINGS].map(cat => hotel[`rating_${cat.id}`] || 0);
            const validRatings = allRatings.filter(r => r > 0);
            if (validRatings.length === 0) return 0;
            const sum = validRatings.reduce((a, b) => a + b, 0);
            return (sum / validRatings.length);
        }

        function renderMarkers(hotelsToRender) {
            markersLayer.clearLayers();
            hotelsToRender.forEach(hotel => addHotelMarker(hotel));
        }
        
        function applyFilters() {
            const searchTerm = searchBox.value.toLowerCase();
            const minRating = parseFloat(ratingFilter.value);
            const selectedCategory = categoryFilter.value;
            
            const filteredHotels = hotels.filter(hotel => {
                const overallRating = calculateOverallRating(hotel);
                const nameMatch = hotel.name.toLowerCase().includes(searchTerm);
                const ratingMatch = overallRating >= minRating;
                const categoryMatch = selectedCategory === "all" || hotel.category === selectedCategory;
                return nameMatch && ratingMatch && categoryMatch;
            });
            renderMarkers(filteredHotels);
        }

        function createHotelIcon(rating) {
            let iconUrl;
            if (rating >= 4.5) iconUrl = 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-gold.png';
            else if (rating >= 3.5) iconUrl = 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png';
            else iconUrl = 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png';
            return new L.Icon({ iconUrl, shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png', iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41] });
        }
        
        function generateStarDisplay(rating) {
            const r = Math.round(rating);
            if (isNaN(r) || r <= 0) return '<span class="text-gray-400">未評分</span>';
            return '★'.repeat(r) + '☆'.repeat(5 - r);
        }

        function formatProsCons(text) {
            if (!text || text.trim() === '') return '';
            return text.split('\n').map(line => `<div>${line}</div>`).join('');
        }
        
        function addHotelMarker(hotel) {
            const overallRating = calculateOverallRating(hotel);
            const marker = L.marker([hotel.lat, hotel.lng], { icon: createHotelIcon(overallRating) }).addTo(markersLayer);
            
            const qualityRatingsHtml = QUALITY_RATINGS.map(cat => `<div class="col-span-2 grid grid-cols-2 items-center"><span class="rating-label">${cat.name}</span><span class="rating-stars" title="${hotel[`rating_${cat.id}`] || 0} / 5">${generateStarDisplay(hotel[`rating_${cat.id}`] || 0)}</span></div>`).join('');
            const coupleRatingsHtml = COUPLE_RATINGS.map(cat => `<div class="col-span-2 grid grid-cols-2 items-center"><span class="rating-label">${cat.name}</span><span class="rating-stars" title="${hotel[`rating_${cat.id}`] || 0} / 5">${generateStarDisplay(hotel[`rating_${cat.id}`] || 0)}</span></div>`).join('');

            const categoryColor = HOTEL_CATEGORIES[hotel.category] || 'bg-gray-400';
            const googleMapsUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(hotel.name)}`;

            const popupContent = `
                <div class="hotel-popup">
                    <img src="${hotel.imageUrl || 'https://placehold.co/600x400/cccccc/ffffff?text=無圖片'}" alt="${hotel.name}" class="popup-image" onerror="this.onerror=null;this.src='https://placehold.co/600x400/cccccc/ffffff?text=圖片載入失敗';">
                    <div class="popup-content-container">
                        <div class="header">
                             <div class="name-price"><h3>${hotel.name}</h3><span class="price-range">${hotel.price || ''}</span></div>
                            <span class="category-badge ${categoryColor}">${hotel.category}</span>
                        </div>
                        <div class="pros-cons-container">
                            ${hotel.pros ? `<div class="pros"><div class="pros-cons-title"><span>✔️</span>優點</div><div class="pros-cons-text">${formatProsCons(hotel.pros)}</div></div>` : ''}
                            ${hotel.cons ? `<div class="cons"><div class="pros-cons-title"><span>❌</span>缺點</div><div class="pros-cons-text">${formatProsCons(hotel.cons)}</div></div>` : ''}
                        </div>
                        <h4 class="ratings-section-title">住宿品質</h4>
                        <div class="ratings-grid">${qualityRatingsHtml}</div>
                        <h4 class="ratings-section-title">情侶專屬體驗</h4>
                        <div class="ratings-grid">${coupleRatingsHtml}</div>
                        <div class="popup-actions">
                            <button class="share-btn" data-id="${hotel.id}"><span>分享</span></button>
                            <a href="${googleMapsUrl}" target="_blank" rel="noopener noreferrer" class="map-btn"><span>Google搜尋</span></a>
                            <button class="edit-btn" data-id="${hotel.id}">編輯</button>
                            <button class="delete-btn" data-id="${hotel.id}">刪除</button>
                        </div>
                    </div>
                </div>`;
            marker.bindPopup(popupContent);
        }
        
        // --- FORM & MODAL LOGIC ---
        function openFormModal(hotelToEdit = null) {
            hotelForm.reset();
            if (hotelToEdit) {
                formTitle.textContent = '編輯旅館評價';
                hotelIdInput.value = hotelToEdit.id;
                document.getElementById('hotel-name').value = hotelToEdit.name;
                document.getElementById('hotel-image-url').value = hotelToEdit.imageUrl || '';
                document.getElementById('hotel-category').value = hotelToEdit.category;
                document.getElementById('hotel-price').value = hotelToEdit.price || '';
                document.getElementById('hotel-pros').value = hotelToEdit.pros || '';
                document.getElementById('hotel-cons').value = hotelToEdit.cons || '';

                [...QUALITY_RATINGS, ...COUPLE_RATINGS].forEach(cat => {
                    const ratingValue = hotelToEdit[`rating_${cat.id}`];
                    if (ratingValue) {
                        const radio = document.querySelector(`input[name="rating_${cat.id}"][value="${ratingValue}"]`);
                        if (radio) radio.checked = true;
                    }
                });
            } else {
                formTitle.textContent = '新增旅館評價';
                hotelIdInput.value = '';
            }
            formModal.classList.remove('hidden');
        }

        function showConfirmModal(callback) {
            confirmCallback = callback;
            confirmModal.classList.remove('hidden');
        }
        
        function hideConfirmModal() {
            confirmCallback = null;
            confirmModal.classList.add('hidden');
        }
        
        function enterAddMode() {
            isAddMode = true;
            addModeBanner.style.display = 'block';
            addHotelBtn.textContent = '取消新增';
            addHotelBtn.classList.replace('bg-blue-500', 'bg-red-500');
            addHotelBtn.classList.replace('hover:bg-blue-600', 'hover:bg-red-600');
            mapElement.classList.add('crosshair-cursor');
            map.once('click', handleMapClickForAdd);
        }

        function exitAddMode() {
            isAddMode = false;
            map.off('click', handleMapClickForAdd);
            addModeBanner.style.display = 'none';
            addHotelBtn.textContent = '新增評價';
            addHotelBtn.classList.replace('bg-red-500', 'bg-blue-500');
            addHotelBtn.classList.replace('hover:bg-red-600', 'hover:bg-blue-600');
            mapElement.classList.remove('crosshair-cursor');
        }
        
        // --- EVENT HANDLERS ---
        function handleAddButtonClick() {
            if (isAddMode) {
                exitAddMode();
            } else {
                enterAddMode();
            }
        }

        function handleMapClickForAdd(e) {
            newHotelCoords = e.latlng;
            openFormModal();
            exitAddMode();
        }
        
        function handleFormSubmit(e) {
            e.preventDefault();
            const formData = new FormData(hotelForm);
            const hotelId = formData.get('hotel-id');
            const hotelData = {
                name: formData.get('hotel-name'),
                imageUrl: formData.get('hotel-image-url'),
                category: formData.get('hotel-category'),
                price: formData.get('hotel-price'),
                pros: formData.get('hotel-pros'),
                cons: formData.get('hotel-cons'),
            };
            [...QUALITY_RATINGS, ...COUPLE_RATINGS].forEach(cat => { 
                const rating = formData.get(`rating_${cat.id}`);
                hotelData[`rating_${cat.id}`] = rating ? parseFloat(rating) : 0;
            });

            if (hotelId) {
                const hotelIndex = hotels.findIndex(h => h.id == hotelId);
                if (hotelIndex !== -1) hotels[hotelIndex] = { ...hotels[hotelIndex], ...hotelData };
            } else {
                hotelData.id = Date.now();
                hotelData.lat = newHotelCoords.lat;
                hotelData.lng = newHotelCoords.lng;
                hotels.push(hotelData);
            }
            saveHotels();
            applyFilters();
            formModal.classList.add('hidden');
        }
        
        function handleShareClick(hotelId, shareButton) {
            const hotel = hotels.find(h => h.id == hotelId);
            if (!hotel) return;
            const overallRating = calculateOverallRating(hotel);
            const shareText = `推薦一間旅館給你！\n\n旅館名稱：${hotel.name} (${hotel.price})\n總體評價：${generateStarDisplay(overallRating)}\n\n優點：\n${hotel.pros || '無'}\n\n缺點：\n${hotel.cons || '無'}`;
            const textarea = document.createElement('textarea');
            textarea.value = shareText;
            textarea.style.position = 'absolute';
            textarea.style.left = '-9999px';
            document.body.appendChild(textarea);
textarea.select();
            try {
                document.execCommand('copy');
                const originalText = shareButton.querySelector('span').textContent;
                shareButton.querySelector('span').textContent = '已複製！';
                setTimeout(() => { shareButton.querySelector('span').textContent = originalText; }, 2000);
            } catch (err) { console.error('無法複製文字: ', err); }
            document.body.removeChild(textarea);
        }
        
        function handleDeleteClick(hotelId) {
            showConfirmModal(() => {
                hotels = hotels.filter(h => h.id != hotelId);
                saveHotels();
                applyFilters();
                map.closePopup();
                hideConfirmModal();
            });
        }
        
        function handleEditClick(hotelId) {
            const hotel = hotels.find(h => h.id == hotelId);
            if(hotel) openFormModal(hotel);
        }

        // --- DYNAMIC CONTENT & EVENT LISTENERS SETUP ---
        function initialize() {
            // Populate category dropdowns
            const categoryOptions = ['<option value="all">顯示全部分類</option>', ...Object.keys(HOTEL_CATEGORIES).map(cat => `<option value="${cat}">${cat}</option>`)].join('');
            categoryFilter.innerHTML = categoryOptions;
            
            const formCategoryOptions = Object.keys(HOTEL_CATEGORIES).map(cat => `<option value="${cat}">${cat}</option>`).join('');
            hotelCategorySelect.innerHTML = `<option value="" disabled selected>請選擇分類</option>${formCategoryOptions}`;
        
            // Generate rating inputs dynamically
            const createRatingInputs = (categories) => categories.map(cat => `<div class="rating-input-group sm:col-span-1"><label class="block text-gray-700 text-sm font-bold mb-2">${cat.name}</label><div class="rating-input">${[5,4,3,2,1].map(num => `<input type="radio" id="star-${cat.id}-${num}" name="rating_${cat.id}" value="${num}"><label for="star-${cat.id}-${num}">★</label>`).join('')}</div></div>`).join('');
            
            ratingsContainerQuality.innerHTML = '<h3 class="form-section-title sm:col-span-2">住宿品質</h3>' + createRatingInputs(QUALITY_RATINGS);
            ratingsContainerCouple.innerHTML = '<h3 class="form-section-title sm:col-span-2">情侶專屬體驗</h3>' + createRatingInputs(COUPLE_RATINGS);

        
            // Main event listeners
            addHotelBtn.addEventListener('click', handleAddButtonClick);
            hotelForm.addEventListener('submit', handleFormSubmit);
            cancelBtn.addEventListener('click', () => formModal.classList.add('hidden'));
            searchBox.addEventListener('input', applyFilters);
            ratingFilter.addEventListener('change', applyFilters);
            categoryFilter.addEventListener('change', applyFilters);
            
            confirmOkBtn.addEventListener('click', () => { if(typeof confirmCallback === 'function') confirmCallback(); });
            confirmCancelBtn.addEventListener('click', hideConfirmModal);
            
            // Event delegation for popup buttons
            map.on('popupopen', (e) => {
                const popupNode = e.popup.getElement();
                popupNode.querySelector('.edit-btn')?.addEventListener('click', (ev) => handleEditClick(ev.target.dataset.id));
                popupNode.querySelector('.delete-btn')?.addEventListener('click', (ev) => handleDeleteClick(ev.target.dataset.id));
                popupNode.querySelector('.share-btn')?.addEventListener('click', (ev) => handleShareClick(ev.currentTarget.dataset.id, ev.currentTarget));
            });

            loadHotels();
            applyFilters();
        }
        
        initialize();

    </script>
</body>
</html>

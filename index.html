<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>創新問題解決工具</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; 
        }
        #diagram-render-area { 
            position: relative; 
            overflow: auto;
            padding: 0; 
            background-color: #fff; 
            border-radius: 0.5rem; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            min-height: 450px; 
            width: 100%; 
            -webkit-user-select: none; 
            -ms-user-select: none; 
            user-select: none; 
        }
        #scalable-content-wrapper {
            position: relative;
            transform-origin: top left;
            display: inline-block; 
            padding: 20px; 
            cursor: grab; 
        }
        #scalable-content-wrapper:active {
            cursor: grabbing;
        }
        #svg-connector-layer {
            position: absolute; 
            top: 20px; 
            left: 20px;
            pointer-events: none; 
            z-index: 0; 
        }
        #rca-diagram-container {
            display: inline-block; 
            text-align: center; 
            position: relative; 
            z-index: 1; 
        }

        .rca-node-wrapper {
            display: inline-flex; 
            flex-direction: column; 
            align-items: center; 
            margin: 0 1rem; 
            vertical-align: top; 
            transition: margin 0.3s ease-in-out, opacity 0.3s ease-in-out; 
        }
        .rca-node {
            border: 2px solid #4b5563; 
            padding: 0.6rem 1.1rem; 
            margin-top: 30px; 
            margin-bottom: 15px; 
            box-shadow: 0 2px 4px 0 rgba(0, 0, 0, 0.1);
            display: inline-flex; 
            flex-direction: column; 
            align-items: center; 
            max-width: 350px; 
            border-radius: 0.375rem; 
            position: relative;
            z-index: 1; 
            background-color: #ffffff; 
            overflow-wrap: break-word; 
            transition: opacity 0.3s ease-in-out, border-color 0.3s ease-in-out;
        }
        .rca-node.dimmed {
            opacity: 0.3;
        }
        .rca-node-content { 
            display: flex; 
            flex-direction: column; 
            gap: 0.4rem; 
            width: 100%; 
            align-items: center; 
        }
        .rca-node-header { 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            gap: 0.4rem; 
            width: 100%;
            position: relative; 
            margin-bottom: 0.25rem; 
        }
        .rca-node-icon {
            font-weight: bold; font-size: 0.85em; 
            padding: 0.2em 0.4em; border-radius: 50%; 
            color: white;
            position: absolute;
            top: 0.4rem; 
            right: 0.4rem;
            min-width: 22px; 
            height: 22px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid white; 
            box-shadow: 0 1px 2px rgba(0,0,0,0.2);
            z-index: 10; 
        }
        .node-badge { 
            font-size: 0.65em; font-weight: bold; color: #374151; 
            background-color: #e5e7eb; padding: 0.15rem 0.35rem; 
            border-radius: 0.25rem; 
            align-self: center; 
            margin-left: 0.25rem; 
        }
        .abc-badge {
            position: absolute;
            top: 0.4rem;
            left: 0.4rem;
            font-size: 0.7em;
            font-weight: bold;
            padding: 0.15em 0.4em;
            border-radius: 0.25rem;
            color: white;
            border: 1px solid white;
            box-shadow: 0 1px 2px rgba(0,0,0,0.2);
            z-index: 10;
        }
        .abc-badge-A { background-color: #ef4444; } 
        .abc-badge-B { background-color: #f97316; } 
        .abc-badge-C { background-color: #f59e0b; } 

        .rca-node-text { 
            font-weight: 500; 
            font-size: 0.9rem; 
            text-align: center; 
            overflow-wrap: break-word; 
            line-height: 1.4; 
            box-sizing: border-box; 
        }
        .rca-node:not(.rca-node-positive-effect):not(.rca-node-negative-effect) .rca-node-text {
            width: 9em; 
            padding-right: 2.5em; 
            padding-left: 1.5em; 
            display: inline-block; 
            vertical-align: middle;
        }
        .rca-node-positive-effect .rca-node-text,
        .rca-node-negative-effect .rca-node-text {
            display: block; 
            width: 100%;    
            padding-right: 3em; 
        }

        .selected-items-list { 
            font-size: 0.75rem; 
            color: #374151; 
            margin-top: 0.5rem; 
            padding-top: 0.375rem; 
            border-top: 1px dashed #d1d5db; 
            width: 100%; 
            text-align: left; 
        }
        .selected-items-list strong { 
            color: #111827; 
            display: block; 
            margin-bottom: 0.25rem; 
        }
        .selected-items-list ul { 
            list-style-type: disc; 
            margin-left: 1.25rem; 
            padding-left: 0.25rem; 
        } 
        .selected-items-list li { 
            margin-bottom: 0.25rem; 
        }
        .selected-items-list .solution-text { color: #059669; margin-left: 0.3rem; font-style: italic;}
        .engineering-param-display { font-size: 0.7rem; color: #4b5563; margin-top: 0.25rem; }
        .ideality-score-display { font-size: 0.7rem; color: #1d4ed8; margin-top: 0.25rem; font-weight: bold;}


        .rca-node-initial-problem { background-color: #fee2e2; border-color: #ef4444; }
        .rca-node-initial-problem .rca-node-icon { background-color: #ef4444; }
        .rca-node-cause { background-color: #fef9c3; border-color: #f59e0b; }
        .rca-node-cause .rca-node-icon.contradictory { background-color: #8b5cf6; }
        .rca-node-positive-effect { background-color: #dbeafe; border-color: #3b82f6; border-radius: 50px; padding: 0.6rem 1.2rem; }
        .rca-node-positive-effect .rca-node-icon { background-color: #2563eb; }
        .rca-node-negative-effect { background-color: #ffedd5; border-color: #f97316; border-radius: 50px; padding: 0.6rem 1.2rem; }
        .rca-node-negative-effect .rca-node-icon { background-color: #f97316; }

        .rca-children-container { 
            display: flex; 
            flex-direction: row; 
            justify-content: center; 
            align-items: flex-start; 
            margin-top: 15px; 
            position: relative; 
            padding-top: 25px; 
            width: max-content; 
        }
        
        .rca-node-actions { 
            display: flex; 
            flex-wrap: wrap; 
            gap: 0.25rem; 
            margin-top: 0.5rem; 
            border-top: 1px solid #e5e7eb; 
            padding-top: 0.5rem; 
            width: 100%; 
            justify-content: flex-start; 
        }
        .action-button { background-color: #6b7280; color: white; padding: 0.375rem 0.75rem; border-radius: 0.25rem; font-size: 0.75rem; border: none; cursor: pointer; transition: background-color 0.2s; }
        .action-button:hover:not(:disabled) { background-color: #4b5563; } .action-button:disabled { background-color: #9ca3af; cursor: not-allowed; }
        .action-button.add-cause { background-color: #3b82f6; } .action-button.add-cause:hover:not(:disabled) { background-color: #2563eb; }
        .action-button.add-positive { background-color: #10b981; } .action-button.add-positive:hover:not(:disabled) { background-color: #059669; }
        .action-button.add-negative { background-color: #f97316; } .action-button.add-negative:hover:not(:disabled) { background-color: #ea580c; }
        .action-button.toggle-nc { background-color: #a855f7; } .action-button.toggle-nc:hover:not(:disabled) { background-color: #9333ea; }
        .action-button.set-abc { background-color: #14b8a6; } 
        .action-button.set-abc:hover:not(:disabled) { background-color: #0d9488; }
        .action-button.set-triz { background-color: #ec4899; } 
        .action-button.set-triz:hover:not(:disabled) { background-color: #db2777; }
        .action-button.set-and-sources { background-color: #6d28d9; } .action-button.set-and-sources:hover:not(:disabled) { background-color: #5b21b6; }
        .action-button.edit-node { background-color: #f59e0b; } .action-button.edit-node:hover:not(:disabled) { background-color: #d97706; }
        .action-button.set-parameters { background-color: #0ea5e9; } .action-button.set-parameters:hover:not(:disabled) { background-color: #0284c7; }
        .action-button.finalize-diagram { background-color: #059669; } .action-button.finalize-diagram:hover:not(:disabled) { background-color: #047857; }
        .action-button.edit-diagram { background-color: #d97706; } .action-button.edit-diagram:hover:not(:disabled) { background-color: #b45309; }
        .remove-button { background-color: #ef4444; } .remove-button:hover:not(:disabled) { background-color: #dc2626; }
        
        .input-group-container { margin-top: 0.5rem; width: calc(100% - 1rem); }
        .input-group { display: flex; flex-direction: column; gap: 0.5rem; padding: 0.5rem; border: 1px solid #e5e7eb; border-radius: 0.25rem; background-color: #f9fafb; }
        .input-field, .select-field { border: 1px solid #d1d5db; padding: 0.5rem; border-radius: 0.25rem; font-size: 0.875rem; width: 100%; }
        .save-button { background-color: #065f46; color: white; } .save-button:hover:not(:disabled) { background-color: #047857; }
        .save-edit-button { background-color: #065f46; color: white; } .save-edit-button:hover:not(:disabled) { background-color: #047857; }

        .data-table-section { margin-top: 2rem; }
        .data-table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
        .data-table th, .data-table td { border: 1px solid #d1d5db; padding: 0.5rem; font-size: 0.875rem; text-align: center; vertical-align: middle; }
        .data-table th { background-color: #e5e7eb; font-weight: 600; }
        .data-table td { background-color: white; }
        .data-table td:first-child, .data-table th:first-child { text-align: left; }
        .data-table .abc-select { padding: 0.25rem; font-size: 0.8rem; border-radius: 0.25rem; border: 1px solid #d1d5db; }
        .data-table .ideality-assess-button { font-size: 0.75rem; padding: 0.25rem 0.5rem; }

        .modal { z-index: 50; } .modal-content { position: relative; } 
        .modal-close-button { position: absolute; top: 0.75rem; right: 0.75rem; background: none; border: none; font-size: 1.5rem; color: #6b7280; cursor: pointer; line-height: 1; }
        .modal-close-button:hover { color: #1f2937; }
        .modal-options-container { max-height: 60vh; overflow-y: auto; } 
        .modal-options-container label { cursor: pointer; display: block; margin-bottom: 0.25rem; }
        .modal-options-container h4 { font-weight:600; margin-top: 0.75rem; margin-bottom: 0.25rem; color: #374151; border-bottom: 1px solid #e5e7eb; padding-bottom: 0.25rem; }
        .modal-options-container h4:first-child { margin-top: 0; }
        .principle-solution-input { width: calc(100% - 2rem); margin-left: 1.5rem; margin-top: 0.25rem; margin-bottom: 0.5rem; padding: 0.25rem 0.5rem; border: 1px solid #d1d5db; border-radius: 0.25rem; font-size: 0.8rem; }
        
        .zoom-controls { display: flex; gap: 0.5rem; align-items: center; }
        .zoom-controls span { font-size: 0.875rem; color: #4b5563; min-width: 50px; text-align: center; }
        .dropdown { position: relative; display: inline-block; }
        .dropdown-content { display: none; position: absolute; background-color: #f9f9f9; min-width: 230px; box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2); z-index: 10; border-radius: 0.375rem; padding: 0.5rem 0; }
        .dropdown-content button, .dropdown-content label { color: black; padding: 0.75rem 1rem; text-decoration: none; display: block; text-align: left; background: none; border: none; width: 100%; font-size: 0.875rem; cursor: pointer; }
        .dropdown-content button:hover, .dropdown-content label:hover { background-color: #e5e7eb; }
        .dropdown-content button:disabled { color: #9ca3af; cursor: not-allowed; background-color: #f9f9f9; }
        .dropdown-content button i, .dropdown-content label i { margin-right: 0.5rem; width: 1.25rem; text-align: center; }
        .dropdown-trigger-button { background-color: #1f2937; }
        .dropdown-trigger-button:hover:not(:disabled) { background-color: #374151; }
        .abc-filter-button {
            padding: 0.5rem 1rem;
            border-radius: 0.25rem;
            font-size: 0.875rem;
            color: white;
            transition: background-color 0.2s;
        }
        .abc-filter-button.active {
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.2);
        }
        .solution-entry { border: 1px solid #e5e7eb; padding: 0.75rem; margin-bottom: 0.75rem; border-radius: 0.25rem; background-color: #f9fafb;}
        .solution-entry label { font-weight: 500; display: block; margin-bottom: 0.25rem;}

        /* Ideas Landscape Chart Styles */
        #ideas-landscape-controls { margin-bottom: 1rem; }
        #ideas-landscape-chart-container { position: relative; min-height: 300px; }
         #ideas-landscape-no-data-message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: #6b7280; 
            font-size: 0.875rem;
            padding: 1rem;
            background-color: #f9fafb; 
            border-radius: 0.375rem;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        .quadrant-label { /* Style for labels drawn by Chart.js plugin */ }
        
        /* Styles for Ideality Assessment Modal */
        .ideality-criterion { margin-bottom: 0.75rem; }
        .ideality-criterion label { display: block; font-size: 0.875rem; font-weight: 500; margin-bottom: 0.25rem; }
        .ideality-criterion input[type="number"], .ideality-criterion select { width: 100%; }
        .ideality-criterion input[type="range"] { width: calc(100% - 3.5rem); margin-right: 0.5rem; vertical-align: middle;}
        .ideality-criterion .range-value { font-size: 0.8rem; display: inline-block; width: 2.5rem; text-align: right;}

        /* Suggested Principles in TRIZ Modal */
        #suggested-principles-container {
            margin-top: 1rem;
            padding: 0.75rem;
            background-color: #f3f4f6; 
            border-radius: 0.375rem;
            border: 1px solid #e5e7eb; 
        }
        #suggested-principles-container h5 {
            font-size: 0.9rem;
            font-weight: 600;
            color: #374151; 
            margin-bottom: 0.5rem;
        }
        #suggested-principles-list {
            list-style-type: decimal;
            margin-left: 1.25rem;
            font-size: 0.85rem;
            color: #4b5563; 
        }
        #suggested-principles-list li {
            margin-bottom: 0.25rem;
        }
    </style>
</head>
<body class="p-4 md:p-8">
    <div class="container mx-auto max-w-7xl"> 
        <header class="mb-6 text-center">
            <h1 id="main-tool-title" class="text-2xl md:text-3xl font-bold text-gray-700">創新問題解決工具</h1>
            <p class="text-gray-500 mt-1">視覺化根本原因，支援衝突參數設定、發明原理應用、解決方案ABC分類、創意景觀圖與TRIZ理想性評估等功能。</p>
        </header>

        <section id="controls-section" class="mb-6 p-4 bg-white rounded-lg shadow">
             <div id="problem-input-area">
                <h2 class="text-xl font-semibold text-gray-700 mb-3">1. 設定主要負面效果</h2>
                <div class="flex flex-col sm:flex-row gap-2">
                    <input type="text" id="problem-statement-input" placeholder="輸入觀察到的主要負面效果" class="input-field flex-grow p-2 rounded-md border-gray-300 focus:ring-blue-500 focus:border-blue-500">
                    <button id="set-problem-button" class="action-button add-cause text-white font-semibold py-2 px-4 rounded-md">設定問題根源</button>
                </div>
            </div>
            <div id="tool-buttons" class="mt-4 flex flex-col gap-3">
                <div class="flex flex-wrap gap-2 justify-center items-center">
                    <div class="dropdown">
                        <button id="file-menu-button" class="action-button dropdown-trigger-button text-white font-semibold py-2 px-4 rounded-md">
                            <i class="fas fa-file-alt"></i> 檔案 <i class="fas fa-caret-down ml-1"></i>
                        </button>
                        <div id="file-dropdown-content" class="dropdown-content">
                            <button id="save-diagram-button"><i class="fas fa-save"></i> 儲存進度 (瀏覽器)</button>
                            <button id="load-diagram-button"><i class="fas fa-folder-open"></i> 載入進度 (瀏覽器)</button>
                            <button id="save-to-file-button"><i class="fas fa-file-download"></i> 儲存至檔案</button>
                            <label for="file-input-for-load" id="load-from-file-label"><i class="fas fa-file-upload"></i> 從檔案載入</label>
                            <input type="file" id="file-input-for-load" accept=".json" style="display: none;">
                        </div>
                    </div>
                    <button id="undo-button" class="action-button bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-md">
                        <i class="fas fa-undo"></i> 上一步
                    </button>
                    <button id="redo-button" class="action-button bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-md">
                        <i class="fas fa-redo"></i> 下一步
                    </button>
                    <div class="zoom-controls">
                        <button id="zoom-out-button" class="action-button bg-sky-500 hover:bg-sky-600 text-white font-semibold py-2 px-3 rounded-md" title="縮小"><i class="fas fa-search-minus"></i></button>
                        <span id="zoom-level-display">100%</span>
                        <button id="zoom-in-button" class="action-button bg-sky-500 hover:bg-sky-600 text-white font-semibold py-2 px-3 rounded-md" title="放大"><i class="fas fa-search-plus"></i></button>
                        <button id="reset-zoom-button" class="action-button bg-sky-500 hover:bg-sky-600 text-white font-semibold py-2 px-4 rounded-md">重設縮放</button>
                    </div>
                </div>
                <div class="flex flex-wrap gap-2 justify-center mt-2">
                    <div id="abc-cause-filter-controls" class="flex gap-2 items-center p-2 bg-gray-100 rounded-md">
                        <span class="text-sm font-medium text-gray-700 mr-1">原因ABC篩選:</span>
                        <button data-filter-type="cause" data-filter="all" class="abc-filter-button bg-gray-500 hover:bg-gray-600 active">全部</button>
                        <button data-filter-type="cause" data-filter="A" class="abc-filter-button bg-red-500 hover:bg-red-600">A類</button>
                        <button data-filter-type="cause" data-filter="B" class="abc-filter-button bg-orange-500 hover:bg-orange-600">B類</button>
                        <button data-filter-type="cause" data-filter="C" class="abc-filter-button bg-amber-500 hover:bg-amber-600">C類</button>
                        <button data-filter-type="cause" data-filter="AB" class="abc-filter-button bg-purple-500 hover:bg-purple-600">A+B類</button>
                        <button data-filter-type="cause" data-filter="none" class="abc-filter-button bg-slate-500 hover:bg-slate-600">未分類</button>
                    </div>
                </div>
                <div class="flex flex-wrap gap-2 justify-center mt-2">
                    <button id="finalize-diagram-button" class="action-button finalize-diagram text-white font-semibold py-2 px-4 rounded-md">完成圖表</button>
                    <button id="auto-adjust-layout-button" class="action-button bg-teal-500 hover:bg-teal-600 text-white font-semibold py-2 px-4 rounded-md">
                        <i class="fas fa-project-diagram"></i> 自動調整節點
                    </button>
                    <div class="dropdown">
                        <button id="export-menu-button" class="action-button dropdown-trigger-button bg-purple-500 hover:bg-purple-600 text-white font-semibold py-2 px-4 rounded-md">
                            <i class="fas fa-download"></i> 匯出 <i class="fas fa-caret-down ml-1"></i>
                        </button>
                        <div id="export-dropdown-content" class="dropdown-content">
                            <button id="export-png-button"><i class="fas fa-image"></i> 匯出圖檔 (PNG)</button>
                        </div>
                    </div>
                    <button id="toggle-cause-effect-table-button" class="action-button bg-cyan-500 hover:bg-cyan-600 text-white font-semibold py-2 px-4 rounded-md">顯示原因效果表</button>
                    <button id="toggle-solution-table-button" class="action-button bg-indigo-500 hover:bg-indigo-600 text-white font-semibold py-2 px-4 rounded-md">顯示潛在解決方案表</button>
                    <button id="toggle-ideas-landscape-button" class="action-button bg-pink-500 hover:bg-pink-600 text-white font-semibold py-2 px-4 rounded-md">顯示創意景觀圖</button>
                </div>
            </div>
        </section>

        <section id="rca-diagram-section" class="bg-white p-0 md:p-0 rounded-lg shadow min-h-[400px]">
            <h2 class="text-xl font-semibold text-gray-700 my-4 text-center" id="diagram-title" style="display: none;">2. RCA+ 分析圖</h2>
            <div id="diagram-render-area"> 
                <div id="scalable-content-wrapper">
                    <div id="rca-diagram-container"></div> 
                    <svg id="svg-connector-layer"></svg>
                </div>
            </div>
        </section>

        <section id="cause-effect-table-section" style="display: none;" class="data-table-section bg-white p-4 md:p-6 rounded-lg shadow">
            <h2 class="text-xl font-semibold text-gray-700 mb-3">3. 原因效果表</h2>
            <table class="data-table">
                <thead> <tr><th>原因</th><th>ABC分類</th><th>原因類型</th><th>正面效果</th><th>負面效果</th></tr> </thead>
                <tbody id="cause-effect-table-body"></tbody>
            </table>
        </section>

        <section id="solution-table-section" style="display: none;" class="data-table-section bg-white p-4 md:p-6 rounded-lg shadow">
            <div class="flex justify-between items-center mb-3">
                <h2 class="text-xl font-semibold text-gray-700">4. 潛在解決方案表 (TRIZ應用)</h2>
                <div id="abc-solution-filter-controls" class="flex gap-1 items-center p-1 bg-gray-100 rounded-md">
                    <span class="text-xs font-medium text-gray-600 mr-1">方案ABC篩選:</span>
                    <button data-filter-type="solution" data-filter="all" class="abc-filter-button text-xs px-2 py-1 bg-gray-500 hover:bg-gray-600 active">全</button>
                    <button data-filter-type="solution" data-filter="A" class="abc-filter-button text-xs px-2 py-1 bg-red-500 hover:bg-red-600">A</button>
                    <button data-filter-type="solution" data-filter="B" class="abc-filter-button text-xs px-2 py-1 bg-orange-500 hover:bg-orange-600">B</button>
                    <button data-filter-type="solution" data-filter="C" class="abc-filter-button text-xs px-2 py-1 bg-amber-500 hover:bg-amber-600">C</button>
                    <button data-filter-type="solution" data-filter="none" class="abc-filter-button text-xs px-2 py-1 bg-slate-500 hover:bg-slate-600">未</button>
                </div>
            </div>
            <table class="data-table">
                <thead> <tr><th>矛盾原因</th><th>改善參數</th><th>惡化參數</th><th>發明原理</th><th>解決方案描述</th><th>方案ABC分類</th><th>理想性評估</th><th>理想性總分</th></tr> </thead>
                <tbody id="solution-table-body"></tbody>
            </table>
        </section>

        <section id="ideas-landscape-section" style="display: none;" class="data-table-section bg-white p-4 md:p-6 rounded-lg shadow">
            <h2 class="text-xl font-semibold text-gray-700 mb-3">5. 創意景觀圖</h2>
            <div id="ideas-landscape-controls" class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4 p-3 bg-gray-50 rounded-md">
                <div>
                    <label for="landscape-time-threshold" class="block text-sm font-medium text-gray-700">時間門檻值 (X軸中線):</label>
                    <input type="number" id="landscape-time-threshold" value="10" class="input-field mt-1" placeholder="例如：10 (單位自訂)">
                </div>
                <div>
                    <label for="landscape-score-threshold" class="block text-sm font-medium text-gray-700">MCDM分數門檻值 (Y軸中線):</label>
                    <input type="number" id="landscape-score-threshold" value="50" class="input-field mt-1" placeholder="例如：50">
                </div>
                <div class="md:col-span-1 flex items-end">
                    <button id="update-ideas-landscape-chart-button" class="action-button bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-md w-full">
                        <i class="fas fa-sync-alt mr-1"></i> 更新圖表
                    </button>
                </div>
            </div>
            <div class="text-xs text-gray-500 mb-2 p-2 bg-gray-100 rounded-md">
                <strong>圖形分析說明：</strong>
                <ul class="list-disc list-inside ml-2">
                    <li>左上 (第二象限): 時間短、總分高 (優先方案)</li>
                    <li>左下 (第三象限): 時間短、總分低 (不值得考慮)</li>
                    <li>右下 (第四象限): 時間長、總分低 (不應執行)</li>
                    <li>右上 (第一象限): 時間長、總分高 (可長期規劃)</li>
                </ul>
                 <p class="mt-1"><strong>提示：</strong>點的大小可能與成本或理想性相關，點的形狀與ABC分類相關。</p>
            </div>
            <div id="ideas-landscape-chart-container" class="w-full h-[500px] bg-white p-2 rounded shadow">
                <canvas id="ideas-landscape-chart"></canvas>
                <div id="ideas-landscape-no-data-message" style="display: none;">
                    <p>沒有資料可顯示於創意景觀圖。</p>
                    <p class="text-xs mt-1">請先產生解決方案並於「設定衝突參數/方案」中填寫「導入所需時間」與「MCDM總分」。</p>
                </div>
            </div>
        </section>


        <div id="abc-category-modal" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center" style="display: none;">
            </div>

        <div id="triz-solution-modal" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center" style="display: none;">
            <div class="modal-content mx-auto p-5 border w-11/12 md:w-3/5 lg:w-3/5 shadow-lg rounded-md bg-white"> 
                <button class="modal-close-button" onclick="ModalManager.closeTrizSolutionModal()">&times;</button>
                <div class="mt-3">
                    <h3 class="text-lg leading-6 font-medium text-gray-900 text-center" id="triz-solution-modal-title">設定衝突參數、解決方案與評估資料</h3>
                    <p id="triz-modal-cause-text" class="text-sm text-gray-600 my-2 text-center"></p>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label for="improving-parameter-select" class="block text-sm font-medium text-gray-700">改善時特性參數:</label>
                            <select id="improving-parameter-select" class="select-field mt-1"></select>
                        </div>
                        <div>
                            <label for="worsening-parameter-select" class="block text-sm font-medium text-gray-700">惡化時特性參數:</label>
                            <select id="worsening-parameter-select" class="select-field mt-1"></select>
                        </div>
                    </div>
                    
                    <div id="suggested-principles-container" style="display: none;">
                        <h5>建議發明原理 (根據矛盾矩陣):</h5>
                        <ul id="suggested-principles-list"></ul>
                    </div>

                    <h4 class="text-md font-semibold text-gray-800 mt-4 mb-2">解決方案列表:</h4>
                    <div id="solutions-list-container" class="max-h-48 overflow-y-auto mb-3"></div> 
                    <button id="add-new-solution-entry-button" class="action-button bg-green-500 hover:bg-green-600 text-sm py-1 px-2 mb-2">
                        <i class="fas fa-plus mr-1"></i> 新增解決方案
                    </button>
                    
                    <div id="edit-solution-entry-container" style="display:none;" class="p-3 border rounded-md bg-gray-50 mb-3">
                        <h5 id="edit-solution-title" class="text-sm font-semibold text-gray-700 mb-2"></h5>
                        <input type="hidden" id="editing-solution-id">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-x-4 gap-y-2">
                            <div>
                                <label for="solution-principle-select" class="block text-xs font-medium text-gray-700">選擇發明原理:</label>
                                <select id="solution-principle-select" class="select-field mt-1 text-sm"></select>
                            </div>
                             <div> </div>
                            <div class="md:col-span-2">
                                <label for="solution-description-input" class="block text-xs font-medium text-gray-700">方案描述:</label>
                                <textarea id="solution-description-input" rows="2" class="input-field mt-1 text-sm" placeholder="輸入此原理對應的具體解決方案描述"></textarea>
                            </div>
                            <div>
                                <label for="solution-time-required-input" class="block text-xs font-medium text-gray-700">導入所需時間 (單位自訂):</label>
                                <input type="number" id="solution-time-required-input" class="input-field mt-1 text-sm" placeholder="例如: 5">
                            </div>
                            <div>
                                <label for="solution-mcdm-score-input" class="block text-xs font-medium text-gray-700">MCDM總分 (0-100):</label>
                                <input type="number" id="solution-mcdm-score-input" class="input-field mt-1 text-sm" placeholder="例如: 75">
                            </div>
                             <div>
                                <label for="solution-cost-input" class="block text-xs font-medium text-gray-700">預估成本 (可選, 單位自訂):</label>
                                <input type="number" id="solution-cost-input" class="input-field mt-1 text-sm" placeholder="例如: 1000">
                            </div>
                        </div>
                        <div class="mt-3 text-right">
                            <button id="cancel-edit-solution-button" class="action-button bg-gray-400 hover:bg-gray-500 text-xs py-1 px-2 mr-1">取消</button>
                            <button id="save-solution-entry-button" class="action-button bg-blue-500 hover:bg-blue-600 text-xs py-1 px-2">儲存此方案</button>
                        </div>
                    </div>

                    <div class="items-center px-4 py-3 mt-2 text-right border-t">
                        <button id="close-triz-modal-button" class="action-button mr-2 px-4 py-2 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400">關閉</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="ideality-assessment-modal" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center" style="display: none;">
            <div class="modal-content mx-auto p-5 border w-11/12 md:w-3/5 lg:w-1/2 shadow-lg rounded-md bg-white">
                <button class="modal-close-button" onclick="ModalManager.closeIdealityAssessmentModal()">&times;</button>
                <div class="mt-3">
                    <h3 class="text-lg leading-6 font-medium text-gray-900 text-center">TRIZ 理想性評估</h3>
                    <p id="ideality-modal-solution-text" class="text-sm text-gray-600 my-2 text-center"></p>
                    <input type="hidden" id="assessing-solution-cause-id">
                    <input type="hidden" id="assessing-solution-entry-id">

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4 mb-4">
                        <div class="ideality-criterion">
                            <label for="ideality-problem-solved-range">1. 問題是否完全解決？ (0-10)</label>
                            <div class="flex items-center">
                                <input type="range" id="ideality-problem-solved-range" min="0" max="10" value="5" class="input-field flex-grow">
                                <span id="ideality-problem-solved-value" class="range-value">5</span>
                            </div>
                            <label for="ideality-problem-solved-weight" class="text-xs mt-1">權重 (0-1): <input type="number" id="ideality-problem-solved-weight" value="0.25" step="0.01" min="0" max="1" class="input-field text-xs p-1 w-20 inline-block ml-1"></label>
                        </div>
                        <div class="ideality-criterion">
                            <label for="ideality-win-win-range">2. 是否為雙贏局面？ (0-10)</label>
                             <div class="flex items-center">
                                <input type="range" id="ideality-win-win-range" min="0" max="10" value="5" class="input-field flex-grow">
                                <span id="ideality-win-win-value" class="range-value">5</span>
                            </div>
                            <label for="ideality-win-win-weight" class="text-xs mt-1">權重 (0-1): <input type="number" id="ideality-win-win-weight" value="0.25" step="0.01" min="0" max="1" class="input-field text-xs p-1 w-20 inline-block ml-1"></label>
                        </div>
                        <div class="ideality-criterion">
                            <label for="ideality-no-negative-effects-range">3. 有無產生負面效應？ (0=很多, 10=沒有)</label>
                            <div class="flex items-center">
                                <input type="range" id="ideality-no-negative-effects-range" min="0" max="10" value="5" class="input-field flex-grow">
                                <span id="ideality-no-negative-effects-value" class="range-value">5</span>
                            </div>
                            <label for="ideality-no-negative-effects-weight" class="text-xs mt-1">權重 (0-1): <input type="number" id="ideality-no-negative-effects-weight" value="0.25" step="0.01" min="0" max="1" class="input-field text-xs p-1 w-20 inline-block ml-1"></label>
                        </div>
                        <div class="ideality-criterion">
                            <label for="ideality-low-cost-resource-range">4. 多符合理想性 (低成本/資源)？ (0-10)</label>
                           <div class="flex items-center">
                                <input type="range" id="ideality-low-cost-resource-range" min="0" max="10" value="5" class="input-field flex-grow">
                                <span id="ideality-low-cost-resource-value" class="range-value">5</span>
                            </div>
                            <label for="ideality-low-cost-resource-weight" class="text-xs mt-1">權重 (0-1): <input type="number" id="ideality-low-cost-resource-weight" value="0.25" step="0.01" min="0" max="1" class="input-field text-xs p-1 w-20 inline-block ml-1"></label>
                        </div>
                    </div>
                    
                    <div class="text-center my-3">
                        <span class="text-md font-semibold">理想性加權總分: </span>
                        <span id="ideality-total-score-display" class="text-lg font-bold text-blue-600">0.00</span>
                         <p class="text-xs text-gray-500 mt-1">(權重總和建議為1，分數範圍0-10)</p>
                         <p id="ideality-weights-sum-warning" class="text-xs text-red-500 mt-1" style="display:none;">注意：目前權重總和不為 1。</p>
                    </div>

                    <div class="items-center px-4 py-3 mt-4 text-right border-t">
                        <button id="cancel-ideality-assessment-button" class="action-button mr-2 px-4 py-2 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400">取消</button>
                        <button id="save-ideality-assessment-button" class="action-button px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">儲存評估</button>
                    </div>
                </div>
            </div>
        </div>


        <div id="and-source-modal" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center" style="display: none;">
             <div class="modal-content mx-auto p-5 border w-11/12 md:w-1/2 lg:w-1/3 shadow-lg rounded-md bg-white">
                <button class="modal-close-button" onclick="ModalManager.closeAndSourceModal()">&times;</button>
                <div class="mt-3">
                    <h3 class="text-lg leading-6 font-medium text-gray-900 text-center">設定 AND 輸入源</h3>
                    <p id="and-source-modal-node-text" class="text-sm text-gray-600 my-2 text-center"></p>
                    <div id="and-source-options-container" class="modal-options-container my-4">
                        </div>
                    <div class="items-center px-4 py-3 mt-4 text-right border-t">
                        <button id="cancel-and-sources-button" class="action-button mr-2 px-4 py-2 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400">取消</button>
                        <button id="save-and-sources-button" class="action-button px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">儲存設定</button>
                    </div>
                </div>
            </div>
        </div>
        <div id="effect-parameter-modal" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center" style="display: none;">
             <div class="modal-content mx-auto p-5 border w-11/12 md:w-1/2 lg:w-2/5 shadow-lg rounded-md bg-white">
                <button class="modal-close-button" onclick="ModalManager.closeEffectParameterModal()">&times;</button>
                <div class="mt-3">
                    <h3 class="text-lg leading-6 font-medium text-gray-900 text-center">設定效果參數</h3>
                    <p id="effect-parameter-modal-node-text" class="text-sm text-gray-600 my-2 text-center"></p>
                    <div id="effect-parameter-options-container" class="modal-options-container my-4">
                        </div>
                    <div class="items-center px-4 py-3 mt-4 text-right border-t">
                        <button id="cancel-effect-parameters-button" class="action-button mr-2 px-4 py-2 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400">取消</button>
                        <button id="save-effect-parameters-button" class="action-button px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">儲存設定</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- "Module": Constants ---
        const Constants = {
            ZOOM_STEP: 0.1,
            MIN_ZOOM: 0.2,
            MAX_ZOOM: 3.0,
            MAX_HISTORY_STATES: 50,
            QUADRANT_COLORS: {
                Q1: 'rgba(220, 252, 231, 0.4)', 
                Q2: 'rgba(219, 234, 254, 0.4)', 
                Q3: 'rgba(254, 226, 226, 0.4)', 
                Q4: 'rgba(254, 249, 195, 0.4)', 
            },
            QUADRANT_LABELS: {
                Q1: '長期規劃 (Q1)', Q2: '優先方案 (Q2)',
                Q3: '不值得考慮 (Q3)', Q4: '不應執行 (Q4)'
            },
            ABC_POINT_STYLES: { 'A': 'rectRot', 'B': 'triangle', 'C': 'star', 'none': 'circle' },
            ABC_COLORS: {
                'A': 'rgba(239, 68, 68, 0.8)', 'B': 'rgba(249, 115, 22, 0.8)',
                'C': 'rgba(245, 158, 11, 0.8)', 'none': 'rgba(107, 114, 128, 0.7)'
            },
            ABC_BORDER_COLORS: {
                'A': 'rgba(220, 38, 38, 1)', 'B': 'rgba(234, 88, 12, 1)',
                'C': 'rgba(217, 119, 6, 1)', 'none': 'rgba(75, 85, 99, 1)'
            },
            EFFECT_PARAMETERS: {
                "活動": ["活動效用性", "活動可變性", "活動費用", "活動時間", "活動複雜性", "活動方便性", "活動安全性", "活動可靠性"],
                "系統": ["系統有效性", "系統可變性", "系統費用", "系統時間", "系統複雜性", "系統方便性", "系統安全性", "系統可靠性", "對系統的有害影響", "系統產生的有害影響", "組織壓力", "組織穩定性"],
                "其他": ["內部風險", "外部風險", "信息共享", "信息損失", "信息流", "回饋", "物料流", "適應性/多功能性", "顧客壓力", "顧客穩定性", "環境穩定性"]
            },
            INVENTIVE_PRINCIPLES: ["分割", "取出/分離", "改變局部特性", "非對稱性", "合併/整合", "多用性/多功能", "套疊/巢狀結構", "反制行動", "預先反制行動", "預先行動", "事先補償/預防", "消除緊張", "另一方向/反向操作", "非直線姓", "動態化", "稍微少些或多些(的動作)", "另外維度/空間", "共鳴(協調)", "週期行動", "連續的有利作用", "快速行動", "轉有害為有利", "回饋", "中介物/媒介", "自助/自我服務", "使用複製品或模型", "廉價與短期[拋棄式]", "替換系統運作原理/使用其他原理", "流動性和靈活性", "改變邊界條件", "孔洞和網路", "改變外觀/可見度", "同質性", "丟棄與恢復", "改變特性", "模範轉移", "相對變化", "增強的環境", "鈍性(惰性)環境", "組合(複合)結構"],
            BUSINESS_MANAGEMENT_PARAMETERS: [
                "未選擇", "活動效用性", "活動可變性", "活動費用", "活動時間", "活動複雜性", "活動方便性", "活動安全性", "活動可靠性",
                "系統可變性", "系統費用", "系統時間", "系統複雜性", "系統方便性", "系統安全性", "系統可靠性",
                "內部風險", "外部風險", "信息共享", "信息損失", "信息流", "回饋", "物料流",
                "對系統的有害影響", "系統產生的有害影響", "系統有效性", 
                "適應性/多功能性", "組織壓力", "組織穩定性", "顧客壓力", "顧客穩定性", "環境穩定性"
            ],
            BUSINESS_CONTRADICTION_MATRIX: {
                // *** 請務必在此處填入完整的 31x31 商業管理矛盾矩陣資料 ***
                // 範例 (僅部分，需補全):
                "活動效用性": {
                    "活動效用性": [], "活動可變性": [26,3,40,2], "活動費用": [18,35,28,26], "活動時間": [39,8,39,36], "活動複雜性": [33,18,17,7],
                    "活動方便性": [21,12,20,35], "活動安全性": [38,35,1,27], "活動可靠性": [39,40,9,2], "系統可變性": [36,18,40,9],
                    "系統費用": [18,37,20,35], "系統時間": [21,13,27,2], "系統複雜性": [33,6,24,20], "系統方便性": [17,7,5,13],
                    "系統安全性": [19,39,30,4], "系統可靠性": [21,12,18,9], "內部風險": [20,35,28,26], "外部風險": [10,12,37,11],
                    "信息共享": [13,19,29,7], "信息損失": [38,39,17,37], "信息流": [39,18,1,2], "回饋": [24,22,9,31],
                    "物料流": [30,29,19,15], "對系統的有害影響": [39,40,8,16], "系統產生的有害影響": [25,30,9,31], "系統有效性": [38,33,17,29],
                    "適應性/多功能性": [28,10,34,1], "組織壓力": [5,36,37,30], "組織穩定性": [25,23,8,12], "顧客壓力": [30,12,22,16],
                    "顧客穩定性": [40,35,10,11], "環境穩定性": [32,11,23,2]
                },
                "活動可變性": {
                    "活動效用性": [3,35,40,2], "活動可變性": [], "活動費用": [7,39,33,22], "活動時間": [21,39,24,22],
                    "活動複雜性": [9,27,26,9], "活動方便性": [21,25,38,33], "活動安全性": [], "活動可靠性": [12,5,31,33], "系統可變性": [6,30,24,19],
                    "系統費用": [24,19,28,1], "系統時間": [2,15,28,14], "系統複雜性": [2,15,14,30], "系統方便性": [2,8],
                    "系統安全性": [1,23,1,7], "系統可靠性": [8,28,31], "內部風險": [25,16,25,23], "外部風險": [30,28,32,25],
                    "信息共享": [16,10,2,8], "信息損失": [29,34,40,30], "信息流": [1,39,27,16], "回饋": [26,4,16,39],
                    "物料流": [30,9,15,3], "對系統的有害影響": [25,4,35,12], "系統產生的有害影響": [19,15,37,35], "系統有效性": [27,2,11,16],
                    "適應性/多功能性": [16,29,35,5], "組織壓力": [7,10,7,10], "組織穩定性": [34,5,34,5], "顧客壓力": [3,12,3,12],
                    "顧客穩定性": [19,33,19,33], "環境穩定性": [32,36,32,36]
                },
                 "活動費用": {
                    "活動效用性": [18,37,20,35], "活動可變性": [21,39,9,27], "活動費用": [], "活動時間": [39,18,1,2],
                    "活動複雜性": [1,2,24,22], "活動方便性": [35,1,9,31], "活動安全性": [], "活動可靠性": [28,20,8,16],
                    "系統可變性": [3,35,28,20], "系統費用": [], "系統時間": [30,29,19,15], "系統複雜性": [36,24,27,29],
                    "系統方便性": [24,22,8,16], "系統安全性": [], "系統可靠性": [39,40,25,30], "內部風險": [8,16,26,9],
                    "外部風險": [38,33,17,29], "信息共享": [31,33,28,10], "信息損失": [34,1,5,36], "信息流": [37,8,25,23],
                    "回饋": [30,12,22,30], "物料流": [40,35,32,18], "對系統的有害影響": [11,23,38,18], "系統產生的有害影響": [10,8,16,14],
                    "系統有效性": [12,16,39,24], "適應性/多功能性": [5,11,29,33], "組織壓力": [15,38,28,29], "組織穩定性": [23,2,17,40],
                    "顧客壓力": [18,23,16,40], "顧客穩定性": [24,3,14,26], "環境穩定性": [4,21,33,37]
                },
                "系統有效性": {
                    "活動效用性": [15,38,39,22], "活動可變性": [26,2,2,33], "活動費用": [25,21,38,38], "活動時間": [19,24,24,3],
                    "活動複雜性": [39,22,6,28], "活動方便性": [2,33,16,17], "活動安全性": [38,28,28,8], "活動可靠性": [6,28,38,6],
                    "系統可變性": [4,21,4,21], "系統費用": [17,29,15,14], "系統時間": [38,38,11,30], "系統複雜性": [38,34,8,5],
                    "系統方便性": [34,28,19,22], "系統安全性": [29,19,29], "系統可靠性": [33,11,10,16], "內部風險": [19,3,19,3],
                    "外部風險": [29,2,16,26], "信息共享": [16,26,21,3], "信息損失": [21,3,4,21], "信息流": [4,40,4,40],
                    "回饋": [5,2,5,2], "物料流": [39,21,39,21], "對系統的有害影響": [11,24,11,24], "系統產生的有害影響": [10,15,10,15],
                    "系統有效性": [], "適應性/多功能性": [16,26,16,26], "組織壓力": [40,27,40,27], "組織穩定性": [11,39,11,39],
                    "顧客壓力": [15,36,15,36], "顧客穩定性": [16,22,16,22], "環境穩定性": [14,4,14,4]
                },
                 "環境穩定性": { 
                    "活動效用性": [20,33,26,27], "活動可變性": [36,10,35,17], "活動費用": [27,35,10,19], "活動時間": [24,36,13,29],
                    "活動複雜性": [40,30,37,36], "活動方便性": [28,17,38,31], "活動安全性": [35,17,36,30], "活動可靠性": [10,19,33,40],
                    "系統可變性": [13,29,39,33], "系統費用": [37,36,35,8], "系統時間": [38,31,26,27], "系統複雜性": [36,30,6,34],
                    "系統方便性": [33,40,23], "系統安全性": [39,33,8], "系統可靠性": [35,8,5], "內部風險": [26,27,8],
                    "外部風險": [6,34,5], "信息共享": [30,2,34], "信息損失": [2,29,6], "信息流": [31,38,8],
                    "回饋": [32,3,17], "物料流": [11,18,17], "對系統的有害影響": [4,5,39,34], "系統產生的有害影響": [7,1,40,16],
                    "系統有效性": [8,16,36,3], "適應性/多功能性": [5,34,30,24], "組織壓力": [2,40,35,32], "組織穩定性": [26,2,9,5],
                    "顧客壓力": [3,29,1,31], "顧客穩定性": [30,8,13], "環境穩定性": []
                }
            }
        };

        // --- "Module": State ---
        const State = {
            rcaData: null,
            nodeIdCounter: 0,
            currentAndTargetNodeId: null,
            isFinalizedView: false,
            currentParameterTargetNodeId: null,
            currentZoom: 1.0,
            historyStack: [],
            historyIndex: -1,
            currentAbcCauseTargetNodeId: null,
            currentAbcCauseFilter: 'all',
            currentAbcSolutionFilter: 'all',
            currentTrizCauseNodeId: null,
            ideasLandscapeChartInstance: null,
            currentAssessingSolution: { causeId: null, solutionId: null }
        };

        // --- "Module": DOM ---
        const DOM = {
            elements: {},
            initializeElements: function() {
                this.elements = {
                    mainToolTitle: document.getElementById('main-tool-title'), 
                    problemInput: document.getElementById('problem-statement-input'),
                    setProblemButton: document.getElementById('set-problem-button'),
                    diagramRenderArea: document.getElementById('diagram-render-area'),
                    scalableContentWrapper: document.getElementById('scalable-content-wrapper'),
                    diagramContainer: document.getElementById('rca-diagram-container'),
                    svgLayer: document.getElementById('svg-connector-layer'),
                    diagramTitle: document.getElementById('diagram-title'),
                    problemInputArea: document.getElementById('problem-input-area'),
                    toolButtonsContainer: document.getElementById('tool-buttons'),
                    fileMenuButton: document.getElementById('file-menu-button'),
                    fileDropdownContent: document.getElementById('file-dropdown-content'),
                    saveDiagramButton: document.getElementById('save-diagram-button'),
                    loadDiagramButton: document.getElementById('load-diagram-button'),
                    saveToFileButton: document.getElementById('save-to-file-button'),
                    loadFromFileLabel: document.getElementById('load-from-file-label'),
                    fileInputForLoad: document.getElementById('file-input-for-load'),
                    undoButton: document.getElementById('undo-button'),
                    redoButton: document.getElementById('redo-button'),
                    zoomOutButton: document.getElementById('zoom-out-button'),
                    zoomInButton: document.getElementById('zoom-in-button'),
                    resetZoomButton: document.getElementById('reset-zoom-button'),
                    zoomLevelDisplay: document.getElementById('zoom-level-display'),
                    finalizeDiagramButton: document.getElementById('finalize-diagram-button'),
                    autoAdjustLayoutButton: document.getElementById('auto-adjust-layout-button'),
                    exportMenuButton: document.getElementById('export-menu-button'),
                    exportDropdownContent: document.getElementById('export-dropdown-content'),
                    exportPngButton: document.getElementById('export-png-button'),
                    toggleCauseEffectTableButton: document.getElementById('toggle-cause-effect-table-button'),
                    toggleSolutionTableButton: document.getElementById('toggle-solution-table-button'),
                    causeEffectTableSection: document.getElementById('cause-effect-table-section'),
                    causeEffectTableBody: document.getElementById('cause-effect-table-body'),
                    solutionTableSection: document.getElementById('solution-table-section'),
                    solutionTableBody: document.getElementById('solution-table-body'),
                    andSourceModal: document.getElementById('and-source-modal'),
                    andSourceModalNodeText: document.getElementById('and-source-modal-node-text'), 
                    andSourceOptionsContainer: document.getElementById('and-source-options-container'), 
                    cancelAndSourcesButton: document.getElementById('cancel-and-sources-button'), 
                    saveAndSourcesButton: document.getElementById('save-and-sources-button'),     
                    effectParameterModal: document.getElementById('effect-parameter-modal'),
                    abcCategoryModal: document.getElementById('abc-category-modal'),
                    abcCauseFilterControls: document.getElementById('abc-cause-filter-controls'),
                    abcSolutionFilterControls: document.getElementById('abc-solution-filter-controls'),
                    trizSolutionModal: document.getElementById('triz-solution-modal'),
                    trizModalCauseText: document.getElementById('triz-modal-cause-text'),
                    improvingParameterSelect: document.getElementById('improving-parameter-select'),
                    worseningParameterSelect: document.getElementById('worsening-parameter-select'),
                    suggestedPrinciplesContainer: document.getElementById('suggested-principles-container'), 
                    suggestedPrinciplesList: document.getElementById('suggested-principles-list'),       
                    solutionsListContainer: document.getElementById('solutions-list-container'),
                    addNewSolutionEntryButton: document.getElementById('add-new-solution-entry-button'),
                    editSolutionEntryContainer: document.getElementById('edit-solution-entry-container'),
                    editingSolutionIdInput: document.getElementById('editing-solution-id'),
                    solutionPrincipleSelect: document.getElementById('solution-principle-select'),
                    solutionDescriptionInput: document.getElementById('solution-description-input'),
                    solutionTimeRequiredInput: document.getElementById('solution-time-required-input'),
                    solutionMcdmScoreInput: document.getElementById('solution-mcdm-score-input'),
                    solutionCostInput: document.getElementById('solution-cost-input'),
                    saveSolutionEntryButton: document.getElementById('save-solution-entry-button'),
                    cancelEditSolutionButton: document.getElementById('cancel-edit-solution-button'),
                    editSolutionTitle: document.getElementById('edit-solution-title'),
                    toggleIdeasLandscapeButton: document.getElementById('toggle-ideas-landscape-button'),
                    ideasLandscapeSection: document.getElementById('ideas-landscape-section'),
                    ideasLandscapeChartCanvas: document.getElementById('ideas-landscape-chart'),
                    ideasLandscapeNoDataMessage: document.getElementById('ideas-landscape-no-data-message'),
                    updateIdeasLandscapeChartButton: document.getElementById('update-ideas-landscape-chart-button'),
                    landscapeTimeThresholdInput: document.getElementById('landscape-time-threshold'),
                    landscapeScoreThresholdInput: document.getElementById('landscape-score-threshold'),
                    idealityAssessmentModal: document.getElementById('ideality-assessment-modal'),
                    idealityModalSolutionText: document.getElementById('ideality-modal-solution-text'),
                    assessingSolutionCauseIdInput: document.getElementById('assessing-solution-cause-id'),
                    assessingSolutionEntryIdInput: document.getElementById('assessing-solution-entry-id'),
                    idealityProblemSolvedRange: document.getElementById('ideality-problem-solved-range'),
                    idealityProblemSolvedValue: document.getElementById('ideality-problem-solved-value'),
                    idealityProblemSolvedWeight: document.getElementById('ideality-problem-solved-weight'),
                    idealityWinWinRange: document.getElementById('ideality-win-win-range'),
                    idealityWinWinValue: document.getElementById('ideality-win-win-value'),
                    idealityWinWinWeight: document.getElementById('ideality-win-win-weight'),
                    idealityNoNegativeEffectsRange: document.getElementById('ideality-no-negative-effects-range'),
                    idealityNoNegativeEffectsValue: document.getElementById('ideality-no-negative-effects-value'),
                    idealityNoNegativeEffectsWeight: document.getElementById('ideality-no-negative-effects-weight'),
                    idealityLowCostResourceRange: document.getElementById('ideality-low-cost-resource-range'),
                    idealityLowCostResourceValue: document.getElementById('ideality-low-cost-resource-value'),
                    idealityLowCostResourceWeight: document.getElementById('ideality-low-cost-resource-weight'),
                    idealityTotalScoreDisplay: document.getElementById('ideality-total-score-display'),
                    idealityWeightsSumWarning: document.getElementById('ideality-weights-sum-warning'),
                    saveIdealityAssessmentButton: document.getElementById('save-ideality-assessment-button'),
                    cancelIdealityAssessmentButton: document.getElementById('cancel-ideality-assessment-button'),
                    effectParameterModalNodeText: document.getElementById('effect-parameter-modal-node-text'),
                    effectParameterOptionsContainer: document.getElementById('effect-parameter-options-container'),
                    cancelEffectParametersButton: document.getElementById('cancel-effect-parameters-button'),
                    saveEffectParametersButton: document.getElementById('save-effect-parameters-button'),
                };
            }
        };

        // --- "Module": Utils ---
        const Utils = {
            deepCopy: function(obj) { return JSON.parse(JSON.stringify(obj)); },
            populateSelect: function(selectElement, optionsArray, includeDefault = true) {
                if (!selectElement) return;
                selectElement.innerHTML = '';
                if (includeDefault) {
                    const defaultOption = document.createElement('option');
                    defaultOption.value = "";
                    defaultOption.textContent = "未選擇"; 
                    selectElement.appendChild(defaultOption);
                }
                optionsArray.forEach(optionText => {
                    if (includeDefault && optionText === "未選擇" && optionsArray.indexOf("未選擇") !== 0) return; 
                    const option = document.createElement('option');
                    option.value = optionText;
                    option.textContent = optionText;
                    selectElement.appendChild(option);
                });
            },
            createActionButton: function(text, className, onClickHandler) {
                const button = document.createElement('button');
                button.classList.add('action-button', ...className.split(' '));
                button.textContent = text;
                button.addEventListener('click', onClickHandler);
                return button;
            }
        };

        // --- "Module": HistoryManager ---
        const HistoryManager = {
            pushStateToHistory: function(currentState, clearRedoStack = true) {
                if (!currentState && State.historyStack.length === 0 && State.historyIndex === -1 && !State.rcaData) {} 
                else if (currentState === null && !State.rcaData && State.historyStack.length > 0) {} 
                else if (!currentState && State.rcaData) { UIInteractions.updateButtonStates(); return; }
                
                const stateCopy = Utils.deepCopy(currentState);
                if (clearRedoStack) {
                    State.historyStack = State.historyStack.slice(0, State.historyIndex + 1);
                }
                State.historyStack.push({ 
                    data: stateCopy, 
                    counter: State.nodeIdCounter, 
                    zoom: State.currentZoom, 
                    abcCauseFilter: State.currentAbcCauseFilter, 
                    abcSolutionFilter: State.currentAbcSolutionFilter 
                });
                State.historyIndex = State.historyStack.length - 1;
                if (State.historyStack.length > Constants.MAX_HISTORY_STATES) {
                    State.historyStack.shift();
                    State.historyIndex--;
                }
                UIInteractions.updateButtonStates();
            },
            restoreStateFromHistory: function(historyEntry) {
                if (historyEntry && typeof historyEntry.data !== 'undefined') {
                    State.rcaData = Utils.deepCopy(historyEntry.data);
                    State.nodeIdCounter = historyEntry.counter;
                    NodeManager.recalculateNodeIdCounter(State.rcaData);
                    State.currentAbcCauseFilter = historyEntry.abcCauseFilter || 'all';
                    State.currentAbcSolutionFilter = historyEntry.abcSolutionFilter || 'all';
                    Renderer.renderRcaDiagram();
                    TableManager.renderCauseEffectTable();
                    TableManager.renderSolutionTable();
                    ChartManager.renderIdeasLandscapeChart();
                    UIInteractions.applyZoom(historyEntry.zoom, true);
                } else {
                    console.error("無法從歷史紀錄中檢索狀態。");
                    return false;
                }
                return true;
            },
            handleUndo: function() {
                if (State.historyIndex > 0) {
                    State.historyIndex--;
                    if (!HistoryManager.restoreStateFromHistory(State.historyStack[State.historyIndex])) {
                        State.historyIndex++; // Revert index if restore failed
                    }
                }
                UIInteractions.updateButtonStates();
            },
            handleRedo: function() {
                if (State.historyIndex < State.historyStack.length - 1) {
                    State.historyIndex++;
                    if (!HistoryManager.restoreStateFromHistory(State.historyStack[State.historyIndex])) {
                        State.historyIndex--; // Revert index if restore failed
                    }
                }
                UIInteractions.updateButtonStates();
            }
        };

        // --- "Module": NodeManager ---
        const NodeManager = {
            createNode: function(text, type, parentId, isNonChangeable = false) {
                State.nodeIdCounter++;
                const node = {
                    id: `node-${State.nodeIdCounter}`,
                    text: text, type: type, parentId: parentId, children: [],
                    andSourceNodeIds: [], effectParameters: [],
                    improvingParameter: null, worseningParameter: null,
                    solutionsGenerated: [], abcCategory: null
                };
                if (type === 'cause') node.isNonChangeable = isNonChangeable;
                return node;
            },
            findNodeById: function(node, id) {
                if (!node || typeof node !== 'object') return null;
                if (node.id === id) return node;
                if (node.children && Array.isArray(node.children)) {
                    for (const child of node.children) {
                        if (!child) continue;
                        const found = NodeManager.findNodeById(child, id);
                        if (found) return found;
                    }
                }
                return null;
            },
            addNodeToData: function(parentId, nodeText, nodeType) {
                const parentNode = NodeManager.findNodeById(State.rcaData, parentId);
                if (parentNode) {
                    const newNode = NodeManager.createNode(nodeText, nodeType, parentId);
                    parentNode.children.push(newNode);
                    HistoryManager.pushStateToHistory(State.rcaData);
                    Renderer.renderRcaDiagram();
                    TableManager.renderCauseEffectTable();
                    TableManager.renderSolutionTable();
                }
            },
            removeNode: function(nodeIdToRemove) {
                if (State.isFinalizedView) return;
                if (State.rcaData && State.rcaData.id === nodeIdToRemove) {
                    alert('不能移除主要問題根源節點！'); return;
                }
                let nodeRemoved = false;
                function filterRecursive(node, idToRemove) {
                    if (!node) return null;
                    if (node.id === idToRemove) {
                        nodeRemoved = true;
                        // Recursively remove this node ID from any andSourceNodeIds in the entire tree
                        function removeAndSourceFromEntireTree(currentNodeData, removedId) {
                            if (!currentNodeData) return;
                            if (currentNodeData.andSourceNodeIds && currentNodeData.andSourceNodeIds.includes(removedId)) {
                                currentNodeData.andSourceNodeIds = currentNodeData.andSourceNodeIds.filter(srcId => srcId !== removedId);
                            }
                            if (currentNodeData.children && Array.isArray(currentNodeData.children)) {
                                currentNodeData.children.forEach(child => removeAndSourceFromEntireTree(child, removedId));
                            }
                        }
                        removeAndSourceFromEntireTree(State.rcaData, idToRemove);
                        return null;
                    }
                    if (node.children && Array.isArray(node.children)) {
                        node.children = node.children.map(child => filterRecursive(child, idToRemove)).filter(child => child !== null);
                    }
                    return node;
                }
                State.rcaData = filterRecursive(State.rcaData, nodeIdToRemove);
                if (nodeRemoved) {
                    HistoryManager.pushStateToHistory(State.rcaData);
                }
                if (!State.rcaData) { // If root node was somehow removed (should be prevented)
                    DOM.elements.problemInputArea.style.display = 'flex';
                    DOM.elements.diagramTitle.style.display = 'none';
                    DOM.elements.toolButtonsContainer.style.display = 'flex';
                    DOM.elements.causeEffectTableSection.style.display = 'none';
                    DOM.elements.solutionTableSection.style.display = 'none';
                    DOM.elements.ideasLandscapeSection.style.display = 'none';
                    State.historyStack = []; State.historyIndex = -1;
                    UIInteractions.applyZoom(1.0);
                    State.currentAbcCauseFilter = 'all'; State.currentAbcSolutionFilter = 'all';
                }
                Renderer.renderRcaDiagram();
                TableManager.renderCauseEffectTable();
                TableManager.renderSolutionTable();
                ChartManager.renderIdeasLandscapeChart();
                UIInteractions.updateButtonStates();
            },
            recalculateNodeIdCounter: function(currentData) {
                let maxId = 0;
                function findMaxIdRecursive(node) {
                    if (!node) return;
                    if (node.id && typeof node.id === 'string') {
                        const idNum = parseInt(node.id.replace('node-', ''));
                        if (!isNaN(idNum) && idNum > maxId) maxId = idNum;
                    }
                    if (node.children && Array.isArray(node.children)) {
                        node.children.forEach(childNode => {
                            if (childNode && typeof childNode === 'object') findMaxIdRecursive(childNode);
                        });
                    }
                }
                if (currentData && typeof currentData === 'object') findMaxIdRecursive(currentData);
                State.nodeIdCounter = maxId;
            },
            checkChildrenEffects: function(nodeData) {
                let hasPositiveChild = false; let hasNegativeChild = false;
                if (nodeData.children && Array.isArray(nodeData.children)) {
                    for (const child of nodeData.children) {
                        if(!child) continue;
                        if (child.type === 'positive-effect') hasPositiveChild = true;
                        if (child.type === 'negative-effect') hasNegativeChild = true;
                        if (hasPositiveChild && hasNegativeChild) break;
                    }
                }
                return { hasPositiveChild, hasNegativeChild };
            },
            toggleNonChangeable: function(nodeId) {
                if (State.isFinalizedView) return;
                const node = NodeManager.findNodeById(State.rcaData, nodeId);
                if (node && node.type === 'cause') {
                    node.isNonChangeable = !node.isNonChangeable;
                    HistoryManager.pushStateToHistory(State.rcaData);
                    Renderer.renderRcaDiagram();
                    TableManager.renderCauseEffectTable();
                }
            }
        };

        // --- "Module": Renderer ---
        const Renderer = {
            renderRcaDiagram: function() {
                DOM.elements.diagramContainer.innerHTML = '';
                if (State.rcaData) {
                    DOM.elements.diagramContainer.appendChild(Renderer.createNodeElement(State.rcaData));
                }
                requestAnimationFrame(() => Renderer.drawAllSvgConnectors());
                UIInteractions.updateButtonStates();
            },
            createNodeElement: function(nodeData) {
                const nodeWrapper = document.createElement('div'); 
                nodeWrapper.classList.add('rca-node-wrapper'); 
                const nodeDiv = document.createElement('div'); 
                nodeDiv.classList.add('rca-node', `rca-node-${nodeData.type}`); 
                nodeDiv.id = nodeData.id; 
                nodeDiv.dataset.nodeId = nodeData.id; 

                if (nodeData.type === 'cause') {
                    let isDimmed = false;
                    if (State.currentAbcCauseFilter === 'all') isDimmed = false;
                    else if (State.currentAbcCauseFilter === 'none') isDimmed = nodeData.abcCategory !== null && typeof nodeData.abcCategory !== 'undefined';
                    else if (State.currentAbcCauseFilter === 'AB') isDimmed = !(nodeData.abcCategory === 'A' || nodeData.abcCategory === 'B');
                    else isDimmed = nodeData.abcCategory !== State.currentAbcCauseFilter;
                    if (isDimmed) nodeDiv.classList.add('dimmed');
                }
                
                const contentDiv = document.createElement('div'); 
                contentDiv.classList.add('rca-node-content'); 
                const headerDiv = document.createElement('div'); 
                headerDiv.classList.add('rca-node-header'); 
                const textSpan = document.createElement('span'); 
                textSpan.classList.add('rca-node-text'); 
                textSpan.textContent = nodeData.text; 
                headerDiv.appendChild(textSpan); 

                if (nodeData.type === 'cause' && nodeData.abcCategory) {
                    const abcBadge = document.createElement('span');
                    abcBadge.classList.add('abc-badge', `abc-badge-${nodeData.abcCategory}`);
                    abcBadge.textContent = nodeData.abcCategory;
                    nodeDiv.appendChild(abcBadge); 
                }

                if (nodeData.type === 'cause' && nodeData.isNonChangeable) { 
                    const ncBadge = document.createElement('span'); 
                    ncBadge.classList.add('node-badge'); 
                    ncBadge.textContent = 'NC'; 
                    headerDiv.appendChild(ncBadge); 
                } 
                contentDiv.appendChild(headerDiv); 
                
                const iconSpan = document.createElement('span'); 
                iconSpan.classList.add('rca-node-icon'); 
                nodeDiv.appendChild(iconSpan); 

                if (nodeData.type === 'cause' && (nodeData.improvingParameter || nodeData.worseningParameter)) {
                    let paramsText = '';
                    if (nodeData.improvingParameter && nodeData.improvingParameter !== "未選擇") paramsText += `↑ ${nodeData.improvingParameter}`;
                    if (nodeData.worseningParameter && nodeData.worseningParameter !== "未選擇") paramsText += `${paramsText ? ' ' : ''}↓ ${nodeData.worseningParameter}`;
                    if (paramsText) {
                        const trizParamsDiv = document.createElement('div');
                        trizParamsDiv.classList.add('engineering-param-display');
                        trizParamsDiv.innerHTML = `<strong>衝突參數:</strong> ${paramsText}`;
                        contentDiv.appendChild(trizParamsDiv);
                    }
                }

                if (nodeData.effectParameters && nodeData.effectParameters.length > 0) { 
                    const paramsDiv = document.createElement('div'); 
                    paramsDiv.classList.add('selected-items-list'); 
                    paramsDiv.innerHTML = `<strong>效果參數:</strong> <ul>${nodeData.effectParameters.map(p => `<li>${p}</li>`).join('')}</ul>`; 
                    contentDiv.appendChild(paramsDiv); 
                } 
                
                if (nodeData.type === 'cause' && nodeData.solutionsGenerated && nodeData.solutionsGenerated.length > 0) {
                    const solutionsSummaryDiv = document.createElement('div');
                    solutionsSummaryDiv.classList.add('selected-items-list');
                    let summaryText = `<strong>潛在解決方案:</strong> ${nodeData.solutionsGenerated.length} 個`;
                    const assessedSolutions = nodeData.solutionsGenerated.filter(s => s.idealityAssessment && s.idealityAssessment.weightedScore !== null && s.idealityAssessment.weightedScore !== undefined);
                    if (assessedSolutions.length > 0) {
                        const avgIdeality = assessedSolutions.reduce((sum, s) => sum + s.idealityAssessment.weightedScore, 0) / assessedSolutions.length;
                        summaryText += ` (平均理想性: ${avgIdeality.toFixed(2)})`;
                    }
                    solutionsSummaryDiv.innerHTML = summaryText;
                    contentDiv.appendChild(solutionsSummaryDiv);
                }

                iconSpan.style.display = 'flex'; 
                if (nodeData.type === 'initial-problem') iconSpan.textContent = '(-)'; 
                else if (nodeData.type === 'cause') { 
                    const { hasPositiveChild, hasNegativeChild } = NodeManager.checkChildrenEffects(nodeData); 
                    if (hasPositiveChild && hasNegativeChild) { 
                        iconSpan.textContent = '+/-'; 
                        iconSpan.classList.add('contradictory'); 
                    } else { iconSpan.style.display = 'none'; } 
                } else if (nodeData.type === 'positive-effect') iconSpan.textContent = '(+)'; 
                else if (nodeData.type === 'negative-effect') iconSpan.textContent = '(-)'; 
                else { iconSpan.style.display = 'none'; } 
                
                if (!State.isFinalizedView) { 
                    const actionsDiv = document.createElement('div'); 
                    actionsDiv.classList.add('rca-node-actions'); 
                    actionsDiv.appendChild(Utils.createActionButton('修訂此項', 'edit-node', () => Renderer.promptEditNode(nodeData.id, contentDiv))); 
                    if (nodeData.type === 'initial-problem') { 
                        actionsDiv.appendChild(Utils.createActionButton('新增原因', 'add-cause', () => Renderer.promptAddNode(nodeData.id, contentDiv, 'cause', '輸入原因描述'))); 
                    } else if (nodeData.type === 'cause') { 
                        actionsDiv.appendChild(Utils.createActionButton('新增子原因', 'add-cause', () => Renderer.promptAddNode(nodeData.id, contentDiv, 'cause', '輸入子原因描述'))); 
                        actionsDiv.appendChild(Utils.createActionButton('(+) 正面效果', 'add-positive', () => Renderer.promptAddNode(nodeData.id, contentDiv, 'positive-effect', '輸入此原因帶來的正面效果'))); 
                        actionsDiv.appendChild(Utils.createActionButton('(-) 負面效果', 'add-negative', () => Renderer.promptAddNode(nodeData.id, contentDiv, 'negative-effect', '輸入此原因導致的負面效果'))); 
                        const ncButtonText = nodeData.isNonChangeable ? '取消NC標記' : '設為NC'; 
                        actionsDiv.appendChild(Utils.createActionButton(ncButtonText, 'toggle-nc', () => NodeManager.toggleNonChangeable(nodeData.id))); 
                        actionsDiv.appendChild(Utils.createActionButton('設定ABC分類', 'set-abc', () => ModalManager.openAbcCauseCategoryModal(nodeData.id))); 
                        const { hasPositiveChild, hasNegativeChild } = NodeManager.checkChildrenEffects(nodeData);
                        if (hasPositiveChild && hasNegativeChild) { 
                            actionsDiv.appendChild(Utils.createActionButton('設定衝突參數/方案', 'set-triz', () => ModalManager.openTrizSolutionModal(nodeData.id))); 
                        }
                        if (nodeData.parentId) { 
                            actionsDiv.appendChild(Utils.createActionButton('移除此原因', 'remove-button', () => NodeManager.removeNode(nodeData.id))); 
                        } 
                    } else if (nodeData.type === 'positive-effect' || nodeData.type === 'negative-effect') { 
                        actionsDiv.appendChild(Utils.createActionButton('(+) 新增正面子效果', 'add-positive', () => Renderer.promptAddNode(nodeData.id, contentDiv, 'positive-effect', '輸入正面子效果描述'))); 
                        actionsDiv.appendChild(Utils.createActionButton('(-) 新增負面子效果', 'add-negative', () => Renderer.promptAddNode(nodeData.id, contentDiv, 'negative-effect', '輸入負面子效果描述'))); 
                        actionsDiv.appendChild(Utils.createActionButton('設定效果參數', 'set-parameters', () => ModalManager.openEffectParameterModal(nodeData.id))); 
                        actionsDiv.appendChild(Utils.createActionButton('設定AND輸入源', 'set-and-sources', () => ModalManager.openAndSourceModal(nodeData.id))); 
                        actionsDiv.appendChild(Utils.createActionButton('移除效果', 'remove-button', () => NodeManager.removeNode(nodeData.id))); 
                    } 
                    contentDiv.appendChild(actionsDiv); 
                    const inputContainer = document.createElement('div'); 
                    inputContainer.classList.add('input-group-container'); 
                    contentDiv.appendChild(inputContainer); 
                } 
                nodeDiv.appendChild(contentDiv); 
                nodeWrapper.appendChild(nodeDiv); 
                if (nodeData.children && Array.isArray(nodeData.children) && nodeData.children.length > 0) { 
                    const childrenContainer = document.createElement('div'); 
                    childrenContainer.classList.add('rca-children-container'); 
                    nodeData.children.forEach(childNode => {
                         if (childNode && typeof childNode === 'object') {
                            childrenContainer.appendChild(Renderer.createNodeElement(childNode));
                        }
                    }); 
                    nodeWrapper.appendChild(childrenContainer); 
                } 
                return nodeWrapper; 
            },
            promptEditNode: function(nodeId, parentNodeContentDiv) { 
                if (State.isFinalizedView) return; 
                const nodeToEdit = NodeManager.findNodeById(State.rcaData, nodeId); 
                if (!nodeToEdit) return; 
                const inputContainer = parentNodeContentDiv.querySelector('.input-group-container'); 
                if (!inputContainer) { console.error("Input container not found for node:", nodeId); return; } 
                document.querySelectorAll('.input-group').forEach(ig => ig.remove()); 
                inputContainer.innerHTML = ''; 
                const inputGroup = document.createElement('div'); 
                inputGroup.classList.add('input-group'); 
                const nodeInput = document.createElement('input'); 
                nodeInput.type = 'text'; 
                nodeInput.value = nodeToEdit.text; 
                nodeInput.classList.add('input-field'); 
                const saveEditButton = document.createElement('button'); 
                saveEditButton.textContent = '儲存修訂'; 
                saveEditButton.classList.add('action-button', 'save-edit-button', 'w-full', 'mt-2'); 
                saveEditButton.onclick = () => { 
                    const newText = nodeInput.value.trim(); 
                    if (newText) { 
                        nodeToEdit.text = newText; 
                        HistoryManager.pushStateToHistory(State.rcaData); 
                        Renderer.renderRcaDiagram(); 
                        TableManager.renderCauseEffectTable(); 
                        TableManager.renderSolutionTable(); 
                        inputContainer.innerHTML = ''; 
                    } else { alert('描述不能為空！'); } 
                }; 
                nodeInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') saveEditButton.click(); }); 
                const cancelEditButton = document.createElement('button'); 
                cancelEditButton.textContent = '取消修訂'; 
                cancelEditButton.classList.add('action-button', 'bg-gray-400', 'hover:bg-gray-500', 'w-full', 'mt-1'); 
                cancelEditButton.onclick = () => { inputContainer.innerHTML = ''; }; 
                inputGroup.appendChild(nodeInput); 
                inputGroup.appendChild(saveEditButton); 
                inputGroup.appendChild(cancelEditButton); 
                inputContainer.appendChild(inputGroup); 
                nodeInput.focus(); nodeInput.select(); 
            },
            promptAddNode: function(parentId, parentNodeContentDiv, nodeTypeToAdd, placeholderText) {
                if (State.isFinalizedView) return;
                const inputContainer = parentNodeContentDiv.querySelector('.input-group-container');
                if (!inputContainer) return;
                inputContainer.innerHTML = '';
                document.querySelectorAll('.input-group').forEach(ig => ig.remove());
                const inputGroup = document.createElement('div');
                inputGroup.classList.add('input-group');
                const nodeInput = document.createElement('input');
                nodeInput.type = 'text';
                nodeInput.placeholder = placeholderText;
                nodeInput.classList.add('input-field');
                const saveButton = document.createElement('button');
                saveButton.textContent = '儲存';
                saveButton.classList.add('action-button', 'save-button', 'w-full', 'mt-2');
                saveButton.onclick = () => {
                    const nodeText = nodeInput.value.trim();
                    if (nodeText) {
                        NodeManager.addNodeToData(parentId, nodeText, nodeTypeToAdd);
                        inputContainer.innerHTML = '';
                    } else { alert('描述不能為空！'); }
                };
                nodeInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') saveButton.click(); });
                const cancelButton = document.createElement('button');
                cancelButton.textContent = '取消';
                cancelButton.classList.add('action-button', 'bg-gray-400', 'hover:bg-gray-500', 'w-full', 'mt-1');
                cancelButton.onclick = () => { inputContainer.innerHTML = ''; };
                inputGroup.appendChild(nodeInput);
                inputGroup.appendChild(saveButton);
                inputGroup.appendChild(cancelButton);
                inputContainer.appendChild(inputGroup);
                nodeInput.focus();
            },
            drawAllSvgConnectors: function(targetSvgLayer = DOM.elements.svgLayer, targetDiagramContainer = DOM.elements.diagramContainer, targetScalableWrapper = DOM.elements.scalableContentWrapper, zoom = State.currentZoom) { 
                targetSvgLayer.innerHTML = ''; 
                if (!State.rcaData || !targetDiagramContainer.querySelector(`#${State.rcaData.id}`) || !targetScalableWrapper) { 
                    targetSvgLayer.setAttribute('width', 0); 
                    targetSvgLayer.setAttribute('height', 0); 
                    return; 
                } 
                
                const wrapperStyle = getComputedStyle(targetScalableWrapper);
                const wrapperPaddingLeft = parseFloat(wrapperStyle.paddingLeft) || 0;
                const wrapperPaddingTop = parseFloat(wrapperStyle.paddingTop) || 0;

                const unscaledDiagramWidth = targetDiagramContainer.scrollWidth; 
                const unscaledDiagramHeight = targetDiagramContainer.scrollHeight; 
                targetSvgLayer.setAttribute('width', unscaledDiagramWidth); 
                targetSvgLayer.setAttribute('height', unscaledDiagramHeight); 
                targetSvgLayer.setAttribute('viewBox', `0 0 ${unscaledDiagramWidth} ${unscaledDiagramHeight}`); 
                
                const lineVerticalOffset = 25; 
                const scalableWrapperRect = targetScalableWrapper.getBoundingClientRect(); 

                function drawRecursive(parentNodeData, currentContainer) { 
                    const parentElement = currentContainer.querySelector(`#${parentNodeData.id}`); 
                    if (!parentElement) return; 
                    
                    const parentRect = parentElement.getBoundingClientRect(); 
                    const parentBottomCenterX_svg = (parentRect.left - (scalableWrapperRect.left + wrapperPaddingLeft) + parentRect.width / 2) / zoom; 
                    const parentBottomY_svg = (parentRect.top - (scalableWrapperRect.top + wrapperPaddingTop) + parentRect.height) / zoom; 
                    const parentTopY_svg = (parentRect.top - (scalableWrapperRect.top + wrapperPaddingTop)) / zoom; 
                    const parentCenterX_svg = parentBottomCenterX_svg; 

                    if (parentNodeData.andSourceNodeIds && parentNodeData.andSourceNodeIds.length > 0) { 
                        const mergePointYOffset = 40; 
                        const mergePoint_svg = { x: parentCenterX_svg, y: parentTopY_svg - mergePointYOffset }; 
                        if(mergePoint_svg.y < 0) mergePoint_svg.y = 10; 
                        Renderer._drawSvgCircle(targetSvgLayer, mergePoint_svg.x, mergePoint_svg.y, 6, '#6d28d9', zoom); 
                        parentNodeData.andSourceNodeIds.forEach(sourceId => { 
                            const sourceElement = DOM.elements.diagramContainer.querySelector(`#${sourceId}`); 
                            if (sourceElement) { 
                                const sourceRect = sourceElement.getBoundingClientRect(); 
                                const sourceConnX_svg = (sourceRect.left - (scalableWrapperRect.left + wrapperPaddingLeft) + sourceRect.width / 2) / zoom; 
                                const sourceConnY_svg = (sourceRect.top - (scalableWrapperRect.top + wrapperPaddingTop) + sourceRect.height) / zoom; 
                                if (sourceConnY_svg < mergePoint_svg.y) { 
                                    Renderer._drawSvgLine(targetSvgLayer, sourceConnX_svg, sourceConnY_svg, mergePoint_svg.x, mergePoint_svg.y, '#6b7280', 2, zoom); 
                                } else { 
                                    const sourceTopY_svg = (sourceRect.top - (scalableWrapperRect.top + wrapperPaddingTop)) / zoom; 
                                    Renderer._drawSvgLine(targetSvgLayer, sourceConnX_svg, sourceTopY_svg, mergePoint_svg.x, mergePoint_svg.y, '#6b7280', 2, zoom); 
                                } 
                            } 
                        }); 
                        if (parentTopY_svg > mergePoint_svg.y) { 
                            Renderer._drawSvgLine(targetSvgLayer, mergePoint_svg.x, mergePoint_svg.y, parentCenterX_svg, parentTopY_svg, '#6b7280', 2, zoom); 
                        } 
                    } 
                    const standardChildren = parentNodeData.children ? parentNodeData.children.filter(c => c && !(c.andSourceNodeIds && c.andSourceNodeIds.length > 0 && c.andSourceNodeIds.includes(parentNodeData.id))) : []; 
                    if (standardChildren.length > 0) { 
                        const horizontalLineY_svg = parentBottomY_svg + lineVerticalOffset; 
                        Renderer._drawSvgLine(targetSvgLayer, parentBottomCenterX_svg, parentBottomY_svg, parentBottomCenterX_svg, horizontalLineY_svg, '#9ca3af', 2, zoom); 
                        if (standardChildren.length > 1) { 
                            const firstChildElement = currentContainer.querySelector(`#${standardChildren[0].id}`); 
                            const lastChildElement = currentContainer.querySelector(`#${standardChildren[standardChildren.length - 1].id}`); 
                            if (firstChildElement && lastChildElement) { 
                                const firstChildRect = firstChildElement.getBoundingClientRect(); 
                                const lastChildRect = lastChildElement.getBoundingClientRect(); 
                                const hLineStartX_svg = (firstChildRect.left - (scalableWrapperRect.left + wrapperPaddingLeft) + firstChildRect.width / 2) / zoom; 
                                const hLineEndX_svg = (lastChildRect.left - (scalableWrapperRect.left + wrapperPaddingLeft) + lastChildRect.width / 2) / zoom; 
                                if (Math.abs(hLineStartX_svg - hLineEndX_svg) > 1) { 
                                    Renderer._drawSvgLine(targetSvgLayer, hLineStartX_svg, horizontalLineY_svg, hLineEndX_svg, horizontalLineY_svg, '#9ca3af', 2, zoom); 
                                } 
                            } 
                        } else if (standardChildren.length === 1) { 
                            const childElement = currentContainer.querySelector(`#${standardChildren[0].id}`); 
                            if (childElement) { 
                                const childRect = childElement.getBoundingClientRect(); 
                                const childCenterX_svg = (childRect.left - (scalableWrapperRect.left + wrapperPaddingLeft) + childRect.width / 2) / zoom; 
                                if (Math.abs(parentBottomCenterX_svg - childCenterX_svg) > 1) { 
                                    Renderer._drawSvgLine(targetSvgLayer, parentBottomCenterX_svg, horizontalLineY_svg, childCenterX_svg, horizontalLineY_svg, '#9ca3af', 2, zoom); 
                                } 
                            } 
                        } 
                        standardChildren.forEach(childNode => { 
                            if (!childNode) return; 
                            const childElement = currentContainer.querySelector(`#${childNode.id}`); 
                            if (childElement) { 
                                const childRect = childElement.getBoundingClientRect(); 
                                const childCenterX_svg = (childRect.left - (scalableWrapperRect.left + wrapperPaddingLeft) + childRect.width / 2) / zoom; 
                                const childTopY_svg = (childRect.top - (scalableWrapperRect.top + wrapperPaddingTop)) / zoom; 
                                if (childTopY_svg > horizontalLineY_svg) { 
                                    Renderer._drawSvgLine(targetSvgLayer, childCenterX_svg, horizontalLineY_svg, childCenterX_svg, childTopY_svg, '#9ca3af', 2, zoom); 
                                } 
                            } 
                        }); 
                    } 
                    if (parentNodeData.children && Array.isArray(parentNodeData.children)) { 
                        parentNodeData.children.forEach(childNode => {
                            if (childNode && typeof childNode === 'object') drawRecursive(childNode, currentContainer)
                        }); 
                    } 
                } 
                if(State.rcaData && typeof State.rcaData === 'object') drawRecursive(State.rcaData, DOM.elements.diagramContainer); 
            },
            _drawSvgLine: function(svg, x1, y1, x2, y2, color = 'black', strokeWidth = 2, zoomFactor = 1) { 
                if (isNaN(x1) || isNaN(y1) || isNaN(x2) || isNaN(y2)) return;
                const line = document.createElementNS('http://www.w3.org/2000/svg', 'line'); 
                line.setAttribute('x1', x1); line.setAttribute('y1', y1); 
                line.setAttribute('x2', x2); line.setAttribute('y2', y2); 
                line.setAttribute('stroke', color); line.setAttribute('stroke-width', strokeWidth / zoomFactor); 
                svg.appendChild(line); 
            },
            _drawSvgCircle: function(svg, cx, cy, r, fillColor = 'black', zoomFactor = 1) { 
                if (isNaN(cx) || isNaN(cy) || isNaN(r)) return;
                const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle'); 
                circle.setAttribute('cx', cx); circle.setAttribute('cy', cy); 
                circle.setAttribute('r', r / zoomFactor); circle.setAttribute('fill', fillColor); 
                svg.appendChild(circle); 
            }
        };

        // --- "Module": FileOperations ---
        const FileOperations = {
            processLoadedData: function(dataString) {
                try {
                    const parsedJson = JSON.parse(dataString);
                    if (!parsedJson || typeof parsedJson !== 'object' || typeof parsedJson.diagramData === 'undefined') {
                        alert('載入失敗：檔案內容不正確或缺少圖表資料。'); return false;
                    }
                    State.rcaData = parsedJson.diagramData;
                    if (State.rcaData !== null && typeof State.rcaData !== 'object') {
                        alert('載入失敗：圖表資料格式不正確。'); return false;
                    }

                    if (State.rcaData) {
                        function migrateNodeDataRecursive(node) { // Renamed for clarity
                            if (!node) return;
                            if (typeof node.andSourceNodeIds === 'undefined') node.andSourceNodeIds = [];
                            if (typeof node.effectParameters === 'undefined') node.effectParameters = [];
                            
                            if (node.type === 'cause') {
                                if (typeof node.improvingParameter === 'undefined') node.improvingParameter = null;
                                if (typeof node.worseningParameter === 'undefined') node.worseningParameter = null;
                                if (typeof node.abcCategory === 'undefined') node.abcCategory = null;
                                if (typeof node.solutionsGenerated === 'undefined') node.solutionsGenerated = [];

                                if (node.inventivePrinciples && Array.isArray(node.inventivePrinciples)) {
                                    node.inventivePrinciples.forEach(oldIp => {
                                        if (!node.solutionsGenerated.some(s => s.principleName === oldIp.name && s.description === oldIp.solution)) {
                                            node.solutionsGenerated.push({
                                                id: `sol-${Date.now()}-${Math.random().toString(36).substr(2, 5)}`,
                                                principleName: oldIp.name, description: oldIp.solution,
                                                abcCategory: oldIp.abcCategory || null,
                                                timeRequired: oldIp.timeRequired || null, 
                                                mcdmScore: oldIp.mcdmScore || null,     
                                                cost: oldIp.cost || null,               
                                                idealityAssessment: oldIp.idealityAssessment || Utils.getDefaultIdealityAssessment()
                                            });
                                        }
                                    });
                                    delete node.inventivePrinciples; 
                                }

                                if(node.solutionsGenerated) {
                                    node.solutionsGenerated.forEach(sol => {
                                        if (typeof sol.timeRequired === 'undefined') sol.timeRequired = null;
                                        if (typeof sol.mcdmScore === 'undefined') sol.mcdmScore = null;
                                        if (typeof sol.cost === 'undefined') sol.cost = null;
                                        if (typeof sol.idealityAssessment === 'undefined' || sol.idealityAssessment === null) {
                                            sol.idealityAssessment = Utils.getDefaultIdealityAssessment();
                                        } else {
                                            const defaultWeights = Utils.getDefaultIdealityAssessment().weights;
                                            if (typeof sol.idealityAssessment.weights === 'undefined' || sol.idealityAssessment.weights === null) {
                                                sol.idealityAssessment.weights = defaultWeights;
                                            } else {
                                                for (const key in defaultWeights) {
                                                    if (typeof sol.idealityAssessment.weights[key] === 'undefined' || sol.idealityAssessment.weights[key] === null) {
                                                        sol.idealityAssessment.weights[key] = defaultWeights[key];
                                                    }
                                                }
                                            }
                                            const defaultScores = Utils.getDefaultIdealityAssessment();
                                            if (typeof sol.idealityAssessment.problemSolved === 'undefined') sol.idealityAssessment.problemSolved = defaultScores.problemSolved;
                                            if (typeof sol.idealityAssessment.winWin === 'undefined') sol.idealityAssessment.winWin = defaultScores.winWin;
                                            if (typeof sol.idealityAssessment.noNegativeEffects === 'undefined') sol.idealityAssessment.noNegativeEffects = defaultScores.noNegativeEffects;
                                            if (typeof sol.idealityAssessment.lowCostResource === 'undefined') sol.idealityAssessment.lowCostResource = defaultScores.lowCostResource;
                                            if (typeof sol.idealityAssessment.weightedScore === 'undefined') sol.idealityAssessment.weightedScore = defaultScores.weightedScore;
                                        }
                                    });
                                }
                            }
                            if (node.children && Array.isArray(node.children)) node.children.forEach(migrateNodeDataRecursive);
                        }
                        migrateNodeDataRecursive(State.rcaData);
                    }

                    NodeManager.recalculateNodeIdCounter(State.rcaData);
                    State.currentAbcCauseFilter = parsedJson.abcCauseFilter || parsedJson.abcFilter || 'all';
                    State.currentAbcSolutionFilter = parsedJson.abcSolutionFilter || 'all';
                    State.currentZoom = typeof parsedJson.zoomLevel === 'number' ? parsedJson.zoomLevel : 1.0;
                    State.historyStack = []; State.historyIndex = -1;
                    HistoryManager.pushStateToHistory(State.rcaData, true);

                    if (State.rcaData) {
                        DOM.elements.problemInputArea.style.display = 'none';
                        DOM.elements.diagramTitle.style.display = 'block';
                    } else {
                        DOM.elements.problemInputArea.style.display = 'flex';
                        DOM.elements.diagramTitle.style.display = 'none';
                        DOM.elements.diagramContainer.innerHTML = ''; DOM.elements.svgLayer.innerHTML = '';
                    }
                    DOM.elements.toolButtonsContainer.style.display = 'flex';
                    Renderer.renderRcaDiagram(); TableManager.renderCauseEffectTable(); TableManager.renderSolutionTable(); ChartManager.renderIdeasLandscapeChart();
                    UIInteractions.applyZoom(State.currentZoom, true);
                    alert('圖表進度已成功載入！');
                    return true;
                } catch (e) {
                    console.error("載入資料時發生錯誤:", e);
                    alert(`載入失敗：${e.message}`);
                    return false;
                }
            },
            handleSaveToLocalStorage: function() { /* ... (Implementation using State and Utils) ... */ 
                if (State.rcaData || State.rcaData === null) { 
                    try { 
                        const dataToSave = { diagramData: State.rcaData, counter: State.nodeIdCounter, zoomLevel: State.currentZoom, abcCauseFilter: State.currentAbcCauseFilter, abcSolutionFilter: State.currentAbcSolutionFilter }; 
                        localStorage.setItem('rcaDiagramData', JSON.stringify(dataToSave)); 
                        alert('圖表進度已儲存至瀏覽器！'); 
                    } catch (e) { 
                        console.error("Error saving to localStorage:", e); 
                        alert('儲存失敗，可能是瀏覽器儲存空間已滿或功能受限。'); 
                    } 
                } else { 
                    alert('沒有圖表資料可儲存。'); 
                } 
                UIInteractions.updateButtonStates(); 
            },
            handleLoadFromLocalStorage: function() { /* ... (Implementation using FileOperations.processLoadedData) ... */ 
                const savedDataString = localStorage.getItem('rcaDiagramData'); 
                if (savedDataString) { 
                    FileOperations.processLoadedData(savedDataString);
                } else { 
                    alert('瀏覽器中沒有儲存的圖表進度。'); 
                } 
                UIInteractions.updateButtonStates(); 
            },
            handleSaveToFile: function() { /* ... (Implementation using State) ... */ 
                if (State.rcaData || State.rcaData === null) { 
                    const dataToSave = { diagramData: State.rcaData, counter: State.nodeIdCounter, zoomLevel: State.currentZoom, abcCauseFilter: State.currentAbcCauseFilter, abcSolutionFilter: State.currentAbcSolutionFilter }; 
                    const jsonData = JSON.stringify(dataToSave, null, 2); 
                    const blob = new Blob([jsonData], { type: 'application/json' }); 
                    const url = URL.createObjectURL(blob); 
                    const a = document.createElement('a'); 
                    a.href = url; 
                    a.download = `創新問題解決工具-資料-${new Date().toISOString().slice(0,10)}.json`; 
                    document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url); 
                    alert('圖表資料已準備下載。'); 
                } else { 
                    alert('沒有圖表資料可儲存至檔案。');
                } 
            },
            handleLoadFromFile: function(event) { /* ... (Implementation using FileOperations.processLoadedData) ... */ 
                const file = event.target.files[0];
                const inputElement = event.target; 
                if (file) {
                    if (file.type === "application/json" || file.name.endsWith(".json")) {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            const fileContent = e.target.result;
                            FileOperations.processLoadedData(fileContent); 
                            inputElement.value = ''; 
                        };
                        reader.onerror = (e) => {
                            alert('讀取檔案時發生錯誤。');
                            console.error("FileReader error:", e);
                            inputElement.value = ''; 
                        };
                        reader.readAsText(file);
                    } else {
                        alert('載入失敗：請選擇一個有效的 .json 檔案。');
                        inputElement.value = ''; 
                    }
                }
                UIInteractions.updateButtonStates();
            },
            exportDiagramAsPNG: async function() { /* ... (Implementation using State, DOM, Renderer, UIInteractions) ... */
                if (!State.rcaData || !DOM.elements.scalableContentWrapper || !DOM.elements.diagramContainer || DOM.elements.diagramContainer.children.length === 0) {
                    alert('圖表為空或找不到圖表元素！'); return;
                }
                const activeInputGroups = DOM.elements.diagramContainer.querySelectorAll('.input-group');
                activeInputGroups.forEach(group => group.style.display = 'none');
                if (DOM.elements.fileDropdownContent.style.display === 'block') DOM.elements.fileDropdownContent.style.display = 'none';
                if (DOM.elements.exportDropdownContent.style.display === 'block') DOM.elements.exportDropdownContent.style.display = 'none';

                const originalRenderAreaScrollX = DOM.elements.diagramRenderArea.scrollLeft;
                const originalRenderAreaScrollY = DOM.elements.diagramRenderArea.scrollTop;
                const originalZoom = State.currentZoom;
                const originalAbcCauseFilter = State.currentAbcCauseFilter; 

                DOM.elements.diagramRenderArea.scrollLeft = 0; DOM.elements.diagramRenderArea.scrollTop = 0;
                UIInteractions.applyZoom(1.0, true); 
                State.currentAbcCauseFilter = 'all'; 
                Renderer.renderRcaDiagram(); 

                await new Promise(resolve => requestAnimationFrame(() => {
                    Renderer.drawAllSvgConnectors(DOM.elements.svgLayer, DOM.elements.diagramContainer, DOM.elements.scalableContentWrapper, 1.0);
                    resolve();
                }));
                
                const exportContainer = document.createElement('div');
                exportContainer.id = 'export-temp-container';
                Object.assign(exportContainer.style, {
                    position: 'absolute', left: '-99999px', top: '-99999px',
                    backgroundColor: '#ffffff', padding: '0', margin: '0', overflow: 'hidden'
                });

                const contentWidth = DOM.elements.scalableContentWrapper.scrollWidth;
                const contentHeight = DOM.elements.scalableContentWrapper.scrollHeight;
                exportContainer.style.width = contentWidth + 'px';
                exportContainer.style.height = contentHeight + 'px';
                
                const clonedScalableContent = DOM.elements.scalableContentWrapper.cloneNode(true);
                Object.assign(clonedScalableContent.style, {
                    transform: 'scale(1.0)', margin: '0', 
                    padding: getComputedStyle(DOM.elements.scalableContentWrapper).padding,
                    backgroundColor: '#ffffff', cursor: 'default'
                });

                clonedScalableContent.querySelectorAll('.rca-node-cause').forEach(node => node.classList.remove('dimmed'));
                if (State.isFinalizedView) { 
                    clonedScalableContent.querySelectorAll('.rca-node-actions').forEach(div => div.style.display = 'none');
                }
                clonedScalableContent.querySelectorAll('.input-group-container').forEach(div => div.style.display = 'none'); 
                clonedScalableContent.querySelectorAll('.rca-node').forEach(node => node.style.boxShadow = 'none'); 

                exportContainer.appendChild(clonedScalableContent);
                document.body.appendChild(exportContainer);

                const clonedDiagramContainer = clonedScalableContent.querySelector('#rca-diagram-container');
                const clonedSvgLayer = clonedScalableContent.querySelector('#svg-connector-layer');
                
                if (clonedDiagramContainer && clonedSvgLayer) {
                     await new Promise(resolve => requestAnimationFrame(() => {
                        Renderer.drawAllSvgConnectors(clonedSvgLayer, clonedDiagramContainer, clonedScalableContent, 1.0);
                        resolve();
                    }));
                }
                await new Promise(resolve => setTimeout(resolve, 300)); 

                try {
                    const canvas = await html2canvas(exportContainer, { 
                        scale: 1.5, useCORS: true, backgroundColor: '#ffffff', logging: false, 
                        width: contentWidth, height: contentHeight, 
                        x: 0, y: 0, scrollX: 0, scrollY: 0, 
                        windowWidth: contentWidth, windowHeight: contentHeight, 
                    });
                    const image = canvas.toDataURL('image/png');
                    const link = document.createElement('a');
                    link.download = '創新問題解決工具-圖表.png'; 
                    link.href = image;
                    link.click();
                } catch (err) {
                    console.error('匯出圖表失敗:', err);
                    alert('匯出圖表失敗，請檢查控制台錯誤訊息。');
                } finally {
                    document.body.removeChild(exportContainer); 
                    activeInputGroups.forEach(group => group.style.display = 'flex'); 
                    State.currentAbcCauseFilter = originalAbcCauseFilter; 
                    UIInteractions.applyZoom(originalZoom, true); 
                    Renderer.renderRcaDiagram(); 
                    DOM.elements.diagramRenderArea.scrollLeft = originalRenderAreaScrollX;
                    DOM.elements.diagramRenderArea.scrollTop = originalRenderAreaScrollY;
                    requestAnimationFrame(() => Renderer.drawAllSvgConnectors());
                }
            }
        };
        
        // --- "Module": ModalManager ---
        const ModalManager = {
            openAbcCauseCategoryModal: function(nodeId) { /* ... (Implementation using State, DOM, NodeManager, Renderer, TableManager) ... */ 
                if (State.isFinalizedView) return;
                State.currentAbcCauseTargetNodeId = nodeId;
                const node = NodeManager.findNodeById(State.rcaData, nodeId);
                if (!node || node.type !== 'cause') {
                    alert('只能為原因節點設定ABC分類。'); return;
                }
                const modal = DOM.elements.abcCategoryModal; 
                if (!modal.innerHTML.trim()) { 
                    modal.innerHTML = `
                        <div class="modal-content mx-auto p-5 border w-11/12 md:w-1/2 lg:w-1/3 shadow-lg rounded-md bg-white">
                            <button class="modal-close-button" onclick="document.getElementById('abc-category-modal').style.display='none'; State.currentAbcCauseTargetNodeId = null;">&times;</button>
                            <div class="mt-3">
                                <h3 class="text-lg leading-6 font-medium text-gray-900 text-center" id="abc-modal-title">設定原因ABC分類</h3>
                                <p class="text-sm text-gray-600 mb-3 text-center" id="abc-modal-node-text"></p>
                                <div class="flex justify-around">
                                    <button data-abc-cause="A" class="action-button bg-red-500 hover:bg-red-600 px-6 py-2">A 類</button>
                                    <button data-abc-cause="B" class="action-button bg-orange-500 hover:bg-orange-600 px-6 py-2">B 類</button>
                                    <button data-abc-cause="C" class="action-button bg-amber-500 hover:bg-amber-600 px-6 py-2">C 類</button>
                                </div>
                                <div class="mt-4 text-center">
                                     <button data-abc-cause="null" class="action-button bg-gray-400 hover:bg-gray-500 px-6 py-2">清除分類</button>
                                </div>
                            </div>
                        </div>`;
                    modal.querySelectorAll('button[data-abc-cause]').forEach(button => {
                        button.addEventListener('click', (event) => {
                            const category = event.target.dataset.abcCause === 'null' ? null : event.target.dataset.abcCause;
                            ModalManager.handleSaveAbcCauseCategory(category);
                            modal.style.display = 'none'; 
                        });
                    });
                }
                modal.querySelector('#abc-modal-node-text').textContent = `節點：${node.text.substring(0,30)}${node.text.length > 30 ? '...' : ''}`;
                modal.querySelectorAll('button[data-abc-cause]').forEach(btn => {
                    btn.classList.remove('ring-2', 'ring-offset-2', 'ring-blue-500');
                    if (btn.dataset.abcCause === (node.abcCategory || 'null')) {
                        btn.classList.add('ring-2', 'ring-offset-2', 'ring-blue-500');
                    }
                });
                modal.style.display = 'flex';
            },
            handleSaveAbcCauseCategory: function(category) { /* ... (Implementation using State, NodeManager, HistoryManager, Renderer, TableManager) ... */ 
                if (!State.currentAbcCauseTargetNodeId) return;
                const node = NodeManager.findNodeById(State.rcaData, State.currentAbcCauseTargetNodeId);
                if (node && node.type === 'cause') {
                    node.abcCategory = category; 
                    HistoryManager.pushStateToHistory(State.rcaData);
                    Renderer.renderRcaDiagram();
                    TableManager.renderCauseEffectTable(); 
                    State.currentAbcCauseTargetNodeId = null;
                }
            },
            openTrizSolutionModal: function(causeNodeId) { /* ... (Implementation using State, DOM, NodeManager, Renderer, TableManager, Constants) ... */ 
                if (State.isFinalizedView) return;
                State.currentTrizCauseNodeId = causeNodeId;
                const causeNode = NodeManager.findNodeById(State.rcaData, causeNodeId);
                if (!causeNode || causeNode.type !== 'cause') return;

                DOM.elements.trizModalCauseText.textContent = `矛盾原因: ${causeNode.text.substring(0,50)}${causeNode.text.length > 50 ? '...' : ''}`;
                DOM.elements.improvingParameterSelect.value = causeNode.improvingParameter || "";
                DOM.elements.worseningParameterSelect.value = causeNode.worseningParameter || "";
                
                ModalManager.updateSuggestedPrinciples(); 
                ModalManager.renderSolutionsListForCause(causeNodeId);
                DOM.elements.editSolutionEntryContainer.style.display = 'none'; 
                DOM.elements.trizSolutionModal.style.display = 'flex';
            },
            closeTrizSolutionModal: function() { /* ... (Implementation using DOM, Renderer, TableManager, State) ... */ 
                DOM.elements.trizSolutionModal.style.display = 'none';
                State.currentTrizCauseNodeId = null;
                Renderer.renderRcaDiagram(); 
                TableManager.renderSolutionTable(); 
            },
            updateSuggestedPrinciples: function() { /* ... (Implementation using DOM, Constants, BUSINESS_CONTRADICTION_MATRIX) ... */ 
                const improvingParam = DOM.elements.improvingParameterSelect.value;
                const worseningParam = DOM.elements.worseningParameterSelect.value;
                DOM.elements.suggestedPrinciplesList.innerHTML = ''; 

                if (improvingParam && worseningParam && improvingParam !== "未選擇" && worseningParam !== "未選擇") {
                    const principlesArray = Constants.BUSINESS_CONTRADICTION_MATRIX[improvingParam]?.[worseningParam];
                    
                    if (principlesArray && principlesArray.length > 0) {
                        DOM.elements.suggestedPrinciplesContainer.style.display = 'block';
                        principlesArray.forEach(num => {
                            const principleName = Constants.INVENTIVE_PRINCIPLES[num - 1]; 
                            if (principleName) {
                                const li = document.createElement('li');
                                li.textContent = `${num}. ${principleName}`;
                                DOM.elements.suggestedPrinciplesList.appendChild(li);
                            }
                        });
                    } else {
                        DOM.elements.suggestedPrinciplesContainer.style.display = 'none';
                    }
                } else {
                    DOM.elements.suggestedPrinciplesContainer.style.display = 'none';
                }
            },
            handleSaveTrizParameters: function() { /* ... (Implementation using State, DOM, NodeManager, HistoryManager, TableManager) ... */ 
                if (!State.currentTrizCauseNodeId) return;
                const causeNode = NodeManager.findNodeById(State.rcaData, State.currentTrizCauseNodeId);
                if (causeNode) {
                    const oldImproving = causeNode.improvingParameter;
                    const oldWorsening = causeNode.worseningParameter;
                    causeNode.improvingParameter = DOM.elements.improvingParameterSelect.value === "未選擇" ? null : DOM.elements.improvingParameterSelect.value;
                    causeNode.worseningParameter = DOM.elements.worseningParameterSelect.value === "未選擇" ? null : DOM.elements.worseningParameterSelect.value;
                    
                    ModalManager.updateSuggestedPrinciples(); 

                    if (oldImproving !== causeNode.improvingParameter || oldWorsening !== causeNode.worseningParameter) {
                        HistoryManager.pushStateToHistory(State.rcaData);
                        TableManager.renderSolutionTable(); 
                    }
                }
            },
            renderSolutionsListForCause: function(causeNodeId) { /* ... (Implementation using DOM, State, NodeManager, Constants) ... */ 
                DOM.elements.solutionsListContainer.innerHTML = '';
                const causeNode = NodeManager.findNodeById(State.rcaData, causeNodeId);
                if (!causeNode || !causeNode.solutionsGenerated || causeNode.solutionsGenerated.length === 0) {
                    DOM.elements.solutionsListContainer.innerHTML = '<p class="text-xs text-gray-500">此原因尚無解決方案。</p>';
                    return;
                }

                causeNode.solutionsGenerated.forEach(sol => {
                    const solDiv = document.createElement('div');
                    solDiv.className = 'solution-entry flex justify-between items-center text-sm';
                    let solText = `<span class="font-semibold">${sol.principleName || '未指定原理'}:</span>
                                   <span class="ml-2">${sol.description ? sol.description.substring(0, 40) + (sol.description.length > 40 ? '...' : '') : '無描述'}</span>`;
                    if (sol.timeRequired !== null || sol.mcdmScore !== null) {
                        solText += `<br><span class="text-xs text-gray-500">時:${sol.timeRequired ?? '-'} | 分:${sol.mcdmScore ?? '-'} | 成本:${sol.cost ?? '-'}</span>`;
                    }

                    solDiv.innerHTML = `
                        <div>${solText}</div>
                        <div>
                            <button class="action-button bg-yellow-500 hover:bg-yellow-600 text-xs py-1 px-1.5 mr-1" onclick="ModalManager.showEditSolutionEntry('${sol.id}')" title="編輯方案"><i class="fas fa-edit"></i></button>
                            <button class="action-button bg-red-500 hover:bg-red-600 text-xs py-1 px-1.5" onclick="ModalManager.handleRemoveSolutionEntry('${sol.id}')" title="移除方案"><i class="fas fa-trash"></i></button>
                        </div>
                    `;
                    DOM.elements.solutionsListContainer.appendChild(solDiv);
                });
            },
            showEditSolutionEntry: function(solutionId) { /* ... (Implementation using DOM, State, NodeManager, Constants) ... */ 
                const causeNode = NodeManager.findNodeById(State.rcaData, State.currentTrizCauseNodeId);
                if (!causeNode) return;

                DOM.elements.editingSolutionIdInput.value = solutionId || '';
                if (solutionId) {
                    const solution = causeNode.solutionsGenerated.find(s => s.id === solutionId);
                    if (solution) {
                        DOM.elements.editSolutionTitle.textContent = "修訂解決方案";
                        DOM.elements.solutionPrincipleSelect.value = solution.principleName;
                        DOM.elements.solutionDescriptionInput.value = solution.description;
                        DOM.elements.solutionTimeRequiredInput.value = solution.timeRequired || '';
                        DOM.elements.solutionMcdmScoreInput.value = solution.mcdmScore || '';
                        DOM.elements.solutionCostInput.value = solution.cost || '';
                    } else { return; } 
                } else {
                    DOM.elements.editSolutionTitle.textContent = "新增解決方案";
                    DOM.elements.solutionPrincipleSelect.value = Constants.INVENTIVE_PRINCIPLES[0]; 
                    DOM.elements.solutionDescriptionInput.value = '';
                    DOM.elements.solutionTimeRequiredInput.value = '';
                    DOM.elements.solutionMcdmScoreInput.value = '';
                    DOM.elements.solutionCostInput.value = '';
                }
                DOM.elements.editSolutionEntryContainer.style.display = 'block';
                DOM.elements.solutionDescriptionInput.focus();
            },
            handleSaveSolutionEntry: function() { /* ... (Implementation using State, DOM, NodeManager, HistoryManager, TableManager, ChartManager, Utils.getDefaultIdealityAssessment) ... */ 
                if (!State.currentTrizCauseNodeId) return;
                const causeNode = NodeManager.findNodeById(State.rcaData, State.currentTrizCauseNodeId);
                if (!causeNode) return;

                const solutionId = DOM.elements.editingSolutionIdInput.value;
                const principle = DOM.elements.solutionPrincipleSelect.value;
                const description = DOM.elements.solutionDescriptionInput.value.trim();
                const timeRequired = DOM.elements.solutionTimeRequiredInput.value ? parseFloat(DOM.elements.solutionTimeRequiredInput.value) : null;
                const mcdmScore = DOM.elements.solutionMcdmScoreInput.value ? parseFloat(DOM.elements.solutionMcdmScoreInput.value) : null;
                const cost = DOM.elements.solutionCostInput.value ? parseFloat(DOM.elements.solutionCostInput.value) : null;

                if (!principle || principle === "未選擇") { alert("請選擇一個發明原理。"); return; }
                if (!description) { alert("請輸入方案描述。"); return; }

                if (!causeNode.solutionsGenerated) causeNode.solutionsGenerated = [];

                if (solutionId) { 
                    const solIndex = causeNode.solutionsGenerated.findIndex(s => s.id === solutionId);
                    if (solIndex > -1) {
                        causeNode.solutionsGenerated[solIndex].principleName = principle;
                        causeNode.solutionsGenerated[solIndex].description = description;
                        causeNode.solutionsGenerated[solIndex].timeRequired = timeRequired;
                        causeNode.solutionsGenerated[solIndex].mcdmScore = mcdmScore;
                        causeNode.solutionsGenerated[solIndex].cost = cost;
                        if (!causeNode.solutionsGenerated[solIndex].idealityAssessment) {
                             causeNode.solutionsGenerated[solIndex].idealityAssessment = Utils.getDefaultIdealityAssessment();
                        }
                    }
                } else { 
                    causeNode.solutionsGenerated.push({
                        id: `sol-${Date.now()}-${Math.random().toString(36).substr(2, 5)}`,
                        principleName: principle, description: description, abcCategory: null,
                        timeRequired: timeRequired, mcdmScore: mcdmScore, cost: cost,
                        idealityAssessment: Utils.getDefaultIdealityAssessment()
                    });
                }
                HistoryManager.pushStateToHistory(State.rcaData);
                ModalManager.renderSolutionsListForCause(State.currentTrizCauseNodeId);
                DOM.elements.editSolutionEntryContainer.style.display = 'none';
                DOM.elements.editingSolutionIdInput.value = '';
                TableManager.renderSolutionTable(); 
                ChartManager.renderIdeasLandscapeChart(); 
            },
            handleRemoveSolutionEntry: function(solutionId) { /* ... (Implementation using State, NodeManager, HistoryManager, TableManager, ChartManager) ... */ 
                if (!State.currentTrizCauseNodeId || !solutionId) return;
                const causeNode = NodeManager.findNodeById(State.rcaData, State.currentTrizCauseNodeId);
                if (causeNode && causeNode.solutionsGenerated) {
                    causeNode.solutionsGenerated = causeNode.solutionsGenerated.filter(s => s.id !== solutionId);
                    HistoryManager.pushStateToHistory(State.rcaData);
                    ModalManager.renderSolutionsListForCause(State.currentTrizCauseNodeId);
                    TableManager.renderSolutionTable(); 
                    ChartManager.renderIdeasLandscapeChart(); 
                }
            },
            openIdealityAssessmentModal: function(causeId, solutionId) { /* ... (Implementation using State, DOM, NodeManager, Utils.getDefaultIdealityAssessment) ... */ 
                const causeNode = NodeManager.findNodeById(State.rcaData, causeId);
                if (!causeNode || !causeNode.solutionsGenerated) return;
                const solution = causeNode.solutionsGenerated.find(s => s.id === solutionId);
                if (!solution) return;

                State.currentAssessingSolution = { causeId, solutionId };
                DOM.elements.assessingSolutionCauseIdInput.value = causeId;
                DOM.elements.assessingSolutionEntryIdInput.value = solutionId;
                DOM.elements.idealityModalSolutionText.textContent = `評估方案: ${solution.description.substring(0,60)}${solution.description.length > 60 ? '...' : ''}`;

                const assessment = solution.idealityAssessment || Utils.getDefaultIdealityAssessment(); 
                const weights = assessment.weights || Utils.getDefaultIdealityAssessment().weights; 

                DOM.elements.idealityProblemSolvedRange.value = assessment.problemSolved !== null ? assessment.problemSolved : 5;
                DOM.elements.idealityProblemSolvedValue.textContent = DOM.elements.idealityProblemSolvedRange.value;
                DOM.elements.idealityProblemSolvedWeight.value = weights.problemSolved !== null ? weights.problemSolved : 0.25;
                // ... (Repeat for other criteria)
                DOM.elements.idealityWinWinRange.value = assessment.winWin !== null ? assessment.winWin : 5;
                DOM.elements.idealityWinWinValue.textContent = DOM.elements.idealityWinWinRange.value;
                DOM.elements.idealityWinWinWeight.value = weights.winWin !== null ? weights.winWin : 0.25;
                
                DOM.elements.idealityNoNegativeEffectsRange.value = assessment.noNegativeEffects !== null ? assessment.noNegativeEffects : 5;
                DOM.elements.idealityNoNegativeEffectsValue.textContent = DOM.elements.idealityNoNegativeEffectsRange.value;
                DOM.elements.idealityNoNegativeEffectsWeight.value = weights.noNegativeEffects !== null ? weights.noNegativeEffects : 0.25;

                DOM.elements.idealityLowCostResourceRange.value = assessment.lowCostResource !== null ? assessment.lowCostResource : 5;
                DOM.elements.idealityLowCostResourceValue.textContent = DOM.elements.idealityLowCostResourceRange.value;
                DOM.elements.idealityLowCostResourceWeight.value = weights.lowCostResource !== null ? weights.lowCostResource : 0.25;
                
                ModalManager.updateIdealityTotalScoreDisplay();
                DOM.elements.idealityAssessmentModal.style.display = 'flex';
            },
            closeIdealityAssessmentModal: function() { /* ... (Implementation using DOM, State) ... */ 
                DOM.elements.idealityAssessmentModal.style.display = 'none';
                State.currentAssessingSolution = { causeId: null, solutionId: null };
            },
            updateIdealityTotalScoreDisplay: function() { /* ... (Implementation using DOM) ... */ 
                const scores = {
                    problemSolved: parseFloat(DOM.elements.idealityProblemSolvedRange.value),
                    winWin: parseFloat(DOM.elements.idealityWinWinRange.value),
                    noNegativeEffects: parseFloat(DOM.elements.idealityNoNegativeEffectsRange.value),
                    lowCostResource: parseFloat(DOM.elements.idealityLowCostResourceRange.value)
                };
                const weights = {
                    problemSolved: parseFloat(DOM.elements.idealityProblemSolvedWeight.value) || 0,
                    winWin: parseFloat(DOM.elements.idealityWinWinWeight.value) || 0,
                    noNegativeEffects: parseFloat(DOM.elements.idealityNoNegativeEffectsWeight.value) || 0,
                    lowCostResource: parseFloat(DOM.elements.idealityLowCostResourceWeight.value) || 0
                };
                let totalWeightedScore = 0; let totalWeightSum = 0;
                for (const key in scores) {
                    totalWeightedScore += scores[key] * weights[key];
                    totalWeightSum += weights[key];
                }
                DOM.elements.idealityTotalScoreDisplay.textContent = totalWeightedScore.toFixed(2);
                if (Math.abs(totalWeightSum - 1.0) > 0.001) { 
                    DOM.elements.idealityWeightsSumWarning.textContent = `注意：目前權重總和為 ${totalWeightSum.toFixed(2)}，建議調整至 1。`;
                    DOM.elements.idealityWeightsSumWarning.style.display = 'block';
                } else {
                    DOM.elements.idealityWeightsSumWarning.style.display = 'none';
                }
            },
            handleSaveIdealityAssessment: function() { /* ... (Implementation using State, DOM, NodeManager, HistoryManager, TableManager, ChartManager, Utils.getDefaultIdealityAssessment) ... */ 
                const causeId = DOM.elements.assessingSolutionCauseIdInput.value;
                const solutionId = DOM.elements.assessingSolutionEntryIdInput.value;
                if (!causeId || !solutionId) return;
                const causeNode = NodeManager.findNodeById(State.rcaData, causeId);
                if (!causeNode || !causeNode.solutionsGenerated) return;
                const solution = causeNode.solutionsGenerated.find(s => s.id === solutionId);
                if (!solution) return;

                if (!solution.idealityAssessment) solution.idealityAssessment = Utils.getDefaultIdealityAssessment();
                if (!solution.idealityAssessment.weights) solution.idealityAssessment.weights = Utils.getDefaultIdealityAssessment().weights;

                solution.idealityAssessment.problemSolved = parseFloat(DOM.elements.idealityProblemSolvedRange.value);
                solution.idealityAssessment.winWin = parseFloat(DOM.elements.idealityWinWinRange.value);
                solution.idealityAssessment.noNegativeEffects = parseFloat(DOM.elements.idealityNoNegativeEffectsRange.value);
                solution.idealityAssessment.lowCostResource = parseFloat(DOM.elements.idealityLowCostResourceRange.value);
                solution.idealityAssessment.weights.problemSolved = parseFloat(DOM.elements.idealityProblemSolvedWeight.value);
                solution.idealityAssessment.weights.winWin = parseFloat(DOM.elements.idealityWinWinWeight.value);
                solution.idealityAssessment.weights.noNegativeEffects = parseFloat(DOM.elements.idealityNoNegativeEffectsWeight.value);
                solution.idealityAssessment.weights.lowCostResource = parseFloat(DOM.elements.idealityLowCostResourceWeight.value);
                
                let totalWeightedScore = (solution.idealityAssessment.problemSolved * solution.idealityAssessment.weights.problemSolved) +
                                         (solution.idealityAssessment.winWin * solution.idealityAssessment.weights.winWin) +
                                         (solution.idealityAssessment.noNegativeEffects * solution.idealityAssessment.weights.noNegativeEffects) +
                                         (solution.idealityAssessment.lowCostResource * solution.idealityAssessment.weights.lowCostResource);
                solution.idealityAssessment.weightedScore = totalWeightedScore;

                HistoryManager.pushStateToHistory(State.rcaData);
                TableManager.renderSolutionTable(); 
                ChartManager.renderIdeasLandscapeChart(); 
                ModalManager.closeIdealityAssessmentModal();
            },
             closeAndSourceModal: function() { // Added for completeness
                DOM.elements.andSourceModal.style.display = 'none';
                State.currentAndTargetNodeId = null;
            },
            closeEffectParameterModal: function() { // Added for completeness
                DOM.elements.effectParameterModal.style.display = 'none';
                State.currentParameterTargetNodeId = null;
            }
        };

        // --- "Module": TableManager ---
        const TableManager = {
            handleToggleCauseEffectTable: function() { /* ... (Implementation using DOM, TableManager.renderCauseEffectTable) ... */ 
                const isHidden = DOM.elements.causeEffectTableSection.style.display === 'none'; 
                DOM.elements.causeEffectTableSection.style.display = isHidden ? 'block' : 'none'; 
                DOM.elements.toggleCauseEffectTableButton.textContent = isHidden ? '隱藏原因效果表' : '顯示原因效果表'; 
                if (isHidden) TableManager.renderCauseEffectTable();
            },
            getCauseEffectTableData: function() { /* ... (Implementation using State, NodeManager.checkChildrenEffects) ... */ 
                const tableRowsData = []; 
                function collectDataRecursive(node) { 
                    if (!node) return; 
                    if (node.type === 'cause') { 
                        const { hasPositiveChild, hasNegativeChild } = NodeManager.checkChildrenEffects(node); 
                        let causeType = ''; 
                        if (node.isNonChangeable) causeType = 'NC'; 
                        else if (hasPositiveChild && hasNegativeChild) causeType = 'N+P (矛盾)'; 
                        else if (hasNegativeChild) causeType = 'N (純負面)'; 
                        else if (hasPositiveChild) causeType = 'P (純正面)'; 
                        else causeType = '未定義效果'; 
                        if (causeType !== 'P (純正面)' || (hasPositiveChild || hasNegativeChild)) { 
                            const positiveEffects = (node.children && Array.isArray(node.children) ? node.children.filter(c => c && c.type === 'positive-effect').map(c => c.text).join('; ') : '') || '無'; 
                            const negativeEffects = (node.children && Array.isArray(node.children) ? node.children.filter(c => c && c.type === 'negative-effect').map(c => c.text).join('; ') : '') || '無'; 
                            tableRowsData.push({ cause: node.text, abc: node.abcCategory || '-', type: causeType, positive: positiveEffects, negative: negativeEffects }); 
                        } 
                    } 
                    if (node.children && Array.isArray(node.children)) node.children.forEach(collectDataRecursive); 
                } 
                if (State.rcaData) collectDataRecursive(State.rcaData); 
                return tableRowsData; 
            },
            renderCauseEffectTable: function() { /* ... (Implementation using DOM, TableManager.getCauseEffectTableData) ... */ 
                if (!State.rcaData) { 
                    DOM.elements.causeEffectTableBody.innerHTML = '<tr><td colspan="5" class="text-center text-gray-500">請先設定主要負面效果並建立分析圖。</td></tr>'; return; 
                } 
                const tableData = TableManager.getCauseEffectTableData(); 
                DOM.elements.causeEffectTableBody.innerHTML = ''; 
                if (tableData.length === 0) { 
                    DOM.elements.causeEffectTableBody.innerHTML = '<tr><td colspan="5" class="text-center text-gray-500">目前圖表中沒有定義直接帶有正面或負面效果的原因 (且非純粹正面原因)。</td></tr>'; return; 
                } 
                tableData.forEach(rowData => { 
                    const row = DOM.elements.causeEffectTableBody.insertRow(); 
                    row.insertCell().textContent = rowData.cause; 
                    row.insertCell().textContent = rowData.abc; 
                    row.insertCell().textContent = rowData.type; 
                    row.insertCell().textContent = rowData.positive; 
                    row.insertCell().textContent = rowData.negative; 
                }); 
            },
            handleToggleSolutionTable: function() { /* ... (Implementation using DOM, TableManager.renderSolutionTable) ... */ 
                const isHidden = DOM.elements.solutionTableSection.style.display === 'none'; 
                DOM.elements.solutionTableSection.style.display = isHidden ? 'block' : 'none'; 
                DOM.elements.toggleSolutionTableButton.textContent = isHidden ? '隱藏潛在解決方案表' : '顯示潛在解決方案表'; 
                if (isHidden) TableManager.renderSolutionTable(); 
            },
            renderSolutionTable: function() { /* ... (Implementation using State, DOM, TableManager.getAllSolutionsWithDetails, Utils.createActionButton, ModalManager.openIdealityAssessmentModal) ... */ 
                if (!State.rcaData) {
                    DOM.elements.solutionTableBody.innerHTML = '<tr><td colspan="8" class="text-center text-gray-500">請先設定主要負面效果並建立分析圖。</td></tr>'; return;
                }
                const allSolutions = TableManager.getAllSolutionsWithDetails();
                DOM.elements.solutionTableBody.innerHTML = '';
                const filteredSolutions = allSolutions.filter(sol => {
                    if (State.currentAbcSolutionFilter === 'all') return true;
                    if (State.currentAbcSolutionFilter === 'none') return !sol.abcCategory;
                    return sol.abcCategory === State.currentAbcSolutionFilter;
                });
                if (filteredSolutions.length === 0) {
                    let message = '目前沒有符合篩選條件的潛在解決方案。';
                    if (allSolutions.length === 0) message = '提示：請先找出矛盾原因 (同時有`+`和`-`效果)，然後為其「設定衝突參數/方案」。';
                    DOM.elements.solutionTableBody.innerHTML = `<tr><td colspan="8" class="text-center text-gray-500">${message}</td></tr>`; return;
                }
                filteredSolutions.forEach(solDetail => {
                    const row = DOM.elements.solutionTableBody.insertRow();
                    row.insertCell().textContent = solDetail.causeText;
                    row.insertCell().textContent = solDetail.improvingParameter || '-';
                    row.insertCell().textContent = solDetail.worseningParameter || '-';
                    row.insertCell().textContent = solDetail.principleName;
                    row.insertCell().textContent = solDetail.description;
                    const abcCell = row.insertCell();
                    const abcSelect = document.createElement('select');
                    abcSelect.classList.add('abc-select');
                    ['-', 'A', 'B', 'C'].forEach(cat => {
                        const option = document.createElement('option');
                        option.value = cat === '-' ? '' : cat; option.textContent = cat;
                        if ((solDetail.abcCategory || '') === option.value) option.selected = true;
                        abcSelect.appendChild(option);
                    });
                    abcSelect.onchange = (e) => TableManager.updateSolutionAbcCategory(solDetail.causeId, solDetail.solutionId, e.target.value || null);
                    abcCell.appendChild(abcSelect);
                    const assessCell = row.insertCell();
                    const assessButton = Utils.createActionButton('評估理想性', 'ideality-assess-button bg-blue-500 hover:bg-blue-600', () => ModalManager.openIdealityAssessmentModal(solDetail.causeId, solDetail.solutionId));
                    assessCell.appendChild(assessButton);
                    const scoreCell = row.insertCell();
                    scoreCell.classList.add('ideality-score-display');
                    scoreCell.textContent = solDetail.idealityAssessment && solDetail.idealityAssessment.weightedScore !== null && solDetail.idealityAssessment.weightedScore !== undefined ? solDetail.idealityAssessment.weightedScore.toFixed(2) : '-';
                });
            },
            getAllSolutionsWithDetails: function() { /* ... (Implementation using State, NodeManager.checkChildrenEffects, Utils.getDefaultIdealityAssessment) ... */ 
                const solutionsList = []; 
                function findSolutionsRecursive(node) { 
                    if (!node) return; 
                    if (node.type === 'cause' && node.solutionsGenerated && node.solutionsGenerated.length > 0) { 
                        const { hasPositiveChild, hasNegativeChild } = NodeManager.checkChildrenEffects(node); 
                        if (hasPositiveChild && hasNegativeChild) { 
                            node.solutionsGenerated.forEach(sol => { 
                                solutionsList.push({ 
                                    causeId: node.id, causeText: node.text, 
                                    improvingParameter: node.improvingParameter, worseningParameter: node.worseningParameter, 
                                    solutionId: sol.id, principleName: sol.principleName, description: sol.description, 
                                    abcCategory: sol.abcCategory, timeRequired: sol.timeRequired, mcdmScore: sol.mcdmScore, cost: sol.cost, 
                                    idealityAssessment: sol.idealityAssessment || Utils.getDefaultIdealityAssessment() 
                                }); 
                            }); 
                        } 
                    } 
                    if (node.children && Array.isArray(node.children)) node.children.forEach(findSolutionsRecursive); 
                } 
                if (State.rcaData) findSolutionsRecursive(State.rcaData); 
                return solutionsList; 
            },
            updateSolutionAbcCategory: function(causeId, solutionId, newAbcCategory) { /* ... (Implementation using State, NodeManager.findNodeById, HistoryManager, TableManager.renderSolutionTable, ChartManager.renderIdeasLandscapeChart) ... */ 
                const causeNode = NodeManager.findNodeById(State.rcaData, causeId);
                if (causeNode && causeNode.solutionsGenerated) {
                    const solution = causeNode.solutionsGenerated.find(s => s.id === solutionId);
                    if (solution) {
                        solution.abcCategory = newAbcCategory;
                        HistoryManager.pushStateToHistory(State.rcaData);
                        TableManager.renderSolutionTable(); 
                        ChartManager.renderIdeasLandscapeChart(); 
                    }
                }
            }
        };

        // --- "Module": ChartManager ---
        const ChartManager = {
            quadrantPlugin: { /* ... (Plugin definition remains the same) ... */ 
                 id: 'quadrantDrawer',
                afterDraw: (chart, args, options) => {
                    const {ctx, chartArea: {left, right, top, bottom}, scales: {x, y}} = chart;
                    const timeThreshold = options.timeThreshold;
                    const scoreThreshold = options.scoreThreshold;

                    ctx.save();
                    ctx.globalCompositeOperation = 'destination-over'; 

                    const xThresholdPixel = x.getPixelForValue(timeThreshold);
                    const yThresholdPixel = y.getPixelForValue(scoreThreshold);

                    const q2 = { x: left, y: top, width: xThresholdPixel - left, height: yThresholdPixel - top }; 
                    const q1 = { x: xThresholdPixel, y: top, width: right - xThresholdPixel, height: yThresholdPixel - top }; 
                    const q3 = { x: left, y: yThresholdPixel, width: xThresholdPixel - left, height: bottom - yThresholdPixel }; 
                    const q4 = { x: xThresholdPixel, y: yThresholdPixel, width: right - xThresholdPixel, height: bottom - yThresholdPixel }; 

                    ctx.fillStyle = Constants.QUADRANT_COLORS.Q2; if (q2.width > 0 && q2.height > 0) ctx.fillRect(q2.x, q2.y, q2.width, q2.height);
                    ctx.fillStyle = Constants.QUADRANT_COLORS.Q1; if (q1.width > 0 && q1.height > 0) ctx.fillRect(q1.x, q1.y, q1.width, q1.height);
                    ctx.fillStyle = Constants.QUADRANT_COLORS.Q3; if (q3.width > 0 && q3.height > 0) ctx.fillRect(q3.x, q3.y, q3.width, q3.height);
                    ctx.fillStyle = Constants.QUADRANT_COLORS.Q4; if (q4.width > 0 && q4.height > 0) ctx.fillRect(q4.x, q4.y, q4.width, q4.height);
                    
                    ctx.globalCompositeOperation = 'source-over'; 

                    if (xThresholdPixel >= left && xThresholdPixel <= right) {
                        ctx.beginPath(); ctx.strokeStyle = 'rgba(0, 0, 0, 0.4)'; ctx.lineWidth = 1.5; ctx.setLineDash([6, 3]);
                        ctx.moveTo(xThresholdPixel, top); ctx.lineTo(xThresholdPixel, bottom); ctx.stroke(); ctx.setLineDash([]);
                    }
                    if (yThresholdPixel >= top && yThresholdPixel <= bottom) {
                        ctx.beginPath(); ctx.strokeStyle = 'rgba(0, 0, 0, 0.4)'; ctx.lineWidth = 1.5; ctx.setLineDash([6, 3]);
                        ctx.moveTo(left, yThresholdPixel); ctx.lineTo(right, yThresholdPixel); ctx.stroke(); ctx.setLineDash([]);
                    }
                    
                    ctx.fillStyle = '#374151'; 
                    ctx.font = 'bold 11px Inter';
                    ctx.textAlign = 'center';
                    const padding = 8;
                    
                    if (q2.width > 20 && q2.height > 20) ctx.fillText(Constants.QUADRANT_LABELS.Q2, q2.x + q2.width / 2, q2.y + padding + 5);
                    if (q3.width > 20 && q3.height > 20) ctx.fillText(Constants.QUADRANT_LABELS.Q3, q3.x + q3.width / 2, q3.y + q3.height - padding);
                    if (q1.width > 20 && q1.height > 20) ctx.fillText(Constants.QUADRANT_LABELS.Q1, q1.x + q1.width / 2, q1.y + padding + 5);
                    if (q4.width > 20 && q4.height > 20) ctx.fillText(Constants.QUADRANT_LABELS.Q4, q4.x + q4.width / 2, q4.y + q4.height - padding);

                    ctx.restore();
                }
            },
            handleToggleIdeasLandscape: function() { /* ... (Implementation using DOM, ChartManager.renderIdeasLandscapeChart) ... */ 
                const isHidden = DOM.elements.ideasLandscapeSection.style.display === 'none';
                DOM.elements.ideasLandscapeSection.style.display = isHidden ? 'block' : 'none';
                DOM.elements.toggleIdeasLandscapeButton.textContent = isHidden ? '隱藏創意景觀圖' : '顯示創意景觀圖';
                if (isHidden) ChartManager.renderIdeasLandscapeChart();
            },
            getChartDataPoints: function() { /* ... (Implementation using TableManager.getAllSolutionsWithDetails) ... */ 
                const solutions = TableManager.getAllSolutionsWithDetails().filter(s => s.timeRequired !== null && s.mcdmScore !== null);
                return solutions.map(sol => ({
                    x: sol.timeRequired, y: sol.mcdmScore, label: sol.description, 
                    shortLabel: sol.description.substring(0, 20) + (sol.description.length > 20 ? "..." : ""), 
                    cost: sol.cost, abc: sol.abcCategory || 'none', ideality: sol.idealityAssessment?.weightedScore, id: sol.solutionId
                }));
            },
            getChartOptions: function(timeThreshold, scoreThreshold) { /* ... (Implementation using Constants) ... */ 
                return {
                    responsive: true, maintainAspectRatio: false,
                    scales: {
                        x: { title: { display: true, text: '導入所需時間 (單位自訂)', font: { weight: 'bold' } }, grid: { color: '#e5e7eb' } },
                        y: { title: { display: true, text: 'MCDM總分 (0-100)', font: { weight: 'bold' } }, grid: { color: '#e5e7eb' } }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.raw.label || '';
                                    if (label) { label = `方案: ${label.substring(0,50)}${label.length > 50 ? '...' : ''}\n`; }
                                    else { label = `方案ID: ${context.raw.id}\n`;}
                                    label += `時間: ${context.raw.x}, 分數: ${context.raw.y}`;
                                    if (context.raw.cost !== null && context.raw.cost !== undefined) label += `\n成本: ${context.raw.cost}`;
                                    if (context.raw.ideality !== null && context.raw.ideality !== undefined) label += `\n理想性: ${context.raw.ideality.toFixed(2)}`;
                                    if (context.raw.abc && context.raw.abc !== 'none') label += `\nABC分類: ${context.raw.abc}`;
                                    return label.split('\n');
                                }
                            },
                            backgroundColor: 'rgba(0,0,0,0.8)', titleFont: { weight: 'bold' }, bodyFont: { size: 11 }, padding: 10, displayColors: false,
                        },
                        legend: { display: false },
                        quadrantDrawer: { timeThreshold: timeThreshold, scoreThreshold: scoreThreshold }
                    },
                };
            },
            renderIdeasLandscapeChart: function() { /* ... (Implementation using State, DOM, ChartManager.getChartDataPoints, ChartManager.getChartOptions, Constants) ... */ 
                DOM.elements.ideasLandscapeNoDataMessage.style.display = 'none'; 
                if (!State.rcaData || !DOM.elements.ideasLandscapeChartCanvas) {
                    if (State.ideasLandscapeChartInstance) { State.ideasLandscapeChartInstance.destroy(); State.ideasLandscapeChartInstance = null; }
                    if (DOM.elements.ideasLandscapeChartCanvas) DOM.elements.ideasLandscapeNoDataMessage.style.display = 'block';
                    return;
                }
                const dataPoints = ChartManager.getChartDataPoints();
                if (dataPoints.length === 0) {
                    if (State.ideasLandscapeChartInstance) { State.ideasLandscapeChartInstance.destroy(); State.ideasLandscapeChartInstance = null; }
                    DOM.elements.ideasLandscapeNoDataMessage.style.display = 'block'; return;
                }
                const timeThreshold = parseFloat(DOM.elements.landscapeTimeThresholdInput.value) || 0;
                const scoreThreshold = parseFloat(DOM.elements.landscapeScoreThresholdInput.value) || 0;
                if (State.ideasLandscapeChartInstance) State.ideasLandscapeChartInstance.destroy();
                const ctx = DOM.elements.ideasLandscapeChartCanvas.getContext('2d');
                State.ideasLandscapeChartInstance = new Chart(ctx, {
                    type: 'scatter',
                    data: {
                        datasets: [{
                            label: '解決方案創意', data: dataPoints,
                            backgroundColor: dataPoints.map(p => Constants.ABC_COLORS[p.abc] || Constants.ABC_COLORS['none']),
                            borderColor: dataPoints.map(p => Constants.ABC_BORDER_COLORS[p.abc] || Constants.ABC_BORDER_COLORS['none']),
                            borderWidth: 1.5,
                            pointRadius: dataPoints.map(p => {
                                let radius = 5;
                                if (p.cost !== null && p.cost !== undefined && p.cost > 0) radius += Math.log10(p.cost / 100 + 1) * 2; 
                                else if (p.ideality !== null && p.ideality !== undefined) radius += p.ideality / 2; 
                                return Math.min(Math.max(radius, 4), 15); 
                            }),
                            pointStyle: dataPoints.map(p => Constants.ABC_POINT_STYLES[p.abc] || Constants.ABC_POINT_STYLES['none']),
                            hoverRadius: dataPoints.map(p => {
                                let radius = 7;
                                if (p.cost !== null && p.cost !== undefined && p.cost > 0) radius += Math.log10(p.cost / 100 + 1) * 2.5;
                                else if (p.ideality !== null && p.ideality !== undefined) radius += p.ideality / 1.5;
                                return Math.min(Math.max(radius, 6), 18);
                            }),
                        }]
                    },
                    options: ChartManager.getChartOptions(timeThreshold, scoreThreshold)
                });
            }
        };
        
        // --- "Module": UIInteractions ---
        const UIInteractions = {
            applyZoom: function(newZoomLevel, avoidRedraw = false) { /* ... (Implementation using State, DOM, Constants, Renderer.drawAllSvgConnectors, UIInteractions.updateButtonStates) ... */ 
                State.currentZoom = Math.max(Constants.MIN_ZOOM, Math.min(Constants.MAX_ZOOM, newZoomLevel)); 
                DOM.elements.scalableContentWrapper.style.transform = `scale(${State.currentZoom})`; 
                DOM.elements.zoomLevelDisplay.textContent = `${Math.round(State.currentZoom * 100)}%`; 
                if (!avoidRedraw && State.rcaData) { requestAnimationFrame(() => Renderer.drawAllSvgConnectors()); } 
                UIInteractions.updateButtonStates(); 
            },
            updateButtonStates: function() { /* ... (Implementation using State, DOM, Constants) ... */ 
                const noData = !State.rcaData; 
                const noLocalStorageData = !localStorage.getItem('rcaDiagramData'); 
                DOM.elements.undoButton.disabled = State.historyIndex <= 0; 
                DOM.elements.redoButton.disabled = State.historyIndex >= State.historyStack.length - 1; 
                DOM.elements.saveDiagramButton.disabled = noData; 
                DOM.elements.loadDiagramButton.disabled = noLocalStorageData; 
                DOM.elements.saveToFileButton.disabled = noData; 
                DOM.elements.zoomInButton.disabled = State.currentZoom >= Constants.MAX_ZOOM; 
                DOM.elements.zoomOutButton.disabled = State.currentZoom <= Constants.MIN_ZOOM; 
                DOM.elements.resetZoomButton.disabled = State.currentZoom === 1.0; 
                DOM.elements.exportPngButton.disabled = noData;
                DOM.elements.exportMenuButton.disabled = noData; 
                DOM.elements.finalizeDiagramButton.disabled = noData; 
                DOM.elements.autoAdjustLayoutButton.disabled = noData; 
                DOM.elements.toggleCauseEffectTableButton.disabled = noData; 
                DOM.elements.toggleSolutionTableButton.disabled = noData; 
                DOM.elements.toggleIdeasLandscapeButton.disabled = noData;
                DOM.elements.updateIdeasLandscapeChartButton.disabled = noData;
                DOM.elements.abcCauseFilterControls.querySelectorAll('button[data-filter-type="cause"]').forEach(button => {
                    button.classList.toggle('active', button.dataset.filter === State.currentAbcCauseFilter);
                    button.disabled = noData;
                });
                DOM.elements.abcSolutionFilterControls.querySelectorAll('button[data-filter-type="solution"]').forEach(button => {
                    button.classList.toggle('active', button.dataset.filter === State.currentAbcSolutionFilter);
                    button.disabled = noData;
                });
            },
            applyAbcCauseFilter: function(filterType) { /* ... (Implementation using State, HistoryManager, Renderer, UIInteractions.updateButtonStates) ... */ 
                State.currentAbcCauseFilter = filterType;
                HistoryManager.pushStateToHistory(State.rcaData); // Push state if filter change should be undoable
                Renderer.renderRcaDiagram(); 
                UIInteractions.updateButtonStates(); 
            },
            applyAbcSolutionFilter: function(filterType) { /* ... (Implementation using State, TableManager.renderSolutionTable, DOM) ... */ 
                State.currentAbcSolutionFilter = filterType;
                TableManager.renderSolutionTable(); 
                DOM.elements.abcSolutionFilterControls.querySelectorAll('button[data-filter-type="solution"]').forEach(button => {
                    button.classList.toggle('active', button.dataset.filter === State.currentAbcSolutionFilter);
                });
            },
            handleToggleFinalizeView: function() { /* ... (Implementation using State, DOM, Renderer.renderRcaDiagram) ... */ 
                State.isFinalizedView = !State.isFinalizedView; 
                if (State.isFinalizedView) { 
                    DOM.elements.finalizeDiagramButton.textContent = '編輯圖表'; 
                    DOM.elements.finalizeDiagramButton.classList.remove('finalize-diagram'); 
                    DOM.elements.finalizeDiagramButton.classList.add('edit-diagram'); 
                } else { 
                    DOM.elements.finalizeDiagramButton.textContent = '完成圖表'; 
                    DOM.elements.finalizeDiagramButton.classList.remove('edit-diagram'); 
                    DOM.elements.finalizeDiagramButton.classList.add('finalize-diagram'); 
                } 
                Renderer.renderRcaDiagram(); 
            },
            autoAdjustNodeLayout: function() { alert('自動調整節點功能尚待開發。'); }
        };

        // --- "Module": App (Main Application Logic) ---
        const App = {
            initialize: function() {
                DOM.initializeElements(); 
                Utils.populateSelect(DOM.elements.improvingParameterSelect, Constants.BUSINESS_MANAGEMENT_PARAMETERS, true); 
                Utils.populateSelect(DOM.elements.worseningParameterSelect, Constants.BUSINESS_MANAGEMENT_PARAMETERS, true); 
                Utils.populateSelect(DOM.elements.solutionPrincipleSelect, Constants.INVENTIVE_PRINCIPLES, false); 
                
                App.setupEventListeners();
                new ResizeObserver(() => Renderer.drawAllSvgConnectors()).observe(DOM.elements.scalableContentWrapper); 
                DOM.elements.toolButtonsContainer.style.display = 'flex'; 
                UIInteractions.applyZoom(1.0, true); 
                UIInteractions.updateButtonStates(); 
                Chart.register(ChartManager.quadrantPlugin); // Register chart plugin
            },
            setupEventListeners: function() {
                DOM.elements.setProblemButton.addEventListener('click', App.handleSetInitialProblem);
                DOM.elements.problemInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') App.handleSetInitialProblem(); });
                
                DOM.elements.fileMenuButton.addEventListener('click', (event) => { 
                    event.stopPropagation(); 
                    DOM.elements.fileDropdownContent.style.display = DOM.elements.fileDropdownContent.style.display === 'block' ? 'none' : 'block';
                    DOM.elements.exportDropdownContent.style.display = 'none'; 
                    UIInteractions.updateButtonStates(); 
                });
                DOM.elements.saveDiagramButton.addEventListener('click', () => { FileOperations.handleSaveToLocalStorage(); DOM.elements.fileDropdownContent.style.display = 'none'; });
                DOM.elements.loadDiagramButton.addEventListener('click', () => { FileOperations.handleLoadFromLocalStorage(); DOM.elements.fileDropdownContent.style.display = 'none'; });
                DOM.elements.saveToFileButton.addEventListener('click', () => { FileOperations.handleSaveToFile(); DOM.elements.fileDropdownContent.style.display = 'none'; });
                DOM.elements.loadFromFileLabel.addEventListener('click', () => { DOM.elements.fileInputForLoad.click(); });
                DOM.elements.fileInputForLoad.addEventListener('change', FileOperations.handleLoadFromFile);

                DOM.elements.undoButton.addEventListener('click', HistoryManager.handleUndo);
                DOM.elements.redoButton.addEventListener('click', HistoryManager.handleRedo);

                DOM.elements.zoomInButton.addEventListener('click', () => UIInteractions.applyZoom(State.currentZoom + Constants.ZOOM_STEP));
                DOM.elements.zoomOutButton.addEventListener('click', () => UIInteractions.applyZoom(State.currentZoom - Constants.ZOOM_STEP));
                DOM.elements.resetZoomButton.addEventListener('click', () => UIInteractions.applyZoom(1.0));

                DOM.elements.finalizeDiagramButton.addEventListener('click', UIInteractions.handleToggleFinalizeView); 
                DOM.elements.autoAdjustLayoutButton.addEventListener('click', UIInteractions.autoAdjustNodeLayout); 

                DOM.elements.exportMenuButton.addEventListener('click', (event) => {
                    event.stopPropagation();
                    DOM.elements.exportDropdownContent.style.display = DOM.elements.exportDropdownContent.style.display === 'block' ? 'none' : 'block';
                    DOM.elements.fileDropdownContent.style.display = 'none'; 
                    UIInteractions.updateButtonStates();
                });
                DOM.elements.exportPngButton.addEventListener('click', () => { FileOperations.exportDiagramAsPNG(); DOM.elements.exportDropdownContent.style.display = 'none'; });

                DOM.elements.toggleCauseEffectTableButton.addEventListener('click', TableManager.handleToggleCauseEffectTable);
                DOM.elements.toggleSolutionTableButton.addEventListener('click', TableManager.handleToggleSolutionTable); 
                DOM.elements.toggleIdeasLandscapeButton.addEventListener('click', ChartManager.handleToggleIdeasLandscape);
                DOM.elements.updateIdeasLandscapeChartButton.addEventListener('click', ChartManager.renderIdeasLandscapeChart);
                
                if (DOM.elements.saveAndSourcesButton) DOM.elements.saveAndSourcesButton.addEventListener('click', ModalManager.handleSaveAndSources);
                if (DOM.elements.cancelAndSourcesButton) DOM.elements.cancelAndSourcesButton.addEventListener('click', ModalManager.closeAndSourceModal);
                
                if (DOM.elements.saveEffectParametersButton) DOM.elements.saveEffectParametersButton.addEventListener('click', ModalManager.handleSaveEffectParameters);
                if (DOM.elements.cancelEffectParametersButton) DOM.elements.cancelEffectParametersButton.addEventListener('click', ModalManager.closeEffectParameterModal);
                
                DOM.elements.abcCauseFilterControls.querySelectorAll('button[data-filter-type="cause"]').forEach(button => {
                    button.addEventListener('click', (event) => UIInteractions.applyAbcCauseFilter(event.target.dataset.filter));
                });
                DOM.elements.abcSolutionFilterControls.querySelectorAll('button[data-filter-type="solution"]').forEach(button => {
                    button.addEventListener('click', (event) => UIInteractions.applyAbcSolutionFilter(event.target.dataset.filter));
                });

                document.getElementById('close-triz-modal-button').addEventListener('click', ModalManager.closeTrizSolutionModal); 
                DOM.elements.improvingParameterSelect.addEventListener('change', ModalManager.handleSaveTrizParameters); 
                DOM.elements.worseningParameterSelect.addEventListener('change', ModalManager.handleSaveTrizParameters); 
                DOM.elements.addNewSolutionEntryButton.addEventListener('click', () => ModalManager.showEditSolutionEntry(null));
                DOM.elements.saveSolutionEntryButton.addEventListener('click', ModalManager.handleSaveSolutionEntry);
                DOM.elements.cancelEditSolutionButton.addEventListener('click', () => {
                    DOM.elements.editSolutionEntryContainer.style.display = 'none';
                    DOM.elements.editingSolutionIdInput.value = '';
                });

                App.initializeIdealityAssessmentRangeListeners();
                DOM.elements.saveIdealityAssessmentButton.addEventListener('click', ModalManager.handleSaveIdealityAssessment);
                DOM.elements.cancelIdealityAssessmentButton.addEventListener('click', ModalManager.closeIdealityAssessmentModal);
                
                window.addEventListener('click', (event) => { 
                    if (DOM.elements.fileDropdownContent && !DOM.elements.fileMenuButton.contains(event.target) && !DOM.elements.fileDropdownContent.contains(event.target)) { 
                        DOM.elements.fileDropdownContent.style.display = 'none'; 
                    }
                    if (DOM.elements.exportDropdownContent && !DOM.elements.exportMenuButton.contains(event.target) && !DOM.elements.exportDropdownContent.contains(event.target)) {
                        DOM.elements.exportDropdownContent.style.display = 'none';
                    }
                });
            },
            initializeIdealityAssessmentRangeListeners: function() { /* ... (Implementation using DOM, ModalManager.updateIdealityTotalScoreDisplay) ... */ 
                const rangesAndValues = [
                    { range: DOM.elements.idealityProblemSolvedRange, valueDisplay: DOM.elements.idealityProblemSolvedValue },
                    { range: DOM.elements.idealityWinWinRange, valueDisplay: DOM.elements.idealityWinWinValue },
                    { range: DOM.elements.idealityNoNegativeEffectsRange, valueDisplay: DOM.elements.idealityNoNegativeEffectsValue },
                    { range: DOM.elements.idealityLowCostResourceRange, valueDisplay: DOM.elements.idealityLowCostResourceValue }
                ];
                rangesAndValues.forEach(item => {
                    item.range.addEventListener('input', (e) => { 
                        item.valueDisplay.textContent = e.target.value;
                        ModalManager.updateIdealityTotalScoreDisplay(); 
                    });
                });
                const weights = [
                    DOM.elements.idealityProblemSolvedWeight, DOM.elements.idealityWinWinWeight,
                    DOM.elements.idealityNoNegativeEffectsWeight, DOM.elements.idealityLowCostResourceWeight
                ];
                weights.forEach(weightInput => {
                    weightInput.addEventListener('input', ModalManager.updateIdealityTotalScoreDisplay);
                });
            },
            handleSetInitialProblem: function() { /* ... (Implementation using DOM, State, NodeManager, HistoryManager, UIInteractions, Renderer, TableManager, ChartManager) ... */ 
                const problemText = DOM.elements.problemInput.value.trim(); 
                if (!problemText) { alert('請輸入主要負面效果！'); return; } 
                State.nodeIdCounter = 0; 
                State.rcaData = NodeManager.createNode(problemText, 'initial-problem', null); 
                State.historyStack = []; State.historyIndex = -1; 
                State.currentAbcCauseFilter = 'all'; State.currentAbcSolutionFilter = 'all'; 
                HistoryManager.pushStateToHistory(State.rcaData); 
                State.isFinalizedView = false; 
                DOM.elements.finalizeDiagramButton.textContent = '完成圖表'; 
                DOM.elements.finalizeDiagramButton.classList.remove('edit-diagram'); 
                DOM.elements.finalizeDiagramButton.classList.add('finalize-diagram'); 
                DOM.elements.problemInputArea.style.display = 'none'; 
                DOM.elements.diagramTitle.style.display = 'block'; 
                DOM.elements.toolButtonsContainer.style.display = 'flex'; 
                UIInteractions.applyZoom(1.0, true); 
                Renderer.renderRcaDiagram(); 
                TableManager.renderCauseEffectTable(); 
                TableManager.renderSolutionTable(); 
                ChartManager.renderIdeasLandscapeChart(); 
                UIInteractions.updateButtonStates(); 
            }
        };
        
        // Initialize the application when the DOM is ready
        document.addEventListener('DOMContentLoaded', App.initialize);
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RCA+矛盾分析與決策工具</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* 基本樣式 */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; 
        }

        /* 步驟導航樣式 */
        .workflow-step {
            transition: background-color 0.3s ease, color 0.3s ease;
            border: 1px solid transparent;
        }
        .workflow-step.active-step {
            background-color: #3b82f6; /* Tailwind blue-500 */
            color: white;
            font-weight: 600;
            border-color: #2563eb; /* Tailwind blue-600 */
        }
        .workflow-step:disabled {
            color: #9ca3af; /* Tailwind gray-400 */
            background-color: #e5e7eb; /* Tailwind gray-200 */
            cursor: not-allowed;
            border-color: #d1d5db;
        }
        .workflow-step:not(:disabled):hover {
            background-color: #dbeafe; /* Tailwind blue-100 */
        }
        .workflow-step.active-step:hover {
             background-color: #2563eb; /* Tailwind blue-600 for active hover */
        }
        .step-arrow {
            color: #9ca3af; /* Tailwind gray-400 */
        }

        /* 圖表渲染區域樣式 */
        #diagram-render-area { 
            position: relative; 
            overflow: auto; 
            padding: 0; 
            background-color: #fff; 
            border-radius: 0.5rem; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            min-height: 450px; 
            width: 100%; 
            -webkit-user-select: none; 
            -ms-user-select: none; 
            user-select: none; 
        }
        #scalable-content-wrapper { 
            position: relative;
            transform-origin: top left; 
            display: inline-block; 
            padding: 20px; 
            cursor: grab; 
        }
        #scalable-content-wrapper:active {
            cursor: grabbing; 
        }
        #svg-connector-layer { 
            position: absolute; 
            top: 20px; 
            left: 20px; 
            pointer-events: none; 
            z-index: 0; 
        }
        #rca-diagram-container { 
            display: inline-block; 
            text-align: center; 
            position: relative; 
            z-index: 1; 
            background-color: transparent; 
        }

        /* RCA 節點樣式 */
        .rca-node-wrapper { 
            display: inline-flex; 
            flex-direction: column; 
            align-items: center; 
            margin: 0 1rem; 
            vertical-align: top; 
            transition: margin 0.3s ease-in-out; 
        }
        .rca-node { 
            border: 2px solid #4b5563; 
            padding: 0.6rem 1.1rem; 
            margin-top: 30px; 
            margin-bottom: 15px; 
            box-shadow: 0 2px 4px 0 rgba(0, 0, 0, 0.1); 
            display: inline-flex; 
            flex-direction: column; 
            align-items: center; 
            max-width: 350px; 
            border-radius: 0.375rem; 
            position: relative;
            z-index: 1; 
            background-color: #ffffff; 
            overflow-wrap: break-word; 
        }
        .rca-node-content { 
            display: flex; 
            flex-direction: column; 
            gap: 0.4rem; 
            width: 100%; 
            align-items: center; 
        }
        .rca-node-header { 
            display: flex;
            align-items: center; 
            justify-content: center; 
            gap: 0.4rem; 
            width: 100%;
            position: relative; 
            margin-bottom: 0.25rem;
        }
        .rca-node-icon { 
            font-weight: bold; font-size: 0.85em; 
            padding: 0.2em 0.4em; 
            border-radius: 50%; 
            color: white; 
            min-width: 22px; 
            height: 22px; 
            display: flex; 
            align-items: center;
            justify-content: center;
            border: 2px solid white; 
            box-shadow: 0 1px 2px rgba(0,0,0,0.2); 
            z-index: 10; 
        }
        .nc-badge { 
            font-size: 0.65em; font-weight: bold; color: #374151; 
            background-color: #e5e7eb; padding: 0.15rem 0.35rem; 
            border-radius: 0.25rem; 
        }
        .rca-node-text { 
            font-weight: 500; 
            font-size: 0.9rem; 
            text-align: center; 
            overflow-wrap: break-word; 
            line-height: 1.4; 
            box-sizing: border-box;
        }
        
        .selected-items-list { 
            font-size: 0.75rem; 
            color: #374151; 
            margin-top: 0.5rem; 
            padding-top: 0.375rem; 
            border-top: 1px dashed #d1d5db; 
            width: 100%; 
            text-align: left; 
        }
        .selected-items-list strong { 
            color: #111827; 
            display: block; 
            margin-bottom: 0.25rem; 
        }
        .selected-items-list ul { 
            list-style-type: disc; 
            margin-left: 1.25rem; 
            padding-left: 0.25rem; 
        } 
        .selected-items-list li { 
            margin-bottom: 0.25rem; 
        }
        .selected-items-list .solution-text { color: #059669; margin-left: 0.3rem; font-style: italic;}

        /* 不同節點類型顏色 */
        .rca-node-initial-problem { background-color: #fee2e2; border-color: #ef4444; } 
        .rca-node-initial-problem .rca-node-icon { background-color: #ef4444; }
        .rca-node-cause { background-color: #fef9c3; border-color: #f59e0b; } 
        .rca-node-cause .rca-node-icon.contradictory { background-color: #8b5cf6; } 
        .rca-node-positive-effect { background-color: #dbeafe; border-color: #3b82f6; border-radius: 50px; padding: 0.6rem 1.2rem; } 
        .rca-node-positive-effect .rca-node-icon { background-color: #2563eb; }
        .rca-node-negative-effect { background-color: #ffedd5; border-color: #f97316; border-radius: 50px; padding: 0.6rem 1.2rem; } 
        .rca-node-negative-effect .rca-node-icon { background-color: #f97316; }

        .rca-children-container { 
            display: flex; 
            flex-direction: row; 
            justify-content: center; 
            align-items: flex-start; 
            margin-top: 15px; 
            position: relative; 
            padding-top: 25px; 
            width: max-content; 
        }
        
        /* 動作按鈕樣式 */
        .rca-node-actions { 
            display: flex; 
            flex-wrap: wrap; 
            gap: 0.25rem; 
            margin-top: 0.5rem; 
            border-top: 1px solid #e5e7eb; 
            padding-top: 0.5rem; 
            width: 100%; 
            justify-content: flex-start; 
        }
        .action-button { background-color: #6b7280; color: white; padding: 0.375rem 0.75rem; border-radius: 0.25rem; font-size: 0.75rem; border: none; cursor: pointer; transition: background-color 0.2s; }
        .action-button:hover:not(:disabled) { background-color: #4b5563; } .action-button:disabled { background-color: #9ca3af; cursor: not-allowed; }
        .action-button.add-cause { background-color: #3b82f6; } .action-button.add-cause:hover:not(:disabled) { background-color: #2563eb; }
        .action-button.add-positive { background-color: #10b981; } .action-button.add-positive:hover:not(:disabled) { background-color: #059669; }
        .action-button.add-negative { background-color: #f97316; } .action-button.add-negative:hover:not(:disabled) { background-color: #ea580c; }
        .action-button.toggle-nc { background-color: #a855f7; } .action-button.toggle-nc:hover:not(:disabled) { background-color: #9333ea; }
        .action-button.set-and-sources { background-color: #6d28d9; } .action-button.set-and-sources:hover:not(:disabled) { background-color: #5b21b6; }
        .action-button.edit-node { background-color: #f59e0b; } .action-button.edit-node:hover:not(:disabled) { background-color: #d97706; }
        .action-button.set-parameters { background-color: #0ea5e9; } .action-button.set-parameters:hover:not(:disabled) { background-color: #0284c7; }
        .action-button.set-principles { background-color: #ec4899; } .action-button.set-principles:hover:not(:disabled) { background-color: #db2777; }
        .action-button.analyze-contradiction { background-color: #7c3aed; } .action-button.analyze-contradiction:hover:not(:disabled) { background-color: #6d28d9; }
        .action-button.finalize-diagram { background-color: #059669; } .action-button.finalize-diagram:hover:not(:disabled) { background-color: #047857; }
        .action-button.edit-diagram { background-color: #d97706; } .action-button.edit-diagram:hover:not(:disabled) { background-color: #b45309; }
        .remove-button { background-color: #ef4444; } .remove-button:hover:not(:disabled) { background-color: #dc2626; }
        
        /* 輸入組件和表格樣式 */
        .input-group-container { margin-top: 0.5rem; width: calc(100% - 1rem); } 
        .input-group { display: flex; flex-direction: column; gap: 0.5rem; padding: 0.5rem; border: 1px solid #e5e7eb; border-radius: 0.25rem; background-color: #f9fafb; }
        .input-field { border: 1px solid #d1d5db; padding: 0.5rem; border-radius: 0.25rem; font-size: 0.875rem; width: 100%; }
        .input-field.small-input { padding: 0.25rem; font-size: 0.8rem; }
        .save-button { background-color: #065f46; color: white; } .save-button:hover:not(:disabled) { background-color: #047857; }
        .save-edit-button { background-color: #065f46; color: white; } .save-edit-button:hover:not(:disabled) { background-color: #047857; }

        .data-table-section { margin-top: 2rem; }
        .data-table { width: 100%; border-collapse: collapse; margin-top: 1rem; table-layout: fixed; }
        .data-table th, .data-table td { border: 1px solid #d1d5db; padding: 0.5rem; font-size: 0.875rem; text-align: center; vertical-align: middle; word-wrap: break-word; }
        .data-table th { background-color: #e5e7eb; font-weight: 600; }
        .data-table td { background-color: white; }
        .data-table td:first-child, .data-table th:first-child { text-align: left; }
        .data-table .action-cell { width: 120px; } 
        .data-table textarea { width: 100%; box-sizing: border-box; font-size: 0.875rem; padding: 0.25rem; border: 1px solid #d1d5db; border-radius: 0.25rem; min-height: 40px;}
        
        /* 彈出視窗 (Modal) 樣式 */
        .modal { z-index: 50; } 
        .modal-content { position: relative; } 
        .modal-close-button { position: absolute; top: 0.75rem; right: 0.75rem; background: none; border: none; font-size: 1.5rem; color: #6b7280; cursor: pointer; line-height: 1; }
        .modal-close-button:hover { color: #1f2937; }
        .modal-options-container label { cursor: pointer; }
        .modal-options-container h4 { font-weight:600; margin-top: 0.75rem; margin-bottom: 0.25rem; color: #374151; border-bottom: 1px solid #e5e7eb; padding-bottom: 0.25rem; }
        .modal-options-container h4:first-child { margin-top: 0; }
        .principle-solution-input { width: calc(100% - 2rem); margin-left: 1.5rem; margin-top: 0.25rem; margin-bottom: 0.5rem; padding: 0.25rem 0.5rem; border: 1px solid #d1d5db; border-radius: 0.25rem; font-size: 0.8rem; }
        
        /* 載入動畫 */
        .loading-spinner-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 1000; display: none; }
        .loading-spinner { border: 8px solid #f3f3f3; border-top: 8px solid #7c3aed; border-radius: 50%; width: 60px; height: 60px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* 縮放控制 */
        .zoom-controls { display: flex; gap: 0.5rem; align-items: center; }
        .zoom-controls span { font-size: 0.875rem; color: #4b5563; min-width: 50px; text-align: center; }
        
        /* 下拉選單 */
        .dropdown { position: relative; display: inline-block; }
        .dropdown-content { display: none; position: absolute; background-color: #f9f9f9; min-width: 250px; box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2); z-index: 10; border-radius: 0.375rem; padding: 0.5rem 0; }
        .dropdown-content button, .dropdown-content label { color: black; padding: 0.75rem 1rem; text-decoration: none; display: block; text-align: left; background: none; border: none; width: 100%; font-size: 0.875rem; cursor: pointer; }
        .dropdown-content button:hover, .dropdown-content label:hover { background-color: #e5e7eb; }
        .dropdown-content button:disabled { color: #9ca3af; cursor: not-allowed; background-color: #f9f9f9; }
        .dropdown-content button i, .dropdown-content label i { margin-right: 0.5rem; width: 1.25rem; text-align: center; }
        .dropdown-trigger-button { background-color: #1f2937; } 
        .dropdown-trigger-button:hover:not(:disabled) { background-color: #374151; }

        #tracking-item-modal .input-field, #tracking-item-modal textarea, #tracking-item-modal select {
            margin-bottom: 0.75rem;
        }
        
        /* 主要內容區塊 */
        #conflict-analysis-section, #triz-mcda-section, #ideas-landscape-section {
            margin-top: 1rem; 
            padding: 1.5rem;
            background-color: white;
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .main-content-section { 
            display: none; 
        }
        .main-content-section.active-section {
            display: block;
        }
        #identified-conflicts-list .conflict-item {
            border: 1px solid #e5e7eb;
            padding: 0.75rem;
            margin-bottom: 0.75rem;
            border-radius: 0.375rem;
            background-color: #f9fafb;
        }
        #identified-conflicts-list .conflict-item p { margin-bottom: 0.25rem; font-size: 0.875rem; }
        #identified-conflicts-list .conflict-item strong { color: #111827; }

        /* TRIZ-MCDA 階段樣式 */
        .triz-mcda-phase {
            margin-bottom: 1.5rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid #e5e7eb;
        }
        .triz-mcda-phase:last-child {
            margin-bottom: 0;
            padding-bottom: 0;
            border-bottom: none;
        }
        #conflict-analysis-section h3, .triz-mcda-phase h3, #ideas-landscape-section h3, .data-table-section h2, #rca-diagram-section h2 {
            font-size: 1.25rem; 
            font-weight: 600; 
            color: #374151; 
            margin-bottom: 1rem;
        }
        .triz-parameter-select {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #d1d5db;
            border-radius: 0.25rem;
            margin-bottom: 0.5rem;
        }
        .triz-solution-concept {
            margin-top: 0.5rem;
            padding-left: 1rem; 
        }
        .triz-solution-concept textarea {
            min-height: 60px;
        }
        .triz-solution-concept label.implementation-time-label {
            font-size: 0.8rem;
            color: #4b5563;
            margin-top: 0.25rem;
        }
        .triz-solution-concept select.implementation-time-select {
            width: auto;
            padding: 0.25rem 0.5rem;
            font-size: 0.8rem;
            margin-left: 0.5rem;
        }

        /* MCDA 表格樣式 */
        #mcda-criteria-table th, #mcda-criteria-table td {
            padding: 0.5rem;
            font-size: 0.875rem;
            text-align: left; 
            vertical-align: middle; 
        }
        #mcda-criteria-table input[type="number"] {
            width: 60px;
            text-align: right;
        }
        .criterion-category-guidance {
            font-size: 0.75rem;
            color: #6b7280;
            margin-top: 0.25rem;
        }
         #mcda-evaluation-table th { 
            padding: 0.5rem;
            font-size: 0.875rem;
            text-align: center; 
            vertical-align: middle;
        }
        #mcda-evaluation-table td { 
            padding: 0.5rem;
            font-size: 0.875rem;
            text-align: center; 
            vertical-align: middle; 
        }
        #mcda-evaluation-table td:first-child { 
             text-align: left;
        }
         #mcda-evaluation-table input[type="number"] {
            width: 50px;
            text-align: center; 
            margin: 0 auto; 
        }
        .mcda-result {
            margin-top: 1rem;
            padding: 1rem;
            background-color: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 0.25rem;
        }
        #ideas-landscape-chart-container {
            width: 100%;
            min-height: 400px; 
            background-color: #f9fafb;
            border: 1px solid #e0e0e0;
            border-radius: 0.25rem;
            position: relative; 
        }
       
        /* 列印樣式 */
        @media print { 
            body { background-color: white; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            header, #controls-section, .modal, .dropdown-content, #loading-spinner-overlay, .rca-node-actions, #generate-landscape-chart-button, #workflow-navigator 
            { 
                display: none !important; 
            }
            #rca-diagram-section, #conflict-analysis-section, #cause-effect-table-section, #solution-table-section, #tracking-table-section, #triz-mcda-section, #ideas-landscape-section, #report-output-sections {
                box-shadow: none !important;
                border: none !important;
                margin-top: 0.5rem !important;
                padding: 0.5rem !important;
                display: block !important; 
                page-break-inside: avoid;
            }
            .main-content-section { display: block !important; } 

            #scalable-content-wrapper { 
                transform: scale(0.8) !important; 
                transform-origin: top left !important; 
                padding: 5px !important; 
                width: 100% !important; 
                overflow: visible !important;
            }
             #rca-diagram-container, #svg-connector-layer {
                display: block !important; 
            }
            .data-table th, .data-table td { font-size: 9pt !important; padding: 0.2rem !important;}
            .rca-node { margin-top: 10px !important; margin-bottom: 5px !important; padding: 0.3rem 0.6rem !important; border-width: 1px !important; }
            .rca-node-text { font-size: 0.75rem !important; }
            header h1 { font-size: 1.5rem !important; } 
            .container > header h1 { font-size: 1.5rem !important; display: block !important; } 
            .container > header p { font-size: 0.9rem !important; display: block !important; }
            #conflict-analysis-section h3, .data-table-section h2, .triz-mcda-phase h3, #diagram-title, #ideas-landscape-section h3 { font-size: 1.1rem !important; margin-bottom: 0.5rem !important; }
            #svg-connector-layer { 
                top: 5px !important; 
                left: 5px !important;
            }
            table { page-break-inside: auto; }
            tr { page-break-inside: avoid; page-break-after: auto; }
            thead { display: table-header-group; } 
            tfoot { display: table-footer-group; }
            button { display: none !important; } 
            .action-button { display: none !important; }
            .dropdown { display: none !important; }
            .zoom-controls { display: none !important; }
        }
    </style>
</head>
<body class="p-4 md:p-8">
    <div id="loading-spinner-overlay" class="loading-spinner-overlay">
        <div class="loading-spinner"></div>
    </div>
    <div class="container mx-auto max-w-7xl"> 
        <header class="mb-6 text-center">
            <h1 class="text-2xl md:text-3xl font-bold text-gray-700">整合性問題解決與TRIZ創新工具</h1>
            <p class="text-gray-500 mt-1">視覺化根本原因、矛盾，整合 TRIZ-MCDA 分析流程，並包含改善方案追蹤與創意景觀圖。</p> 
        </header>

        <section id="workflow-navigator" class="mb-6 p-3 bg-white rounded-lg shadow flex flex-wrap justify-around items-center text-sm sticky top-0 z-40">
            <button data-step="1" class="workflow-step active-step py-2 px-3 rounded focus:outline-none">1. 問題與RCA</button>
            <span class="step-arrow mx-1 text-gray-400">&rarr;</span>
            <button data-step="2" class="workflow-step py-2 px-3 rounded focus:outline-none" disabled>2. 衝突分析</button>
            <span class="step-arrow mx-1 text-gray-400">&rarr;</span>
            <button data-step="3" class="workflow-step py-2 px-3 rounded focus:outline-none" disabled>3. TRIZ方案生成</button>
            <span class="step-arrow mx-1 text-gray-400">&rarr;</span>
            <button data-step="4" class="workflow-step py-2 px-3 rounded focus:outline-none" disabled>4. 方案評估選擇</button>
            <span class="step-arrow mx-1 text-gray-400">&rarr;</span>
            <button data-step="5" class="workflow-step py-2 px-3 rounded focus:outline-none" disabled>5. 產出與報告</button>
        </section>

        <section id="controls-section" class="mb-6 p-4 bg-white rounded-lg shadow">
             <div id="problem-input-area"> 
                <h2 class="text-xl font-semibold text-gray-700 mb-3">界定關鍵問題</h2>
                <div class="flex flex-col sm:flex-row gap-2">
                    <input type="text" id="problem-statement-input" placeholder="輸入觀察到的關鍵問題/主要負面效果" class="input-field flex-grow p-2 rounded-md border-gray-300 focus:ring-blue-500 focus:border-blue-500">
                    <button id="set-problem-button" class="action-button add-cause text-white font-semibold py-2 px-4 rounded-md">設定問題根源</button>
                </div>
            </div>
            <div id="tool-buttons" class="mt-4 flex flex-col gap-3">
                <div class="flex flex-wrap gap-2 justify-center items-center">
                    <div class="dropdown">
                        <button id="file-menu-button" class="action-button dropdown-trigger-button text-white font-semibold py-2 px-4 rounded-md">
                            <i class="fas fa-file-alt"></i> 檔案 <i class="fas fa-caret-down ml-1"></i>
                        </button>
                        <div id="file-dropdown-content" class="dropdown-content">
                            <button id="save-workspace-button"><i class="fas fa-save"></i> 儲存工作區 (瀏覽器)</button>
                            <button id="load-workspace-button"><i class="fas fa-folder-open"></i> 載入工作區 (瀏覽器)</button>
                            <button id="download-backup-button"><i class="fas fa-file-download"></i> 下載備份 (.json)</button>
                            <label for="load-backup-input" id="load-backup-label"><i class="fas fa-file-upload"></i> 從備份載入 (.json)</label>
                            <input type="file" id="load-backup-input" accept=".json" style="display: none;">
                        </div>
                    </div>
                    <button id="undo-button" class="action-button bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-md">
                        <i class="fas fa-undo"></i> 上一步
                    </button>
                    <button id="redo-button" class="action-button bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-md">
                        <i class="fas fa-redo"></i> 下一步
                    </button>
                    <div class="zoom-controls">
                        <button id="zoom-out-button" class="action-button bg-sky-500 hover:bg-sky-600 text-white font-semibold py-2 px-3 rounded-md" title="縮小"><i class="fas fa-search-minus"></i></button>
                        <span id="zoom-level-display">100%</span>
                        <button id="zoom-in-button" class="action-button bg-sky-500 hover:bg-sky-600 text-white font-semibold py-2 px-3 rounded-md" title="放大"><i class="fas fa-search-plus"></i></button>
                        <button id="reset-zoom-button" class="action-button bg-sky-500 hover:bg-sky-600 text-white font-semibold py-2 px-4 rounded-md">重設縮放</button>
                    </div>
                </div>
                <div class="flex flex-wrap gap-2 justify-center">
                    <button id="finalize-diagram-button" class="action-button finalize-diagram text-white font-semibold py-2 px-4 rounded-md">完成圖表</button>
                    <button id="auto-adjust-layout-button" class="action-button bg-teal-500 hover:bg-teal-600 text-white font-semibold py-2 px-4 rounded-md">
                        <i class="fas fa-project-diagram"></i> 自動調整節點
                    </button>
                    <div class="dropdown">
                        <button id="export-menu-button" class="action-button dropdown-trigger-button bg-purple-500 hover:bg-purple-600 text-white font-semibold py-2 px-4 rounded-md">
                            <i class="fas fa-download"></i> 匯出 <i class="fas fa-caret-down ml-1"></i>
                        </button>
                        <div id="export-dropdown-content" class="dropdown-content">
                            <button id="export-cause-effect-csv-button"><i class="fas fa-file-csv"></i> 匯出原因效果表 (CSV)</button>
                            <button id="export-solution-csv-button"><i class="fas fa-file-csv"></i> 匯出改善方案表 (CSV)</button>
                            <button id="export-tracking-csv-button"><i class="fas fa-file-csv"></i> 匯出改善追蹤表 (CSV)</button>
                            <hr class="my-1 border-gray-300">
                            <button id="export-svg-button"><i class="fas fa-file-image"></i> 匯出圖表 (SVG)</button>
                            <hr class="my-1 border-gray-300">
                            <button id="print-document-button"><i class="fas fa-print"></i> 列印文件</button>
                        </div>
                    </div>
                    <div class="dropdown"> 
                        <button id="view-tables-menu-button" class="action-button dropdown-trigger-button bg-cyan-500 hover:bg-cyan-600 text-white font-semibold py-2 px-4 rounded-md">
                            <i class="fas fa-table"></i> 檢視表格 <i class="fas fa-caret-down ml-1"></i>
                        </button>
                        <div id="view-tables-dropdown-content" class="dropdown-content">
                            <button id="show-cause-effect-table-button"><i class="fas fa-tasks"></i> 顯示原因效果表</button>
                            <button id="show-solution-table-button"><i class="fas fa-lightbulb"></i> 顯示改善方案表</button>
                            <button id="show-tracking-table-button"><i class="fas fa-clipboard-check"></i> 顯示改善追蹤表</button>
                            <button id="hide-all-tables-button"><i class="fas fa-eye-slash"></i> 隱藏所有表格</button>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section id="conflict-analysis-section" class="main-content-section">
            <h3>衝突分析 (Conflict Analysis)</h3>
            <p class="text-sm text-gray-600 mb-4">請在下方的RCA圖中，找出同時具有正面和負面效果的「原因」節點。點擊該節點上的「<i class="fas fa-magic"></i> 分析此矛盾」按鈕，以識別並記錄衝突點。已識別的衝突將列於下方。</p>
            <div id="identified-conflicts-list" class="mt-4 space-y-3">
                <p class="text-gray-500 text-center italic">尚未識別任何衝突點。</p>
            </div>
        </section>

        <section id="rca-diagram-section" class="main-content-section active-section bg-white p-0 md:p-0 rounded-lg shadow min-h-[400px]">
            <h2 class="text-xl font-semibold text-gray-700 my-4 text-center" id="diagram-title">根本原因分析 (RCA) 圖</h2>
            <div id="diagram-render-area"> 
                <div id="scalable-content-wrapper">
                    <div id="rca-diagram-container"></div> 
                    <svg id="svg-connector-layer"></svg>
                </div>
            </div>
        </section>

        <section id="triz-mcda-section" class="main-content-section">
            <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">TRIZ方案生成與MCDA評估</h2>
            <p class="text-sm text-gray-600 text-center mb-4">請先在「衝突分析」步驟中，從「已識別衝突列表」選擇一個衝突點，點擊「<i class="fas fa-cogs"></i> 將此衝突帶入TRIZ分析」按鈕。</p>
            
            <div id="triz-phase-1" class="triz-mcda-phase">
                <h3>階段一：問題定義與衝突分析 (帶入)</h3>
                <div>
                    <label for="triz-problem-description" class="block text-sm font-medium text-gray-700 mb-1">關鍵問題摘要：</label>
                    <textarea id="triz-problem-description" rows="2" class="input-field w-full bg-gray-100" readonly placeholder="將由RCA圖中的關鍵問題自動帶入..."></textarea>
                </div>
                <div class="mt-4">
                    <label for="triz-contradiction-source-cause" class="block text-sm font-medium text-gray-700 mb-1">衝突來源原因：</label>
                    <input type="text" id="triz-contradiction-source-cause" class="input-field w-full bg-gray-100" readonly placeholder="將由「衝突分析」步驟選定的矛盾原因自動帶入...">
                </div>
                <div class="mt-4">
                    <label for="triz-contradiction-phenomenon" class="block text-sm font-medium text-gray-700 mb-1">矛盾現象描述 (當試圖改善A，卻導致B惡化)：</label>
                    <textarea id="triz-contradiction-phenomenon" rows="3" class="input-field w-full bg-gray-100" readonly placeholder="將由「衝突分析」步驟選定的矛盾現象自動帶入..."></textarea>
                </div>
            </div>

            <div id="triz-phase-2" class="triz-mcda-phase">
                <h3>階段二：TRIZ 方案生成</h3>
                <p class="text-xs text-gray-500 mb-2">提示：矛盾矩陣為簡化示例，實際應用請參考完整TRIZ資源。</p>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="triz-improving-parameter" class="block text-sm font-medium text-gray-700 mb-1">改善參數 (Improving Feature)：<span class="text-xs text-gray-500">(對應矛盾現象中的「好處」)</span></label>
                        <select id="triz-improving-parameter" class="triz-parameter-select"></select>
                    </div>
                    <div>
                        <label for="triz-worsening-parameter" class="block text-sm font-medium text-gray-700 mb-1">惡化參數 (Worsening Feature)：<span class="text-xs text-gray-500">(對應矛盾現象中的「壞處」)</span></label>
                        <select id="triz-worsening-parameter" class="triz-parameter-select"></select>
                    </div>
                </div>
                <button id="triz-generate-principles-button" class="action-button bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-md mt-3">
                    <i class="fas fa-cogs mr-2"></i>應用矛盾矩陣建議發明原理
                </button>
                <div id="triz-principles-output" class="mt-4">
                    </div>
            </div>

            <div id="triz-phase-3" class="triz-mcda-phase">
                <h3>階段三：MCDA 評估框架</h3>
                <p class="text-sm text-gray-600 mb-2">提示：請從TRIZ階段生成的方案雛形中，挑選約10-15個有潛力的方案進行詳細評估。</p>
                <div>
                    <h4 class="text-lg font-medium text-gray-700 mb-2">設定評估標準與權重：</h4>
                    <p class="text-xs text-gray-500 mb-2">可考慮「問題特定準則」(如：不應違反的原則、必須達成的要求)、「TRIZ理想性準則」(如：低成本/資源、是否雙贏)及「一般性準則」(如：花費、導入時間)。</p>
                    <div id="mcda-criteria-input-area" class="space-y-2 mb-4">
                        </div>
                    <button id="mcda-add-criterion-button" class="action-button bg-gray-500 hover:bg-gray-600 text-sm py-1 px-3 rounded-md">
                        <i class="fas fa-plus mr-1"></i>新增標準
                    </button>
                    <button id="mcda-calculate-total-weight-button" class="action-button bg-yellow-500 hover:bg-yellow-600 text-sm py-1 px-3 rounded-md ml-2">
                        檢查權重總和
                    </button>
                    <span id="mcda-total-weight-display" class="ml-2 text-sm text-gray-600"></span>
                </div>
                <div id="mcda-evaluation-area" class="mt-6">
                    <h4 class="text-lg font-medium text-gray-700 mb-2">方案評估表 (建議評分尺度：1-10分)：</h4>
                    <div class="overflow-x-auto">
                        <table id="mcda-evaluation-table" class="data-table w-full">
                            <thead></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                     <button id="mcda-calculate-scores-button" class="action-button bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-md mt-4">
                        <i class="fas fa-calculator mr-2"></i>計算總分並推薦方案
                    </button>
                </div>
                <div id="mcda-result-output" class="mcda-result" style="display: none;">
                    <h4 class="text-lg font-medium text-gray-700 mb-2">評估結果：</h4>
                    <p id="mcda-best-solution-text" class="text-green-600 font-semibold"></p>
                    <div class="mt-2">
                        <label for="mcda-recommendation-reason-text" class="block text-sm font-medium text-gray-700">推薦理由：</label>
                        <textarea id="mcda-recommendation-reason-text" rows="3" class="input-field w-full mt-1" placeholder="手動輸入推薦理由..."></textarea>
                    </div>
                </div>
            </div>
             <button id="save-triz-mcda-button" class="action-button bg-purple-600 hover:bg-purple-700 text-white font-semibold py-2 px-4 rounded-md mt-6">
                <i class="fas fa-save mr-2"></i>儲存 TRIZ-MCDA 分析進度
            </button>
        </section>

        <section id="ideas-landscape-section" class="main-content-section">
            <h3>創意景觀圖</h3>
            <p class="text-sm text-gray-600 mb-4">此圖表根據MCDA評估總分與方案導入時間，將方案分佈於四個象限以便決策。</p>
            <button id="generate-landscape-chart-button" class="action-button bg-teal-500 hover:bg-teal-600 text-white font-semibold py-2 px-4 rounded-md mb-4">
                <i class="fas fa-sync-alt mr-2"></i>產生/更新景觀圖
            </button>
            <div id="ideas-landscape-chart-container">
                </div>
            <div class="mt-4 grid grid-cols-2 gap-4 text-xs text-gray-600">
                <div>
                    <p><strong>第二象限 (左上):</strong> 時間短、總分高 - 優先考慮方案。</p>
                    <p><strong>第三象限 (左下):</strong> 時間短、總分低 - 不值得考慮。</p>
                </div>
                <div>
                    <p><strong>第一象限 (右上):</strong> 時間長、總分高 - 可長期規劃。</p>
                    <p><strong>第四象限 (右下):</strong> 時間長、總分低 - 不適合現階段。</p>
                </div>
            </div>
        </section>

        <div id="report-output-sections" class="main-content-section">
            <section id="cause-effect-table-section" class="data-table-section bg-white p-4 md:p-6 rounded-lg shadow">
                <h2 class="text-xl font-semibold text-gray-700 mb-3">原因效果表</h2>
                <table class="data-table" id="cause-effect-data-table">
                    <thead> <tr><th>原因</th><th>原因類型</th><th>正面效果</th><th>負面效果</th></tr> </thead>
                    <tbody id="cause-effect-table-body"></tbody>
                </table>
            </section>
            <section id="solution-table-section" class="data-table-section bg-white p-4 md:p-6 rounded-lg shadow">
                <h2 class="text-xl font-semibold text-gray-700 mb-3">矛盾點之創意改善方案表</h2>
                <table class="data-table" id="solution-data-table">
                    <thead> <tr><th>矛盾原因</th><th>發明原理</th><th>改善方案</th></tr> </thead>
                    <tbody id="solution-table-body"></tbody>
                </table>
            </section>
            <section id="tracking-table-section" class="data-table-section bg-white p-4 md:p-6 rounded-lg shadow">
                <div class="flex justify-between items-center mb-3">
                    <h2 class="text-xl font-semibold text-gray-700">改善方案追蹤表</h2>
                    <button id="add-tracking-item-button" class="action-button bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-md">
                        <i class="fas fa-plus mr-2"></i>新增追蹤項目
                    </button>
                </div>
                <table class="data-table" id="tracking-data-table">
                    <thead> 
                        <tr>
                            <th style="width: 20%;">改善方案</th>
                            <th style="width: 10%;">負責人</th>
                            <th style="width: 10%;">完成日期</th>
                            <th style="width: 15%;">狀態</th>
                            <th style="width: 25%;">實際成效</th>
                            <th style="width: 10%;">備註</th>
                            <th class="action-cell">操作</th>
                        </tr> 
                    </thead>
                    <tbody id="tracking-table-body"></tbody>
                </table>
            </section>
        </div>
        
        <div id="contradiction-to-triz-modal" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center" style="display: none;">
            <div class="modal-content mx-auto p-5 border w-11/12 md:w-1/2 lg:w-2/5 shadow-lg rounded-md bg-white">
                <button class="modal-close-button" onclick="document.getElementById('contradiction-to-triz-modal').style.display='none';">&times;</button>
                <div class="mt-3">
                    <h3 class="text-lg leading-6 font-medium text-gray-900 text-center mb-4">識別衝突點</h3>
                    <input type="hidden" id="contradiction-node-id-holder">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">衝突來源原因：</label>
                        <p id="modal-contradiction-cause-text" class="mt-1 text-sm text-gray-800 p-2 bg-gray-100 rounded"></p>
                    </div>
                    <div class="mt-2">
                        <label for="modal-improving-feature-text" class="block text-sm font-medium text-gray-700">改善方面 (好處)：</label>
                        <textarea id="modal-improving-feature-text" rows="2" class="input-field w-full mt-1" placeholder="描述此原因帶來的正面效果或期望改善的特性"></textarea>
                    </div>
                    <div class="mt-2">
                        <label for="modal-worsening-feature-text" class="block text-sm font-medium text-gray-700">惡化方面 (壞處)：</label>
                        <textarea id="modal-worsening-feature-text" rows="2" class="input-field w-full mt-1" placeholder="描述此原因導致的負面效果或因此惡化的特性"></textarea>
                    </div>
                     <div class="mt-4 items-center px-4 py-3 text-right">
                        <button id="cancel-contradiction-to-triz" class="action-button mr-2 px-4 py-2 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400" onclick="document.getElementById('contradiction-to-triz-modal').style.display='none';">取消</button>
                        <button id="confirm-contradiction-to-triz" class="action-button px-4 py-2 bg-purple-600 text-white rounded-md hover:bg-purple-700">確認並記錄此衝突</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="and-source-modal" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center" style="display: none;">
            <div class="modal-content mx-auto p-5 border w-11/12 md:w-1/2 lg:w-1/3 shadow-lg rounded-md bg-white">
                <button class="modal-close-button" onclick="document.getElementById('and-source-modal').style.display='none'; currentAndTargetNodeId = null;">&times;</button>
                <div class="mt-3">
                    <h3 class="text-lg leading-6 font-medium text-gray-900 text-center" id="and-source-modal-title">為效果設定 AND 輸入源</h3>
                    <div class="mt-4 px-2 py-3 max-h-72 overflow-y-auto modal-options-container" id="and-source-options-container"></div>
                    <div class="items-center px-4 py-3 mt-4 text-right">
                        <button id="cancel-and-sources-button" class="action-button mr-2 px-4 py-2 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400">取消</button>
                        <button id="save-and-sources-button" class="action-button px-4 py-2 bg-green-500 text-white rounded-md hover:bg-green-700">儲存AND來源</button>
                    </div>
                </div>
            </div>
        </div>
        <div id="effect-parameter-modal" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center" style="display: none;">
            <div class="modal-content mx-auto p-5 border w-11/12 md:w-1/2 lg:w-2/5 shadow-lg rounded-md bg-white">
                <button class="modal-close-button" onclick="document.getElementById('effect-parameter-modal').style.display='none'; currentParameterTargetNodeId = null;">&times;</button>
                <div class="mt-3">
                    <h3 class="text-lg leading-6 font-medium text-gray-900 text-center" id="effect-parameter-modal-title">設定效果參數</h3>
                    <div class="mt-4 px-2 py-3 max-h-96 overflow-y-auto modal-options-container" id="effect-parameter-options-container"></div>
                    <div class="items-center px-4 py-3 mt-4 text-right">
                        <button id="cancel-effect-parameters-button" class="action-button mr-2 px-4 py-2 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400">取消</button>
                        <button id="save-effect-parameters-button" class="action-button px-4 py-2 bg-sky-500 text-white rounded-md hover:bg-sky-700">儲存參數</button>
                    </div>
                </div>
            </div>
        </div>
        <div id="inventive-principle-modal" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center" style="display: none;">
            <div class="modal-content mx-auto p-5 border w-11/12 md:w-1/2 lg:w-2/5 shadow-lg rounded-md bg-white">
                <button class="modal-close-button" onclick="document.getElementById('inventive-principle-modal').style.display='none'; currentPrincipleTargetNodeId = null;">&times;</button>
                <div class="mt-3">
                    <h3 class="text-lg leading-6 font-medium text-gray-900 text-center" id="inventive-principle-modal-title">選擇發明原理與改善方案</h3>
                    <div class="mt-4 px-2 py-3 max-h-[calc(100vh-200px)] overflow-y-auto modal-options-container" id="inventive-principle-options-container">
                    </div>
                     <div class="items-center px-4 py-3 mt-4 text-right">
                        <button id="cancel-inventive-principles-button" class="action-button mr-2 px-4 py-2 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400">取消</button>
                        <button id="save-inventive-principles-button" class="action-button px-4 py-2 bg-pink-500 text-white rounded-md hover:bg-pink-700">儲存原理與方案</button>
                    </div>
                </div>
            </div>
        </div>
        <div id="tracking-item-modal" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center" style="display: none;">
            <div class="modal-content mx-auto p-5 border w-11/12 md:w-1/2 lg:w-2/5 shadow-lg rounded-md bg-white">
                 <button class="modal-close-button" onclick="closeTrackingItemModal()">&times;</button>
                <div class="mt-3">
                    <h3 class="text-lg leading-6 font-medium text-gray-900 text-center mb-4" id="tracking-item-modal-title">新增/編輯追蹤項目</h3>
                    <input type="hidden" id="tracking-item-id">
                    <div>
                        <label for="tracking-solution-text" class="block text-sm font-medium text-gray-700">改善方案</label>
                        <textarea id="tracking-solution-text" rows="3" class="input-field w-full mt-1" placeholder="輸入改善方案描述"></textarea>
                    </div>
                    <div>
                        <label for="tracking-responsible-person" class="block text-sm font-medium text-gray-700 mt-2">負責人</label>
                        <input type="text" id="tracking-responsible-person" class="input-field w-full mt-1" placeholder="輸入負責人或團隊">
                    </div>
                    <div>
                        <label for="tracking-due-date" class="block text-sm font-medium text-gray-700 mt-2">預計完成日期</label>
                        <input type="date" id="tracking-due-date" class="input-field w-full mt-1">
                    </div>
                    <div>
                        <label for="tracking-status" class="block text-sm font-medium text-gray-700 mt-2">狀態</label>
                        <select id="tracking-status" class="input-field w-full mt-1">
                            <option value="未開始">未開始</option>
                            <option value="進行中">進行中</option>
                            <option value="已完成">已完成</option>
                            <option value="已驗證">已驗證</option>
                            <option value="遇到障礙">遇到障礙</option>
                            <option value="已取消">已取消</option>
                        </select>
                    </div>
                    <div>
                        <label for="tracking-actual-outcome" class="block text-sm font-medium text-gray-700 mt-2">實際成效</label>
                        <textarea id="tracking-actual-outcome" rows="3" class="input-field w-full mt-1" placeholder="記錄實際執行成效與結果"></textarea>
                    </div>
                    <div>
                        <label for="tracking-notes" class="block text-sm font-medium text-gray-700 mt-2">備註</label>
                        <textarea id="tracking-notes" rows="2" class="input-field w-full mt-1" placeholder="其他備註事項"></textarea>
                    </div>
                    <div class="items-center px-4 py-3 mt-4 text-right">
                        <button id="cancel-tracking-item-button" class="action-button mr-2 px-4 py-2 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400" onclick="closeTrackingItemModal()">取消</button>
                        <button id="save-tracking-item-button" class="action-button px-4 py-2 bg-green-500 text-white rounded-md hover:bg-green-700">儲存項目</button>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script>
        // --- 全域狀態與常數 ---
        let currentWorkflowStep = 1; // 當前工作流程步驟
        let trizMcdaData = {
            problemDescription: "", 
            identifiedConflicts: [], // 儲存已識別的衝突 {id, causeId, causeText, improving, worsening}
            contradictionSourceCauseId: null, 
            contradictionSourceCauseText: "", 
            contradictionPhenomenon: "", 
            improvingParameter: null, 
            worseningParameter: null, 
            suggestedPrinciples: [],  
            mcdaCriteria: [], 
            mcdaSolutions: [], 
            mcdaBestSolution: null,
            mcdaRecommendation: ""
        };
        const TRIZ_PARAMETERS = []; // TRIZ 參數列表
        const TRIZ_PRINCIPLES = {}; // TRIZ 發明原理列表
        const TRIZ_CONTRADICTION_MATRIX = {}; // TRIZ 矛盾矩陣
        let trackingData = []; // 改善方案追蹤資料
        let currentEditingTrackingItemId = null; // 當前編輯中的追蹤項目 ID
        
        let rcaData = null; // RCA 圖表資料
        let nodeIdCounter = 0; // 節點 ID 計數器
        let currentAndTargetNodeId = null; // 當前設定 AND 輸入源的目標節點 ID
        let isFinalizedView = false; // 是否處於完成圖表模式
        let currentParameterTargetNodeId = null; // 當前設定效果參數的目標節點 ID
        let currentPrincipleTargetNodeId = null; // 當前設定發明原理的目標節點 ID
        let currentZoom = 1.0; // 當前縮放級別
        const ZOOM_STEP = 0.1; // 縮放步長
        const MIN_ZOOM = 0.2; // 最小縮放級別
        const MAX_ZOOM = 3.0; // 最大縮放級別
        let historyStack = []; // 歷史記錄堆疊
        let historyIndex = -1; // 歷史記錄索引
        const MAX_HISTORY_STATES = 50; // 最大歷史記錄數量

        // --- DOM 元素引用 ---
        const workflowNavigator = document.getElementById('workflow-navigator');
        const workflowStepButtons = Array.from(workflowNavigator.querySelectorAll('.workflow-step'));
        
        const problemInput = document.getElementById('problem-statement-input');
        const setProblemButton = document.getElementById('set-problem-button');
        const diagramRenderArea = document.getElementById('diagram-render-area'); 
        const scalableContentWrapper = document.getElementById('scalable-content-wrapper');
        const diagramContainer = document.getElementById('rca-diagram-container'); 
        const svgLayer = document.getElementById('svg-connector-layer');
        const diagramTitle = document.getElementById('diagram-title');
        const problemInputArea = document.getElementById('problem-input-area');
        const toolButtonsContainer = document.getElementById('tool-buttons');
        const loadingSpinnerOverlay = document.getElementById('loading-spinner-overlay');
        
        const fileMenuButton = document.getElementById('file-menu-button');
        const fileDropdownContent = document.getElementById('file-dropdown-content');
        const saveWorkspaceButton = document.getElementById('save-workspace-button'); 
        const loadWorkspaceButton = document.getElementById('load-workspace-button'); 
        const downloadBackupButton = document.getElementById('download-backup-button');   
        const loadBackupLabel = document.getElementById('load-backup-label'); 
        const loadBackupInput = document.getElementById('load-backup-input');
        
        const undoButton = document.getElementById('undo-button');
        const redoButton = document.getElementById('redo-button');
        
        const zoomOutButton = document.getElementById('zoom-out-button'); 
        const zoomInButton = document.getElementById('zoom-in-button');   
        const resetZoomButton = document.getElementById('reset-zoom-button'); 
        const zoomLevelDisplay = document.getElementById('zoom-level-display'); 
        
        const finalizeDiagramButton = document.getElementById('finalize-diagram-button'); 
        const autoAdjustLayoutButton = document.getElementById('auto-adjust-layout-button'); 

        const exportMenuButton = document.getElementById('export-menu-button');
        const exportDropdownContent = document.getElementById('export-dropdown-content');
        const exportCauseEffectCsvButton = document.getElementById('export-cause-effect-csv-button'); 
        const exportSolutionCsvButton = document.getElementById('export-solution-csv-button'); 
        const exportTrackingCsvButton = document.getElementById('export-tracking-csv-button'); 
        const exportSvgButton = document.getElementById('export-svg-button');
        const printDocumentButton = document.getElementById('print-document-button'); 

        const viewTablesMenuButton = document.getElementById('view-tables-menu-button');
        const viewTablesDropdownContent = document.getElementById('view-tables-dropdown-content');
        const showCauseEffectTableButton = document.getElementById('show-cause-effect-table-button');
        const showSolutionTableButton = document.getElementById('show-solution-table-button');
        const showTrackingTableButton = document.getElementById('show-tracking-table-button'); 
        const hideAllTablesButton = document.getElementById('hide-all-tables-button');

        // 主要內容區塊，用於步驟導航
        const conflictAnalysisSection = document.getElementById('conflict-analysis-section');
        const identifiedConflictsList = document.getElementById('identified-conflicts-list');
        const rcaDiagramSection = document.getElementById('rca-diagram-section');
        const trizMcdaSection = document.getElementById('triz-mcda-section');
        const ideasLandscapeSection = document.getElementById('ideas-landscape-section');
        const reportOutputSections = document.getElementById('report-output-sections'); 
        const causeEffectTableSection = document.getElementById('cause-effect-table-section');
        const causeEffectTableBody = document.getElementById('cause-effect-table-body');
        const solutionTableSection = document.getElementById('solution-table-section'); 
        const solutionTableBody = document.getElementById('solution-table-body'); 
        const trackingTableSection = document.getElementById('tracking-table-section'); 
        const trackingTableBody = document.getElementById('tracking-table-body'); 
        const addTrackingItemButton = document.getElementById('add-tracking-item-button'); 
        
        // 彈出視窗 (Modals)
        const contradictionToTrizModal = document.getElementById('contradiction-to-triz-modal');
        const contradictionNodeIdHolder = document.getElementById('contradiction-node-id-holder');
        const modalContradictionCauseText = document.getElementById('modal-contradiction-cause-text');
        const modalImprovingFeatureText = document.getElementById('modal-improving-feature-text');
        const modalWorseningFeatureText = document.getElementById('modal-worsening-feature-text');
        const confirmContradictionToTrizButton = document.getElementById('confirm-contradiction-to-triz');

        const andSourceModal = document.getElementById('and-source-modal');
        const andSourceOptionsContainer = document.getElementById('and-source-options-container');
        const andSourceModalTitle = document.getElementById('and-source-modal-title');
        const saveAndSourcesButton = document.getElementById('save-and-sources-button');
        const cancelAndSourcesButton = document.getElementById('cancel-and-sources-button');
        const effectParameterModal = document.getElementById('effect-parameter-modal');
        const effectParameterOptionsContainer = document.getElementById('effect-parameter-options-container');
        const effectParameterModalTitle = document.getElementById('effect-parameter-modal-title');
        const saveEffectParametersButton = document.getElementById('save-effect-parameters-button');
        const cancelEffectParametersButton = document.getElementById('cancel-effect-parameters-button');
        
        const inventivePrincipleModal = document.getElementById('inventive-principle-modal');
        const inventivePrincipleOptionsContainer = document.getElementById('inventive-principle-options-container');
        const inventivePrincipleModalTitle = document.getElementById('inventive-principle-modal-title');
        const saveInventivePrinciplesButton = document.getElementById('save-inventive-principles-button');
        const cancelInventivePrinciplesButton = document.getElementById('cancel-inventive-principles-button');

        const trackingItemModal = document.getElementById('tracking-item-modal');
        const trackingItemModalTitle = document.getElementById('tracking-item-modal-title');
        const trackingItemIdInput = document.getElementById('tracking-item-id');
        const trackingSolutionTextInput = document.getElementById('tracking-solution-text');
        const trackingResponsiblePersonInput = document.getElementById('tracking-responsible-person');
        const trackingDueDateInput = document.getElementById('tracking-due-date');
        const trackingStatusSelect = document.getElementById('tracking-status');
        const trackingActualOutcomeInput = document.getElementById('tracking-actual-outcome');
        const trackingNotesInput = document.getElementById('tracking-notes');
        const saveTrackingItemButton = document.getElementById('save-tracking-item-button');

        // TRIZ-MCDA 區塊元素
        const trizProblemDescriptionInput = document.getElementById('triz-problem-description');
        const trizContradictionSourceCauseInput = document.getElementById('triz-contradiction-source-cause');
        const trizContradictionPhenomenonInput = document.getElementById('triz-contradiction-phenomenon');
        const trizImprovingParameterSelect = document.getElementById('triz-improving-parameter');
        const trizWorseningParameterSelect = document.getElementById('triz-worsening-parameter');
        const trizGeneratePrinciplesButton = document.getElementById('triz-generate-principles-button');
        const trizPrinciplesOutput = document.getElementById('triz-principles-output');
        const mcdaCriteriaInputArea = document.getElementById('mcda-criteria-input-area');
        const mcdaAddCriterionButton = document.getElementById('mcda-add-criterion-button');
        const mcdaCalculateTotalWeightButton = document.getElementById('mcda-calculate-total-weight-button');
        const mcdaTotalWeightDisplay = document.getElementById('mcda-total-weight-display');
        const mcdaEvaluationTable = document.getElementById('mcda-evaluation-table');
        const mcdaCalculateScoresButton = document.getElementById('mcda-calculate-scores-button');
        const mcdaResultOutput = document.getElementById('mcda-result-output');
        const mcdaBestSolutionText = document.getElementById('mcda-best-solution-text');
        const mcdaRecommendationReasonText = document.getElementById('mcda-recommendation-reason-text'); 
        const saveTrizMcdaButton = document.getElementById('save-triz-mcda-button');

        // 創意景觀圖區塊元素
        const generateLandscapeChartButton = document.getElementById('generate-landscape-chart-button');
        const ideasLandscapeChartContainer = document.getElementById('ideas-landscape-chart-container');

        // 效果參數定義 (用於效果節點)
        const EFFECT_PARAMETERS = {
            "活動": ["活動效用性", "活動可變性", "活動費用", "活動時間", "活動複雜性", "活動方便性", "活動安全性", "活動可靠性"],
            "系統": ["系統有效性", "系統可變性", "系統費用", "系統時間", "系統複雜性", "系統方便性", "系統安全性", "系統可靠性", "對系統的有害影響", "系統產生的有害影響", "組織壓力", "組織穩定性"],
            "其他": ["內部風險", "外部風險", "信息共享", "信息損失", "信息流", "回饋", "物料流", "適應性/多功能性", "顧客壓力", "顧客穩定性", "環境穩定性"]
        }; 
        // 發明原理定義 (用於原因節點)
        const INVENTIVE_PRINCIPLES = [
            "1. 分割", "2. 取出", "3. 局部品質", "4. 不對稱", "5. 合併", "6. 通用性", "7. 套疊", "8. 反作用力（配重）",
            "9. 預先反作用", "10. 預先作用", "11. 事先防範", "12. 等勢能", "13. 反向作用", "14. 曲面化", "15. 動態化",
            "16. 不足或超額作用", "17. 維度變更", "18. 機械振動", "19. 週期性作用", "20. 連續有用作用", "21. 快速通過",
            "22. 轉害為利", "23. 回饋", "24. 中介物", "25. 自助服務", "26. 複製", "27. 廉價替代品", "28. 機械系統替代",
            "29. 氣壓與液壓", "30. 可撓性殼膜", "31. 多孔材料", "32. 改變顏色", "33. 同質性", "34. 拋棄與再生",
            "35. 參數改變", "36. 相態轉換", "37. 熱膨脹", "38. 強氧化劑", "39. 惰性環境", "40. 複合材料"
        ];
        
        // --- 工作流程步驟導航邏輯 ---
        /**
         * 導航到指定的工作流程步驟。
         * @param {number} stepNumber - 目標步驟號碼。
         * @param {boolean} [forceNavigation=false] - 是否強制導航，忽略前置條件檢查。
         */
        function navigateToStep(stepNumber, forceNavigation = false) {
            const targetStep = parseInt(stepNumber);

            // 檢查導航前置條件 (除非強制導航)
            if (!forceNavigation) {
                if (targetStep > 1 && !rcaData) {
                    alert("請先在「步驟1」設定關鍵問題並建立RCA圖。");
                    return;
                }
                if (targetStep === 3 && !trizMcdaData.contradictionSourceCauseId ) { 
                     alert("請先在「步驟2：衝突分析」中，從已識別的衝突列表選擇一個衝突點，並點擊「將此衝突帶入TRIZ分析」。");
                     return; 
                }
                if (targetStep === 4 && (trizMcdaData.mcdaSolutions.length === 0 || trizMcdaData.mcdaCriteria.length === 0) ) {
                     alert("請先在「步驟3：TRIZ方案生成」中產生方案並完成MCDA評估標準的設定。");
                     return; 
                }
                 if (targetStep === 5 && !rcaData) { 
                    alert("請先完成前面的分析步驟。");
                    return;
                }
            }

            currentWorkflowStep = targetStep;
            // 更新步驟按鈕的 active 狀態
            workflowStepButtons.forEach(btn => {
                btn.classList.remove('active-step');
                if (parseInt(btn.dataset.step) === targetStep) {
                    btn.classList.add('active-step');
                }
            });

            // 隱藏所有主要內容區塊
            [problemInputArea, rcaDiagramSection, conflictAnalysisSection, trizMcdaSection, ideasLandscapeSection, reportOutputSections].forEach(section => {
                if (section) section.classList.remove('active-section');
            });
            
            let sectionToScrollTo = null; // 用於滾動到目標區塊

            // 根據步驟顯示對應的區塊
            switch (targetStep) {
                case 1: 
                    if (!rcaData) { // 如果沒有 RCA 資料，顯示問題輸入區塊
                        problemInputArea.style.display = 'block'; 
                        sectionToScrollTo = problemInputArea;
                    } else { // 否則隱藏問題輸入區塊
                        problemInputArea.style.display = 'none';
                    }
                    rcaDiagramSection.classList.add('active-section');
                    if (!sectionToScrollTo) sectionToScrollTo = rcaDiagramSection;
                    diagramTitle.textContent = "根本原因分析 (RCA) 圖";
                    break;
                case 2: 
                    problemInputArea.style.display = 'none';
                    conflictAnalysisSection.classList.add('active-section');
                    rcaDiagramSection.classList.add('active-section'); // RCA圖在衝突分析下方顯示以供操作
                    sectionToScrollTo = conflictAnalysisSection;
                    diagramTitle.textContent = "衝突分析 (於RCA圖中操作)";
                    renderIdentifiedConflictsList(); // 重新渲染已識別衝突列表
                    break;
                case 3: 
                    problemInputArea.style.display = 'none';
                    trizMcdaSection.classList.add('active-section');
                    sectionToScrollTo = trizMcdaSection;
                    renderTrizMcdaFromData(); // 確保帶入的衝突資料已更新到UI
                    break;
                case 4: 
                    problemInputArea.style.display = 'none';
                    trizMcdaSection.classList.add('active-section'); 
                    ideasLandscapeSection.classList.add('active-section');
                    sectionToScrollTo = trizMcdaSection; // 優先捲動到MCDA部分
                    renderIdeasLandscapeChart(); // 渲染創意景觀圖
                    break;
                case 5: 
                    problemInputArea.style.display = 'none';
                    reportOutputSections.classList.add('active-section');
                    renderCauseEffectTable(); // 渲染原因效果表
                    renderSolutionTable(); // 渲染改善方案表
                    renderTrackingTable(); // 渲染改善追蹤表
                    sectionToScrollTo = reportOutputSections;
                    break;
            }
            // 滾動到目標區塊
            if (sectionToScrollTo) {
                sectionToScrollTo.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
            updateStepButtonStates(); // 更新步驟按鈕的啟用/禁用狀態
            updateButtonStates(); // 更新其他按鈕的啟用/禁用狀態
        }

        /**
         * 更新工作流程步驟按鈕的啟用/禁用狀態。
         */
        function updateStepButtonStates() {
            workflowStepButtons.forEach(btn => {
                const step = parseInt(btn.dataset.step);
                let disabled = false;
                // 步驟1完成後 (rcaData存在) 才能到步驟2
                if (step > 1 && !rcaData) disabled = true; 
                
                // 步驟3 (TRIZ) 需要步驟2中至少有一個衝突被選定並帶入 (即trizMcdaData.contradictionSourceCauseId有值)
                // 或者，如果用戶是從已保存的狀態載入，且先前已進行到TRIZ階段，也應允許進入
                if (step === 3 && !(rcaData && (trizMcdaData.contradictionSourceCauseId || trizMcdaData.suggestedPrinciples.length > 0) )) {
                     disabled = true;
                }

                // 步驟4 (評估) 需要步驟3中已生成方案 (mcdaSolutions有內容) 且設定了評估標準 (mcdaCriteria有內容)
                if (step === 4 && !(rcaData && trizMcdaData.mcdaSolutions.length > 0 && trizMcdaData.mcdaCriteria.length > 0)) {
                    disabled = true;
                }
                // 步驟5 (報告) 至少需要RCA資料
                if (step === 5 && !rcaData) {
                    disabled = true;
                }
                
                btn.disabled = disabled;
            });
        }

        // --- 輔助函數 (下拉選單、縮放、UI 狀態、歷史記錄、持久化) ---
        /**
         * 深度複製物件。
         * @param {object} obj - 要複製的物件。
         * @returns {object} 複製後的物件。
         */
        function deepCopy(obj) { return JSON.parse(JSON.stringify(obj)); } 

        /**
         * 切換下拉選單的顯示狀態。
         * @param {HTMLElement} dropdownToShow - 要顯示/隱藏的下拉選單元素。
         * @param {HTMLElement[]} otherDropdownsToHide - 其他需要隱藏的下拉選單元素陣列。
         */
        function toggleDropdown(dropdownToShow, otherDropdownsToHide) {
            const currentDisplay = dropdownToShow.style.display;
            otherDropdownsToHide.forEach(dd => dd.style.display = 'none');
            dropdownToShow.style.display = currentDisplay === 'block' ? 'none' : 'block';
        }

        /**
         * 關閉所有下拉選單。
         */
        function closeAllDropdowns() {
            fileDropdownContent.style.display = 'none';
            exportDropdownContent.style.display = 'none';
            viewTablesDropdownContent.style.display = 'none';
        }
        
        /**
         * 應用縮放級別到圖表。
         * @param {number} newZoomLevel - 新的縮放級別。
         * @param {boolean} [avoidRedraw=false] - 是否避免重新繪製 SVG 連接線。
         */
        function applyZoom(newZoomLevel, avoidRedraw = false) { 
            currentZoom = Math.max(MIN_ZOOM, Math.min(MAX_ZOOM, newZoomLevel)); 
            scalableContentWrapper.style.transform = `scale(${currentZoom})`; 
            zoomLevelDisplay.textContent = `${Math.round(currentZoom * 100)}%`; 
            if (!avoidRedraw && rcaData) { 
                requestAnimationFrame(() => drawAllSvgConnectors()); 
            } 
            updateButtonStates(); 
        }
        
        /**
         * 顯示載入動畫。
         */
        function showLoadingSpinner() { loadingSpinnerOverlay.style.display = 'flex'; }
        /**
         * 隱藏載入動畫。
         */
        function hideLoadingSpinner() { loadingSpinnerOverlay.style.display = 'none'; }

        /**
         * 更新所有按鈕的啟用/禁用狀態。
         */
        function updateButtonStates() { 
            const noData = !rcaData; 
            const noLocalStorageData = !localStorage.getItem('rcaPlusData'); 
            
            undoButton.disabled = historyIndex <= 0; 
            redoButton.disabled = historyIndex >= historyStack.length - 1; 
            
            saveWorkspaceButton.disabled = noData && trackingData.length === 0 && !hasTrizMcdaData(); 
            loadWorkspaceButton.disabled = noLocalStorageData; 
            downloadBackupButton.disabled = noData && trackingData.length === 0 && !hasTrizMcdaData(); 
            
            zoomInButton.disabled = currentZoom >= MAX_ZOOM; 
            zoomOutButton.disabled = currentZoom <= MIN_ZOOM; 
            resetZoomButton.disabled = currentZoom === 1.0; 
            
            exportCauseEffectCsvButton.disabled = noData; 
            exportSolutionCsvButton.disabled = noData || trizMcdaData.mcdaSolutions.length === 0;
            exportTrackingCsvButton.disabled = trackingData.length === 0;
            if (exportSvgButton) exportSvgButton.disabled = noData; 
            printDocumentButton.disabled = noData && trackingData.length === 0 && !hasTrizMcdaData(); 
            exportMenuButton.disabled = noData && trackingData.length === 0 && !hasTrizMcdaData(); 

            finalizeDiagramButton.disabled = noData || (currentWorkflowStep !== 1 && currentWorkflowStep !== 2); 
            autoAdjustLayoutButton.disabled = noData || isFinalizedView || (currentWorkflowStep !== 1 && currentWorkflowStep !== 2); 
            
            viewTablesMenuButton.disabled = noData || currentWorkflowStep !== 5; // 表格檢視主要在步驟5
            showCauseEffectTableButton.disabled = noData;
            showSolutionTableButton.disabled = noData || trizMcdaData.mcdaSolutions.length === 0;
            showTrackingTableButton.disabled = trackingData.length === 0; 
            addTrackingItemButton.disabled = noData; 
            hideAllTablesButton.disabled = noData || (causeEffectTableSection.style.display === 'none' && solutionTableSection.style.display === 'none' && trackingTableSection.style.display === 'none');
            updateStepButtonStates(); 
        }
        
        /**
         * 檢查 TRIZ-MCDA 資料物件是否有任何有效資料。
         * @returns {boolean} 如果有資料則為 true，否則為 false。
         */
        function hasTrizMcdaData() {
            return trizMcdaData.problemDescription || 
                   trizMcdaData.identifiedConflicts.length > 0 || 
                   trizMcdaData.contradictionPhenomenon || 
                   trizMcdaData.suggestedPrinciples.length > 0 || 
                   trizMcdaData.mcdaCriteria.length > 0 || 
                   trizMcdaData.mcdaSolutions.length > 0;
        }

        /**
         * 將當前狀態推入歷史記錄堆疊。
         * @param {object} currentRcaData - 當前的 RCA 圖表資料。
         * @param {boolean} [clearRedoStack=true] - 是否清除重做堆疊。
         */
        function pushStateToHistory(currentRcaData, clearRedoStack = true) { 
            // 如果沒有任何資料，則不儲存歷史記錄
            if (!currentRcaData && trackingData.length === 0 && !hasTrizMcdaData()) { 
                updateButtonStates(); 
                return; 
            } 
            const stateCopy = {
                rca: currentRcaData ? deepCopy(currentRcaData) : null,
                tracking: deepCopy(trackingData),
                trizMcda: deepCopy(trizMcdaData) 
            };
            if (clearRedoStack) { 
                historyStack = historyStack.slice(0, historyIndex + 1); 
            } 
            historyStack.push({ 
                diagramData: stateCopy.rca, 
                trackingInfo: stateCopy.tracking, 
                trizMcdaInfo: stateCopy.trizMcda, 
                counter: nodeIdCounter, 
                zoom: currentZoom,
                activeStep: currentWorkflowStep 
            }); 
            historyIndex = historyStack.length - 1; 
            // 限制歷史記錄數量
            if (historyStack.length > MAX_HISTORY_STATES) { 
                historyStack.shift(); 
                historyIndex--; 
            } 
            updateButtonStates(); 
        }

        /**
         * 從歷史記錄中恢復狀態。
         * @param {object} historyEntry - 要恢復的歷史記錄條目。
         * @returns {boolean} 恢復是否成功。
         */
        function restoreStateFromHistory(historyEntry) { 
            if (historyEntry) { 
                rcaData = historyEntry.diagramData ? deepCopy(historyEntry.diagramData) : null; 
                trackingData = historyEntry.trackingInfo ? deepCopy(historyEntry.trackingInfo) : []; 
                trizMcdaData = historyEntry.trizMcdaInfo ? deepCopy(historyEntry.trizMcdaInfo) : initializeTrizMcdaDataObject(); 
                if (!trizMcdaData.identifiedConflicts) trizMcdaData.identifiedConflicts = []; // 向下相容舊資料
                nodeIdCounter = historyEntry.counter; 
                recalculateNodeIdCounter(rcaData); // 重新計算節點 ID 計數器
                
                renderRcaDiagram(); // 渲染 RCA 圖表
                renderCauseEffectTable(); // 渲染原因效果表
                renderSolutionTable(); // 渲染改善方案表
                renderTrackingTable(); // 渲染追蹤表
                renderTrizMcdaFromData(); // 渲染 TRIZ-MCDA 數據
                renderIdentifiedConflictsList(); // 恢復衝突列表
                applyZoom(historyEntry.zoom, true); // 應用縮放
                navigateToStep(historyEntry.activeStep || 1, true); // 導航到活動步驟
            } else { 
                console.error("無法從歷史記錄中檢索狀態。"); 
                return false; 
            } 
            return true; 
        } 

        /** 處理撤銷操作 */
        function handleUndo() { 
            if (historyIndex > 0) { 
                historyIndex--; 
                if (!restoreStateFromHistory(historyStack[historyIndex])) { 
                    historyIndex++; // 如果恢復失敗，回退索引
                } 
            } 
            updateButtonStates(); 
        }

        /** 處理重做操作 */
        function handleRedo() { 
            if (historyIndex < historyStack.length - 1) { 
                historyIndex++; 
                if (!restoreStateFromHistory(historyStack[historyIndex])) { 
                    historyIndex--; // 如果恢復失敗，回退索引
                } 
            } 
            updateButtonStates(); 
        }
        
        /**
         * 處理載入的資料字串。
         * @param {string} dataString - 載入的 JSON 資料字串。
         * @returns {boolean} 處理是否成功。
         */
        function processLoadedData(dataString) { 
            try { 
                const parsedJson = JSON.parse(dataString); 
                if (parsedJson && (typeof parsedJson.diagramData !== 'undefined' || typeof parsedJson.rcaDiagramData !== 'undefined') && typeof parsedJson.counter !== 'undefined') { 
                    rcaData = parsedJson.diagramData || parsedJson.rcaDiagramData; 
                    trackingData = parsedJson.trackingData || []; 
                    trizMcdaData = parsedJson.trizMcdaData || initializeTrizMcdaDataObject(); 
                    if (!trizMcdaData.identifiedConflicts) trizMcdaData.identifiedConflicts = []; // 向下相容舊資料
                    nodeIdCounter = parseInt(parsedJson.counter); 
                    if (isNaN(nodeIdCounter)) nodeIdCounter = 0; 
                    recalculateNodeIdCounter(rcaData); 
                    historyStack = []; 
                    historyIndex = -1; 
                    currentWorkflowStep = parsedJson.activeStep || 1;
                    pushStateToHistory(rcaData, true); 
                    
                    toolButtonsContainer.style.display = 'flex'; 
                    renderRcaDiagram(); 
                    renderCauseEffectTable(); 
                    renderSolutionTable(); 
                    renderTrackingTable();
                    renderTrizMcdaFromData(); 
                    renderIdentifiedConflictsList();
                    applyZoom(parsedJson.zoomLevel || 1.0, true); 
                    navigateToStep(currentWorkflowStep, true); 
                    alert('圖表進度已成功載入！'); 
                    return true; 
                } else { 
                    alert('載入失敗：檔案格式不正確或資料不完整。'); 
                    return false; 
                } 
            } catch (e) { 
                console.error("載入資料時發生錯誤:", e); 
                alert('載入失敗：檔案內容可能不是有效的JSON格式，或已損毀。\n' + e.message); 
                return false; 
            } finally { 
                updateButtonStates(); 
            } 
        } 

        /** 處理儲存到本地儲存 */
        function handleSaveToLocalStorage() { 
            if (rcaData || trackingData.length > 0 || hasTrizMcdaData()) { 
                try { 
                    const dataToSave = { 
                        diagramData: rcaData, 
                        trackingData: trackingData, 
                        trizMcdaData: trizMcdaData, 
                        counter: nodeIdCounter, 
                        zoomLevel: currentZoom,
                        activeStep: currentWorkflowStep 
                    }; 
                    localStorage.setItem('rcaPlusData', JSON.stringify(dataToSave)); 
                    alert('圖表進度已儲存至瀏覽器！'); 
                } catch (e) { 
                    console.error("儲存至localStorage時發生錯誤:", e); 
                    alert('儲存失敗，可能是瀏覽器儲存空間已滿或功能受限。'); 
                } 
            } else { 
                alert('沒有圖表資料可儲存。'); 
            } 
            updateButtonStates(); 
        }

        /** 處理從本地儲存載入 */
        function handleLoadFromLocalStorage() { 
            const savedDataString = localStorage.getItem('rcaPlusData'); 
            if (savedDataString) { 
                processLoadedData(savedDataString); 
            } else { 
                alert('瀏覽器中沒有儲存的圖表進度。'); 
            } 
        }

        /** 處理儲存到檔案 */
        function handleSaveToFile() { 
            if (!rcaData && trackingData.length === 0 && !hasTrizMcdaData()) { alert('沒有圖表資料可儲存至檔案。'); return; } 
            const dataToSave = { 
                diagramData: rcaData, 
                trackingData: trackingData, 
                trizMcdaData: trizMcdaData, 
                counter: nodeIdCounter, 
                zoomLevel: currentZoom,
                activeStep: currentWorkflowStep 
            }; 
            const jsonData = JSON.stringify(dataToSave, null, 2); 
            const blob = new Blob([jsonData], { type: 'application/json' }); 
            const url = URL.createObjectURL(blob); 
            const a = document.createElement('a'); 
            a.href = url; 
            a.download = `rca-plus-triz-mcda-data-${new Date().toISOString().slice(0,10)}.json`; 
            document.body.appendChild(a); 
            a.click(); 
            document.body.removeChild(a); 
            URL.revokeObjectURL(url); 
            alert('圖表資料已準備下載。'); 
        }

        /**
         * 處理從檔案載入。
         * @param {Event} event - 檔案輸入事件。
         */
        function handleLoadFromFile(event) { 
            const file = event.target.files[0]; 
            if (file) { 
                if (file.type === "application/json") { 
                    const reader = new FileReader(); 
                    reader.onload = (e) => { 
                        const fileContent = e.target.result; 
                        processLoadedData(fileContent); 
                        loadBackupInput.value = ''; 
                    }; 
                    reader.onerror = (e) => { 
                        alert('讀取檔案時發生錯誤。'); 
                        console.error("FileReader error:", e); 
                        loadBackupInput.value = ''; 
                    }; 
                    reader.readAsText(file); 
                } else { 
                    alert('載入失敗：請選擇一個有效的 .json 檔案。'); 
                    loadBackupInput.value = ''; 
                } 
            } 
        }

        /**
         * 重新計算節點 ID 計數器，確保其大於現有節點的最大 ID。
         * @param {object} currentData - 當前的 RCA 圖表資料。
         */
        function recalculateNodeIdCounter(currentData) { 
            let maxId = 0; 
            function findMaxIdRecursive(node) { 
                if (!node) return; 
                if (node.id && typeof node.id === 'string') { 
                    const idNum = parseInt(node.id.replace('node-', '')); 
                    if (!isNaN(idNum) && idNum > maxId) { 
                        maxId = idNum; 
                    } 
                } 
                if (node.children) { 
                    node.children.forEach(findMaxIdRecursive); 
                } 
            } 
            if (currentData) { 
                findMaxIdRecursive(currentData); 
            } 
            nodeIdCounter = maxId; 
        }
        
        /** 處理設定初始問題 */
        function handleSetInitialProblem() { 
            const problemText = problemInput.value.trim(); 
            if (!problemText) { alert('請輸入關鍵問題！'); return; } 
            nodeIdCounter = 0; 
            rcaData = createNode(problemText, 'initial-problem', null); 
            trackingData = []; 
            trizMcdaData = initializeTrizMcdaDataObject(); 
            trizMcdaData.problemDescription = problemText; 
            historyStack = []; 
            historyIndex = -1; 
            currentWorkflowStep = 1; 
            pushStateToHistory(rcaData); 
            isFinalizedView = false; 
            finalizeDiagramButton.textContent = '完成圖表'; 
            finalizeDiagramButton.classList.remove('edit-diagram'); 
            finalizeDiagramButton.classList.add('finalize-diagram'); 
            toolButtonsContainer.style.display = 'flex'; 
            applyZoom(1.0, true); 
            navigateToStep(1, true); 
            renderRcaDiagram(); 
            renderCauseEffectTable(); 
            renderSolutionTable(); 
            renderTrackingTable();
            renderTrizMcdaFromData(); 
            renderIdentifiedConflictsList();
            updateButtonStates(); 
        } 
        
        /** 處理切換完成/編輯圖表模式 */
        function handleToggleFinalizeView() { 
            isFinalizedView = !isFinalizedView; 
            if (isFinalizedView) { 
                finalizeDiagramButton.textContent = '編輯圖表'; 
                finalizeDiagramButton.classList.remove('finalize-diagram'); 
                finalizeDiagramButton.classList.add('edit-diagram'); 
            } else { 
                finalizeDiagramButton.textContent = '完成圖表'; 
                finalizeDiagramButton.classList.remove('edit-diagram'); 
                finalizeDiagramButton.classList.add('finalize-diagram'); 
            } 
            renderRcaDiagram(); 
            updateButtonStates(); 
        }

        /**
         * 匯出 RCA 圖表為 SVG 檔案。
         * @param {string} filename - 匯出的檔案名稱。
         */
        function exportSVG(filename = 'RCA_矛盾分析圖.svg') {
            const htmlContainer = document.getElementById('rca-diagram-container');
            const svgLinesContainer = document.getElementById('svg-connector-layer');
            const scalableWrapper = document.getElementById('scalable-content-wrapper'); 

            if (!htmlContainer || !svgLinesContainer || !scalableWrapper) {
                alert('錯誤：匯出 SVG 所需的圖表元素未找到。');
                console.error('Error: Diagram elements for SVG export not found.');
                return;
            }
            if (!rcaData) {
                alert('沒有圖表資料可匯出。');
                return;
            }
            
            showLoadingSpinner();

            // 暫時將縮放重設為 1，以確保正確的尺寸和位置
            const originalTransform = scalableWrapper.style.transform;
            scalableWrapper.style.transform = 'scale(1)';
            void scalableWrapper.offsetHeight; // 強制重繪

            const contentWidth = htmlContainer.scrollWidth;
            const contentHeight = htmlContainer.scrollHeight;

            const newSvg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
            newSvg.setAttribute('xmlns', 'http://www.w3.org/2000/svg');
            newSvg.setAttribute('xmlns:xlink', 'http://www.w3.org/1999/xlink');
            newSvg.setAttribute('width', contentWidth);
            newSvg.setAttribute('height', contentHeight);
            newSvg.setAttribute('viewBox', `0 0 ${contentWidth} ${contentHeight}`);
            
            // 添加白色背景
            const backgroundRect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
            backgroundRect.setAttribute('x', '0');
            backgroundRect.setAttribute('y', '0');
            backgroundRect.setAttribute('width', '100%');
            backgroundRect.setAttribute('height', '100%');
            backgroundRect.setAttribute('fill', '#ffffff');
            newSvg.appendChild(backgroundRect);

            // 嵌入 CSS 樣式
            const defs = document.createElementNS('http://www.w3.org/2000/svg', 'defs');
            const styleTag = document.createElementNS('http://www.w3.org/2000/svg', 'style');
            styleTag.setAttribute('type', 'text/css');
            
            let cssText = `@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');\n`;
            cssText += `@import url('https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css');\n`; 
            
            // 複製所有樣式表規則
            for (const styleSheet of Array.from(document.styleSheets)) {
                try {
                    if (styleSheet.cssRules) {
                        for (const rule of Array.from(styleSheet.cssRules)) {
                            cssText += rule.cssText + "\n";
                        }
                    }
                } catch (e) {
                    console.warn("無法存取樣式表規則:", styleSheet.href, e);
                }
            }
            styleTag.textContent = cssText;
            defs.appendChild(styleTag);
            newSvg.appendChild(defs);

            // 將 HTML 內容嵌入到 foreignObject 中
            const foreignObject = document.createElementNS('http://www.w3.org/2000/svg', 'foreignObject');
            foreignObject.setAttribute('x', '0');
            foreignObject.setAttribute('y', '0');
            foreignObject.setAttribute('width', contentWidth);
            foreignObject.setAttribute('height', contentHeight);

            const clonedHtmlContainer = htmlContainer.cloneNode(true);
            const xhtmlDiv = document.createElementNS('http://www.w3.org/1999/xhtml', 'div');
            xhtmlDiv.setAttribute('style', 'width: 100%; height: 100%;'); 
            xhtmlDiv.appendChild(clonedHtmlContainer);
            foreignObject.appendChild(xhtmlDiv);
            newSvg.appendChild(foreignObject);

            // 複製 SVG 連接線
            const linesGroup = document.createElementNS('http://www.w3.org/2000/svg', 'g');
            linesGroup.setAttribute('id', 'connector-lines-group');
            Array.from(svgLinesContainer.children).forEach(childLine => {
                linesGroup.appendChild(childLine.cloneNode(true));
            });
            newSvg.appendChild(linesGroup);
            
            // 恢復原始縮放
            scalableWrapper.style.transform = originalTransform;

            try {
                const serializer = new XMLSerializer();
                let svgString = serializer.serializeToString(newSvg);
                
                // 確保 SVG 命名空間正確
                if (!svgString.match(/xmlns="http:\/\/www\.w3\.org\/2000\/svg"/)) {
                    svgString = svgString.replace('<svg', '<svg xmlns="http://www.w3.org/2000/svg"');
                }
                 if (!svgString.match(/xmlns:xlink="http:\/\/www\.w3\.org\/1999\/xlink"/)) {
                    svgString = svgString.replace('<svg', '<svg xmlns:xlink="http://www.w3.org/1999/xlink"');
                }

                const blob = new Blob([svgString], { type: 'image/svg+xml;charset=utf-8' });
                const url = URL.createObjectURL(blob);

                const link = document.createElement('a');
                link.href = url;
                link.download = filename;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                alert(`${filename} 已準備下載。`);
            } catch (error) {
                alert(`匯出 SVG 時發生錯誤： ${error.message}`);
                console.error("Error exporting SVG:", error);
            } finally {
                hideLoadingSpinner();
            }
        }

        // --- TRIZ-MCDA 相關函數 ---
        /**
         * 初始化 TRIZ-MCDA 資料物件。
         * @returns {object} 初始化後的 TRIZ-MCDA 資料物件。
         */
        function initializeTrizMcdaDataObject() {
            return {
                problemDescription: rcaData ? rcaData.text : "", 
                identifiedConflicts: [],
                contradictionSourceCauseId: null,
                contradictionSourceCauseText: "",
                contradictionPhenomenon: "",
                improvingParameter: null,
                worseningParameter: null,
                suggestedPrinciples: [], 
                mcdaCriteria: [], 
                mcdaSolutions: [], 
                mcdaBestSolution: null,
                mcdaRecommendation: ""
            };
        }
        
        /**
         * 開啟衝突分析彈出視窗。
         * @param {string} nodeId - 衝突原因節點的 ID。
         */
        function openContradictionToTrizModal(nodeId) {
            const node = findNodeById(rcaData, nodeId);
            if (!node || node.type !== 'cause') return;

            // 收集正面和負面效果文字
            const positiveEffects = node.children.filter(c => c.type === 'positive-effect').map(c => c.text).join('; ');
            const negativeEffects = node.children.filter(c => c.type === 'negative-effect').map(c => c.text).join('; ');

            // 填充彈出視窗內容
            contradictionNodeIdHolder.value = nodeId;
            modalContradictionCauseText.textContent = node.text;
            modalImprovingFeatureText.value = positiveEffects; 
            modalWorseningFeatureText.value = negativeEffects; 
            
            contradictionToTrizModal.style.display = 'flex';
        }
        
        /** 渲染已識別的衝突列表 */
        function renderIdentifiedConflictsList() {
            identifiedConflictsList.innerHTML = '';
            if (trizMcdaData.identifiedConflicts.length === 0) {
                identifiedConflictsList.innerHTML = '<p class="text-gray-500 text-center italic">尚未識別任何衝突點。請在RCA圖中操作。</p>';
                return;
            }
            trizMcdaData.identifiedConflicts.forEach(conflict => {
                const itemDiv = document.createElement('div');
                itemDiv.classList.add('conflict-item');
                itemDiv.innerHTML = `
                    <p><strong>衝突來源原因：</strong> ${conflict.causeText}</p>
                    <p><strong>改善方面 (好處)：</strong> ${conflict.improving}</p>
                    <p><strong>惡化方面 (壞處)：</strong> ${conflict.worsening}</p>
                `;
                const bringToTrizButton = createActionButton('<i class="fas fa-cogs mr-1"></i> 將此衝突帶入TRIZ分析', 'bg-indigo-500 hover:bg-indigo-600 text-xs mt-2', () => {
                    // 將選定的衝突資料填入 TRIZ-MCDA 區塊
                    trizMcdaData.problemDescription = rcaData.text;
                    trizMcdaData.contradictionSourceCauseId = conflict.causeId;
                    trizMcdaData.contradictionSourceCauseText = conflict.causeText;
                    trizMcdaData.contradictionPhenomenon = `當試圖改善「${conflict.improving}」時，卻導致「${conflict.worsening}」惡化。`;
                    
                    // 清空可能已有的TRIZ參數和原理，以便重新開始此衝突的分析
                    trizMcdaData.improvingParameter = null;
                    trizMcdaData.worseningParameter = null;
                    trizMcdaData.suggestedPrinciples = [];
                    trizMcdaData.mcdaSolutions = []; // 清空舊方案，因為衝突源變了

                    renderTrizMcdaFromData(); // 更新TRIZ區塊UI
                    navigateToStep(3, true); // 強制導航到TRIZ步驟
                });
                itemDiv.appendChild(bringToTrizButton);
                identifiedConflictsList.appendChild(itemDiv);
            });
        }

        /** 處理確認衝突分析並記錄 */
        function handleConfirmContradictionToTriz() {
            const causeNodeId = contradictionNodeIdHolder.value;
            const causeNode = findNodeById(rcaData, causeNodeId);
            if (!causeNode) return;
            
            const improvingText = modalImprovingFeatureText.value.trim();
            const worseningText = modalWorseningFeatureText.value.trim();
            
            if (!improvingText || !worseningText) {
                alert("請描述改善方面(好處)與惡化方面(壞處)。");
                return;
            }
            
            // 檢查是否已存在相同的衝突 (基於 causeId)
            const existingConflictIndex = trizMcdaData.identifiedConflicts.findIndex(c => c.causeId === causeNodeId);
            const conflictData = {
                id: existingConflictIndex > -1 ? trizMcdaData.identifiedConflicts[existingConflictIndex].id : `conflict-${Date.now()}`, // 保留舊ID或生成新ID
                causeId: causeNodeId,
                causeText: causeNode.text,
                improving: improvingText,
                worsening: worseningText
            };

            if (existingConflictIndex > -1) {
                trizMcdaData.identifiedConflicts[existingConflictIndex] = conflictData; // 更新現有衝突
            } else {
                trizMcdaData.identifiedConflicts.push(conflictData); // 新增衝突
            }
            
            renderIdentifiedConflictsList(); // 更新衝突列表顯示
            contradictionToTrizModal.style.display = 'none';
            // 提示用戶已記錄，並可以到步驟2查看和操作
            alert(`衝突點「${causeNode.text}」已記錄。\n請至「步驟2：衝突分析」查看列表，並選擇要帶入TRIZ分析的衝突。`);
            navigateToStep(2); // 導航到衝突分析步驟以查看列表
            pushStateToHistory(rcaData);
        }

        /** 填充 TRIZ 參數下拉選單 */
        function populateTrizParameters() {
            const parameters = [
                { id: 1, name: "1. 移動物體的重量" }, { id: 2, name: "2. 固定物體的重量" },
                { id: 3, name: "3. 移動物體的長度" }, { id: 4, name: "4. 固定物體的長度" },
                { id: 5, name: "5. 移動物體的面積" }, { id: 6, name: "6. 固定物體的面積" },
                { id: 7, name: "7. 移動物體的體積" }, { id: 8, name: "8. 固定物體的體積" },
                { id: 9, name: "9. 速度" }, { id: 10, name: "10. 力" },
                { id: 11, name: "11. 應力或壓力" }, { id: 12, name: "12. 形狀" },
                { id: 13, name: "13. 物體組成的穩定性" }, { id: 14, name: "14. 強度" },
                { id: 15, name: "15. 移動物體的作用時間" }, { id: 16, name: "16. 固定物體的作用時間" },
                { id: 17, name: "17. 溫度" }, { id: 18, name: "18. 照明強度" },
                { id: 19, name: "19. 移動物體的能量消耗" }, { id: 20, name: "20. 固定物體的能量消耗" },
                { id: 21, name: "21. 功率" }, { id: 22, name: "22. 能量損失" },
                { id: 23, name: "23. 物質損失" }, { id: 24, name: "24. 資訊損失" },
                { id: 25, name: "25. 時間損失" }, { id: 26, name: "26. 物質數量" },
                { id: 27, name: "27. 可靠性" }, { id: 28, name: "28. 量測精度" },
                { id: 29, name: "29. 製造精度" }, { id: 30, name: "30. 物體相關的有害因素" },
                { id: 31, name: "31. 物體產生的有害因素" }, { id: 32, name: "32. 製造容易度" },
                { id: 33, name: "33. 操作容易度" }, { id: 34, name: "34. 維修容易度" },
                { id: 35, name: "35. 適應性或通用性" }, { id: 36, name: "36. 裝置複雜性" },
                { id: 37, name: "37. 偵測與量測的困難度" }, { id: 38, name: "38. 自動化程度" },
                { id: 39, name: "39. 生產率" }
            ];
            trizImprovingParameterSelect.innerHTML = '<option value="">請選擇改善參數</option>';
            trizWorseningParameterSelect.innerHTML = '<option value="">請選擇惡化參數</option>';

            parameters.forEach(param => {
                TRIZ_PARAMETERS.push(param); 
                const option1 = new Option(param.name, param.id);
                const option2 = new Option(param.name, param.id);
                trizImprovingParameterSelect.add(option1);
                trizWorseningParameterSelect.add(option2);
            });

            // 填充發明原理列表
            INVENTIVE_PRINCIPLES.forEach((name, index) => {
                TRIZ_PRINCIPLES[index + 1] = name;
            });
        }

        /** 初始化 TRIZ 矛盾矩陣 (簡化版) */
        function initializeTrizMatrix() {
            // 這裡只包含幾個示例條目，實際應用中應包含完整的矛盾矩陣數據
            TRIZ_CONTRADICTION_MATRIX[9] = { // 速度
                14: [10, 15, 40, 1], // 強度
                19: [15, 18, 10, 35], // 移動物體的能量消耗
                21: [10, 15, 18, 35]  // 功率
            };
            TRIZ_CONTRADICTION_MATRIX[15] = { // 移動物體的作用時間
                 27: [10, 2, 35, 13] // 可靠性
            };
            TRIZ_CONTRADICTION_MATRIX[33] = { // 操作容易度
                 27: [28, 1, 24, 32] // 可靠性
            };
        }
        
        /** 處理 TRIZ 生成發明原理 */
        function handleTrizGeneratePrinciples() {
            const improvingParamId = parseInt(trizImprovingParameterSelect.value);
            const worseningParamId = parseInt(trizWorseningParameterSelect.value);

            if (!improvingParamId || !worseningParamId) {
                alert("請選擇改善參數和惡化參數。");
                return;
            }
            if (improvingParamId === worseningParamId) {
                alert("改善參數和惡化參數不能相同。");
                return;
            }

            // 根據矛盾矩陣獲取建議原理
            const principlesIds = (TRIZ_CONTRADICTION_MATRIX[improvingParamId] && TRIZ_CONTRADICTION_MATRIX[improvingParamId][worseningParamId]) || [];
            
            trizMcdaData.improvingParameter = improvingParamId;
            trizMcdaData.worseningParameter = worseningParamId;
            const newSuggestedPrinciples = [];
            // 只取前四個建議原理，並保留現有方案概念
            principlesIds.slice(0, 4).forEach(pId => { 
                const existingPrincipleData = trizMcdaData.suggestedPrinciples.find(sp => sp.id === pId);
                newSuggestedPrinciples.push({
                    id: pId,
                    name: TRIZ_PRINCIPLES[pId] || `原理 ${pId}`,
                    concepts: existingPrincipleData ? existingPrincipleData.concepts : [{ text: "", implementationTime: "medium" }] 
                });
            });
            // 將用戶手動添加的非建議原理也保留下來
            trizMcdaData.suggestedPrinciples.forEach(oldSp => {
                if (!newSuggestedPrinciples.some(newSp => newSp.id === oldSp.id)) {
                    if (oldSp.concepts.some(c => c.text.trim() !== "")) { 
                         newSuggestedPrinciples.push(oldSp);
                    }
                }
            });

            trizMcdaData.suggestedPrinciples = newSuggestedPrinciples;
            
            renderTrizPrinciplesOutput(); // 渲染 TRIZ 原理輸出
            updateMcdaSolutionsFromTriz(); // 從 TRIZ 方案更新 MCDA 方案
            pushStateToHistory(rcaData);
        }

        /** 渲染 TRIZ 原理輸出區塊 */
        function renderTrizPrinciplesOutput() {
            trizPrinciplesOutput.innerHTML = '';
            if (trizMcdaData.suggestedPrinciples.length === 0) {
                trizPrinciplesOutput.innerHTML = '<p class="text-gray-500">未找到匹配的發明原理，或此組合無建議原理。請嘗試其他參數組合，或手動新增原理與方案。</p>';
            }

            trizMcdaData.suggestedPrinciples.forEach((principle, pIndex) => {
                const div = document.createElement('div');
                div.classList.add('mb-4', 'p-3', 'border', 'border-gray-200', 'rounded-md', 'bg-white');
                div.innerHTML = `<h5 class="font-semibold text-indigo-700">${principle.name} (原理 #${principle.id})</h5>`;
                
                principle.concepts.forEach((concept, cIndex) => {
                    const conceptDiv = document.createElement('div');
                    conceptDiv.classList.add('triz-solution-concept', 'ml-4', 'mb-3', 'p-2', 'border-l-2', 'border-indigo-100');
                    
                    const label = document.createElement('label');
                    label.textContent = `方案雛形 ${pIndex+1}-${cIndex+1}：`;
                    label.classList.add('block', 'text-sm', 'font-medium', 'text-gray-600', 'mb-1');
                    
                    const textarea = document.createElement('textarea');
                    textarea.classList.add('input-field', 'w-full', 'mb-1');
                    textarea.rows = 2;
                    textarea.placeholder = `基於「${principle.name}」的方案描述...`;
                    textarea.value = concept.text;
                    textarea.dataset.principleId = principle.id; 
                    textarea.dataset.conceptIndex = cIndex;      
                    textarea.oninput = (e) => { 
                        trizMcdaData.suggestedPrinciples[pIndex].concepts[cIndex].text = e.target.value;
                        updateMcdaSolutionsFromTriz(); // 方案內容改變時更新 MCDA 方案
                    };

                    const timeLabel = document.createElement('label');
                    timeLabel.textContent = '預計導入時間：';
                    timeLabel.classList.add('implementation-time-label', 'mr-1');
                    
                    const timeSelect = document.createElement('select');
                    timeSelect.classList.add('input-field', 'small-input', 'implementation-time-select');
                    ['short', 'medium', 'long'].forEach(timeVal => {
                        const option = new Option(timeVal === 'short' ? '短期' : timeVal === 'medium' ? '中期' : '長期', timeVal);
                        timeSelect.add(option);
                    });
                    timeSelect.value = concept.implementationTime || 'medium';
                    timeSelect.onchange = (e) => {
                        trizMcdaData.suggestedPrinciples[pIndex].concepts[cIndex].implementationTime = e.target.value;
                        updateMcdaSolutionsFromTriz(); // 導入時間改變時更新 MCDA 方案
                    };

                    conceptDiv.appendChild(label);
                    conceptDiv.appendChild(textarea);
                    const timeDiv = document.createElement('div');
                    timeDiv.classList.add('mt-1');
                    timeDiv.appendChild(timeLabel);
                    timeDiv.appendChild(timeSelect);
                    conceptDiv.appendChild(timeDiv);

                    div.appendChild(conceptDiv);
                });
                // 添加新方案雛形按鈕
                const addConceptButton = document.createElement('button');
                addConceptButton.innerHTML = '<i class="fas fa-plus-circle mr-1"></i> 新增此原理的方案雛形';
                addConceptButton.classList.add('action-button', 'bg-gray-400', 'hover:bg-gray-500', 'text-xs', 'py-1', 'px-2', 'rounded', 'mt-1', 'ml-4');
                addConceptButton.onclick = () => {
                    trizMcdaData.suggestedPrinciples[pIndex].concepts.push({ text: "", implementationTime: "medium" });
                    renderTrizPrinciplesOutput(); // 重新渲染以顯示新方案
                    updateMcdaSolutionsFromTriz();
                };
                div.appendChild(addConceptButton);
                trizPrinciplesOutput.appendChild(div);
            });
        }
        
        /** 從 TRIZ 方案更新 MCDA 方案列表 */
        function updateMcdaSolutionsFromTriz() {
            const newMcdaSolutions = [];
            trizMcdaData.suggestedPrinciples.forEach(principle => {
                principle.concepts.forEach((concept, conceptIndex) => {
                    if (concept.text.trim() !== "") { // 只添加有內容的方案
                        const solutionId = `${principle.id}-${conceptIndex}`; 
                        const existingSolution = trizMcdaData.mcdaSolutions.find(s => s.id === solutionId);
                        newMcdaSolutions.push({
                            id: solutionId,
                            principleId: principle.id,
                            principleName: principle.name,
                            conceptIndex: conceptIndex,
                            conceptText: concept.text,
                            implementationTime: concept.implementationTime || 'medium',
                            scores: existingSolution ? existingSolution.scores : {}, // 保留現有評分
                            weightedScore: existingSolution ? existingSolution.weightedScore : 0 // 保留現有加權分數
                        });
                    }
                });
            });
            trizMcdaData.mcdaSolutions = newMcdaSolutions;
            renderMcdaEvaluationTableHeaders(); // 更新 MCDA 評估表頭
            renderMcdaSolutionsForEvaluation(); // 更新 MCDA 評估方案
            updateButtonStates(); 
        }

        /** 處理 MCDA 新增評估標準 */
        function handleMcdaAddCriterion() {
            const criterionId = `crit-${Date.now()}`;
            trizMcdaData.mcdaCriteria.push({ id: criterionId, name: "", weight: 0, categoryHint: "" });
            renderMcdaCriteriaInputs(); // 渲染評估標準輸入
            renderMcdaEvaluationTableHeaders(); // 更新評估表頭
            pushStateToHistory(rcaData);
        }

        /** 渲染 MCDA 評估標準輸入區塊 */
        function renderMcdaCriteriaInputs() {
            mcdaCriteriaInputArea.innerHTML = '';
            trizMcdaData.mcdaCriteria.forEach((criterion, index) => {
                const div = document.createElement('div');
                div.classList.add('flex', 'flex-col', 'sm:flex-row', 'items-start', 'sm:items-center', 'gap-2', 'mb-3', 'p-2', 'border', 'border-gray-200', 'rounded-md');
                
                const inputWrapper = document.createElement('div');
                inputWrapper.classList.add('flex-grow', 'w-full', 'sm:w-auto');

                const nameInput = document.createElement('input');
                nameInput.type = 'text';
                nameInput.value = criterion.name;
                nameInput.placeholder = `標準 ${index + 1} 名稱 (例如：解決問題程度、成本效益、導入時間)`;
                nameInput.classList.add('input-field', 'w-full');
                nameInput.onchange = (e) => {
                    criterion.name = e.target.value;
                    renderMcdaEvaluationTableHeaders(); // 標準名稱改變時更新表頭
                    pushStateToHistory(rcaData);
                };
                inputWrapper.appendChild(nameInput);
                
                const guidanceText = document.createElement('p');
                guidanceText.classList.add('criterion-category-guidance', 'text-xs', 'text-gray-500', 'mt-1');
                guidanceText.textContent = '提示：問題特定(如ISQ)、TRIZ理想性、一般性(成本/時間)';
                inputWrapper.appendChild(guidanceText);

                const weightInput = document.createElement('input');
                weightInput.type = 'number';
                weightInput.value = criterion.weight;
                weightInput.min = 0;
                weightInput.max = 100;
                weightInput.placeholder = '權重 %';
                weightInput.classList.add('input-field', 'w-24', 'text-right', 'mt-2', 'sm:mt-0');
                weightInput.onchange = (e) => {
                    criterion.weight = parseInt(e.target.value) || 0;
                    pushStateToHistory(rcaData);
                };

                const removeButton = document.createElement('button');
                removeButton.innerHTML = '<i class="fas fa-times text-red-500"></i>';
                removeButton.classList.add('p-1', 'hover:bg-red-100', 'rounded', 'mt-2', 'sm:mt-0', 'self-start', 'sm:self-center');
                removeButton.title = "移除此標準";
                removeButton.onclick = () => {
                    trizMcdaData.mcdaCriteria.splice(index, 1);
                    renderMcdaCriteriaInputs();
                    renderMcdaEvaluationTableHeaders(); 
                    renderMcdaSolutionsForEvaluation(); 
                    pushStateToHistory(rcaData);
                };

                div.appendChild(inputWrapper);
                div.appendChild(weightInput);
                div.appendChild(removeButton);
                mcdaCriteriaInputArea.appendChild(div);
            });
        }
        
        /** 計算並顯示 MCDA 總權重 */
        function calculateAndDisplayTotalWeight() {
            const totalWeight = trizMcdaData.mcdaCriteria.reduce((sum, crit) => sum + (crit.weight || 0), 0);
            mcdaTotalWeightDisplay.textContent = `目前總權重: ${totalWeight}%`;
            if (totalWeight !== 100 && trizMcdaData.mcdaCriteria.length > 0) {
                mcdaTotalWeightDisplay.classList.add('text-red-500', 'font-semibold');
                mcdaTotalWeightDisplay.classList.remove('text-green-500');
                 alert(`提醒：目前評估標準的總權重為 ${totalWeight}%，建議調整至 100%。`);
            } else if (totalWeight === 100) {
                 mcdaTotalWeightDisplay.classList.remove('text-red-500', 'font-semibold');
                 mcdaTotalWeightDisplay.classList.add('text-green-500', 'font-semibold');
            } else {
                mcdaTotalWeightDisplay.classList.remove('text-red-500', 'text-green-500', 'font-semibold');
            }
        }

        /** 渲染 MCDA 評估表頭 */
        function renderMcdaEvaluationTableHeaders() {
            const tableHead = mcdaEvaluationTable.querySelector('thead');
            if (!tableHead) return;
            tableHead.innerHTML = ''; 
            const headerRow = tableHead.insertRow();
            
            let th = document.createElement('th');
            th.textContent = '方案雛形';
            th.style.width = '25%';
            headerRow.appendChild(th);

            th = document.createElement('th'); 
            th.textContent = '導入時間';
            th.style.width = '10%';
            headerRow.appendChild(th);

            trizMcdaData.mcdaCriteria.forEach(criterion => {
                th = document.createElement('th');
                th.textContent = `${criterion.name || '未命名標準'} (${criterion.weight || 0}%)`;
                headerRow.appendChild(th);
            });

            th = document.createElement('th');
            th.textContent = '加權總分';
            th.style.width = '10%';
            headerRow.appendChild(th);
        }
        
        /** 渲染 MCDA 方案供評估 */
        function renderMcdaSolutionsForEvaluation() {
            const tableBody = mcdaEvaluationTable.querySelector('tbody');
            if (!tableBody) return;
            tableBody.innerHTML = ''; 

            if (trizMcdaData.mcdaSolutions.length === 0) {
                const colSpan = trizMcdaData.mcdaCriteria.length + 3; 
                const row = tableBody.insertRow();
                const cell = row.insertCell();
                cell.colSpan = colSpan; 
                cell.textContent = "請先在階段二生成方案雛形，並在上方設定評估標準。";
                cell.classList.add("text-center", "text-gray-500", "py-4");
                return;
            }

            trizMcdaData.mcdaSolutions.forEach(solution => {
                const row = tableBody.insertRow();
                let cell = row.insertCell();
                cell.textContent = `${solution.principleName} - 方案 ${solution.conceptIndex + 1}: ${solution.conceptText.substring(0,30)}${solution.conceptText.length > 30 ? '...' : ''}`;
                cell.title = solution.conceptText;

                cell = row.insertCell();
                cell.textContent = solution.implementationTime === 'short' ? '短期' : solution.implementationTime === 'medium' ? '中期' : '長期';

                trizMcdaData.mcdaCriteria.forEach(criterion => {
                    cell = row.insertCell();
                    const scoreInput = document.createElement('input');
                    scoreInput.type = 'number';
                    scoreInput.classList.add('input-field', 'w-16', 'text-center', 'small-input');
                    scoreInput.value = solution.scores[criterion.id] || '';
                    scoreInput.placeholder = "1-10";
                    scoreInput.onchange = (e) => {
                        solution.scores[criterion.id] = parseFloat(e.target.value) || 0;
                        pushStateToHistory(rcaData); 
                    };
                    cell.appendChild(scoreInput);
                });
                
                cell = row.insertCell();
                cell.textContent = solution.weightedScore ? solution.weightedScore.toFixed(2) : '0.00'; 
                cell.id = `score-${solution.id}`; 
                cell.classList.add('font-semibold');
            });
        }

        /** 處理 MCDA 計算分數 */
        function handleMcdaCalculateScores() {
            const totalWeight = trizMcdaData.mcdaCriteria.reduce((sum, crit) => sum + (crit.weight || 0), 0);
            if (totalWeight !== 100 && trizMcdaData.mcdaCriteria.length > 0) {
                if (!confirm(`警告：評估標準的總權重為 ${totalWeight}%，並非 100%。計算結果可能不符合預期。\n\n是否仍要繼續計算？`)) {
                    return;
                }
            }
            if (trizMcdaData.mcdaSolutions.length === 0) {
                alert("請先定義方案雛形並設定評估標準。");
                return;
            }

            trizMcdaData.mcdaSolutions.forEach(solution => {
                solution.weightedScore = 0;
                trizMcdaData.mcdaCriteria.forEach(criterion => {
                    const score = solution.scores[criterion.id] || 0;
                    solution.weightedScore += score * (criterion.weight / 100);
                });
                const scoreCell = document.getElementById(`score-${solution.id}`);
                if (scoreCell) {
                    scoreCell.textContent = solution.weightedScore.toFixed(2);
                }
            });

            // 排序並找出最佳方案
            if (trizMcdaData.mcdaSolutions.length > 0) {
                trizMcdaData.mcdaSolutions.sort((a, b) => b.weightedScore - a.weightedScore); 
                trizMcdaData.mcdaBestSolution = trizMcdaData.mcdaSolutions[0];
                mcdaBestSolutionText.innerHTML = `最佳方案推薦：<strong>${trizMcdaData.mcdaBestSolution.principleName} - 方案 ${trizMcdaData.mcdaBestSolution.conceptIndex + 1}</strong> (${trizMcdaData.mcdaBestSolution.conceptText.substring(0,30)}...)，總分：<strong>${trizMcdaData.mcdaBestSolution.weightedScore.toFixed(2)}</strong>`;
                
                mcdaRecommendationReasonText.value = trizMcdaData.mcdaRecommendation || "";  
                mcdaResultOutput.style.display = 'block';
            } else {
                 mcdaBestSolutionText.textContent = `沒有可評估的方案。`;
                 mcdaRecommendationReasonText.value = "";
                 mcdaResultOutput.style.display = 'block';
            }
            pushStateToHistory(rcaData);
            updateButtonStates(); 
        }
        
        /** 儲存 TRIZ-MCDA 分析進度 */
        function saveTrizMcdaProgress() {
            trizMcdaData.problemDescription = trizProblemDescriptionInput.value;
            trizMcdaData.contradictionPhenomenon = trizContradictionPhenomenonInput.value;
            trizMcdaData.improvingParameter = parseInt(trizImprovingParameterSelect.value) || null;
            trizMcdaData.worseningParameter = parseInt(trizWorseningParameterSelect.value) || null;
            trizMcdaData.mcdaRecommendation = mcdaRecommendationReasonText.value; 
            
            handleSaveToLocalStorage(); // 呼叫通用儲存函數
            alert("TRIZ-MCDA 分析進度已儲存。");
        }

        /** 從本地儲存載入 TRIZ-MCDA 資料 */
        function loadTrizMcdaDataFromLocalStorage() { 
            const savedDataString = localStorage.getItem('rcaPlusData');
            if (savedDataString) {
                const parsedJson = JSON.parse(savedDataString);
                if (parsedJson && parsedJson.trizMcdaData) {
                    trizMcdaData = { ...initializeTrizMcdaDataObject(), ...parsedJson.trizMcdaData }; 
                    if (!trizMcdaData.identifiedConflicts) trizMcdaData.identifiedConflicts = []; // 向下相容
                    if (rcaData && rcaData.text && !trizMcdaData.problemDescription) trizMcdaData.problemDescription = rcaData.text; 
                    renderTrizMcdaFromData();
                } else { 
                     if (rcaData && rcaData.text) trizMcdaData.problemDescription = rcaData.text;
                     renderTrizMcdaFromData(); 
                }
            } else { 
                if (rcaData && rcaData.text) trizMcdaData.problemDescription = rcaData.text;
                renderTrizMcdaFromData();
            }
        }
        
        /** 根據 trizMcdaData 渲染 TRIZ-MCDA 區塊的 UI */
        function renderTrizMcdaFromData() {
            trizProblemDescriptionInput.value = trizMcdaData.problemDescription || (rcaData ? rcaData.text : "");
            trizContradictionSourceCauseInput.value = trizMcdaData.contradictionSourceCauseText || "";
            trizContradictionPhenomenonInput.value = trizMcdaData.contradictionPhenomenon || "";
            
            if (trizMcdaData.improvingParameter) trizImprovingParameterSelect.value = trizMcdaData.improvingParameter;
            else trizImprovingParameterSelect.value = "";
            if (trizMcdaData.worseningParameter) trizWorseningParameterSelect.value = trizMcdaData.worseningParameter;
            else trizWorseningParameterSelect.value = "";
            
            renderTrizPrinciplesOutput(); 
            renderMcdaCriteriaInputs(); 
            renderMcdaEvaluationTableHeaders();
            renderMcdaSolutionsForEvaluation(); 

            if (trizMcdaData.mcdaBestSolution && trizMcdaData.mcdaSolutions.length > 0 && trizMcdaData.mcdaSolutions.find(s => s.id === trizMcdaData.mcdaBestSolution.id)) { 
                mcdaBestSolutionText.innerHTML = `最佳方案推薦：<strong>${trizMcdaData.mcdaBestSolution.principleName} - 方案 ${trizMcdaData.mcdaBestSolution.conceptIndex + 1}</strong> (${trizMcdaData.mcdaBestSolution.conceptText.substring(0,30)}...)，總分：<strong>${trizMcdaData.mcdaBestSolution.weightedScore.toFixed(2)}</strong>`;
                mcdaRecommendationReasonText.value = trizMcdaData.mcdaRecommendation || ""; 
                mcdaResultOutput.style.display = 'block';
            } else {
                mcdaResultOutput.style.display = 'none';
                mcdaBestSolutionText.textContent = "";
                mcdaRecommendationReasonText.value = "";
            }
            calculateAndDisplayTotalWeight(); 
            updateButtonStates();
        }

        /** 渲染創意景觀圖 */
        function renderIdeasLandscapeChart() {
            ideasLandscapeChartContainer.innerHTML = ''; 
            if (trizMcdaData.mcdaSolutions.length === 0) {
                ideasLandscapeChartContainer.innerHTML = '<p class="text-center text-gray-500 p-4">沒有方案可供繪製景觀圖。請先完成MCDA評估。</p>';
                return;
            }

            const solutions = trizMcdaData.mcdaSolutions.filter(s => typeof s.weightedScore === 'number');
            if (solutions.length === 0) {
                 ideasLandscapeChartContainer.innerHTML = '<p class="text-center text-gray-500 p-4">方案尚未評分，無法繪製景觀圖。</p>';
                return;
            }

            const timeMapping = { 'short': 1, 'medium': 2, 'long': 3 };
            const timeLabels = { 1: '短期', 2: '中期', 3: '長期' };

            const dataPoints = solutions.map(s => ({
                x: timeMapping[s.implementationTime] || 2, 
                y: s.weightedScore,
                name: `${s.principleName} - ${s.conceptIndex + 1}`
            }));

            const margin = { top: 20, right: 30, bottom: 50, left: 50 };
            const svgWidth = ideasLandscapeChartContainer.clientWidth;
            const svgHeight = 400; 
            const chartWidth = svgWidth - margin.left - margin.right;
            const chartHeight = svgHeight - margin.top - margin.bottom;

            const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
            svg.setAttribute('width', svgWidth);
            svg.setAttribute('height', svgHeight);
            svg.setAttribute('viewBox', `0 0 ${svgWidth} ${svgHeight}`);

            const chartGroup = document.createElementNS('http://www.w3.org/2000/svg', 'g');
            chartGroup.setAttribute('transform', `translate(${margin.left},${margin.top})`);
            svg.appendChild(chartGroup);

            // X 軸 (導入時間)
            const xScale = { domain: [0.5, 3.5], range: [0, chartWidth] }; 
            const xAxisGroup = document.createElementNS('http://www.w3.org/2000/svg', 'g');
            xAxisGroup.setAttribute('transform', `translate(0,${chartHeight})`);
            chartGroup.appendChild(xAxisGroup);

            const xAxisLine = document.createElementNS('http://www.w3.org/2000/svg', 'line');
            xAxisLine.setAttribute('x1', 0);
            xAxisLine.setAttribute('y1', 0);
            xAxisLine.setAttribute('x2', chartWidth);
            xAxisLine.setAttribute('y2', 0);
            xAxisLine.setAttribute('stroke', '#333');
            xAxisGroup.appendChild(xAxisLine);

            [1, 2, 3].forEach(val => {
                const xPos = ((val - xScale.domain[0]) / (xScale.domain[1] - xScale.domain[0])) * xScale.range[1];
                const tick = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                tick.setAttribute('x1', xPos);
                tick.setAttribute('y1', 0);
                tick.setAttribute('x2', xPos);
                tick.setAttribute('y2', 5);
                tick.setAttribute('stroke', '#333');
                xAxisGroup.appendChild(tick);
                const label = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                label.setAttribute('x', xPos);
                label.setAttribute('y', 20);
                label.setAttribute('text-anchor', 'middle');
                label.setAttribute('font-size', '10px');
                label.textContent = timeLabels[val];
                xAxisGroup.appendChild(label);
            });
            const xAxisTitle = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            xAxisTitle.setAttribute('x', chartWidth / 2);
            xAxisTitle.setAttribute('y', 35);
            xAxisTitle.setAttribute('text-anchor', 'middle');
            xAxisTitle.setAttribute('font-size', '12px');
            xAxisTitle.setAttribute('font-weight', 'bold');
            xAxisTitle.textContent = '導入所需時間';
            xAxisGroup.appendChild(xAxisTitle);

            // Y 軸 (MCDA 總分)
            const yScores = dataPoints.map(p => p.y);
            const yMin = Math.min(0, ...yScores) -1; 
            const yMax = Math.max(10, ...yScores) +1; 
            const yScale = { domain: [yMin, yMax], range: [chartHeight, 0] }; 

            const yAxisGroup = document.createElementNS('http://www.w3.org/2000/svg', 'g');
            chartGroup.appendChild(yAxisGroup);
            const yAxisLine = document.createElementNS('http://www.w3.org/2000/svg', 'line');
            yAxisLine.setAttribute('x1', 0);
            yAxisLine.setAttribute('y1', 0);
            yAxisLine.setAttribute('x2', 0);
            yAxisLine.setAttribute('y2', chartHeight);
            yAxisLine.setAttribute('stroke', '#333');
            yAxisGroup.appendChild(yAxisLine);
            
            const numYTicks = 5;
            for (let i = 0; i <= numYTicks; i++) {
                const val = yMin + (i / numYTicks) * (yMax - yMin);
                const yPos = ((val - yScale.domain[0]) / (yScale.domain[1] - yScale.domain[0])) * (yScale.range[1] - yScale.range[0]) + yScale.range[0];
                const tick = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                tick.setAttribute('x1', -5);
                tick.setAttribute('y1', yPos);
                tick.setAttribute('x2', 0);
                tick.setAttribute('y2', yPos);
                tick.setAttribute('stroke', '#333');
                yAxisGroup.appendChild(tick);
                const label = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                label.setAttribute('x', -10);
                label.setAttribute('y', yPos + 3); 
                label.setAttribute('text-anchor', 'end');
                label.setAttribute('font-size', '10px');
                label.textContent = val.toFixed(1);
                yAxisGroup.appendChild(label);
            }
             const yAxisTitle = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            yAxisTitle.setAttribute('transform', `translate(-35, ${chartHeight/2}) rotate(-90)`);
            yAxisTitle.setAttribute('text-anchor', 'middle');
            yAxisTitle.setAttribute('font-size', '12px');
            yAxisTitle.setAttribute('font-weight', 'bold');
            yAxisTitle.textContent = 'MCDA 總分';
            yAxisGroup.appendChild(yAxisTitle);

            // 繪製象限線
            const midXVal = 2; // 短期/中期/長期 的中間點
            const midYVal = (yMax + yMin) / 2; // MCDA 總分的中間點
            const midXPos = ((midXVal - xScale.domain[0]) / (xScale.domain[1] - xScale.domain[0])) * xScale.range[1];
            const midYPos = ((midYVal - yScale.domain[0]) / (yScale.domain[1] - yScale.domain[0])) * (yScale.range[1] - yScale.range[0]) + yScale.range[0];

            const verticalQuadrantLine = document.createElementNS('http://www.w3.org/2000/svg', 'line');
            verticalQuadrantLine.setAttribute('x1', midXPos);
            verticalQuadrantLine.setAttribute('y1', 0);
            verticalQuadrantLine.setAttribute('x2', midXPos);
            verticalQuadrantLine.setAttribute('y2', chartHeight);
            verticalQuadrantLine.setAttribute('stroke', '#cccccc');
            verticalQuadrantLine.setAttribute('stroke-dasharray', '4 2');
            chartGroup.appendChild(verticalQuadrantLine);

            const horizontalQuadrantLine = document.createElementNS('http://www.w3.org/2000/svg', 'line');
            horizontalQuadrantLine.setAttribute('x1', 0);
            horizontalQuadrantLine.setAttribute('y1', midYPos);
            horizontalQuadrantLine.setAttribute('x2', chartWidth);
            horizontalQuadrantLine.setAttribute('y2', midYPos);
            horizontalQuadrantLine.setAttribute('stroke', '#cccccc');
            horizontalQuadrantLine.setAttribute('stroke-dasharray', '4 2');
            chartGroup.appendChild(horizontalQuadrantLine);

            // 繪製數據點
            dataPoints.forEach(point => {
                const cx = ((point.x - xScale.domain[0]) / (xScale.domain[1] - xScale.domain[0])) * xScale.range[1];
                const cy = ((point.y - yScale.domain[0]) / (yScale.domain[1] - yScale.domain[0])) * (yScale.range[1] - yScale.range[0]) + yScale.range[0];

                const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                circle.setAttribute('cx', cx);
                circle.setAttribute('cy', cy);
                circle.setAttribute('r', 5);
                circle.setAttribute('fill', '#3b82f6'); 
                circle.setAttribute('stroke', '#2563eb');
                circle.setAttribute('stroke-width', 1);
                
                const title = document.createElementNS('http://www.w3.org/2000/svg', 'title');
                title.textContent = `${point.name}\n時間: ${timeLabels[point.x]}\n總分: ${point.y.toFixed(2)}`;
                circle.appendChild(title);
                chartGroup.appendChild(circle);

                const textLabel = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                textLabel.setAttribute('x', cx + 7);
                textLabel.setAttribute('y', cy + 3);
                textLabel.setAttribute('font-size', '9px');
                textLabel.textContent = point.name.substring(0,15) + (point.name.length > 15 ? "..." : "");
                chartGroup.appendChild(textLabel);
            });

            ideasLandscapeChartContainer.appendChild(svg);
        }

        /** 顯示原因效果表 */
        function handleShowCauseEffectTable() {
            navigateToStep(5); 
            causeEffectTableSection.style.display = 'block'; 
            solutionTableSection.style.display = 'none'; 
            trackingTableSection.style.display = 'none';
        }
        /** 顯示改善方案表 */
        function handleShowSolutionTable() {
            navigateToStep(5);
            solutionTableSection.style.display = 'block';
            causeEffectTableSection.style.display = 'none'; 
            trackingTableSection.style.display = 'none';
        }
        /** 顯示改善追蹤表 */
        function handleShowTrackingTable() { 
            navigateToStep(5);
            trackingTableSection.style.display = 'block';
            causeEffectTableSection.style.display = 'none'; 
            solutionTableSection.style.display = 'none';
        }
        /** 隱藏所有表格 */
        function handleHideAllTables() { 
            if (currentWorkflowStep === 5) {
                 causeEffectTableSection.style.display = 'none';
                 solutionTableSection.style.display = 'none';
                 trackingTableSection.style.display = 'none';
            }
            updateButtonStates();
        }
        
        /**
         * 創建一個新的 RCA 節點資料物件。
         * @param {string} text - 節點文字內容。
         * @param {string} type - 節點類型 (e.g., 'initial-problem', 'cause', 'positive-effect', 'negative-effect')。
         * @param {string|null} parentId - 父節點的 ID，如果沒有則為 null。
         * @param {boolean} [isNonChangeable=false] - 是否為不可變原因。
         * @returns {object} 新的節點資料物件。
         */
        function createNode(text, type, parentId, isNonChangeable = false) { 
            nodeIdCounter++; 
            const node = { 
                id: `node-${nodeIdCounter}`, 
                text: text, 
                type: type, 
                parentId: parentId, 
                children: [], 
                andSourceNodeIds: [], 
                effectParameters: [], 
                inventivePrinciples: [] 
            }; 
            if (type === 'cause') node.isNonChangeable = isNonChangeable; 
            return node; 
        }
        
        /** 渲染 RCA 圖表 */
        function renderRcaDiagram() { 
            diagramContainer.innerHTML = ''; 
            if (rcaData) { 
                diagramContainer.appendChild(createNodeElement(rcaData)); 
            } 
            requestAnimationFrame(() => drawAllSvgConnectors()); 
        }

        /**
         * 創建 RCA 節點的 DOM 元素。
         * @param {object} nodeData - 節點資料物件。
         * @returns {HTMLElement} 節點的 DOM 元素。
         */
        function createNodeElement(nodeData) { 
            const nodeWrapper = document.createElement('div'); 
            nodeWrapper.classList.add('rca-node-wrapper'); 
            const nodeDiv = document.createElement('div'); 
            nodeDiv.classList.add('rca-node', `rca-node-${nodeData.type}`); 
            nodeDiv.id = nodeData.id; 
            nodeDiv.dataset.nodeId = nodeData.id; 
            
            const contentDiv = document.createElement('div'); 
            contentDiv.classList.add('rca-node-content'); 
            
            const headerDiv = document.createElement('div'); 
            headerDiv.classList.add('rca-node-header'); 
            
            const textSpan = document.createElement('span'); 
            textSpan.classList.add('rca-node-text'); 
            textSpan.textContent = nodeData.text; 
            headerDiv.appendChild(textSpan); 

            // 顯示 NC 標記
            if (nodeData.type === 'cause' && nodeData.isNonChangeable) { 
                const ncBadge = document.createElement('span'); 
                ncBadge.classList.add('nc-badge'); 
                ncBadge.textContent = 'NC'; 
                headerDiv.appendChild(ncBadge); 
            } 
            
            // 顯示節點圖標
            const iconSpan = document.createElement('span'); 
            iconSpan.classList.add('rca-node-icon'); 
            let iconShouldBeDisplayed = true;
            let isContradictory = false;

            if (nodeData.type === 'initial-problem') iconSpan.innerHTML = '<i class="fas fa-exclamation-triangle"></i>'; 
            else if (nodeData.type === 'cause') { 
                const { hasPositiveChild, hasNegativeChild } = checkChildrenEffects(nodeData); 
                if (hasPositiveChild && hasNegativeChild) { 
                    iconSpan.innerHTML = '<i class="fas fa-exchange-alt"></i>'; 
                    iconSpan.classList.add('contradictory'); 
                    isContradictory = true;
                } else { 
                    iconShouldBeDisplayed = false; 
                } 
            } else if (nodeData.type === 'positive-effect') iconSpan.innerHTML = '<i class="fas fa-plus-circle text-green-500"></i>'; 
            else if (nodeData.type === 'negative-effect') iconSpan.innerHTML = '<i class="fas fa-minus-circle text-red-500"></i>'; 
            else { 
                iconShouldBeDisplayed = false; 
            } 

            if (iconShouldBeDisplayed) {
                iconSpan.style.display = 'flex';
                headerDiv.appendChild(iconSpan); 
            }
            
            contentDiv.appendChild(headerDiv); 

            // 顯示效果參數
            if (nodeData.effectParameters && nodeData.effectParameters.length > 0) { 
                const paramsDiv = document.createElement('div'); 
                paramsDiv.classList.add('selected-items-list'); 
                paramsDiv.innerHTML = `<strong>效果參數:</strong> <ul>${nodeData.effectParameters.map(p => `<li>${p}</li>`).join('')}</ul>`; 
                contentDiv.appendChild(paramsDiv); 
            } 
            // 顯示發明原理
            if (nodeData.inventivePrinciples && nodeData.inventivePrinciples.length > 0) { 
                const principlesDiv = document.createElement('div'); 
                principlesDiv.classList.add('selected-items-list'); 
                let principlesHtml = '<strong>發明原理:</strong> <ul>'; 
                nodeData.inventivePrinciples.forEach(ip => { 
                    principlesHtml += `<li>${ip.name}${ip.solution ? `<span class="solution-text">- ${ip.solution.substring(0, 20)}${ip.solution.length > 20 ? '...' : ''}</span>` : ''}</li>`; 
                }); 
                principlesHtml += '</ul>'; 
                principlesDiv.innerHTML = principlesHtml; 
                contentDiv.appendChild(principlesDiv); 
            } 
            
            // 如果不是完成圖表模式，則顯示動作按鈕
            if (!isFinalizedView) { 
                const actionsDiv = document.createElement('div'); 
                actionsDiv.classList.add('rca-node-actions'); 
                actionsDiv.appendChild(createActionButton('修訂此項', 'edit-node', () => promptEditNode(nodeData.id, contentDiv))); 
                if (nodeData.type === 'initial-problem') { 
                    actionsDiv.appendChild(createActionButton('新增原因', 'add-cause', () => promptAddNode(nodeData.id, contentDiv, 'cause', '導致此問題的直接原因是？'))); 
                } else if (nodeData.type === 'cause') { 
                    actionsDiv.appendChild(createActionButton('新增子原因', 'add-cause', () => promptAddNode(nodeData.id, contentDiv, 'cause', '導致此原因的更深層原因是？'))); 
                    actionsDiv.appendChild(createActionButton('(+) 正面效果', 'add-positive', () => promptAddNode(nodeData.id, contentDiv, 'positive-effect', '此原因帶來的正面效果/好處是？'))); 
                    actionsDiv.appendChild(createActionButton('(-) 負面效果', 'add-negative', () => promptAddNode(nodeData.id, contentDiv, 'negative-effect', '此原因導致的負面效果/壞處是？'))); 
                    const ncButtonText = nodeData.isNonChangeable ? '取消NC標記' : '設為NC'; 
                    actionsDiv.appendChild(createActionButton(ncButtonText, 'toggle-nc', () => toggleNonChangeable(nodeData.id))); 
                    
                    if (isContradictory) { 
                        const analyzeButton = createActionButton('<i class="fas fa-magic mr-1"></i>分析此矛盾', 'analyze-contradiction', () => openContradictionToTrizModal(nodeData.id));
                        analyzeButton.title = "識別此矛盾點並記錄";
                        actionsDiv.appendChild(analyzeButton);
                    } else { 
                         actionsDiv.appendChild(createActionButton('選擇發明原理', 'set-principles', () => openInventivePrincipleModal(nodeData.id, isContradictory)));
                    }

                    if (nodeData.parentId) { 
                        actionsDiv.appendChild(createActionButton('移除此原因', 'remove-button', () => removeNode(nodeData.id))); 
                    } 
                } else if (nodeData.type === 'positive-effect' || nodeData.type === 'negative-effect') { 
                    actionsDiv.appendChild(createActionButton('(+) 新增正面子效果', 'add-positive', () => promptAddNode(nodeData.id, contentDiv, 'positive-effect', '輸入正面子效果描述'))); 
                    actionsDiv.appendChild(createActionButton('(-) 新增負面子效果', 'add-negative', () => promptAddNode(nodeData.id, contentDiv, 'negative-effect', '輸入負面子效果描述'))); 
                    actionsDiv.appendChild(createActionButton('設定效果參數', 'set-parameters', () => openEffectParameterModal(nodeData.id))); 
                    actionsDiv.appendChild(createActionButton('設定AND輸入源', 'set-and-sources', () => openAndSourceModal(nodeData.id))); 
                    actionsDiv.appendChild(createActionButton('移除效果', 'remove-button', () => removeNode(nodeData.id))); 
                } 
                contentDiv.appendChild(actionsDiv); 
                const inputContainer = document.createElement('div'); 
                inputContainer.classList.add('input-group-container'); 
                contentDiv.appendChild(inputContainer); 
            } 
            nodeDiv.appendChild(contentDiv); 
            nodeWrapper.appendChild(nodeDiv); 
            // 遞迴渲染子節點
            if (nodeData.children && nodeData.children.length > 0) { 
                const childrenContainer = document.createElement('div'); 
                childrenContainer.classList.add('rca-children-container'); 
                nodeData.children.forEach(childNode => childrenContainer.appendChild(createNodeElement(childNode))); 
                nodeWrapper.appendChild(childrenContainer); 
            } 
            return nodeWrapper; 
        }
        
        /**
         * 提示用戶編輯節點內容。
         * @param {string} nodeId - 要編輯的節點 ID。
         * @param {HTMLElement} parentNodeContentDiv - 父節點的內容 DOM 元素。
         */
        function promptEditNode(nodeId, parentNodeContentDiv) { 
            if (isFinalizedView) return; 
            const nodeToEdit = findNodeById(rcaData, nodeId); 
            if (!nodeToEdit) return; 
            const inputContainer = parentNodeContentDiv.querySelector('.input-group-container'); 
            if (!inputContainer) { console.error("找不到節點的輸入容器:", nodeId); return; } 
            
            // 移除所有現有的輸入組件，確保只顯示一個
            document.querySelectorAll('.input-group').forEach(ig => ig.remove()); 
            inputContainer.innerHTML = ''; 

            const inputGroup = document.createElement('div'); 
            inputGroup.classList.add('input-group'); 
            const nodeInput = document.createElement('input'); 
            nodeInput.type = 'text'; 
            nodeInput.value = nodeToEdit.text; 
            nodeInput.classList.add('input-field'); 
            
            const saveEditButton = document.createElement('button'); 
            saveEditButton.textContent = '儲存修訂'; 
            saveEditButton.classList.add('action-button', 'save-edit-button', 'w-full', 'mt-2'); 
            saveEditButton.onclick = () => { 
                const newText = nodeInput.value.trim(); 
                if (newText) { 
                    nodeToEdit.text = newText; 
                    if (nodeToEdit.type === 'initial-problem') {
                        trizMcdaData.problemDescription = newText;
                        renderTrizMcdaFromData(); 
                    }
                    pushStateToHistory(rcaData); 
                    renderRcaDiagram(); 
                    renderCauseEffectTable(); 
                    renderSolutionTable(); 
                    inputContainer.innerHTML = ''; 
                } else { alert('描述不能為空！'); } 
            }; 
            nodeInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') saveEditButton.click(); }); 
            
            const cancelEditButton = document.createElement('button'); 
            cancelEditButton.textContent = '取消修訂'; 
            cancelButton.classList.add('action-button', 'bg-gray-400', 'hover:bg-gray-500', 'w-full', 'mt-1'); 
            cancelEditButton.onclick = () => { inputContainer.innerHTML = ''; }; 
            
            inputGroup.appendChild(nodeInput); 
            inputGroup.appendChild(saveEditButton); 
            inputGroup.appendChild(cancelEditButton); 
            inputContainer.appendChild(inputGroup); 
            nodeInput.focus(); 
            nodeInput.select(); 
        }

        /** 處理儲存 AND 輸入源 */
        function handleSaveAndSources() { 
            if (!currentAndTargetNodeId) return; 
            const targetNode = findNodeById(rcaData, currentAndTargetNodeId); 
            if (!targetNode) return; 
            const selectedSourceIds = []; 
            const checkboxes = andSourceOptionsContainer.querySelectorAll('input[type="checkbox"]:checked'); 
            checkboxes.forEach(chk => selectedSourceIds.push(chk.value)); 
            targetNode.andSourceNodeIds = selectedSourceIds; 
            pushStateToHistory(rcaData); 
            andSourceModal.style.display = 'none'; 
            currentAndTargetNodeId = null; 
            renderRcaDiagram(); 
        }

        /**
         * 開啟 AND 輸入源彈出視窗。
         * @param {string} targetNodeId - 目標節點的 ID。
         */
        function openAndSourceModal(targetNodeId) { 
            if (isFinalizedView) return; 
            currentAndTargetNodeId = targetNodeId; 
            const targetNode = findNodeById(rcaData, targetNodeId); 
            if (!targetNode) return; 
            andSourceModalTitle.textContent = `為效果 "${targetNode.text}" 設定 AND 輸入源`; 
            andSourceOptionsContainer.innerHTML = ''; 
            const availableCauses = []; 
            function findCausesRecursive(node) { 
                if (!node) return; 
                if (node.type === 'cause') availableCauses.push(node); 
                if (node.children) node.children.forEach(findCausesRecursive); 
            } 
            if (rcaData) findCausesRecursive(rcaData); 
            if (availableCauses.length === 0) { 
                andSourceOptionsContainer.innerHTML = '<p class="text-gray-500 text-center">圖表中尚無可用的原因節點。</p>'; 
            } else { 
                availableCauses.forEach(causeNode => { 
                    // 避免將自身或子孫節點設為 AND 輸入源
                    if (causeNode.id === targetNode.id || isDescendant(targetNode, causeNode.id) || causeNode.id === targetNode.parentId) return; 
                    const div = document.createElement('div'); 
                    div.classList.add('flex', 'items-center', 'my-2', 'p-2', 'hover:bg-gray-100', 'rounded'); 
                    const checkbox = document.createElement('input'); 
                    checkbox.type = 'checkbox'; 
                    checkbox.id = `and-source-chk-${causeNode.id}`; 
                    checkbox.value = causeNode.id; 
                    checkbox.classList.add('form-checkbox', 'h-5', 'w-5', 'text-blue-600', 'rounded', 'border-gray-300'); 
                    if (targetNode.andSourceNodeIds && targetNode.andSourceNodeIds.includes(causeNode.id)) { 
                        checkbox.checked = true; 
                    } 
                    const label = document.createElement('label'); 
                    label.htmlFor = `and-source-chk-${causeNode.id}`; 
                    label.textContent = `${causeNode.text} (ID: ${causeNode.id.split('-')[1]})`; 
                    label.classList.add('ml-3', 'text-sm', 'text-gray-700', 'flex-grow'); 
                    div.appendChild(checkbox); 
                    div.appendChild(label); 
                    andSourceOptionsContainer.appendChild(div); 
                }); 
                if (andSourceOptionsContainer.childElementCount === 0) { 
                    andSourceOptionsContainer.innerHTML = '<p class="text-gray-500 text-center">無有效的 AND 輸入源選項。</p>'; 
                } 
            } 
            andSourceModal.style.display = 'flex'; 
        }

        /**
         * 檢查一個節點是否是另一個節點的子孫節點。
         * @param {object} parentNode - 潛在的父節點。
         * @param {string} childNodeIdToFind - 要查找的子孫節點 ID。
         * @returns {boolean} 如果是子孫節點則為 true，否則為 false。
         */
        function isDescendant(parentNode, childNodeIdToFind) { 
            if (!parentNode || !parentNode.children || parentNode.children.length === 0) return false; 
            for (const child of parentNode.children) { 
                if (child.id === childNodeIdToFind) return true; 
                if (isDescendant(child, childNodeIdToFind)) return true; 
            } 
            return false; 
        }

        /** 處理儲存效果參數 */
        function handleSaveEffectParameters() { 
            if (!currentParameterTargetNodeId) return; 
            const targetNode = findNodeById(rcaData, currentParameterTargetNodeId); 
            if (!targetNode) return; 
            const selectedParameters = []; 
            const checkboxes = effectParameterOptionsContainer.querySelectorAll('input[type="checkbox"]:checked'); 
            checkboxes.forEach(chk => selectedParameters.push(chk.value)); 
            targetNode.effectParameters = selectedParameters; 
            pushStateToHistory(rcaData); 
            effectParameterModal.style.display = 'none'; 
            currentParameterTargetNodeId = null; 
            renderRcaDiagram(); 
        }

        /**
         * 開啟效果參數彈出視窗。
         * @param {string} targetNodeId - 目標節點的 ID。
         */
        function openEffectParameterModal(targetNodeId) { 
            if (isFinalizedView) return; 
            currentParameterTargetNodeId = targetNodeId; 
            const targetNode = findNodeById(rcaData, targetNodeId); 
            if (!targetNode || (targetNode.type !== 'positive-effect' && targetNode.type !== 'negative-effect')) return; 
            effectParameterModalTitle.textContent = `為效果 "${targetNode.text}" 設定效果參數`; 
            effectParameterOptionsContainer.innerHTML = ''; 
            Object.keys(EFFECT_PARAMETERS).forEach(category => { 
                const categoryTitle = document.createElement('h4'); 
                categoryTitle.textContent = category; 
                effectParameterOptionsContainer.appendChild(categoryTitle); 
                EFFECT_PARAMETERS[category].forEach(param => { 
                    const div = document.createElement('div'); 
                    div.classList.add('flex', 'items-center', 'my-1', 'p-1', 'hover:bg-gray-50', 'rounded'); 
                    const checkbox = document.createElement('input'); 
                    checkbox.type = 'checkbox'; 
                    const checkboxId = `param-chk-${param.replace(/\s|\/|[\(\)]/g, '-')}`; 
                    checkbox.id = checkboxId; 
                    checkbox.value = param; 
                    checkbox.classList.add('form-checkbox', 'h-4', 'w-4', 'text-sky-600', 'rounded', 'border-gray-300', 'focus:ring-sky-500'); 
                    if (targetNode.effectParameters && targetNode.effectParameters.includes(param)) { 
                        checkbox.checked = true; 
                    } 
                    const label = document.createElement('label'); 
                    label.htmlFor = checkboxId; 
                    label.textContent = param; 
                    label.classList.add('ml-2', 'text-sm', 'text-gray-700'); 
                    div.appendChild(checkbox); 
                    div.appendChild(label); 
                    effectParameterOptionsContainer.appendChild(div); 
                }); 
            }); 
            effectParameterModal.style.display = 'flex'; 
        }

        /** 處理儲存發明原理和方案 */
        function handleSaveInventivePrinciples() { 
            if (!currentPrincipleTargetNodeId) return; 
            const targetNode = findNodeById(rcaData, currentPrincipleTargetNodeId); 
            if (!targetNode) return; 
            const selectedPrinciples = []; 
            const principleCheckboxes = inventivePrincipleOptionsContainer.querySelectorAll('input[type="checkbox"]');
            principleCheckboxes.forEach(chk => {
                if (chk.checked) {
                    const principleName = chk.value;
                    const solutionInput = chk.closest('.my-2').querySelector('input[type="text"][data-principle-name]');
                    selectedPrinciples.push({ 
                        name: principleName, 
                        solution: solutionInput ? solutionInput.value.trim() : '' 
                    });
                }
            });
            targetNode.inventivePrinciples = selectedPrinciples; 
            pushStateToHistory(rcaData); 
            inventivePrincipleModal.style.display = 'none'; 
            currentPrincipleTargetNodeId = null; 
            renderRcaDiagram(); 
            renderSolutionTable(); 
        }

        /**
         * 開啟發明原理彈出視窗。
         * @param {string} targetNodeId - 目標節點的 ID。
         * @param {boolean} isContradictoryCause - 目標節點是否為矛盾原因。
         */
        function openInventivePrincipleModal(targetNodeId, isContradictoryCause) { 
            if (isFinalizedView) return; 
            currentPrincipleTargetNodeId = targetNodeId; 
            const targetNode = findNodeById(rcaData, targetNodeId); 
            if (!targetNode || targetNode.type !== 'cause') return; 
            
            inventivePrincipleModalTitle.textContent = `為原因 "${targetNode.text}" ${isContradictoryCause ? '的矛盾選擇' : '選擇'}發明原理與改善方案`; 
            inventivePrincipleOptionsContainer.innerHTML = ''; 
            INVENTIVE_PRINCIPLES.forEach(principleName => { 
                const principleContainer = document.createElement('div'); 
                principleContainer.classList.add('my-2', 'p-2', 'border-b', 'border-gray-200'); 
                const div = document.createElement('div'); 
                div.classList.add('flex', 'items-center'); 
                const checkbox = document.createElement('input'); 
                checkbox.type = 'checkbox'; 
                const checkboxId = `principle-chk-${principleName.replace(/\s|\/|[\(\)\[\]]/g, '-')}`; 
                checkbox.id = checkboxId; 
                checkbox.value = principleName; 
                checkbox.classList.add('form-checkbox', 'h-4', 'w-4', 'text-pink-600', 'rounded', 'border-gray-300', 'focus:ring-pink-500'); 
                const existingPrinciple = targetNode.inventivePrinciples.find(p => p.name === principleName); 
                if (existingPrinciple) { 
                    checkbox.checked = true; 
                } 
                const label = document.createElement('label'); 
                label.htmlFor = checkboxId; 
                label.textContent = principleName; 
                label.classList.add('ml-2', 'text-sm', 'text-gray-700', 'font-medium'); 
                div.appendChild(checkbox); 
                div.appendChild(label); 
                principleContainer.appendChild(div); 
                const solutionInput = document.createElement('input'); 
                solutionInput.type = 'text'; 
                solutionInput.placeholder = '輸入此原理的改善方案...'; 
                solutionInput.dataset.principleName = principleName; 
                solutionInput.classList.add('principle-solution-input', 'input-field', 'mt-1'); 
                solutionInput.value = existingPrinciple && existingPrinciple.solution ? existingPrinciple.solution : ''; 
                solutionInput.style.display = checkbox.checked ? 'block' : 'none'; 
                checkbox.onchange = () => { 
                    solutionInput.style.display = checkbox.checked ? 'block' : 'none'; 
                    if (!checkbox.checked) solutionInput.value = ''; 
                }; 
                principleContainer.appendChild(solutionInput); 
                inventivePrincipleOptionsContainer.appendChild(principleContainer); 
            }); 
            inventivePrincipleModal.style.display = 'flex'; 
        }
        
        /**
         * 繪製所有 SVG 連接線。
         * @param {HTMLElement} [targetSvgLayer=svgLayer] - 目標 SVG 層元素。
         * @param {HTMLElement} [targetDiagramContainer=diagramContainer] - 目標圖表容器元素。
         * @param {HTMLElement} [targetScalableWrapper=scalableContentWrapper] - 目標可縮放內容包裝器元素。
         * @param {number} [zoom=currentZoom] - 當前縮放級別。
         */
        function drawAllSvgConnectors(
            targetSvgLayer = svgLayer, 
            targetDiagramContainer = diagramContainer, 
            targetScalableWrapper = scalableContentWrapper, 
            zoom = currentZoom
        ) { 
            targetSvgLayer.innerHTML = ''; // 清空現有連接線
            if (!rcaData || !targetDiagramContainer.querySelector(`#${rcaData.id}`) || !targetScalableWrapper) { 
                targetSvgLayer.setAttribute('width', 0); 
                targetSvgLayer.setAttribute('height', 0); 
                return; 
            } 
            
            // 獲取包裝器的 padding，用於計算相對位置
            const wrapperStyle = getComputedStyle(targetScalableWrapper);
            const wrapperPaddingLeft = parseFloat(wrapperStyle.paddingLeft) || 0;
            const wrapperPaddingTop = parseFloat(wrapperStyle.paddingTop) || 0;

            // 設置 SVG 層的尺寸
            const unscaledDiagramWidth = targetDiagramContainer.scrollWidth; 
            const unscaledDiagramHeight = targetDiagramContainer.scrollHeight; 
            targetSvgLayer.setAttribute('width', unscaledDiagramWidth); 
            targetSvgLayer.setAttribute('height', unscaledDiagramHeight); 
            targetSvgLayer.setAttribute('viewBox', `0 0 ${unscaledDiagramWidth} ${unscaledDiagramHeight}`); 
            
            const lineVerticalOffset = 25; // 連接線垂直偏移量
            const scalableWrapperRect = targetScalableWrapper.getBoundingClientRect(); 

            /**
             * 遞迴繪製連接線。
             * @param {object} parentNodeData - 父節點資料。
             * @param {HTMLElement} currentContainer - 當前包含節點的 DOM 容器。
             */
            function drawRecursive(parentNodeData, currentContainer) { 
                const parentElement = currentContainer.querySelector(`#${parentNodeData.id}`); 
                if (!parentElement) return; 
                
                const parentRect = parentElement.getBoundingClientRect(); 
                // 計算父節點在 SVG 座標系中的位置
                const parentBottomCenterX_svg = (parentRect.left - (scalableWrapperRect.left + wrapperPaddingLeft) + parentRect.width / 2) / zoom; 
                const parentBottomY_svg = (parentRect.top - (scalableWrapperRect.top + wrapperPaddingTop) + parentRect.height) / zoom; 
                const parentTopY_svg = (parentRect.top - (scalableWrapperRect.top + wrapperPaddingTop)) / zoom; 
                const parentCenterX_svg = parentBottomCenterX_svg; 

                // 繪製 AND 輸入源連接線
                if (parentNodeData.andSourceNodeIds && parentNodeData.andSourceNodeIds.length > 0) { 
                    const mergePointYOffset = 40; 
                    const mergePoint_svg = { x: parentCenterX_svg, y: parentTopY_svg - mergePointYOffset }; 
                    if(mergePoint_svg.y < 0) mergePoint_svg.y = 10; // 避免線條超出邊界
                    _drawSvgCircle(targetSvgLayer, mergePoint_svg.x, mergePoint_svg.y, 6, '#6d28d9', zoom); // 繪製 AND 點圓圈
                    parentNodeData.andSourceNodeIds.forEach(sourceId => { 
                        const sourceElement = currentContainer.querySelector(`#${sourceId}`); 
                        if (sourceElement) { 
                            const sourceRect = sourceElement.getBoundingClientRect(); 
                            const sourceConnX_svg = (sourceRect.left - (scalableWrapperRect.left + wrapperPaddingLeft) + sourceRect.width / 2) / zoom; 
                            const sourceConnY_svg = (sourceRect.top - (scalableWrapperRect.top + wrapperPaddingTop) + sourceRect.height) / zoom; 
                            if (sourceConnY_svg < mergePoint_svg.y) { // 如果源節點在合併點上方，從底部連接
                                _drawSvgLine(targetSvgLayer, sourceConnX_svg, sourceConnY_svg, mergePoint_svg.x, mergePoint_svg.y, '#6b7280', 2, zoom); 
                            } else { // 否則從頂部連接
                                const sourceTopY_svg = (sourceRect.top - (scalableWrapperRect.left + wrapperPaddingLeft)) / zoom; 
                                _drawSvgLine(targetSvgLayer, sourceConnX_svg, sourceTopY_svg, mergePoint_svg.x, mergePoint_svg.y, '#6b7280', 2, zoom); 
                            } 
                        } 
                    }); 
                    if (parentTopY_svg > mergePoint_svg.y) { 
                        _drawSvgLine(targetSvgLayer, mergePoint_svg.x, mergePoint_svg.y, parentCenterX_svg, parentTopY_svg, '#6b7280', 2, zoom); 
                    } 
                } 
                // 過濾掉作為 AND 輸入源的子節點，避免重複繪製
                const standardChildren = parentNodeData.children.filter(c => !(c.andSourceNodeIds && c.andSourceNodeIds.length > 0 && c.andSourceNodeIds.includes(parentNodeData.id))); 
                if (standardChildren.length > 0) { 
                    const horizontalLineY_svg = parentBottomY_svg + lineVerticalOffset; 
                    // 繪製從父節點到底部水平線的垂直線
                    _drawSvgLine(targetSvgLayer, parentBottomCenterX_svg, parentBottomY_svg, parentBottomCenterX_svg, horizontalLineY_svg, '#9ca3af', 2, zoom); 
                    if (standardChildren.length > 1) { 
                        // 繪製連接多個子節點的水平線
                        const firstChildElement = currentContainer.querySelector(`#${standardChildren[0].id}`); 
                        const lastChildElement = currentContainer.querySelector(`#${standardChildren[standardChildren.length - 1].id}`); 
                        if (firstChildElement && lastChildElement) { 
                            const firstChildRect = firstChildElement.getBoundingClientRect(); 
                            const lastChildRect = lastChildElement.getBoundingClientRect(); 
                            const hLineStartX_svg = (firstChildRect.left - (scalableWrapperRect.left + wrapperPaddingLeft) + firstChildRect.width / 2) / zoom; 
                            const hLineEndX_svg = (lastChildRect.left - (scalableWrapperRect.left + wrapperPaddingLeft) + lastChildRect.width / 2) / zoom; 
                            if (Math.abs(hLineStartX_svg - hLineEndX_svg) > 1) { 
                                _drawSvgLine(targetSvgLayer, hLineStartX_svg, horizontalLineY_svg, hLineEndX_svg, horizontalLineY_svg, '#9ca3af', 2, zoom); 
                            } 
                        } 
                    } else if (standardChildren.length === 1) { 
                        // 如果只有一個子節點，繪製從父節點中心到子節點中心的水平線
                        const childElement = currentContainer.querySelector(`#${standardChildren[0].id}`); 
                        if (childElement) { 
                            const childRect = childElement.getBoundingClientRect(); 
                            const childCenterX_svg = (childRect.left - (scalableWrapperRect.left + wrapperPaddingLeft) + childRect.width / 2) / zoom; 
                            if (Math.abs(parentBottomCenterX_svg - childCenterX_svg) > 1) { 
                                _drawSvgLine(targetSvgLayer, parentBottomCenterX_svg, horizontalLineY_svg, childCenterX_svg, horizontalLineY_svg, '#9ca3af', 2, zoom); 
                            } 
                        } 
                    } 
                    // 繪製從水平線到子節點的垂直線
                    standardChildren.forEach(childNode => { 
                        const childElement = currentContainer.querySelector(`#${childNode.id}`); 
                        if (childElement) { 
                            const childRect = childElement.getBoundingClientRect(); 
                            const childCenterX_svg = (childRect.left - (scalableWrapperRect.left + wrapperPaddingLeft) + childRect.width / 2) / zoom; 
                            const childTopY_svg = (childRect.top - (scalableWrapperRect.top + wrapperPaddingTop)) / zoom; 
                            if (childTopY_svg > horizontalLineY_svg) { 
                                _drawSvgLine(targetSvgLayer, childCenterX_svg, horizontalLineY_svg, childCenterX_svg, childTopY_svg, '#9ca3af', 2, zoom); 
                            } 
                        } 
                    }); 
                } 
                // 遞迴繪製子節點的連接線
                if (parentNodeData.children) { 
                    parentNodeData.children.forEach(childNode => drawRecursive(childNode, currentContainer)); 
                } 
            } 
            if(rcaData) drawRecursive(rcaData, targetDiagramContainer); 
        }

        /**
         * 繪製 SVG 線條。
         * @param {SVGElement} svg - SVG 元素。
         * @param {number} x1 - 起點 X 座標。
         * @param {number} y1 - 起點 Y 座標。
         * @param {number} x2 - 終點 X 座標。
         * @param {number} y2 - 終點 Y 座標。
         * @param {string} [color='black'] - 線條顏色。
         * @param {number} [strokeWidth=2] - 線條寬度。
         * @param {number} [zoomFactor=1] - 縮放因子。
         */
        function _drawSvgLine(svg, x1, y1, x2, y2, color = 'black', strokeWidth = 2, zoomFactor = 1) { 
            if (isNaN(x1) || isNaN(y1) || isNaN(x2) || isNaN(y2)) { return; } 
            const line = document.createElementNS('http://www.w3.org/2000/svg', 'line'); 
            line.setAttribute('x1', x1); line.setAttribute('y1', y1); 
            line.setAttribute('x2', x2); line.setAttribute('y2', y2); 
            line.setAttribute('stroke', color); 
            line.setAttribute('stroke-width', strokeWidth / zoomFactor); 
            svg.appendChild(line); 
        }

        /**
         * 繪製 SVG 圓圈。
         * @param {SVGElement} svg - SVG 元素。
         * @param {number} cx - 圓心 X 座標。
         * @param {number} cy - 圓心 Y 座標。
         * @param {number} r - 半徑。
         * @param {string} [fillColor='black'] - 填充顏色。
         * @param {number} [zoomFactor=1] - 縮放因子。
         */
        function _drawSvgCircle(svg, cx, cy, r, fillColor = 'black', zoomFactor = 1) { 
            if (isNaN(cx) || isNaN(cy) || isNaN(r)) { return; } 
            const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle'); 
            circle.setAttribute('cx', cx); circle.setAttribute('cy', cy); 
            circle.setAttribute('r', r / zoomFactor); 
            circle.setAttribute('fill', fillColor); 
            svg.appendChild(circle); 
        }
        
        /**
         * 檢查節點是否有正面或負面子效果。
         * @param {object} nodeData - 節點資料。
         * @returns {{hasPositiveChild: boolean, hasNegativeChild: boolean}} 包含是否有正面和負面子效果的物件。
         */
        function checkChildrenEffects(nodeData) { 
            let hasPositiveChild = false; 
            let hasNegativeChild = false; 
            if (nodeData.children) { 
                for (const child of nodeData.children) { 
                    if (child.type === 'positive-effect') hasPositiveChild = true; 
                    if (child.type === 'negative-effect') hasNegativeChild = true; 
                    if (hasPositiveChild && hasNegativeChild) break; 
                } 
            } 
            return { hasPositiveChild, hasNegativeChild }; 
        }

        /**
         * 切換原因節點的「不可變 (Non-Changeable)」標記。
         * @param {string} nodeId - 要切換的節點 ID。
         */
        function toggleNonChangeable(nodeId) { 
            if (isFinalizedView) return; 
            const node = findNodeById(rcaData, nodeId); 
            if (node && node.type === 'cause') { 
                node.isNonChangeable = !node.isNonChangeable; 
                pushStateToHistory(rcaData); 
                renderRcaDiagram(); 
                renderCauseEffectTable(); 
            } 
        }

        /**
         * 創建一個動作按鈕。
         * @param {string} textOrHtml - 按鈕的文字或 HTML 內容。
         * @param {string} className - 按鈕的 CSS 類名。
         * @param {function} onClickHandler - 按鈕的點擊事件處理函數。
         * @returns {HTMLButtonElement} 創建的按鈕元素。
         */
        function createActionButton(textOrHtml, className, onClickHandler) { 
            const button = document.createElement('button'); 
            button.classList.add('action-button', ...className.split(' ')); 
            button.innerHTML = textOrHtml; 
            button.addEventListener('click', onClickHandler); 
            return button; 
        }

        /**
         * 提示用戶添加新節點。
         * @param {string} parentId - 父節點的 ID。
         * @param {HTMLElement} parentNodeContentDiv - 父節點的內容 DOM 元素。
         * @param {string} nodeTypeToAdd - 要添加的節點類型。
         * @param {string} placeholderText - 輸入框的佔位符文字。
         */
        function promptAddNode(parentId, parentNodeContentDiv, nodeTypeToAdd, placeholderText) { 
            if (isFinalizedView) return; 
            const inputContainer = parentNodeContentDiv.querySelector('.input-group-container'); 
            if (!inputContainer) return; 
            
            // 移除所有現有的輸入組件，確保只顯示一個
            inputContainer.innerHTML = ''; 
            document.querySelectorAll('.input-group').forEach(ig => ig.remove()); 

            const inputGroup = document.createElement('div'); 
            inputGroup.classList.add('input-group'); 
            const nodeInput = document.createElement('input'); 
            nodeInput.type = 'text'; 
            nodeInput.placeholder = placeholderText; 
            nodeInput.classList.add('input-field'); 
            
            const saveButton = document.createElement('button'); 
            saveButton.textContent = '儲存'; 
            saveButton.classList.add('action-button', 'save-button', 'w-full', 'mt-2'); 
            saveButton.onclick = () => { 
                const nodeText = nodeInput.value.trim(); 
                if (nodeText) { 
                    addNodeToData(parentId, nodeText, nodeTypeToAdd); 
                    inputContainer.innerHTML = ''; 
                } else { alert('描述不能為空！'); } 
            }; 
            nodeInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') saveButton.click(); }); 
            
            const cancelButton = document.createElement('button'); 
            cancelButton.textContent = '取消'; 
            cancelButton.classList.add('action-button', 'bg-gray-400', 'hover:bg-gray-500', 'w-full', 'mt-1'); 
            cancelButton.onclick = () => { inputContainer.innerHTML = ''; }; 
            
            inputGroup.appendChild(nodeInput); 
            inputGroup.appendChild(saveButton); 
            inputGroup.appendChild(cancelButton); 
            inputContainer.appendChild(inputGroup); 
            nodeInput.focus(); 
        }

        /**
         * 將新節點添加到資料結構中。
         * @param {string} parentId - 父節點的 ID。
         * @param {string} nodeText - 新節點的文字內容。
         * @param {string} nodeType - 新節點的類型。
         */
        function addNodeToData(parentId, nodeText, nodeType) { 
            const parentNode = findNodeById(rcaData, parentId); 
            if (parentNode) { 
                const newNode = createNode(nodeText, nodeType, parentId); 
                parentNode.children.push(newNode); 
                pushStateToHistory(rcaData); 
                renderRcaDiagram(); 
                renderCauseEffectTable(); 
                renderSolutionTable(); 
            } 
        }

        /**
         * 從資料結構中移除節點。
         * @param {string} nodeIdToRemove - 要移除的節點 ID。
         */
        function removeNode(nodeIdToRemove) { 
            if (isFinalizedView) return; 
            if (rcaData && rcaData.id === nodeIdToRemove) { 
                alert('不能移除主要問題根源節點！'); 
                return; 
            } 
            let nodeRemoved = false; 
            /**
             * 遞迴過濾節點。
             * @param {object} node - 當前節點。
             * @param {string} idToRemove - 要移除的節點 ID。
             * @returns {object|null} 過濾後的節點，如果被移除則為 null。
             */
            function filterRecursive(node, idToRemove) { 
                if (!node) return null; 
                if (node.id === idToRemove) { 
                    nodeRemoved = true; 
                    // 移除所有引用該節點作為 AND 輸入源的連接
                    function removeAndSourceFromEntireTree(currentNodeData, removedId) {
                        if (!currentNodeData) return;
                        if (currentNodeData.andSourceNodeIds && currentNodeData.andSourceNodeIds.includes(removedId)) {
                            currentNodeData.andSourceNodeIds = currentNodeData.andSourceNodeIds.filter(srcId => srcId !== removedId);
                        }
                        if (currentNodeData.children) {
                            currentNodeData.children.forEach(child => removeAndSourceFromEntireTree(child, removedId));
                        }
                    }
                    removeAndSourceFromEntireTree(rcaData, idToRemove);
                    // 如果被移除的節點是某個已識別衝突的來源，則從列表中移除該衝突
                    trizMcdaData.identifiedConflicts = trizMcdaData.identifiedConflicts.filter(c => c.causeId !== idToRemove);
                    renderIdentifiedConflictsList(); // 更新衝突列表顯示

                    // 如果被移除的節點是當前 TRIZ 分析的衝突來源，則重置相關數據
                    if (trizMcdaData.contradictionSourceCauseId === idToRemove) {
                        trizMcdaData.contradictionSourceCauseId = null;
                        trizMcdaData.contradictionSourceCauseText = "";
                        trizMcdaData.contradictionPhenomenon = ""; 
                        renderTrizMcdaFromData(); 
                    }
                    return null; 
                } 
                if (node.children) { 
                    node.children = node.children.map(child => filterRecursive(child, idToRemove)).filter(child => child !== null); 
                } 
                return node; 
            } 
            rcaData = filterRecursive(rcaData, nodeIdToRemove); 
            if (nodeRemoved) { 
                pushStateToHistory(rcaData); 
            } 
            // 如果所有節點都被移除，重置應用程式狀態
            if (!rcaData) { 
                historyStack = []; 
                historyIndex = -1; 
                applyZoom(1.0); 
                navigateToStep(1, true); 
            } 
            renderRcaDiagram(); 
            renderCauseEffectTable(); 
            renderSolutionTable(); 
            renderTrackingTable();
            updateButtonStates(); 
        }

        /**
         * 根據 ID 查找節點。
         * @param {object} node - 當前節點。
         * @param {string} id - 要查找的節點 ID。
         * @returns {object|null} 找到的節點物件，如果未找到則為 null。
         */
        function findNodeById(node, id) { 
            if (!node) return null; 
            if (node.id === id) return node; 
            if (node.children) { 
                for (const child of node.children) { 
                    const found = findNodeById(child, id); 
                    if (found) return found; 
                } 
            } 
            return null; 
        }
        
        /**
         * 獲取原因效果表的數據。
         * @returns {Array<object>} 原因效果表的數據陣列。
         */
        function getCauseEffectTableData() { 
            const tableRowsData = []; 
            /**
             * 遞迴收集數據。
             * @param {object} node - 當前節點。
             */
            function collectDataRecursive(node) { 
                if (!node) return; 
                if (node.type === 'cause') { 
                    const { hasPositiveChild, hasNegativeChild } = checkChildrenEffects(node); 
                    let causeType = ''; 
                    if (node.isNonChangeable) causeType = 'NC (不可變)'; 
                    else if (hasPositiveChild && hasNegativeChild) causeType = '矛盾 (N+P)'; 
                    else if (hasNegativeChild) causeType = '純負面 (N)'; 
                    else if (hasPositiveChild) causeType = '純正面 (P)'; 
                    else causeType = '未定義效果'; 
                        const positiveEffects = node.children.filter(c => c.type === 'positive-effect').map(c => c.text).join('; ') || '無'; 
                        const negativeEffects = node.children.filter(c => c.type === 'negative-effect').map(c => c.text).join('; ') || '無'; 
                        tableRowsData.push({ cause: node.text, type: causeType, positive: positiveEffects, negative: negativeEffects }); 
                } 
                if (node.children) node.children.forEach(collectDataRecursive); 
            } 
            if (rcaData) collectDataRecursive(rcaData); 
            return tableRowsData; 
        }

        /** 渲染原因效果表 */
        function renderCauseEffectTable() { 
            if (!rcaData) { 
                causeEffectTableBody.innerHTML = '<tr><td colspan="4" class="text-center text-gray-500">請先設定主要負面效果並建立分析圖。</td></tr>'; 
                return; 
            } 
            const tableData = getCauseEffectTableData(); 
            causeEffectTableBody.innerHTML = ''; 
            if (tableData.length === 0) { 
                causeEffectTableBody.innerHTML = '<tr><td colspan="4" class="text-center text-gray-500">目前圖表中沒有定義原因節點。</td></tr>'; 
                return; 
            } 
            tableData.forEach(rowData => { 
                const row = causeEffectTableBody.insertRow(); 
                row.insertCell().textContent = rowData.cause; 
                row.insertCell().textContent = rowData.type; 
                row.insertCell().textContent = rowData.positive; 
                row.insertCell().textContent = rowData.negative; 
            }); 
        }
        
        /** 渲染改善方案表 */
        function renderSolutionTable() { 
            if (!rcaData) { 
                solutionTableBody.innerHTML = '<tr><td colspan="3" class="text-center text-gray-500">請先設定主要負面效果並建立分析圖。</td></tr>'; 
                return; 
            } 
            const tableData = getSolutionTableData(); 
            solutionTableBody.innerHTML = ''; 
            if (tableData.length === 0) { 
                let message = '目前沒有矛盾原因已選擇發明原理並填寫改善方案。'; 
                let hasContradictoryCauseWithPrinciple = false;
                function findContradictoryWithPrinciple(node) {
                    if(!node) return;
                    if (node.type === 'cause') {
                        const { hasPositiveChild, hasNegativeChild } = checkChildrenEffects(node);
                        if (hasPositiveChild && hasNegativeChild && node.inventivePrinciples && node.inventivePrinciples.length > 0) {
                            hasContradictoryCauseWithPrinciple = true;
                            return;
                        }
                    }
                    if (node.children && !hasContradictoryCauseWithPrinciple) node.children.forEach(findContradictoryWithPrinciple);
                }
                if (rcaData) findContradictoryWithPrinciple(rcaData);

                if (!hasContradictoryCauseWithPrinciple) {
                     message = '提示：請先識別RCA圖中的矛盾原因(同時有正負面效果)，點擊其「分析此矛盾」按鈕，然後在TRIZ分析區塊選擇發明原理並填寫方案雛形。';
                }
                solutionTableBody.innerHTML = `<tr><td colspan="3" class="text-center text-gray-500">${message}</td></tr>`; 
                return; 
            } 
            const groupedSolutions = {}; 
            tableData.forEach(item => { 
                if (!groupedSolutions[item.contradictoryCause]) { 
                    groupedSolutions[item.contradictoryCause] = []; 
                } 
                groupedSolutions[item.contradictoryCause].push({ principle: item.principle, solution: item.solution }); 
            }); 
            Object.keys(groupedSolutions).forEach(causeText => { 
                const solutionsForCause = groupedSolutions[causeText]; 
                solutionsForCause.forEach((solutionItem, index) => { 
                    const row = solutionTableBody.insertRow(); 
                    if (index === 0) { 
                        const causeCell = row.insertCell(); 
                        causeCell.textContent = causeText; 
                        causeCell.rowSpan = solutionsForCause.length; 
                    } 
                    row.insertCell().textContent = solutionItem.principle; 
                    row.insertCell().textContent = solutionItem.solution; 
                }); 
            }); 
        }

        /**
         * 獲取改善方案表的數據。
         * @returns {Array<object>} 改善方案表的數據陣列。
         */
        function getSolutionTableData() { 
            const solutionData = []; 
            if (trizMcdaData.mcdaSolutions && trizMcdaData.mcdaSolutions.length > 0) {
                const causeNodeText = trizMcdaData.contradictionSourceCauseText || "未知矛盾原因";
                trizMcdaData.mcdaSolutions.forEach(sol => {
                     if (sol.conceptText.trim() !== '') {
                        solutionData.push({
                            contradictoryCause: causeNodeText, 
                            principle: sol.principleName,
                            solution: sol.conceptText
                        });
                    }
                });
            }
            return solutionData; 
        }

        /** 渲染改善方案追蹤表 */
        function renderTrackingTable() {
            trackingTableBody.innerHTML = '';
            if (trackingData.length === 0) {
                trackingTableBody.innerHTML = '<tr><td colspan="7" class="text-center text-gray-500">目前沒有追蹤中的改善方案。</td></tr>';
                return;
            }
            trackingData.forEach(item => {
                const row = trackingTableBody.insertRow();
                row.insertCell().textContent = item.solutionText;
                row.insertCell().textContent = item.responsiblePerson;
                row.insertCell().textContent = item.dueDate;
                row.insertCell().textContent = item.status;
                row.insertCell().textContent = item.actualOutcome;
                row.insertCell().textContent = item.notes;
                
                const actionCell = row.insertCell();
                actionCell.classList.add('action-cell');
                const editButton = createActionButton('編輯', 'edit-node !py-1 !px-2', () => openTrackingItemModalForEdit(item.id));
                const deleteButton = createActionButton('刪除', 'remove-button !py-1 !px-2 ml-1', () => handleDeleteTrackingItem(item.id));
                actionCell.appendChild(editButton);
                actionCell.appendChild(deleteButton);
            });
            updateButtonStates();
        }

        /** 開啟新增追蹤項目彈出視窗 */
        function openTrackingItemModalForAdd() {
            currentEditingTrackingItemId = null;
            trackingItemModalTitle.textContent = '新增追蹤項目';
            trackingItemIdInput.value = '';
            trackingSolutionTextInput.value = '';
            trackingResponsiblePersonInput.value = '';
            trackingDueDateInput.value = '';
            trackingStatusSelect.value = '未開始';
            trackingActualOutcomeInput.value = '';
            trackingNotesInput.value = '';
            trackingItemModal.style.display = 'flex';
        }

        /**
         * 開啟編輯追蹤項目彈出視窗。
         * @param {string} itemId - 要編輯的追蹤項目 ID。
         */
        function openTrackingItemModalForEdit(itemId) {
            const item = trackingData.find(t => t.id === itemId);
            if (!item) return;
            currentEditingTrackingItemId = itemId;
            trackingItemModalTitle.textContent = '編輯追蹤項目';
            trackingItemIdInput.value = item.id;
            trackingSolutionTextInput.value = item.solutionText;
            trackingResponsiblePersonInput.value = item.responsiblePerson;
            trackingDueDateInput.value = item.dueDate;
            trackingStatusSelect.value = item.status;
            trackingActualOutcomeInput.value = item.actualOutcome;
            trackingNotesInput.value = item.notes;
            trackingItemModal.style.display = 'flex';
        }

        /** 關閉追蹤項目彈出視窗 */
        function closeTrackingItemModal() {
            trackingItemModal.style.display = 'none';
            currentEditingTrackingItemId = null;
        }

        /** 處理儲存追蹤項目 */
        function handleSaveTrackingItem() {
            const solutionText = trackingSolutionTextInput.value.trim();
            if (!solutionText) {
                alert('改善方案描述不能為空！');
                return;
            }
            const itemData = {
                solutionText: solutionText,
                responsiblePerson: trackingResponsiblePersonInput.value.trim(),
                dueDate: trackingDueDateInput.value,
                status: trackingStatusSelect.value,
                actualOutcome: trackingActualOutcomeInput.value.trim(),
                notes: trackingNotesInput.value.trim()
            };

            if (currentEditingTrackingItemId) { // 編輯現有項目
                const index = trackingData.findIndex(item => item.id === currentEditingTrackingItemId);
                if (index > -1) {
                    trackingData[index] = { ...trackingData[index], ...itemData };
                }
            } else { // 新增項目
                itemData.id = `track-${Date.now()}`; 
                trackingData.push(itemData);
            }
            pushStateToHistory(rcaData); 
            renderTrackingTable();
            closeTrackingItemModal();
        }

        /**
         * 處理刪除追蹤項目。
         * @param {string} itemId - 要刪除的追蹤項目 ID。
         */
        function handleDeleteTrackingItem(itemId) {
            if (confirm('確定要刪除此追蹤項目嗎？')) {
                trackingData = trackingData.filter(item => item.id !== itemId);
                pushStateToHistory(rcaData); 
                renderTrackingTable();
            }
        }
        
        /** 自動調整節點佈局 */
        function autoAdjustNodeLayout() { 
            if (!rcaData || isFinalizedView) {
                alert('請先建立圖表或結束「完成圖表」模式以調整節點位置。');
                return;
            }
            const nodeWrappers = Array.from(diagramContainer.querySelectorAll('.rca-node-wrapper'));
            const MIN_SPACING = 20; // 最小間距
            for (let i = 0; i < nodeWrappers.length; i++) {
                const wrapper1 = nodeWrappers[i];
                const rect1 = wrapper1.getBoundingClientRect();
                for (let j = i + 1; j < nodeWrappers.length; j++) {
                    const wrapper2 = nodeWrappers[j];
                    // 檢查是否為同層級節點
                    if (wrapper1.parentNode !== wrapper2.parentNode || wrapper1.parentNode.classList.contains('rca-diagram-container')) {
                        continue; 
                    }
                    const rect2 = wrapper2.getBoundingClientRect();
                    const overlapX = Math.max(0, Math.min(rect1.right, rect2.right) - Math.max(rect1.left, rect2.left));
                    const verticalAlign = Math.abs(rect1.top - rect2.top) < rect1.height / 2; // 判斷是否垂直對齊
                    
                    if (verticalAlign && overlapX > -MIN_SPACING) { // 如果有重疊或間距不足
                        const adjustment = (overlapX > 0 ? overlapX : 0) + MIN_SPACING; 
                        let currentMarginLeft = parseFloat(getComputedStyle(wrapper2).marginLeft) || 0;
                        wrapper2.style.marginLeft = (currentMarginLeft + adjustment) + 'px';
                        wrapper2.getBoundingClientRect(); // 強制重繪
                    }
                }
            }
            requestAnimationFrame(() => drawAllSvgConnectors()); // 重新繪製連接線
            alert('嘗試自動調整節點位置。您可能需要多次點擊或手動微調以獲得最佳效果。');
        }

        /**
         * 將表格數據匯出為 CSV 檔案。
         * @param {string} tableId - 表格的 ID。
         * @param {string} filename - 匯出的檔案名稱。
         */
        function exportTableToCSV(tableId, filename) {
            const table = document.getElementById(tableId);
            if (!table) {
                alert(`找不到表格 ID: ${tableId}`);
                return;
            }
            let csv = [];
            const rows = table.querySelectorAll("tr");
            
            for (const row of rows) {
                const rowData = [];
                const cols = row.querySelectorAll("td, th");
                for (const col of cols) {
                    let cellData = col.innerText.replace(/"/g, '""'); // 處理雙引號
                    if (cellData.includes(',')) { // 如果包含逗號，用雙引號包裹
                        cellData = `"${cellData}"`;
                    }
                    rowData.push(cellData);
                }
                csv.push(rowData.join(","));
            }

            const csvFile = new Blob(["\uFEFF" + csv.join("\n")], {type: "text/csv;charset=utf-8;"}); // 添加 BOM 以支援中文
            const downloadLink = document.createElement("a");
            downloadLink.download = filename;
            downloadLink.href = window.URL.createObjectURL(csvFile);
            downloadLink.style.display = "none";
            document.body.appendChild(downloadLink);
            downloadLink.click();
            document.body.removeChild(downloadLink);
            alert(`${filename} 已準備下載。`);
        }
        
        // --- 初始化函數定義 ---
        function initialize() {
            populateTrizParameters(); // 填充 TRIZ 參數
            initializeTrizMatrix(); // 初始化 TRIZ 矛盾矩陣

            // 綁定工作流程步驟按鈕事件
            workflowStepButtons.forEach(button => {
                button.addEventListener('click', () => {
                    navigateToStep(parseInt(button.dataset.step));
                });
            });

            // 綁定問題輸入和設定按鈕事件
            setProblemButton.addEventListener('click', handleSetInitialProblem);
            problemInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') handleSetInitialProblem(); });
            
            // 綁定檔案操作按鈕事件
            fileMenuButton.addEventListener('click', (event) => { 
                event.stopPropagation(); 
                toggleDropdown(fileDropdownContent, [exportDropdownContent, viewTablesDropdownContent]);
                updateButtonStates(); 
            });
            saveWorkspaceButton.addEventListener('click', () => { handleSaveToLocalStorage(); closeAllDropdowns(); });
            loadWorkspaceButton.addEventListener('click', () => { handleLoadFromLocalStorage(); closeAllDropdowns(); });
            downloadBackupButton.addEventListener('click', () => { handleSaveToFile(); closeAllDropdowns(); });
            loadBackupLabel.addEventListener('click', () => { loadBackupInput.click(); }); 
            loadBackupInput.addEventListener('change', (event) => { handleLoadFromFile(event); closeAllDropdowns(); });

            // 綁定撤銷/重做按鈕事件
            undoButton.addEventListener('click', handleUndo);
            redoButton.addEventListener('click', handleRedo);

            // 綁定縮放控制按鈕事件
            zoomInButton.addEventListener('click', () => applyZoom(currentZoom + ZOOM_STEP));
            zoomOutButton.addEventListener('click', () => applyZoom(currentZoom - ZOOM_STEP));
            resetZoomButton.addEventListener('click', () => applyZoom(1.0));

            // 綁定圖表操作按鈕事件
            finalizeDiagramButton.addEventListener('click', handleToggleFinalizeView); 
            autoAdjustLayoutButton.addEventListener('click', autoAdjustNodeLayout); 
            generateLandscapeChartButton.addEventListener('click', renderIdeasLandscapeChart);

            // 綁定匯出按鈕事件
            exportMenuButton.addEventListener('click', (event) => {
                event.stopPropagation();
                toggleDropdown(exportDropdownContent, [fileDropdownContent, viewTablesDropdownContent]);
                updateButtonStates();
            });
            exportCauseEffectCsvButton.addEventListener('click', () => { exportTableToCSV('cause-effect-data-table', 'cause_effect_table.csv'); closeAllDropdowns(); });
            exportSolutionCsvButton.addEventListener('click', () => { exportTableToCSV('solution-data-table', 'solution_table.csv'); closeAllDropdowns(); });
            exportTrackingCsvButton.addEventListener('click', () => { exportTableToCSV('tracking-data-table', 'tracking_table.csv'); closeAllDropdowns(); });
            
            if (exportSvgButton) {
                exportSvgButton.addEventListener('click', () => { 
                    exportSVG('RCA_矛盾分析圖.svg'); 
                    closeAllDropdowns(); 
                });
            }

            printDocumentButton.addEventListener('click', () => { 
                if(rcaData || trackingData.length > 0 || hasTrizMcdaData()) { 
                    const originalStep = currentWorkflowStep;
                    const sectionsToPrint = [rcaDiagramSection, conflictAnalysisSection, trizMcdaSection, ideasLandscapeSection, reportOutputSections];
                    
                    // 暫時顯示所有要列印的區塊
                    sectionsToPrint.forEach(s => { if(s) s.classList.add('active-section'); });
                    if (problemInputArea && !rcaData) problemInputArea.style.display = 'block';

                    requestAnimationFrame(() => {
                        if (rcaData) drawAllSvgConnectors(svgLayer, diagramContainer, scalableContentWrapper, currentZoom); 
                        if (ideasLandscapeSection.classList.contains('active-section')) renderIdeasLandscapeChart();
                        setTimeout(() => {
                            window.print();
                            // 列印後恢復原來的步驟顯示
                            navigateToStep(originalStep, true); 
                        }, 300); // 增加延遲確保渲染完成
                    });
                } else {
                     alert("沒有可列印的內容。");
                }
                closeAllDropdowns(); 
            });
            
            // 綁定檢視表格按鈕事件
            viewTablesMenuButton.addEventListener('click', (event) => {
                event.stopPropagation();
                toggleDropdown(viewTablesDropdownContent, [fileDropdownContent, exportDropdownContent]);
                updateButtonStates();
            });
            showCauseEffectTableButton.addEventListener('click', () => { handleShowCauseEffectTable(); closeAllDropdowns(); });
            showSolutionTableButton.addEventListener('click', () => { handleShowSolutionTable(); closeAllDropdowns(); });
            showTrackingTableButton.addEventListener('click', () => { handleShowTrackingTable(); closeAllDropdowns(); }); 
            hideAllTablesButton.addEventListener('click', () => { handleHideAllTables(); closeAllDropdowns(); });
            
            // 綁定追蹤項目按鈕事件
            addTrackingItemButton.addEventListener('click', openTrackingItemModalForAdd); 
            saveTrackingItemButton.addEventListener('click', handleSaveTrackingItem); 

            // 綁定彈出視窗按鈕事件
            confirmContradictionToTrizButton.addEventListener('click', handleConfirmContradictionToTriz);

            saveAndSourcesButton.addEventListener('click', handleSaveAndSources);
            cancelAndSourcesButton.addEventListener('click', () => { andSourceModal.style.display = 'none'; currentAndTargetNodeId = null; });
            saveEffectParametersButton.addEventListener('click', handleSaveEffectParameters);
            cancelEffectParametersButton.addEventListener('click', () => { effectParameterModal.style.display = 'none'; currentParameterTargetNodeId = null; });
            saveInventivePrinciplesButton.addEventListener('click', handleSaveInventivePrinciples);
            cancelInventivePrinciplesButton.addEventListener('click', () => { inventivePrincipleModal.style.display = 'none'; currentPrincipleTargetNodeId = null; });
            
            // 綁定 TRIZ-MCDA 按鈕事件
            trizGeneratePrinciplesButton.addEventListener('click', handleTrizGeneratePrinciples);
            mcdaAddCriterionButton.addEventListener('click', handleMcdaAddCriterion);
            mcdaCalculateTotalWeightButton.addEventListener('click', calculateAndDisplayTotalWeight);
            mcdaCalculateScoresButton.addEventListener('click', handleMcdaCalculateScores);
            saveTrizMcdaButton.addEventListener('click', saveTrizMcdaProgress);

            // 點擊視窗外部關閉下拉選單
            window.addEventListener('click', (event) => { 
                if (!event.target.closest('.dropdown')) {
                    closeAllDropdowns();
                }
            });

            // 監聽視窗大小變化，重新繪製圖表和景觀圖
            new ResizeObserver(() => { 
                if(rcaData && rcaDiagramSection.classList.contains('active-section')) drawAllSvgConnectors(); 
                if(ideasLandscapeSection.classList.contains('active-section')) renderIdeasLandscapeChart(); 
            }).observe(document.body); 
            
            // 初始顯示工具按鈕，應用縮放，載入本地儲存數據，導航到步驟1，並更新按鈕狀態
            toolButtonsContainer.style.display = 'flex'; 
            applyZoom(1.0, true); 
            loadTrizMcdaDataFromLocalStorage(); 
            navigateToStep(1); 
            updateButtonStates(); 
            
            // 禁用右鍵選單
            scalableContentWrapper.addEventListener('contextmenu', (event) => {
                event.preventDefault(); 
            });
        }
        
        // --- 初始化應用程式 ---
        initialize(); 
    </script>
</body>
</html>
